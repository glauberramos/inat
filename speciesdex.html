<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      SpeciesDex - Track Top 100 Species in Any Location | iNaturalist Tool
    </title>
    <link rel="icon" href="favicon.ico" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#74ac00" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <link rel="apple-touch-icon" href="logo.png" />
    <link
      rel="canonical"
      href="https://glauberramos.github.io/inat/speciesdex.html"
    />
    <meta
      name="description"
      content="Discover which of the top 100 most observed species in any location you've already observed on iNaturalist. Track your progress like a Pokedex for nature!"
    />
    <meta
      name="keywords"
      content="SpeciesDex, iNaturalist, species tracker, top species, nature pokedex, biodiversity challenge, wildlife checklist, species collection"
    />
    <meta
      property="og:title"
      content="SpeciesDex - Track Top 100 Species Like a Pokedex"
    />
    <meta
      property="og:description"
      content="Discover which top species in any location you've observed on iNaturalist. A Pokedex for nature lovers!"
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://glauberramos.github.io/inat/speciesdex.html"
    />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="SpeciesDex - Track Top 100 Species" />
    <meta name="twitter:description" content="Discover which top species in any location you've observed on iNaturalist. A Pokedex for nature lovers!" />
    <meta name="robots" content="index, follow" />
    <meta name="author" content="Glauber Ramos" />
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "SpeciesDex",
      "description": "Discover which of the top 100 most observed species in any location you've already observed on iNaturalist. Track your progress like a Pokedex for nature!",
      "url": "https://glauberramos.github.io/inat/speciesdex.html",
      "applicationCategory": "UtilitiesApplication",
      "operatingSystem": "Web",
      "author": {
        "@type": "Person",
        "name": "Glauber Ramos"
      }
    }
    </script>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="dark-mode.css" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
      @media (max-width: 480px) {
        .place-search-container,
        .username-search-container,
        .taxon-search-container {
          width: 100%;
          display: block;
        }

        .place-search-container input,
        .username-search-container input,
        .taxon-search-container input,
        .taxon-id-override-input {
          width: 100%;
          margin-right: 0;
        }

        .taxon-autocomplete {
          left: 0;
          right: 0;
          width: 100%;
        }

        .advanced-options-section {
          align-items: stretch;
        }

        .advanced-options-checkbox input[type="checkbox"] {
          margin-left: 0;
        }

        .language-select-container {
          width: 100%;
          margin-top: 10px;
        }

        .language-select-container .language-select {
          width: 100%;
        }

        .month-filter-label {
          display: block;
          margin-bottom: 8px;
        }

        .month-checkboxes .advanced-options-checkbox {
          width: auto;
          justify-content: center;
        }

        .month-checkboxes input[type="checkbox"] {
          margin-left: 0;
          margin-right: 4px;
        }
      }

      /* Hide default pipeback widget */
      #pipeback-widget-container,
      .pipeback-launcher-frame {
        display: none !important;
      }

      /* Custom feedback button */
      .feedback-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #74ac00;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 999;
        transition: all 0.3s;
      }

      .feedback-button:hover {
        background: #5d8a00;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      }

      /* Map Modal Styles */
      .map-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      }

      .map-modal.show {
        display: flex;
      }

      .map-modal-content {
        background: #fff;
        border-radius: 16px;
        width: 94%;
        max-width: 720px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .map-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: #fafafa;
        border-bottom: 1px solid #eee;
      }

      .map-modal-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: #333;
      }

      .map-modal-close {
        background: none;
        border: none;
        font-size: 1.3rem;
        cursor: pointer;
        color: #999;
        padding: 4px 8px;
        line-height: 1;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .map-modal-close:hover {
        background: #eee;
        color: #333;
      }

      .map-container {
        height: 420px;
        position: relative;
        background: #e8e8e8;
      }

      #areaMap {
        width: 100%;
        height: 100%;
      }

      .map-toolbar {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        display: flex;
        gap: 4px;
        background: white;
        padding: 4px;
        border-radius: 10px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
      }

      .map-tool-btn {
        background: transparent;
        border: none;
        border-radius: 6px;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        transition: all 0.2s;
        color: #555;
      }

      .map-tool-btn:hover {
        background: #f0f0f0;
      }

      .map-tool-btn.active {
        background: #74ac00;
        color: white;
      }

      .map-modal-footer {
        padding: 16px 20px;
        background: #fafafa;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
      }

      .map-info {
        font-size: 0.8rem;
        color: #888;
        flex: 1;
      }

      .map-modal-actions {
        display: flex;
        gap: 8px;
      }

      .map-cancel-btn {
        background: white;
        border: 1px solid #ddd;
        color: #555;
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .map-cancel-btn:hover {
        background: #f5f5f5;
        border-color: #ccc;
      }

      .map-apply-btn {
        background: #74ac00;
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .map-apply-btn:hover {
        background: #629200;
        transform: translateY(-1px);
      }

      .map-open-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.7;
        transition: opacity 0.2s;
      }

      .map-open-btn:hover {
        opacity: 1;
      }

      .place-search-wrapper {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      @media (max-width: 600px) {
        .map-container {
          height: 320px;
        }
        .map-modal-footer {
          flex-direction: column;
          align-items: stretch;
          gap: 12px;
        }
        .map-info {
          text-align: center;
        }
        .map-modal-actions {
          justify-content: stretch;
        }
        .map-modal-actions button {
          flex: 1;
        }
      }
    </style>
  </head>
  <body>
    <a
      href="/inat"
      class="back-button"
      style="
        position: fixed;
        top: 20px;
        left: 20px;
        background: #74ac00;
        color: white;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 10px 16px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
      "
      onmouseover="this.style.background='#659900'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.2)'"
      onmouseout="this.style.background='#74ac00'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.15)'"
    >
      <span style="font-size: 1rem">‚Üê</span> More iNat tools
    </a>
    <div class="container">
      <header>
        <div class="header-content">
          <div class="title-container">
            <img src="logo.png" alt="SpeciesDex Logo" class="logo" />
            <h1>SpeciesDex</h1>
          </div>
          <p class="description">
            See which of the most observed species in a place you've observed -
            iNaturalist.
          </p>
        </div>
        <div class="search-container">
          <select id="taxonSelect" class="taxon-select">
            <option value="all" selected>All Species</option>
            <option value="1">Animals</option>
            <option value="355675">Vertebrates</option>
            <option value="3">Birds</option>
            <option value="40151">Mammals</option>
            <option value="26036">Reptiles</option>
            <option value="20978">Amphibians</option>
            <option value="47178">Fish</option>
            <option value="47158">Insects</option>
            <option value="47157">Butterflies and Moths</option>
            <option value="47208">Beetles</option>
            <option value="47119">Arachnids</option>
            <option value="47115">Mollusks</option>
            <option value="47126">Plants</option>
            <option value="47170">Fungi</option>
          </select>
          <div class="place-search-wrapper">
            <div class="place-search-container">
              <input
                type="text"
                id="placeNameInput"
                placeholder="Search place or project..."
                autocomplete="off"
              />
              <div id="placeAutocomplete" class="place-autocomplete"></div>
            </div>
            <button type="button" class="map-open-btn" id="openMapBtn" title="Select area on map">üó∫Ô∏è</button>
          </div>
          <input type="text" id="placeIdInput" style="display: none" />
          <input type="hidden" id="mapBoundsInput" />
          <select id="limitSelect" class="limit-select">
            <option value="100">Top 100 Species</option>
            <option value="200">Top 200 Species</option>
            <option value="500">Top 500 Species</option>
            <option value="1000">Top 1000 Species</option>
            <option value="5000">Top 5000 Species</option>
          </select>
          <div class="username-search-container">
            <input
              type="text"
              id="usernameInput"
              placeholder="Enter iNaturalist username"
              data-1p-ignore
            />
          </div>
          <button id="searchButton">Search</button>
          <button id="advancedOptionsButton" type="button">
            Advanced Options
          </button>
        </div>
        <div
          id="advancedOptionsSection"
          class="advanced-options-section"
          style="display: none"
        >
          <div class="taxon-search-container">
            <input
              id="taxonIdOverrideInput"
              class="taxon-id-override-input"
              placeholder="Search for a taxon..."
              autocomplete="off"
            />
            <div id="taxonAutocomplete" class="taxon-autocomplete"></div>
          </div>
          <span class="language-select-container">
            <select id="languageSelect" class="language-select">
              <option value="en" selected>English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="pt">Portuguese</option>
              <option value="it">Italian</option>
              <option value="nl">Dutch</option>
              <option value="ru">Russian</option>
              <option value="ja">Japanese</option>
              <option value="zh">Chinese</option>
            </select>
          </span>
          <span class="advanced-options-checkbox">
            <input type="checkbox" id="wildCheckbox" class="wild-checkbox" />
            <label for="wildCheckbox">Wild</label>
          </span>
          <span class="advanced-options-checkbox">
            <input
              type="checkbox"
              id="researchGradeCheckbox"
              class="research-grade-checkbox"
            />
            <label for="researchGradeCheckbox">Research Grade</label>
          </span>
          <span class="advanced-options-checkbox">
            <input
              type="checkbox"
              id="threatenedCheckbox"
              class="threatened-checkbox"
            />
            <label for="threatenedCheckbox">Threatened</label>
          </span>
          <span class="advanced-options-checkbox">
            <input
              type="checkbox"
              id="endemicCheckbox"
              class="endemic-checkbox"
            />
            <label for="endemicCheckbox">Endemic</label>
          </span>
          <span class="advanced-options-checkbox">
            <input
              type="checkbox"
              id="verifiableCheckbox"
              class="verifiable-checkbox"
              checked
            />
            <label for="verifiableCheckbox">Verifiable</label>
          </span>
          <span class="advanced-options-checkbox">
            <input
              type="checkbox"
              id="includeAllPlacesCheckbox"
              class="include-all-places-checkbox"
            />
            <label for="includeAllPlacesCheckbox"
              >Include my observations from all places</label
            >
          </span>
          <div class="month-filter-container">
            <label class="month-filter-label">Filter by months:</label>
            <div class="month-checkboxes">
              <span class="advanced-options-checkbox">
                <input
                  type="checkbox"
                  id="monthCheckbox1"
                  class="month-checkbox"
                  value="1"
                />
                <label for="monthCheckbox1">Jan</label>
              </span>
              <span class="advanced-options-checkbox">
                <input
                  type="checkbox"
                  id="monthCheckbox2"
                  class="month-checkbox"
                  value="2"
                />
                <label for="monthCheckbox2">Feb</label>
              </span>
              <span class="advanced-options-checkbox">
                <input
                  type="checkbox"
                  id="monthCheckbox3"
                  class="month-checkbox"
                  value="3"
                />
                <label for="monthCheckbox3">Mar</label>
              </span>
              <span class="advanced-options-checkbox">
                <input
                  type="checkbox"
                  id="monthCheckbox4"
                  class="month-checkbox"
                  value="4"
                />
                <label for="monthCheckbox4">Apr</label>
              </span>
              <span class="advanced-options-checkbox">
                <input
                  type="checkbox"
                  id="monthCheckbox5"
                  class="month-checkbox"
                  value="5"
                />
                <label for="monthCheckbox5">May</label>
              </span>
              <span class="advanced-options-checkbox">
                <input
                  type="checkbox"
                  id="monthCheckbox6"
                  class="month-checkbox"
                  value="6"
                />
                <label for="monthCheckbox6">Jun</label>
              </span>
              <span class="advanced-options-checkbox">
                <input
                  type="checkbox"
                  id="monthCheckbox7"
                  class="month-checkbox"
                  value="7"
                />
                <label for="monthCheckbox7">Jul</label>
              </span>
              <span class="advanced-options-checkbox">
                <input
                  type="checkbox"
                  id="monthCheckbox8"
                  class="month-checkbox"
                  value="8"
                />
                <label for="monthCheckbox8">Aug</label>
              </span>
              <span class="advanced-options-checkbox">
                <input
                  type="checkbox"
                  id="monthCheckbox9"
                  class="month-checkbox"
                  value="9"
                />
                <label for="monthCheckbox9">Sep</label>
              </span>
              <span class="advanced-options-checkbox">
                <input
                  type="checkbox"
                  id="monthCheckbox10"
                  class="month-checkbox"
                  value="10"
                />
                <label for="monthCheckbox10">Oct</label>
              </span>
              <span class="advanced-options-checkbox">
                <input
                  type="checkbox"
                  id="monthCheckbox11"
                  class="month-checkbox"
                  value="11"
                />
                <label for="monthCheckbox11">Nov</label>
              </span>
              <span class="advanced-options-checkbox">
                <input
                  type="checkbox"
                  id="monthCheckbox12"
                  class="month-checkbox"
                  value="12"
                />
                <label for="monthCheckbox12">Dec</label>
              </span>
            </div>
          </div>
          <div class="advanced-actions">
            <button id="searchButtonAdvanced" class="search-button-advanced">
              Search
            </button>
            <button id="downloadButton" class="download-button" disabled>
              üìÑ Download Report
            </button>
          </div>
        </div>
        <div class="status-bar" id="statusBar">
          <div class="status-text">
            Observed: <span id="observedCount">0</span> /
            <span id="totalCount">0</span> species (<span id="percentObserved"
              >0</span
            >%)
          </div>

          <div class="progress-bar">
            <div class="progress" id="progressBar"></div>
          </div>
        </div>
      </header>

      <main>
        <div class="loading" id="loading">Loading...</div>
        <div class="checkbox-container" style="display: none;">
          <span id="locationName" class="location-name"></span>
          <input
            type="checkbox"
            id="showMissingOnly"
            class="show-missing-checkbox"
          />
          <label for="showMissingOnly">Show only missing</label>
          <input
            type="checkbox"
            id="showSpottedOnly"
            class="show-spotted-checkbox"
          />
          <label for="showSpottedOnly">Show only observed</label>
        </div>
        <div class="species-grid" id="speciesGrid"></div>
      </main>
    </div>
    <script src="constants.js"></script>
    <script src="shared-utils.js"></script>
    <script src="script.js"></script>
    <script src="search.js"></script>
    <script src="download.js"></script>
    <!-- Map Modal -->
    <div class="map-modal" id="mapModal">
      <div class="map-modal-content">
        <div class="map-modal-header">
          <h3>Select Area</h3>
          <button class="map-modal-close" id="mapModalClose">&times;</button>
        </div>
        <div class="map-container">
          <div id="areaMap"></div>
          <div class="map-toolbar">
            <button class="map-tool-btn active" id="circleToolBtn" title="Circle">‚≠ï</button>
            <button class="map-tool-btn" id="rectangleToolBtn" title="Rectangle">üî≤</button>
            <button class="map-tool-btn" id="myLocationBtn" title="My location">üìç</button>
          </div>
        </div>
        <div class="map-modal-footer">
          <div class="map-info" id="mapInfo">Click on the map to select an area</div>
          <div class="map-modal-actions">
            <button class="map-cancel-btn" id="mapCancelBtn">Cancel</button>
            <button class="map-apply-btn" id="mapApplyBtn">Apply</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Map Selection Script -->
    <script>
      (function() {
        let areaMap = null;
        let currentSelection = null;
        let selectionType = 'circle'; // 'circle' or 'rectangle'
        let isDragging = false;
        let isResizing = false;
        let resizeHandle = null;
        let defaultRadius = 50000; // 50km default
        let dragStartLatLng = null;
        let dragStartBounds = null;
        let circleHandles = [];
        let rectHandles = [];
        let justFinishedInteraction = false; // Prevent click after drag/resize

        // Initialize map when modal opens
        function initAreaMap() {
          if (areaMap) return;

          areaMap = L.map('areaMap').setView([20, 0], 2);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
          }).addTo(areaMap);

          // Map click handler
          areaMap.on('click', function(e) {
            if (isDragging || isResizing || justFinishedInteraction) {
              justFinishedInteraction = false;
              return;
            }
            placeSelection(e.latlng);
          });

          // Single mousemove handler for all drag/resize operations
          areaMap.on('mousemove', function(e) {
            // Check resize FIRST (before drag) to prioritize handle interactions
            if (isResizing && currentSelection) {
              if (selectionType === 'circle') {
                const center = currentSelection.getLatLng();
                const newRadius = center.distanceTo(e.latlng);
                currentSelection.setRadius(Math.max(100, newRadius)); // Min 100m
                defaultRadius = currentSelection.getRadius();
                updateCircleHandles();
              } else if (resizeHandle !== null) {
                const bounds = currentSelection.getBounds();
                let south = bounds.getSouth();
                let north = bounds.getNorth();
                let west = bounds.getWest();
                let east = bounds.getEast();

                switch(resizeHandle) {
                  case 0: // NW - change north and west
                    north = e.latlng.lat;
                    west = e.latlng.lng;
                    break;
                  case 1: // NE - change north and east
                    north = e.latlng.lat;
                    east = e.latlng.lng;
                    break;
                  case 2: // SE - change south and east
                    south = e.latlng.lat;
                    east = e.latlng.lng;
                    break;
                  case 3: // SW - change south and west
                    south = e.latlng.lat;
                    west = e.latlng.lng;
                    break;
                }
                currentSelection.setBounds([[south, west], [north, east]]);
                updateRectangleHandles();
              }
              updateMapInfo();
            } else if (isDragging && currentSelection) {
              if (selectionType === 'circle') {
                currentSelection.setLatLng(e.latlng);
                updateCircleHandles();
              } else {
                const latDiff = e.latlng.lat - dragStartLatLng.lat;
                const lngDiff = e.latlng.lng - dragStartLatLng.lng;
                const newBounds = [
                  [dragStartBounds.getSouth() + latDiff, dragStartBounds.getWest() + lngDiff],
                  [dragStartBounds.getNorth() + latDiff, dragStartBounds.getEast() + lngDiff]
                ];
                currentSelection.setBounds(newBounds);
                dragStartLatLng = e.latlng;
                dragStartBounds = currentSelection.getBounds();
                updateRectangleHandles();
              }
              updateMapInfo();
            }
          });

          // Single mouseup handler
          areaMap.on('mouseup', function() {
            if (isDragging || isResizing) {
              justFinishedInteraction = true; // Prevent click from firing
              isDragging = false;
              isResizing = false;
              resizeHandle = null;
              areaMap.dragging.enable();
            }
          });
        }

        function placeSelection(latlng) {
          clearSelection();

          // Calculate size based on current map view (about 1/4 of visible area)
          const mapBounds = areaMap.getBounds();
          const viewHeight = mapBounds.getNorth() - mapBounds.getSouth();
          const viewWidth = mapBounds.getEast() - mapBounds.getWest();
          const selectionSize = Math.min(viewHeight, viewWidth) * 0.25;

          if (selectionType === 'circle') {
            // Convert degrees to meters (approximate)
            const radiusInMeters = selectionSize * 111000 / 2;
            currentSelection = L.circle(latlng, {
              radius: radiusInMeters,
              color: '#74ac00',
              fillColor: '#74ac00',
              fillOpacity: 0.2,
              weight: 2
            }).addTo(areaMap);

            // Make circle draggable
            setupCircleDrag(currentSelection);
            addCircleResizeHandles(currentSelection);
          } else {
            // Rectangle - use selection size relative to view
            const halfHeight = selectionSize / 2;
            const halfWidth = selectionSize * 0.75; // slightly wider
            const bounds = [
              [latlng.lat - halfHeight, latlng.lng - halfWidth],
              [latlng.lat + halfHeight, latlng.lng + halfWidth]
            ];
            currentSelection = L.rectangle(bounds, {
              color: '#74ac00',
              fillColor: '#74ac00',
              fillOpacity: 0.2,
              weight: 2
            }).addTo(areaMap);

            setupRectangleDrag(currentSelection);
            addRectangleResizeHandles(currentSelection);
          }

          updateMapInfo();
        }

        function setupCircleDrag(circle) {
          circle.on('mousedown', function(e) {
            if (isResizing) return;
            isDragging = true;
            areaMap.dragging.disable();
            L.DomEvent.stopPropagation(e);
          });
        }

        function setupRectangleDrag(rect) {
          rect.on('mousedown', function(e) {
            if (isResizing) return;
            isDragging = true;
            dragStartLatLng = e.latlng;
            dragStartBounds = rect.getBounds();
            areaMap.dragging.disable();
            L.DomEvent.stopPropagation(e);
          });
        }

        function addCircleResizeHandles(circle) {
          circleHandles.forEach(h => areaMap.removeLayer(h));
          circleHandles = [];

          const center = circle.getLatLng();
          const radius = circle.getRadius();
          const handlePositions = [
            L.latLng(center.lat, center.lng + radius / 111000 / Math.cos(center.lat * Math.PI / 180)),
            L.latLng(center.lat, center.lng - radius / 111000 / Math.cos(center.lat * Math.PI / 180)),
            L.latLng(center.lat + radius / 111000, center.lng),
            L.latLng(center.lat - radius / 111000, center.lng)
          ];

          handlePositions.forEach((pos, i) => {
            const handle = L.circleMarker(pos, {
              radius: 8,
              color: '#74ac00',
              fillColor: 'white',
              fillOpacity: 1,
              weight: 2,
              bubblingMouseEvents: false
            }).addTo(areaMap);

            handle.on('mousedown', function(e) {
              isResizing = true;
              isDragging = false; // Explicitly prevent dragging
              areaMap.dragging.disable();
              L.DomEvent.stopPropagation(e);
              L.DomEvent.preventDefault(e);
            });

            handle.bringToFront();
            circleHandles.push(handle);
          });
        }

        function updateCircleHandles() {
          if (!currentSelection || selectionType !== 'circle') return;
          const center = currentSelection.getLatLng();
          const radius = currentSelection.getRadius();
          const positions = [
            L.latLng(center.lat, center.lng + radius / 111000 / Math.cos(center.lat * Math.PI / 180)),
            L.latLng(center.lat, center.lng - radius / 111000 / Math.cos(center.lat * Math.PI / 180)),
            L.latLng(center.lat + radius / 111000, center.lng),
            L.latLng(center.lat - radius / 111000, center.lng)
          ];
          circleHandles.forEach((h, i) => h.setLatLng(positions[i]));
        }

        function addRectangleResizeHandles(rect) {
          rectHandles.forEach(h => areaMap.removeLayer(h));
          rectHandles = [];

          const bounds = rect.getBounds();
          const corners = [
            bounds.getNorthWest(),
            bounds.getNorthEast(),
            bounds.getSouthEast(),
            bounds.getSouthWest()
          ];

          corners.forEach((pos, i) => {
            const handle = L.circleMarker(pos, {
              radius: 8,
              color: '#74ac00',
              fillColor: 'white',
              fillOpacity: 1,
              weight: 2,
              bubblingMouseEvents: false
            }).addTo(areaMap);

            handle.on('mousedown', function(e) {
              isResizing = true;
              isDragging = false; // Explicitly prevent dragging
              resizeHandle = i;
              areaMap.dragging.disable();
              L.DomEvent.stopPropagation(e);
              L.DomEvent.preventDefault(e);
            });

            handle.bringToFront();
            rectHandles.push(handle);
          });
        }

        function updateRectangleHandles() {
          if (!currentSelection || selectionType !== 'rectangle') return;
          const bounds = currentSelection.getBounds();
          const positions = [
            bounds.getNorthWest(),
            bounds.getNorthEast(),
            bounds.getSouthEast(),
            bounds.getSouthWest()
          ];
          rectHandles.forEach((h, i) => h.setLatLng(positions[i]));
        }

        function clearSelection() {
          if (currentSelection) {
            areaMap.removeLayer(currentSelection);
            currentSelection = null;
          }
          circleHandles.forEach(h => areaMap.removeLayer(h));
          circleHandles = [];
          rectHandles.forEach(h => areaMap.removeLayer(h));
          rectHandles = [];
          updateMapInfo();
        }

        function updateMapInfo() {
          const info = document.getElementById('mapInfo');
          if (!currentSelection) {
            info.textContent = 'Click on map to place selection, drag to move, use handles to resize';
            return;
          }

          if (selectionType === 'circle') {
            const center = currentSelection.getLatLng();
            const radius = currentSelection.getRadius();
            info.textContent = `Circle: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)} | Radius: ${(radius / 1000).toFixed(1)} km`;
          } else {
            const bounds = currentSelection.getBounds();
            info.textContent = `Rectangle: ${bounds.getSouth().toFixed(4)} to ${bounds.getNorth().toFixed(4)} lat, ${bounds.getWest().toFixed(4)} to ${bounds.getEast().toFixed(4)} lng`;
          }
        }

        function getSelectionBounds() {
          if (!currentSelection) return null;

          if (selectionType === 'circle') {
            const center = currentSelection.getLatLng();
            const radius = currentSelection.getRadius();
            return {
              type: 'circle',
              lat: center.lat,
              lng: center.lng,
              radius: radius
            };
          } else {
            const bounds = currentSelection.getBounds();
            return {
              type: 'rectangle',
              swlat: bounds.getSouth(),
              swlng: bounds.getWest(),
              nelat: bounds.getNorth(),
              nelng: bounds.getEast()
            };
          }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
          const openMapBtn = document.getElementById('openMapBtn');
          const mapModal = document.getElementById('mapModal');
          const mapModalClose = document.getElementById('mapModalClose');
          const mapCancelBtn = document.getElementById('mapCancelBtn');
          const mapApplyBtn = document.getElementById('mapApplyBtn');
          const circleToolBtn = document.getElementById('circleToolBtn');
          const rectangleToolBtn = document.getElementById('rectangleToolBtn');
          const myLocationBtn = document.getElementById('myLocationBtn');

          openMapBtn.addEventListener('click', function() {
            mapModal.classList.add('show');
            setTimeout(function() {
              initAreaMap();
              areaMap.invalidateSize();
            }, 100);
          });

          mapModalClose.addEventListener('click', function() {
            mapModal.classList.remove('show');
          });

          mapCancelBtn.addEventListener('click', function() {
            mapModal.classList.remove('show');
          });

          mapModal.addEventListener('click', function(e) {
            if (e.target === mapModal) {
              mapModal.classList.remove('show');
            }
          });

          circleToolBtn.addEventListener('click', function() {
            selectionType = 'circle';
            circleToolBtn.classList.add('active');
            rectangleToolBtn.classList.remove('active');
            clearSelection();
          });

          rectangleToolBtn.addEventListener('click', function() {
            selectionType = 'rectangle';
            rectangleToolBtn.classList.add('active');
            circleToolBtn.classList.remove('active');
            clearSelection();
          });

          myLocationBtn.addEventListener('click', function() {
            if (navigator.geolocation) {
              myLocationBtn.disabled = true;
              myLocationBtn.style.opacity = '0.5';
              navigator.geolocation.getCurrentPosition(
                function(pos) {
                  const lat = pos.coords.latitude;
                  const lng = pos.coords.longitude;
                  if (areaMap) {
                    areaMap.setView([lat, lng], 10);
                    placeSelection(L.latLng(lat, lng));
                  }
                  myLocationBtn.disabled = false;
                  myLocationBtn.style.opacity = '1';
                },
                function(error) {
                  console.error('Geolocation error:', error);
                  alert('Could not get your location. Please check your browser permissions.');
                  myLocationBtn.disabled = false;
                  myLocationBtn.style.opacity = '1';
                },
                { enableHighAccuracy: true, timeout: 10000 }
              );
            } else {
              alert('Geolocation is not supported by your browser.');
            }
          });

          mapApplyBtn.addEventListener('click', function() {
            const selection = getSelectionBounds();
            if (!selection) {
              alert('Please make a selection on the map first.');
              return;
            }

            // Store the bounds and update the UI
            const mapBoundsInput = document.getElementById('mapBoundsInput');
            const placeNameInput = document.getElementById('placeNameInput');
            const placeIdInput = document.getElementById('placeIdInput');

            mapBoundsInput.value = JSON.stringify(selection);
            placeIdInput.value = ''; // Clear place ID when using map selection

            if (selection.type === 'circle') {
              placeNameInput.value = `Map area: ${selection.lat.toFixed(2)}, ${selection.lng.toFixed(2)} (${(selection.radius / 1000).toFixed(0)} km radius)`;
            } else {
              placeNameInput.value = `Map area: ${selection.swlat.toFixed(2)} to ${selection.nelat.toFixed(2)} lat`;
            }

            // Save to localStorage and clear place/project
            localStorage.setItem('inatMapArea', JSON.stringify(selection));
            localStorage.setItem('inatPlaceName', placeNameInput.value);
            localStorage.removeItem('inatPlaceId');
            localStorage.removeItem('inatProject');
            localStorage.removeItem('inatProjectId');

            mapModal.classList.remove('show');
          });
        });
      })();
    </script>

    <script
      defer
      data-domain="glauberramos.github.io/inat"
      src="https://plausible.io/js/script.js"
    ></script>
    <button class="feedback-button" id="feedbackBtn">Send feedback</button>
    <script type="text/javascript">
      window.$pipeback = [];
      window.PIPEBACK_ID = "a069b910-4aef-4233-99cc-913e7fb30fb5";
      (function () {
        d = document;
        s = d.createElement("script");
        s.src = "https://widget.pipeback.com/l.js";
        s.async = 1;
        d.getElementsByTagName("head")[0].appendChild(s);
      })();

      // Feedback button toggle
      let feedbackOpen = false;
      document.getElementById("feedbackBtn").addEventListener("click", () => {
        if (feedbackOpen) {
          $pipeback.close();
          feedbackOpen = false;
        } else {
          $pipeback.open();
          feedbackOpen = true;
        }
      });
    </script>
    <script src="dark-mode.js"></script>
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
      }
    </script>
  </body>
</html>
