<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iNaturalist Auth Test</title>
    <link rel="icon" href="favicon.ico" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="dark-mode.css" />
    <style>
      .auth-container {
        max-width: 650px;
        margin: 30px auto;
        padding: 30px;
        text-align: center;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .dark-mode .auth-container {
        background: #2d2d2d;
      }

      .auth-logo {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
      }

      .auth-title {
        font-size: 1.5rem;
        color: #333;
        margin-bottom: 10px;
      }

      .dark-mode .auth-title {
        color: #e0e0e0;
      }

      .auth-subtitle {
        color: #666;
        margin-bottom: 30px;
      }

      .dark-mode .auth-subtitle {
        color: #aaa;
      }

      .auth-button {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: #74ac00;
        color: white;
        border: none;
        padding: 14px 28px;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .auth-button:hover {
        background: #659900;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(116, 172, 0, 0.4);
      }

      .auth-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .success-message {
        display: none;
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
      }

      .dark-mode .success-message {
        background: #1e3a1e;
        border-color: #2d5a2d;
        color: #90ee90;
      }

      .success-message.show {
        display: block;
      }

      .error-message {
        display: none;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
      }

      .dark-mode .error-message {
        background: #3a1e1e;
        border-color: #5a2d2d;
        color: #ff9090;
      }

      .error-message.show {
        display: block;
      }

      .user-info {
        display: none;
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .dark-mode .user-info {
        background: #1e1e1e;
      }

      .user-info.show {
        display: block;
      }

      .user-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin-bottom: 10px;
      }

      .user-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
      }

      .dark-mode .user-name {
        color: #e0e0e0;
      }

      .user-login {
        color: #666;
      }

      .dark-mode .user-login {
        color: #aaa;
      }

      .logout-button {
        margin-top: 15px;
        background: #dc3545;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .logout-button:hover {
        background: #c82333;
      }

      .token-info {
        margin-top: 15px;
        padding: 10px;
        background: #e9ecef;
        border-radius: 6px;
        font-family: monospace;
        font-size: 0.8rem;
        word-break: break-all;
        text-align: left;
      }

      .dark-mode .token-info {
        background: #333;
        color: #aaa;
      }

      .updates-section {
        display: none;
        margin-top: 20px;
        text-align: left;
      }

      .updates-section.show {
        display: block;
      }

      .updates-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .dark-mode .updates-title {
        color: #e0e0e0;
        border-bottom-color: #444;
      }

      .updates-list {
      }

      .update-item {
        display: flex;
        gap: 12px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 12px;
        text-decoration: none;
        color: inherit;
        transition: all 0.2s;
        border: 1px solid #e9ecef;
      }

      .update-item:hover {
        background: #e9ecef;
        border-color: #ddd;
        transform: translateY(-1px);
      }

      .dark-mode .update-item {
        background: #1e1e1e;
        border-color: #333;
      }

      .dark-mode .update-item:hover {
        background: #2a2a2a;
        border-color: #444;
      }

      .update-photo {
        width: 70px;
        height: 70px;
        border-radius: 8px;
        object-fit: cover;
        flex-shrink: 0;
      }

      .update-content {
        flex: 1;
        min-width: 0;
      }

      .update-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
      }

      .update-user-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        object-fit: cover;
      }

      .update-action {
        font-size: 0.85rem;
        color: #666;
      }

      .update-action strong {
        color: #3498db;
        font-weight: 600;
      }

      .dark-mode .update-action {
        color: #aaa;
      }

      .dark-mode .update-action strong {
        color: #5dade2;
      }

      .update-species {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 2px;
      }

      .dark-mode .update-species {
        color: #e0e0e0;
      }

      .update-scientific {
        font-size: 0.85rem;
        font-style: italic;
        color: #666;
        margin-bottom: 6px;
      }

      .dark-mode .update-scientific {
        color: #999;
      }

      .update-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 0.75rem;
        color: #888;
      }

      .dark-mode .update-meta {
        color: #777;
      }

      .update-meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .update-category {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .update-category.improving {
        background: #d4edda;
        color: #155724;
      }

      .update-category.supporting {
        background: #cce5ff;
        color: #004085;
      }

      .update-category.leading {
        background: #e2d5f1;
        color: #5b3d8a;
      }

      .update-category.maverick {
        background: #f8d7da;
        color: #721c24;
      }

      .dark-mode .update-category.improving {
        background: #1e3a1e;
        color: #90ee90;
      }

      .dark-mode .update-category.supporting {
        background: #1e2a3a;
        color: #87ceeb;
      }

      .dark-mode .update-category.leading {
        background: #2a1e3a;
        color: #dda0dd;
      }

      .dark-mode .update-category.maverick {
        background: #3a1e1e;
        color: #ff9090;
      }

      .update-quality {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
      }

      .update-quality.research {
        background: #74ac00;
        color: white;
      }

      .update-quality.needs_id {
        background: #f0ad4e;
        color: #333;
      }

      .update-quality.casual {
        background: #999;
        color: white;
      }

      .dark-mode .update-quality.research {
        background: #5a8a00;
      }

      .dark-mode .update-quality.needs_id {
        background: #c89333;
      }

      .dark-mode .update-quality.casual {
        background: #666;
      }

      .update-comment-body {
        font-size: 0.85rem;
        color: #555;
        font-style: italic;
        margin: 6px 0;
        padding: 8px;
        background: #f0f0f0;
        border-radius: 6px;
        border-left: 3px solid #9b59b6;
      }

      .dark-mode .update-comment-body {
        background: #2a2a2a;
        color: #bbb;
        border-left-color: #9b59b6;
      }

      .updates-loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .dark-mode .updates-loading {
        color: #aaa;
      }

      .no-updates {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .dark-mode .no-updates {
        color: #aaa;
      }
    </style>
  </head>
  <body>
    <div class="auth-container">
      <img src="logo.png" alt="iNaturalist" class="auth-logo" />
      <h1 class="auth-title">iNaturalist Authentication</h1>
      <p class="auth-subtitle">Test OAuth authentication with iNaturalist</p>

      <button class="auth-button" id="loginButton">
        <span>Login with iNaturalist</span>
      </button>

      <div class="success-message" id="successMessage">
        Authentication successful!
      </div>

      <div class="error-message" id="errorMessage"></div>

      <div class="user-info" id="userInfo">
        <img src="" alt="" class="user-avatar" id="userAvatar" />
        <div class="user-name" id="userName"></div>
        <div class="user-login" id="userLogin"></div>
        <div class="token-info" id="tokenInfo"></div>
        <button class="logout-button" id="logoutButton">Logout</button>
      </div>

      <div class="updates-section" id="updatesSection">
        <div class="updates-title">Recent Updates</div>
        <div class="updates-list" id="updatesList">
          <div class="updates-loading">Loading updates...</div>
        </div>
      </div>
    </div>

    <script>
      // iNaturalist OAuth Configuration
      // You need to register your app at: https://www.inaturalist.org/oauth/applications/new
      const CLIENT_ID = 'ynnL-3Y_xUWiXtWo1Id-DNePN3VSe5p3mZrnviIx_bA';
      const REDIRECT_URI = window.location.origin + window.location.pathname;
      const AUTH_URL = 'https://www.inaturalist.org/oauth/authorize';
      const TOKEN_URL = 'https://www.inaturalist.org/oauth/token';

      const loginButton = document.getElementById('loginButton');
      const successMessage = document.getElementById('successMessage');
      const errorMessage = document.getElementById('errorMessage');
      const userInfo = document.getElementById('userInfo');

      // PKCE Helper Functions
      function generateRandomString(length) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
        let result = '';
        const randomValues = new Uint8Array(length);
        crypto.getRandomValues(randomValues);
        for (let i = 0; i < length; i++) {
          result += chars[randomValues[i] % chars.length];
        }
        return result;
      }

      async function generateCodeChallenge(verifier) {
        const encoder = new TextEncoder();
        const data = encoder.encode(verifier);
        const digest = await crypto.subtle.digest('SHA-256', data);
        const base64 = btoa(String.fromCharCode(...new Uint8Array(digest)));
        return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      // Start OAuth flow
      async function startAuth() {
        if (CLIENT_ID === 'YOUR_CLIENT_ID_HERE') {
          showError('Please set your CLIENT_ID. Register your app at: https://www.inaturalist.org/oauth/applications/new');
          return;
        }

        // Generate PKCE values
        const codeVerifier = generateRandomString(64);
        const codeChallenge = await generateCodeChallenge(codeVerifier);

        // Store code verifier for later
        sessionStorage.setItem('code_verifier', codeVerifier);

        // Build authorization URL
        const params = new URLSearchParams({
          client_id: CLIENT_ID,
          redirect_uri: REDIRECT_URI,
          response_type: 'code',
          code_challenge: codeChallenge,
          code_challenge_method: 'S256'
        });

        // Redirect to iNaturalist
        window.location.href = `${AUTH_URL}?${params.toString()}`;
      }

      // Exchange code for token
      async function exchangeCodeForToken(code) {
        const codeVerifier = sessionStorage.getItem('code_verifier');

        if (!codeVerifier) {
          showError('Code verifier not found. Please try logging in again.');
          return;
        }

        try {
          loginButton.disabled = true;
          loginButton.textContent = 'Authenticating...';

          const response = await fetch(TOKEN_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
              client_id: CLIENT_ID,
              code: code,
              redirect_uri: REDIRECT_URI,
              grant_type: 'authorization_code',
              code_verifier: codeVerifier
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error_description || 'Failed to exchange code for token');
          }

          const tokenData = await response.json();

          // Store token
          localStorage.setItem('inat_access_token', tokenData.access_token);

          // Clear code verifier
          sessionStorage.removeItem('code_verifier');

          // Clear URL parameters
          window.history.replaceState({}, document.title, window.location.pathname);

          // Show success and fetch user info
          showSuccess();
          await fetchUserInfo(tokenData.access_token);

        } catch (error) {
          console.error('Token exchange error:', error);
          showError('Authentication failed: ' + error.message);
          loginButton.disabled = false;
          loginButton.innerHTML = '<span>Login with iNaturalist</span>';
        }
      }

      // Get JWT token from OAuth token
      async function getJwtToken(oauthToken) {
        const response = await fetch('https://www.inaturalist.org/users/api_token', {
          headers: {
            'Authorization': `Bearer ${oauthToken}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to get JWT token');
        }

        const data = await response.json();
        return data.api_token;
      }

      // Fetch authenticated user info
      async function fetchUserInfo(oauthToken) {
        try {
          // First get JWT token for API access
          const jwtToken = await getJwtToken(oauthToken);

          // Store JWT token for future API calls
          localStorage.setItem('inat_jwt_token', jwtToken);

          const response = await fetch('https://api.inaturalist.org/v1/users/me', {
            headers: {
              'Authorization': jwtToken
            }
          });

          if (!response.ok) {
            throw new Error('Failed to fetch user info');
          }

          const data = await response.json();
          const user = data.results[0];

          // Display user info
          document.getElementById('userAvatar').src = user.icon || 'logo.png';
          document.getElementById('userName').textContent = user.name || user.login;
          document.getElementById('userLogin').textContent = '@' + user.login;
          document.getElementById('tokenInfo').textContent = 'JWT: ' + jwtToken.substring(0, 30) + '...';

          userInfo.classList.add('show');
          loginButton.style.display = 'none';

          // Fetch updates
          await fetchUpdates(jwtToken);

        } catch (error) {
          console.error('Error fetching user info:', error);
          showError('Could not fetch user info: ' + error.message);
        }
      }

      // Fetch user's recent updates
      async function fetchUpdates(jwtToken) {
        const updatesSection = document.getElementById('updatesSection');
        const updatesList = document.getElementById('updatesList');

        updatesSection.classList.add('show');
        updatesList.innerHTML = '<div class="updates-loading">Loading updates...</div>';

        try {
          const response = await fetch('https://api.inaturalist.org/v1/observations/updates?per_page=200&observations_by=owner', {
            headers: {
              'Authorization': jwtToken
            }
          });

          if (!response.ok) {
            throw new Error('Failed to fetch updates');
          }

          const data = await response.json();
          console.log('Updates response:', data);

          if (!data.results || data.results.length === 0) {
            updatesList.innerHTML = '<div class="no-updates">No recent updates</div>';
            return;
          }

          // Get unique observation IDs to fetch photos
          const obsIds = [...new Set(data.results.map(u => u.resource_id))].join(',');

          // Fetch observation details for photos
          const obsResponse = await fetch(`https://api.inaturalist.org/v1/observations?id=${obsIds}&per_page=200`, {
            headers: { 'Authorization': jwtToken }
          });
          const obsData = await obsResponse.json();

          // Create map of observation photos
          const obsMap = {};
          obsData.results?.forEach(obs => {
            obsMap[obs.id] = obs;
          });

          updatesList.innerHTML = data.results.map(update => {
            const obsId = update.resource_id;
            const obs = obsMap[obsId] || {};
            const notifType = update.notifier_type || 'Activity';

            // Handle both Identification and Comment types
            const isComment = notifType === 'Comment';
            const identification = update.identification || {};
            const comment = update.comment || {};

            // Get user info based on type
            const user = isComment ? (comment.user || {}) : (identification.user || {});
            const fromUser = user.login || 'Someone';
            const userIcon = user.icon_url || user.icon || 'logo.png';

            // Get taxon info (only for identifications)
            const taxon = identification.taxon || {};
            const category = identification.category || '';

            // Get photo from observation
            const obsPhoto = obs.photos?.[0]?.url?.replace('square', 'small') ||
                            taxon.default_photo?.medium_url || 'logo.png';

            // Species info from observation or identification
            const obsTaxon = obs.taxon || {};
            const commonName = taxon.preferred_common_name || obsTaxon.preferred_common_name || '';
            const scientificName = taxon.name || obsTaxon.name || obs.species_guess || 'Unknown';

            // Action text and extra info based on type
            let actionText = 'added an identification';
            let extraInfo = '';
            if (isComment) {
              actionText = 'added a comment';
              if (comment.body) {
                const truncatedBody = comment.body.length > 100
                  ? comment.body.substring(0, 100) + '...'
                  : comment.body;
                extraInfo = `<div class="update-comment-body">"${truncatedBody}"</div>`;
              }
            }

            // Format time
            const time = new Date(update.created_at);
            const timeAgo = getTimeAgo(time);

            // Category label (only for identifications)
            const categoryLabels = {
              'improving': 'Improving',
              'supporting': 'Supporting',
              'leading': 'Leading',
              'maverick': 'Maverick'
            };
            const categoryLabel = isComment ? '' : (categoryLabels[category] || '');

            // Quality grade
            const qualityGrade = obs.quality_grade || 'needs_id';
            const qualityLabels = {
              'research': 'Research Grade',
              'needs_id': 'Needs ID',
              'casual': 'Casual'
            };
            const qualityLabel = qualityLabels[qualityGrade] || qualityGrade;

            const obsUrl = `https://www.inaturalist.org/observations/${obsId}`;

            return `
              <a href="${obsUrl}" target="_blank" class="update-item">
                <img src="${obsPhoto}" alt="" class="update-photo" onerror="this.src='logo.png'">
                <div class="update-content">
                  <div class="update-header">
                    <img src="${userIcon}" alt="" class="update-user-avatar" onerror="this.src='logo.png'">
                    <div class="update-action">
                      <strong>${fromUser}</strong> ${actionText}
                    </div>
                  </div>
                  <div class="update-species">${commonName || scientificName}</div>
                  ${commonName && !isComment ? `<div class="update-scientific">${scientificName}</div>` : ''}
                  ${extraInfo}
                  <div class="update-meta">
                    ${categoryLabel ? `<span class="update-category ${category}">${categoryLabel}</span>` : ''}
                    <span class="update-quality ${qualityGrade}">${qualityLabel}</span>
                    <span class="update-meta-item">${timeAgo}</span>
                  </div>
                </div>
              </a>
            `;
          }).join('');

        } catch (error) {
          console.error('Error fetching updates:', error);
          updatesList.innerHTML = '<div class="no-updates">Could not load updates</div>';
        }
      }

      function formatNotificationType(type) {
        const types = {
          'identification': 'New ID',
          'comment': 'Comment',
          'mention': 'Mention',
          'activity': 'Activity',
          'created_observation': 'Observation'
        };
        return types[type] || type.replace(/_/g, ' ');
      }

      function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);

        const intervals = {
          year: 31536000,
          month: 2592000,
          week: 604800,
          day: 86400,
          hour: 3600,
          minute: 60
        };

        for (const [unit, secondsInUnit] of Object.entries(intervals)) {
          const interval = Math.floor(seconds / secondsInUnit);
          if (interval >= 1) {
            return `${interval} ${unit}${interval > 1 ? 's' : ''} ago`;
          }
        }
        return 'just now';
      }

      // Logout
      function logout() {
        localStorage.removeItem('inat_access_token');
        localStorage.removeItem('inat_jwt_token');
        userInfo.classList.remove('show');
        successMessage.classList.remove('show');
        document.getElementById('updatesSection').classList.remove('show');
        loginButton.style.display = 'inline-flex';
        loginButton.disabled = false;
        loginButton.innerHTML = '<span>Login with iNaturalist</span>';
      }

      // UI Helpers
      function showSuccess() {
        successMessage.classList.add('show');
        errorMessage.classList.remove('show');
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add('show');
        successMessage.classList.remove('show');
      }

      // Event Listeners
      loginButton.addEventListener('click', startAuth);
      document.getElementById('logoutButton').addEventListener('click', logout);

      // Check for OAuth callback
      window.addEventListener('load', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');

        if (error) {
          showError('Authorization denied: ' + (urlParams.get('error_description') || error));
          window.history.replaceState({}, document.title, window.location.pathname);
          return;
        }

        if (code) {
          await exchangeCodeForToken(code);
          return;
        }

        // Check for existing token
        const existingJwt = localStorage.getItem('inat_jwt_token');
        const existingOauth = localStorage.getItem('inat_access_token');

        if (existingJwt) {
          // Use existing JWT directly
          showSuccess();
          await fetchUserInfoWithJwt(existingJwt);
        } else if (existingOauth) {
          // Get new JWT from OAuth token
          showSuccess();
          await fetchUserInfo(existingOauth);
        }
      });

      // Fetch user info with existing JWT
      async function fetchUserInfoWithJwt(jwtToken) {
        try {
          const response = await fetch('https://api.inaturalist.org/v1/users/me', {
            headers: {
              'Authorization': jwtToken
            }
          });

          if (!response.ok) {
            // JWT might be expired, clear and ask to login again
            localStorage.removeItem('inat_jwt_token');
            localStorage.removeItem('inat_access_token');
            throw new Error('Session expired. Please login again.');
          }

          const data = await response.json();
          const user = data.results[0];

          document.getElementById('userAvatar').src = user.icon || 'logo.png';
          document.getElementById('userName').textContent = user.name || user.login;
          document.getElementById('userLogin').textContent = '@' + user.login;
          document.getElementById('tokenInfo').textContent = 'JWT: ' + jwtToken.substring(0, 30) + '...';

          userInfo.classList.add('show');
          loginButton.style.display = 'none';

          // Fetch updates
          await fetchUpdates(jwtToken);

        } catch (error) {
          console.error('Error fetching user info:', error);
          showError(error.message);
        }
      }
    </script>
    <script src="dark-mode.js"></script>
  </body>
</html>
