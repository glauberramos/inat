<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iNaturalist Project Search - Find Projects by Location</title>
    <link rel="icon" href="favicon.ico" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#74ac00" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <link rel="apple-touch-icon" href="logo.png" />
    <link rel="canonical" href="https://glauberramos.github.io/inat/project-search.html" />
    <meta
      name="description"
      content="Search and discover iNaturalist projects near any location. Find bioblitzes, citizen science initiatives, and local nature projects to join and contribute your observations."
    />
    <meta name="keywords" content="iNaturalist projects, project search, bioblitz, citizen science projects, local nature projects, biodiversity projects, community science" />
    <meta property="og:title" content="iNaturalist Project Search - Find Projects by Location" />
    <meta property="og:description" content="Discover iNaturalist projects near any location. Find bioblitzes and citizen science initiatives to join!" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://glauberramos.github.io/inat/project-search.html" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="iNaturalist Project Search" />
    <meta name="twitter:description" content="Discover iNaturalist projects near any location. Find bioblitzes and citizen science initiatives to join!" />
    <meta name="robots" content="index, follow" />
    <meta name="author" content="Glauber Ramos" />
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "iNaturalist Project Search",
      "description": "Search and discover iNaturalist projects near any location. Find bioblitzes, citizen science initiatives, and local nature projects to join.",
      "url": "https://glauberramos.github.io/inat/project-search.html",
      "applicationCategory": "UtilitiesApplication",
      "operatingSystem": "Web",
      "author": {
        "@type": "Person",
        "name": "Glauber Ramos"
      }
    }
    </script>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="dark-mode.css" />
    <style>
      #projectsContainer {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 16px;
        margin-top: 16px;
      }

      .project-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        max-width: 260px;
        width: 100%;
      }

      .project-card-image-container {
        position: relative;
        width: 100%;
        height: 200px;
        border-radius: 8px 8px 0 0;
        overflow: visible;
      }

      .project-card-header-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #f5f5f5;
        border-radius: 8px 8px 0 0;
      }

      .project-card-icon {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 4px solid white;
        object-fit: cover;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .umbrella-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #3498db;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        z-index: 10;
      }
      .project-card-content {
        padding: 16px;
        flex: 1;
      }
      .project-card h3 {
        margin: 0 0 8px 0;
        color: #333;
        font-size: 16px;
      }
      .project-card p {
        margin: 4px 0;
        color: #666;
        font-size: 14px;
      }
      .project-card a {
        color: #74ac00;
        text-decoration: none;
      }
      .project-card a:hover {
        text-decoration: underline;
      }
      .location-info {
        background: #f5f5f5;
        padding: 12px;
        border-radius: 4px;
        margin: 16px 0;
        display: none;
      }
      .location-info.show {
        display: block;
      }
      .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 12px;
        border-radius: 4px;
        margin: 16px 0;
        display: none;
      }
      .error-message.show {
        display: block;
      }
      .pagination {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        margin: 24px 0;
        display: none;
      }
      .pagination.show {
        display: flex;
      }
      .pagination button {
        padding: 10px 20px;
        border-radius: 5px;
        border: none;
        background-color: #3498db;
        color: white;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.3s;
      }
      .pagination button:hover:not(:disabled) {
        background-color: #2980b9;
      }
      .pagination button:disabled {
        background-color: #bdc3c7;
        opacity: 0.6;
        cursor: not-allowed;
      }
      .pagination .page-info {
        font-size: 14px;
        color: #666;
      }
      .autocomplete-item {
        padding: 6px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      .autocomplete-item:last-child {
        border-bottom: none;
      }
      .autocomplete-item:hover {
        background-color: #f5f5f5;
      }
      .checkbox-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: #333;
        cursor: pointer;
        white-space: nowrap;
      }
      .checkbox-label input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      @media (max-width: 1400px) {
        #projectsContainer {
          grid-template-columns: repeat(4, 1fr);
        }
      }
      @media (max-width: 1200px) {
        #projectsContainer {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      @media (max-width: 900px) {
        #projectsContainer {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 600px) {
        #projectsContainer {
          grid-template-columns: 1fr;
        }

        .project-card {
          max-width: 100%;
        }
      }

      @media (max-width: 768px) {
        .search-container {
          flex-direction: column;
          align-items: stretch;
        }

        .search-container input,
        .search-container select,
        .search-container button {
          width: 100%;
        }

        .place-search-container {
          width: 100%;
        }

        .checkbox-label {
          justify-content: center;
          padding: 5px 0;
        }

        .pagination {
          flex-wrap: wrap;
        }
      }

      @media (max-width: 480px) {
        body {
          padding-top: 60px;
        }

        .back-button {
          font-size: 0.8rem !important;
          padding: 8px 12px !important;
          top: 10px !important;
          left: 10px !important;
        }

        h1 {
          font-size: 1.4rem;
        }

        .description {
          font-size: 0.9rem;
        }

        .project-card-image-container {
          height: 150px;
        }

        .project-card-icon {
          width: 60px;
          height: 60px;
        }

        .project-card h3 {
          font-size: 14px;
        }

        .project-card p {
          font-size: 13px;
        }

        .umbrella-badge {
          font-size: 10px;
          padding: 3px 6px;
        }
      }

      /* Hide default pipeback widget */
      #pipeback-widget-container,
      .pipeback-launcher-frame {
        display: none !important;
      }

      /* Custom feedback button */
      .feedback-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #74ac00;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 999;
        transition: all 0.3s;
      }

      .feedback-button:hover {
        background: #5d8a00;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      }
    </style>
  </head>
  <body>
    <a
      href="/inat"
      class="back-button"
      style="
        position: fixed;
        top: 20px;
        left: 20px;
        background: #74ac00;
        color: white;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 10px 16px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
      "
      onmouseover="this.style.background='#659900'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.2)'"
      onmouseout="this.style.background='#74ac00'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.15)'"
    >
      <span style="font-size: 1rem">←</span> More iNat tools
    </a>
    <div class="container">
      <header>
        <div class="header-content">
          <div class="title-container">
            <img src="logo.png" alt="iNaturalist Logo" class="logo" />
            <h1>iNaturalist Project Search</h1>
          </div>
          <p class="description">
            Search for iNaturalist projects by name and/or location
          </p>
        </div>
        <div class="search-container">
          <input
            type="text"
            id="nameInput"
            placeholder="Search by project name..."
            autocomplete="off"
          />
          <div class="place-search-container">
            <input
              type="text"
              id="locationInput"
              placeholder="Search for a location..."
              autocomplete="off"
            />
            <div id="locationAutocomplete" class="place-autocomplete"></div>
          </div>
          <select id="orderBySelect" class="limit-select">
            <option value="">No order</option>
            <option value="recent_posts">Recent posts</option>
            <option value="created">Created</option>
            <option value="updated">Updated</option>
            <option value="distance">Distance</option>
            <option value="featured">Featured</option>
            <option value="members">Members</option>
          </select>
          <label class="checkbox-label">
            <input type="checkbox" id="umbrellaOnly" />
            Umbrella projects only
          </label>
          <button id="searchButton">Search Projects</button>
        </div>
        <div class="location-info" id="locationInfo"></div>
        <div class="error-message" id="errorMessage"></div>
      </header>

      <main>
        <div class="loading" id="loading" style="display: none">Loading...</div>
        <div id="projectsContainer"></div>
        <div class="pagination" id="pagination">
          <button id="prevPage">Previous</button>
          <span class="page-info" id="pageInfo">Page 1 of 1</span>
          <button id="nextPage">Next</button>
        </div>
      </main>
    </div>
    <script src="location-autocomplete.js"></script>
    <script>
      let selectedLocation = null;
      let currentPage = 1;
      let totalPages = 1;
      let totalResults = 0;
      const perPage = 200;

      const nameInput = document.getElementById("nameInput");
      const locationInput = document.getElementById("locationInput");
      const locationAutocomplete = document.getElementById(
        "locationAutocomplete"
      );
      const orderBySelect = document.getElementById("orderBySelect");
      const umbrellaOnlyCheckbox = document.getElementById("umbrellaOnly");
      const searchButton = document.getElementById("searchButton");
      const loading = document.getElementById("loading");
      const projectsContainer = document.getElementById("projectsContainer");
      const locationInfo = document.getElementById("locationInfo");
      const errorMessage = document.getElementById("errorMessage");
      const pagination = document.getElementById("pagination");
      const pageInfo = document.getElementById("pageInfo");
      const prevPageBtn = document.getElementById("prevPage");
      const nextPageBtn = document.getElementById("nextPage");

      // Initialize location autocomplete
      const locationAutocompleteInstance = initLocationAutocomplete(
        locationInput,
        locationAutocomplete,
        null,
        {
          persistToStorage: true,
          loadFromStorage: true,
          suggestionClass: 'autocomplete-item',
          nameClass: 'autocomplete-name',
          infoClass: 'autocomplete-info',
          onSelect: function(place) {
            selectedLocation = { id: place.id, name: place.name };
          },
          onClear: function() {
            selectedLocation = null;
          }
        }
      );

      // Initialize selectedLocation from saved place
      const savedPlace = locationAutocompleteInstance.getSelectedPlace();
      if (savedPlace) {
        selectedLocation = { id: savedPlace.id, name: savedPlace.name };
      }

      // Fetch projects for a specific page
      async function fetchProjects(page = 1) {
        const nameQuery = nameInput.value.trim();

        if (!selectedLocation && !nameQuery) {
          showError("Please enter a project name or select a location");
          return;
        }

        // Hide error and show loading
        hideError();
        loading.style.display = "block";
        projectsContainer.innerHTML = "";
        pagination.classList.remove("show");

        try {
          // Build URL with parameters using v2 API
          const fields = "title,description,icon,header_image_url,is_umbrella,user_id,created_at,user_ids,project_type,rule_preferences.field,rule_preferences.value,search_parameters.field,search_parameters.value,admins.user.login,admins.user.id";
          let url = `https://api.inaturalist.org/v2/projects?per_page=${perPage}&page=${page}&fields=${encodeURIComponent(fields)}`;

          if (nameQuery) {
            url += `&q=${encodeURIComponent(nameQuery)}`;
          }

          if (selectedLocation) {
            url += `&place_id=${selectedLocation.id}`;
          }

          const orderBy = orderBySelect.value;
          if (orderBy && orderBy !== "members") {
            url += `&order_by=${orderBy}`;
          }

          if (umbrellaOnlyCheckbox.checked) {
            url += `&type=umbrella`;
          }

          const response = await fetch(url);
          const data = await response.json();

          // Client-side sort by member count
          if (orderBy === "members" && data.results) {
            data.results.sort((a, b) => (b.user_ids?.length || 0) - (a.user_ids?.length || 0));
          }

          loading.style.display = "none";

          if (data.results && data.results.length > 0) {
            // Update pagination state
            currentPage = page;
            totalResults = data.total_results || 0;
            totalPages = Math.ceil(totalResults / perPage);

            // Display projects
            projectsContainer.innerHTML = data.results
              .map((project) => {
                // Get header image and icon
                let headerImageUrl =
                  "https://www.inaturalist.org/assets/logo-small.png";
                let iconUrl = "";

                if (project.header_image_url) {
                  headerImageUrl = project.header_image_url.replace(
                    "/medium.",
                    "/large."
                  );
                } else if (project.icon) {
                  headerImageUrl = project.icon
                    .replace("/span.", "/large.")
                    .replace("/medium.", "/large.");
                }

                if (project.icon) {
                  iconUrl = project.icon
                    .replace("/span.", "/medium.")
                    .replace("/large.", "/medium.");
                }

                // Helper function to escape HTML
                const escapeHtml = (text) => {
                  const div = document.createElement("div");
                  div.textContent = text;
                  return div.innerHTML;
                };

                // Get member count
                let membersHtml = "";
                const memberCount = project.user_ids ? project.user_ids.length : 0;
                if (memberCount > 0) {
                  membersHtml = `<p><strong>Members:</strong> ${memberCount.toLocaleString()}</p>`;
                }

                // Get creator information
                let creatorHtml = "";
                if (project.user_id) {
                  const username =
                    project.admins?.[0]?.user?.login ||
                    `user ${project.user_id}`;
                  creatorHtml = `<p><strong>Created by:</strong> <a href="https://www.inaturalist.org/people/${
                    project.user_id
                  }" target="_blank">${escapeHtml(username)}</a></p>`;
                }

                // Format created date
                let createdDateHtml = "";
                if (project.created_at) {
                  const date = new Date(project.created_at);
                  const formattedDate = date.toLocaleDateString("en-US", {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                  });
                  createdDateHtml = `<p><strong>Created:</strong> ${formattedDate}</p>`;
                }

                // Check for date range in rule_preferences
                let dateRangeHtml = "";
                if (
                  project.rule_preferences &&
                  Array.isArray(project.rule_preferences)
                ) {
                  const d1Rule = project.rule_preferences.find(
                    (rule) => rule.field === "d1"
                  );
                  const d2Rule = project.rule_preferences.find(
                    (rule) => rule.field === "d2"
                  );

                  if (d1Rule && d2Rule && d1Rule.value && d2Rule.value) {
                    // Parse dates without timezone conversion
                    const formatDate = (dateStr) => {
                      const [year, month, day] = dateStr.split("-");
                      const monthNames = [
                        "Jan",
                        "Feb",
                        "Mar",
                        "Apr",
                        "May",
                        "Jun",
                        "Jul",
                        "Aug",
                        "Sep",
                        "Oct",
                        "Nov",
                        "Dec",
                      ];
                      return `${monthNames[parseInt(month) - 1]} ${parseInt(
                        day
                      )}, ${year}`;
                    };

                    const formattedStart = formatDate(d1Rule.value);
                    const formattedEnd = formatDate(d2Rule.value);
                    dateRangeHtml = `<p><strong>From </strong> ${formattedStart} <strong>to</strong> ${formattedEnd}</p>`;
                  }
                }

                // Check for observed_on in search_parameters
                let observedOnHtml = "";
                if (
                  project.search_parameters &&
                  Array.isArray(project.search_parameters)
                ) {
                  const observedOnParam = project.search_parameters.find(
                    (param) => param.field === "observed_on"
                  );

                  if (observedOnParam && observedOnParam.value) {
                    // Parse and format the date
                    const formatDate = (dateStr) => {
                      const [year, month, day] = dateStr.split("-");
                      const monthNames = [
                        "Jan",
                        "Feb",
                        "Mar",
                        "Apr",
                        "May",
                        "Jun",
                        "Jul",
                        "Aug",
                        "Sep",
                        "Oct",
                        "Nov",
                        "Dec",
                      ];
                      return `${monthNames[parseInt(month) - 1]} ${parseInt(
                        day
                      )}, ${year}`;
                    };

                    const formattedDate = formatDate(observedOnParam.value);
                    observedOnHtml = `<p><strong>Date:</strong> ${formattedDate}</p>`;
                  }
                }

                return `
                <div class="project-card">
                  <div class="project-card-image-container">
                    ${
                      project.is_umbrella
                        ? `<div class="umbrella-badge">☂ Umbrella</div>`
                        : ""
                    }
                    <img class="project-card-header-image" src="${headerImageUrl}" alt="${escapeHtml(
                  project.title
                )}" onerror="this.src='https://www.inaturalist.org/assets/logo-small.png'">
                    ${
                      iconUrl
                        ? `<img class="project-card-icon" src="${iconUrl}" alt="${escapeHtml(
                            project.title
                          )} icon" onerror="this.style.display='none'">`
                        : ""
                    }
                  </div>
                  <div class="project-card-content">
                    <h3>
                      <a href="https://www.inaturalist.org/projects/${
                        project.id
                      }" target="_blank">
                        ${escapeHtml(project.title)}
                      </a>
                    </h3>
                    ${
                      project.description
                        ? `<p>${escapeHtml(
                            project.description.substring(0, 150)
                          )}${
                            project.description.length > 150 ? "..." : ""
                          }</p>`
                        : ""
                    }
                    ${membersHtml}
                    ${creatorHtml}
                    ${createdDateHtml}
                    ${dateRangeHtml}
                    ${observedOnHtml}
                  </div>
                </div>
              `;
              })
              .join("");

            // Update pagination UI
            if (totalResults > perPage) {
              pagination.classList.add("show");
              pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
              prevPageBtn.disabled = currentPage === 1;
              nextPageBtn.disabled = currentPage === totalPages;
            }

            // Update location info
            let searchInfo = [];
            if (nameQuery) {
              searchInfo.push(`<strong>Name:</strong> "${nameQuery}"`);
            }
            if (selectedLocation) {
              searchInfo.push(
                `<strong>Location:</strong> ${selectedLocation.name}`
              );
            }
            searchInfo.push(`<strong>Total Projects:</strong> ${totalResults}`);

            locationInfo.innerHTML = searchInfo.join("<br>");
            locationInfo.classList.add("show");
          } else {
            let noResultsMsg = "No projects found";
            if (nameQuery && selectedLocation) {
              noResultsMsg += " matching your name and location criteria.";
            } else if (nameQuery) {
              noResultsMsg += " matching your name criteria.";
            } else {
              noResultsMsg += " in this location.";
            }
            projectsContainer.innerHTML = `<p style="text-align: center; color: #666; grid-column: 1 / -1;">${noResultsMsg}</p>`;

            let searchInfo = [];
            if (nameQuery) {
              searchInfo.push(`<strong>Name:</strong> "${nameQuery}"`);
            }
            if (selectedLocation) {
              searchInfo.push(
                `<strong>Location:</strong> ${selectedLocation.name}`
              );
            }

            locationInfo.innerHTML = searchInfo.join("<br>");
            locationInfo.classList.add("show");
          }

          // Scroll to top
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch (error) {
          console.error("Error fetching projects:", error);
          loading.style.display = "none";
          showError("Error fetching projects. Please try again.");
        }
      }

      // Search for projects (reset to page 1)
      searchButton.addEventListener("click", () => {
        currentPage = 1;
        fetchProjects(1);
      });

      // Pagination controls
      prevPageBtn.addEventListener("click", () => {
        if (currentPage > 1) {
          fetchProjects(currentPage - 1);
        }
      });

      nextPageBtn.addEventListener("click", () => {
        if (currentPage < totalPages) {
          fetchProjects(currentPage + 1);
        }
      });

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add("show");
        locationInfo.classList.remove("show");
      }

      function hideError() {
        errorMessage.classList.remove("show");
      }
    </script>
    <script
      defer
      data-domain="glauberramos.github.io/inat"
      src="https://plausible.io/js/script.js"
    ></script>
    <button class="feedback-button" id="feedbackBtn">Send feedback</button>
    <script type="text/javascript">
      window.$pipeback = [];
      window.PIPEBACK_ID = "a069b910-4aef-4233-99cc-913e7fb30fb5";
      (function () {
        d = document;
        s = d.createElement("script");
        s.src = "https://widget.pipeback.com/l.js";
        s.async = 1;
        d.getElementsByTagName("head")[0].appendChild(s);
      })();

      // Feedback button toggle
      let feedbackOpen = false;
      document.getElementById("feedbackBtn").addEventListener("click", () => {
        if (feedbackOpen) {
          $pipeback.close();
          feedbackOpen = false;
        } else {
          $pipeback.open();
          feedbackOpen = true;
        }
      });
    </script>
    <script src="dark-mode.js"></script>
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
      }
    </script>
  </body>
</html>
