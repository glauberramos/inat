<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Search iNaturalist</title>
    <link rel="icon" href="favicon.ico" />
    <meta
      name="description"
      content="Search for iNaturalist projects by location"
    />
    <link rel="stylesheet" href="styles.css" />
    <style>
      #projectsContainer {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 16px;
        margin-top: 16px;
      }

      .project-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        max-width: 260px;
        width: 100%;
      }

      .project-card-image-container {
        position: relative;
        width: 100%;
        height: 200px;
        border-radius: 8px 8px 0 0;
        overflow: visible;
      }

      .project-card-header-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #f5f5f5;
        border-radius: 8px 8px 0 0;
      }

      .project-card-icon {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 4px solid white;
        object-fit: cover;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .umbrella-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #3498db;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        z-index: 10;
      }
      .project-card-content {
        padding: 16px;
        flex: 1;
      }
      .project-card h3 {
        margin: 0 0 8px 0;
        color: #333;
        font-size: 16px;
      }
      .project-card p {
        margin: 4px 0;
        color: #666;
        font-size: 14px;
      }
      .project-card a {
        color: #74ac00;
        text-decoration: none;
      }
      .project-card a:hover {
        text-decoration: underline;
      }
      .location-info {
        background: #f5f5f5;
        padding: 12px;
        border-radius: 4px;
        margin: 16px 0;
        display: none;
      }
      .location-info.show {
        display: block;
      }
      .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 12px;
        border-radius: 4px;
        margin: 16px 0;
        display: none;
      }
      .error-message.show {
        display: block;
      }
      .pagination {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        margin: 24px 0;
        display: none;
      }
      .pagination.show {
        display: flex;
      }
      .pagination button {
        padding: 10px 20px;
        border-radius: 5px;
        border: none;
        background-color: #3498db;
        color: white;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.3s;
      }
      .pagination button:hover:not(:disabled) {
        background-color: #2980b9;
      }
      .pagination button:disabled {
        background-color: #bdc3c7;
        opacity: 0.6;
        cursor: not-allowed;
      }
      .pagination .page-info {
        font-size: 14px;
        color: #666;
      }
      .autocomplete-item {
        padding: 6px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      .autocomplete-item:last-child {
        border-bottom: none;
      }
      .autocomplete-item:hover {
        background-color: #f5f5f5;
      }

      @media (max-width: 1400px) {
        #projectsContainer {
          grid-template-columns: repeat(4, 1fr);
        }
      }
      @media (max-width: 1200px) {
        #projectsContainer {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      @media (max-width: 900px) {
        #projectsContainer {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 600px) {
        #projectsContainer {
          grid-template-columns: 1fr;
        }

        .project-card {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <a
      href="/inat"
      style="
        position: fixed;
        top: 20px;
        left: 20px;
        background: #74ac00;
        color: white;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 10px 16px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
      "
      onmouseover="this.style.background='#659900'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.2)'"
      onmouseout="this.style.background='#74ac00'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.15)'"
    >
      <span style="font-size: 1rem">←</span> More iNat tools
    </a>
    <div class="container">
      <header>
        <div class="header-content">
          <div class="title-container">
            <img src="logo.png" alt="SpeciesDex Logo" class="logo" />
            <h1>iNat Project Search</h1>
          </div>
          <p class="description">
            Search for iNaturalist projects by name and/or location
          </p>
        </div>
        <div class="search-container">
          <input
            type="text"
            id="nameInput"
            placeholder="Search by project name..."
            autocomplete="off"
          />
          <div class="place-search-container">
            <input
              type="text"
              id="locationInput"
              placeholder="Search for a location..."
              autocomplete="off"
            />
            <div id="locationAutocomplete" class="place-autocomplete"></div>
          </div>
          <select id="orderBySelect" class="limit-select">
            <option value="">No order</option>
            <option value="recent_posts">Recent posts</option>
            <option value="created">Created</option>
            <option value="updated">Updated</option>
            <option value="distance">Distance</option>
            <option value="featured">Featured</option>
          </select>
          <button id="searchButton">Search Projects</button>
        </div>
        <div class="location-info" id="locationInfo"></div>
        <div class="error-message" id="errorMessage"></div>
      </header>

      <main>
        <div class="loading" id="loading" style="display: none">Loading...</div>
        <div id="projectsContainer"></div>
        <div class="pagination" id="pagination">
          <button id="prevPage">Previous</button>
          <span class="page-info" id="pageInfo">Page 1 of 1</span>
          <button id="nextPage">Next</button>
        </div>
      </main>
    </div>
    <script>
      let selectedLocation = null;
      let searchTimeout = null;
      let currentPage = 1;
      let totalPages = 1;
      let totalResults = 0;
      const perPage = 100;

      const nameInput = document.getElementById("nameInput");
      const locationInput = document.getElementById("locationInput");
      const locationAutocomplete = document.getElementById(
        "locationAutocomplete"
      );
      const orderBySelect = document.getElementById("orderBySelect");
      const searchButton = document.getElementById("searchButton");
      const loading = document.getElementById("loading");
      const projectsContainer = document.getElementById("projectsContainer");
      const locationInfo = document.getElementById("locationInfo");
      const errorMessage = document.getElementById("errorMessage");
      const pagination = document.getElementById("pagination");
      const pageInfo = document.getElementById("pageInfo");
      const prevPageBtn = document.getElementById("prevPage");
      const nextPageBtn = document.getElementById("nextPage");

      // Search for locations using iNaturalist autocomplete
      locationInput.addEventListener("input", (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();

        if (query.length < 2) {
          locationAutocomplete.innerHTML = "";
          locationAutocomplete.style.display = "none";
          return;
        }

        searchTimeout = setTimeout(async () => {
          try {
            const response = await fetch(
              `https://api.inaturalist.org/v1/places/autocomplete?q=${encodeURIComponent(
                query
              )}`
            );
            const data = await response.json();

            if (data.results && data.results.length > 0) {
              locationAutocomplete.innerHTML = data.results
                .slice(0, 10)
                .map(
                  (place) => `
                  <div class="autocomplete-item" data-id="${place.id}" data-lat="${place.location}" data-name="${place.display_name}">
                    ${place.display_name}
                  </div>
                `
                )
                .join("");
              locationAutocomplete.style.display = "block";

              // Add click handlers to autocomplete items
              document
                .querySelectorAll(".autocomplete-item")
                .forEach((item) => {
                  item.addEventListener("click", () => {
                    selectedLocation = {
                      id: item.dataset.id,
                      name: item.dataset.name,
                    };
                    locationInput.value = item.dataset.name;
                    locationAutocomplete.innerHTML = "";
                    locationAutocomplete.style.display = "none";
                  });
                });
            } else {
              locationAutocomplete.innerHTML = "";
              locationAutocomplete.style.display = "none";
            }
          } catch (error) {
            console.error("Error fetching locations:", error);
            locationAutocomplete.innerHTML = "";
            locationAutocomplete.style.display = "none";
          }
        }, 300);
      });

      // Hide autocomplete when clicking outside
      document.addEventListener("click", (e) => {
        if (
          !locationInput.contains(e.target) &&
          !locationAutocomplete.contains(e.target)
        ) {
          locationAutocomplete.style.display = "none";
        }
      });

      // Fetch projects for a specific page
      async function fetchProjects(page = 1) {
        const nameQuery = nameInput.value.trim();

        if (!selectedLocation && !nameQuery) {
          showError("Please enter a project name or select a location");
          return;
        }

        // Hide error and show loading
        hideError();
        loading.style.display = "block";
        projectsContainer.innerHTML = "";
        pagination.classList.remove("show");

        try {
          // Build URL with parameters
          let url = `https://api.inaturalist.org/v1/projects?per_page=${perPage}&page=${page}`;

          if (nameQuery) {
            url += `&q=${encodeURIComponent(nameQuery)}`;
          }

          if (selectedLocation) {
            url += `&place_id=${selectedLocation.id}`;
          }

          const orderBy = orderBySelect.value;
          if (orderBy) {
            url += `&order_by=${orderBy}`;
          }

          console.log("Fetching projects with URL:", url);
          console.log("Order by value:", orderBy);

          const response = await fetch(url);
          const data = await response.json();

          loading.style.display = "none";

          if (data.results && data.results.length > 0) {
            // Update pagination state
            currentPage = page;
            totalResults = data.total_results || 0;
            totalPages = Math.ceil(totalResults / perPage);

            // Display projects
            projectsContainer.innerHTML = data.results
              .map((project) => {
                // Get header image and icon
                let headerImageUrl =
                  "https://www.inaturalist.org/assets/logo-small.png";
                let iconUrl = "";

                if (project.header_image_url) {
                  headerImageUrl = project.header_image_url.replace(
                    "/medium.",
                    "/large."
                  );
                } else if (project.icon) {
                  headerImageUrl = project.icon
                    .replace("/span.", "/large.")
                    .replace("/medium.", "/large.");
                }

                if (project.icon) {
                  iconUrl = project.icon
                    .replace("/span.", "/medium.")
                    .replace("/large.", "/medium.");
                }

                // Helper function to escape HTML
                const escapeHtml = (text) => {
                  const div = document.createElement("div");
                  div.textContent = text;
                  return div.innerHTML;
                };

                // Get creator information
                let creatorHtml = "";
                if (project.user_id) {
                  const username =
                    project.user?.login ||
                    project.admins?.[0]?.user?.login ||
                    `user ${project.user_id}`;
                  creatorHtml = `<p><strong>Created by:</strong> <a href="https://www.inaturalist.org/people/${
                    project.user_id
                  }" target="_blank">${escapeHtml(username)}</a></p>`;
                }

                // Format created date
                let createdDateHtml = "";
                if (project.created_at) {
                  const date = new Date(project.created_at);
                  const formattedDate = date.toLocaleDateString("en-US", {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                  });
                  createdDateHtml = `<p><strong>Created:</strong> ${formattedDate}</p>`;
                }

                // Check for date range in rule_preferences
                let dateRangeHtml = "";
                if (
                  project.rule_preferences &&
                  Array.isArray(project.rule_preferences)
                ) {
                  const d1Rule = project.rule_preferences.find(
                    (rule) => rule.field === "d1"
                  );
                  const d2Rule = project.rule_preferences.find(
                    (rule) => rule.field === "d2"
                  );

                  if (d1Rule && d2Rule && d1Rule.value && d2Rule.value) {
                    // Parse dates without timezone conversion
                    const formatDate = (dateStr) => {
                      const [year, month, day] = dateStr.split("-");
                      const monthNames = [
                        "Jan",
                        "Feb",
                        "Mar",
                        "Apr",
                        "May",
                        "Jun",
                        "Jul",
                        "Aug",
                        "Sep",
                        "Oct",
                        "Nov",
                        "Dec",
                      ];
                      return `${monthNames[parseInt(month) - 1]} ${parseInt(
                        day
                      )}, ${year}`;
                    };

                    const formattedStart = formatDate(d1Rule.value);
                    const formattedEnd = formatDate(d2Rule.value);
                    dateRangeHtml = `<p><strong>From </strong> ${formattedStart} <strong>to</strong> ${formattedEnd}</p>`;
                  }
                }

                // Check for observed_on in search_parameters
                let observedOnHtml = "";
                if (
                  project.search_parameters &&
                  Array.isArray(project.search_parameters)
                ) {
                  const observedOnParam = project.search_parameters.find(
                    (param) => param.field === "observed_on"
                  );

                  if (observedOnParam && observedOnParam.value) {
                    // Parse and format the date
                    const formatDate = (dateStr) => {
                      const [year, month, day] = dateStr.split("-");
                      const monthNames = [
                        "Jan",
                        "Feb",
                        "Mar",
                        "Apr",
                        "May",
                        "Jun",
                        "Jul",
                        "Aug",
                        "Sep",
                        "Oct",
                        "Nov",
                        "Dec",
                      ];
                      return `${monthNames[parseInt(month) - 1]} ${parseInt(
                        day
                      )}, ${year}`;
                    };

                    const formattedDate = formatDate(observedOnParam.value);
                    observedOnHtml = `<p><strong>Date:</strong> ${formattedDate}</p>`;
                  }
                }

                return `
                <div class="project-card">
                  <div class="project-card-image-container">
                    ${
                      project.is_umbrella
                        ? `<div class="umbrella-badge">☂ Umbrella</div>`
                        : ""
                    }
                    <img class="project-card-header-image" src="${headerImageUrl}" alt="${escapeHtml(
                  project.title
                )}" onerror="this.src='https://www.inaturalist.org/assets/logo-small.png'">
                    ${
                      iconUrl
                        ? `<img class="project-card-icon" src="${iconUrl}" alt="${escapeHtml(
                            project.title
                          )} icon" onerror="this.style.display='none'">`
                        : ""
                    }
                  </div>
                  <div class="project-card-content">
                    <h3>
                      <a href="https://www.inaturalist.org/projects/${
                        project.id
                      }" target="_blank">
                        ${escapeHtml(project.title)}
                      </a>
                    </h3>
                    ${
                      project.description
                        ? `<p>${escapeHtml(
                            project.description.substring(0, 150)
                          )}${
                            project.description.length > 150 ? "..." : ""
                          }</p>`
                        : ""
                    }
                    ${creatorHtml}
                    ${createdDateHtml}
                    ${dateRangeHtml}
                    ${observedOnHtml}
                  </div>
                </div>
              `;
              })
              .join("");

            // Update pagination UI
            if (totalResults > perPage) {
              pagination.classList.add("show");
              pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
              prevPageBtn.disabled = currentPage === 1;
              nextPageBtn.disabled = currentPage === totalPages;
            }

            // Update location info
            let searchInfo = [];
            if (nameQuery) {
              searchInfo.push(`<strong>Name:</strong> "${nameQuery}"`);
            }
            if (selectedLocation) {
              searchInfo.push(
                `<strong>Location:</strong> ${selectedLocation.name}`
              );
            }
            searchInfo.push(`<strong>Total Projects:</strong> ${totalResults}`);

            locationInfo.innerHTML = searchInfo.join("<br>");
            locationInfo.classList.add("show");
          } else {
            let noResultsMsg = "No projects found";
            if (nameQuery && selectedLocation) {
              noResultsMsg += " matching your name and location criteria.";
            } else if (nameQuery) {
              noResultsMsg += " matching your name criteria.";
            } else {
              noResultsMsg += " in this location.";
            }
            projectsContainer.innerHTML = `<p style="text-align: center; color: #666; grid-column: 1 / -1;">${noResultsMsg}</p>`;

            let searchInfo = [];
            if (nameQuery) {
              searchInfo.push(`<strong>Name:</strong> "${nameQuery}"`);
            }
            if (selectedLocation) {
              searchInfo.push(
                `<strong>Location:</strong> ${selectedLocation.name}`
              );
            }

            locationInfo.innerHTML = searchInfo.join("<br>");
            locationInfo.classList.add("show");
          }

          // Scroll to top
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch (error) {
          console.error("Error fetching projects:", error);
          loading.style.display = "none";
          showError("Error fetching projects. Please try again.");
        }
      }

      // Search for projects (reset to page 1)
      searchButton.addEventListener("click", () => {
        currentPage = 1;
        fetchProjects(1);
      });

      // Pagination controls
      prevPageBtn.addEventListener("click", () => {
        if (currentPage > 1) {
          fetchProjects(currentPage - 1);
        }
      });

      nextPageBtn.addEventListener("click", () => {
        if (currentPage < totalPages) {
          fetchProjects(currentPage + 1);
        }
      });

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add("show");
        locationInfo.classList.remove("show");
      }

      function hideError() {
        errorMessage.classList.remove("show");
      }
    </script>
    <script
      defer
      data-domain="glauberramos.github.io/inat"
      src="https://plausible.io/js/script.js"
    ></script>
    <footer
      style="text-align: center; padding: 40px 20px 20px; margin-top: 40px"
    >
      <img
        src="powered_by.png"
        alt="Powered By"
        style="max-width: 300px; height: auto; opacity: 0.8"
      />
    </footer>
  </body>
</html>
