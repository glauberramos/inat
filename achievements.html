<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Achievements - iNaturalist</title>
    <link rel="icon" href="favicon.ico" />
    <meta
      name="description"
      content="View iNaturalist user achievements and milestones"
    />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="achievements.css" />
  </head>
  <body>
    <button
      class="dark-mode-toggle"
      id="darkModeToggle"
      title="Toggle dark mode"
    >
      üåô
    </button>
    <a
      href="/inat"
      style="
        position: fixed;
        top: 20px;
        left: 20px;
        background: #74ac00;
        color: white;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 10px 16px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
      "
      onmouseover="this.style.background='#659900'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.2)'"
      onmouseout="this.style.background='#74ac00'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.15)'"
    >
      <span style="font-size: 1rem">‚Üê</span> More iNat tools
    </a>
    <div class="container">
      <header>
        <div class="header-content">
          <div class="title-container">
            <img src="logo.png" alt="iNaturalist Logo" class="logo" />
            <h1>Achievements</h1>
          </div>
          <p class="description">
            Track your iNaturalist milestones and achievements
          </p>
        </div>
        <div class="error-message" id="errorMessage"></div>
      </header>

      <main>
        <div class="summary-card" id="summaryCard">
          <div class="summary-search">
            <div class="username-search-container" style="width: 300px">
              <input
                type="text"
                id="usernameInput"
                placeholder="Enter iNaturalist username..."
                autocomplete="off"
                style="width: 100%"
              />
              <div
                id="usernameAutocomplete"
                class="username-autocomplete"
              ></div>
            </div>
            <button id="loadButton">Load</button>
            <span
              id="achievementsProgress"
              class="achievements-progress"
            ></span>
          </div>
        </div>

        <div class="loading" id="loading" style="display: none">
          Loading... <span id="loadingCount"></span>
        </div>
        <div id="achievementsContainer"></div>
      </main>
    </div>
    <script>
      const usernameInput = document.getElementById("usernameInput");
      const usernameAutocomplete = document.getElementById(
        "usernameAutocomplete"
      );
      const loadButton = document.getElementById("loadButton");
      const loading = document.getElementById("loading");
      const achievementsContainer = document.getElementById(
        "achievementsContainer"
      );
      const errorMessage = document.getElementById("errorMessage");
      const achievementsProgress = document.getElementById(
        "achievementsProgress"
      );

      let searchTimeout = null;
      let currentUsername = "";

      // All iconic taxons in iNaturalist with emojis
      const ICONIC_TAXONS = {
        Plantae: { emoji: "üåø", name: "Plants", id: 47126 },
        Fungi: { emoji: "üçÑ", name: "Fungi", id: 47170 },
        Chromista: { emoji: "üü§", name: "Chromista", id: 48222 },
        Protozoa: { emoji: "ü¶†", name: "Protozoa", id: 47686 },
        Animalia: { emoji: "üêæ", name: "Animals", id: 1 },
        Mollusca: { emoji: "üêå", name: "Mollusks", id: 47115 },
        Arachnida: { emoji: "üï∑Ô∏è", name: "Arachnids", id: 47119 },
        Insecta: { emoji: "ü¶ã", name: "Insects", id: 47158 },
        Actinopterygii: { emoji: "üêü", name: "Fish", id: 47178 },
        Amphibia: { emoji: "üê∏", name: "Amphibians", id: 20978 },
        Reptilia: { emoji: "ü¶é", name: "Reptiles", id: 26036 },
        Aves: { emoji: "üê¶", name: "Birds", id: 3 },
        Mammalia: { emoji: "ü¶å", name: "Mammals", id: 40151 },
      };

      // Specialty taxon IDs for achievements
      const SPECIALTY_TAXONS = {
        lepidoptera: 47157, // Butterflies & Moths
        raptors: [71261, 67570, 19350, 559244], // Accipitriformes, Falconiformes, Strigiformes, Cathartiformes
        coleoptera: 47208, // Beetles
        anthophila: 630955, // Bees
        cetacea: 152871, // Whales & Dolphins
        anura: 20979, // Frogs & Toads
        serpentes: 85553, // Snakes
        testudines: 39532, // Turtles & Tortoises
        rodentia: 43698, // Rodents
        primates: 43367, // Primates
      };

      // Load saved username from localStorage (shared with other tools)
      const savedUsername = localStorage.getItem("inatUsername");
      if (savedUsername) {
        usernameInput.value = savedUsername;
        loadUserData();
      }

      // Username autocomplete
      usernameInput.addEventListener("input", (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();

        if (query.length < 2) {
          usernameAutocomplete.innerHTML = "";
          usernameAutocomplete.style.display = "none";
          return;
        }

        searchTimeout = setTimeout(async () => {
          try {
            const response = await fetch(
              `https://api.inaturalist.org/v1/users/autocomplete?q=${encodeURIComponent(
                query
              )}`
            );
            const data = await response.json();

            if (data.results && data.results.length > 0) {
              usernameAutocomplete.innerHTML = data.results
                .slice(0, 10)
                .map((user) => {
                  const obsCount = user.observations_count || 0;
                  return `
                    <div class="username-suggestion" data-login="${user.login}">
                      <div class="username-name">${user.login}</div>
                      <div class="username-info">${obsCount.toLocaleString()} observations</div>
                    </div>
                  `;
                })
                .join("");
              usernameAutocomplete.style.display = "block";

              document
                .querySelectorAll(".username-suggestion")
                .forEach((item) => {
                  item.addEventListener("click", () => {
                    usernameInput.value = item.dataset.login;
                    usernameAutocomplete.innerHTML = "";
                    usernameAutocomplete.style.display = "none";
                    loadUserData();
                  });
                });
            } else {
              usernameAutocomplete.innerHTML = "";
              usernameAutocomplete.style.display = "none";
            }
          } catch (error) {
            console.error("Error fetching users:", error);
            usernameAutocomplete.innerHTML = "";
            usernameAutocomplete.style.display = "none";
          }
        }, 300);
      });

      // Hide autocomplete when clicking outside
      document.addEventListener("click", (e) => {
        if (
          !usernameInput.contains(e.target) &&
          !usernameAutocomplete.contains(e.target)
        ) {
          usernameAutocomplete.style.display = "none";
        }
      });

      // Load button handler
      loadButton.addEventListener("click", () => {
        loadUserData();
      });

      // Enter key handler
      usernameInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          loadUserData();
        }
      });

      async function loadUserData() {
        const username = usernameInput.value.trim();

        if (!username) {
          showError("Please enter a username");
          return;
        }

        hideError();
        loading.style.display = "block";
        achievementsContainer.innerHTML = "";
        achievementsProgress.classList.remove("show");
        document.getElementById("loadingCount").textContent = "";

        try {
          // Get user info
          const userResponse = await fetch(
            `https://api.inaturalist.org/v1/users/autocomplete?q=${encodeURIComponent(
              username
            )}`
          );
          const userData = await userResponse.json();

          if (!userData.results || userData.results.length === 0) {
            loading.style.display = "none";
            showError("User not found");
            return;
          }

          const user = userData.results[0];
          const userId = user.id;

          // Save username to localStorage (shared with other tools)
          localStorage.setItem("inatUsername", username);
          currentUsername = username;

          const identificationsCount = user.identifications_count || 0;
          const userCreatedAt = user.created_at || null;

          // Fetch identification categories (for others' observations)
          const idCategoriesResponse = await fetch(
            `https://api.inaturalist.org/v1/identifications/categories?own_observation=false&user_id=${userId}`
          );
          const idCategoriesData = await idCategoriesResponse.json();
          const idCategories = {};
          if (idCategoriesData.results) {
            idCategoriesData.results.forEach((item) => {
              idCategories[item.category] = item.count;
            });
          }

          // Fetch identification species counts (for others' observations)
          const idSpeciesResponse = await fetch(
            `https://api.inaturalist.org/v1/identifications/species_counts?own_observation=false&user_id=${userId}&per_page=1`
          );
          const idSpeciesData = await idSpeciesResponse.json();
          // Find max count for any single species
          let maxSpeciesIdCount = 0;
          let maxSpeciesName = "";
          if (idSpeciesData.results && idSpeciesData.results.length > 0) {
            maxSpeciesIdCount = idSpeciesData.results[0].count;
            const taxon = idSpeciesData.results[0].taxon;
            maxSpeciesName = taxon.preferred_common_name || taxon.name || "";
          }

          // Fetch Research Grade observations count
          const researchGradePromise = fetch(
            `https://api.inaturalist.org/v1/observations/quality_grades?user_id=${userId}&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch observation histogram for date-based achievements
          const histogramPromise = fetch(
            `https://api.inaturalist.org/v2/observations/histogram?interval=day&d1=1900-01-01&user_id=${userId}&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch favorite observations for favorite achievements
          const favoriteObservationsPromise = loadFavoriteObservations(userId);

          // Fetch all species counts for rarity achievements
          const loadingCount = document.getElementById("loadingCount");
          const allSpeciesCountsPromise = loadAllSpeciesCounts(
            userId,
            (percentage) => {
              loadingCount.textContent = `${percentage}%`;
            }
          );

          // Fetch threatened species counts separately for conservation achievements
          const threatenedSpeciesCountsPromise =
            loadThreatenedSpeciesCounts(userId);

          // Fetch introduced species counts separately
          const introducedSpeciesCountsPromise =
            loadIntroducedSpeciesCounts(userId);

          // Fetch endemic species counts separately
          const endemicSpeciesCountsPromise = loadEndemicSpeciesCounts(userId);

          // Fetch sound observations count
          const soundObservationsPromise = fetch(
            `https://api.inaturalist.org/v1/observations?user_id=${userId}&sounds=true&per_page=1&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch sound+photo observations count
          const soundPhotoObservationsPromise = fetch(
            `https://api.inaturalist.org/v1/observations?user_id=${userId}&sounds=true&photos=true&per_page=1&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch projects the user is a member of
          const projectsPromise = fetch(
            `https://api.inaturalist.org/v1/projects?member_id=${userId}&per_page=1`
          ).then((res) => res.json());

          // Fetch early bird observations (5-7 AM)
          const earlyBirdPromise = fetch(
            `https://api.inaturalist.org/v2/observations?user_id=${userId}&per_page=0&verifiable=true&captive=false&hour=5,6,7`
          ).then((res) => res.json());

          // Fetch night owl observations (9 PM - 4 AM)
          const nightOwlPromise = fetch(
            `https://api.inaturalist.org/v2/observations?user_id=${userId}&per_page=0&verifiable=true&captive=false&hour=21,22,23,0,1,2,3,4`
          ).then((res) => res.json());

          // Fetch "From the Archives" observations (RG observations from before user joined)
          const userJoinDate = userCreatedAt
            ? new Date(userCreatedAt).toISOString().split("T")[0]
            : null;
          const fromArchivesPromise = userJoinDate
            ? fetch(
                `https://api.inaturalist.org/v2/observations?user_id=${userId}&per_page=0&verifiable=true&captive=false&quality_grade=research&d2=${userJoinDate}`
              ).then((res) => res.json())
            : Promise.resolve({ total_results: 0 });

          // Fetch "Old Timer" observations (RG observations from before iNaturalist existed - March 2008)
          const oldTimerPromise = fetch(
            `https://api.inaturalist.org/v2/observations?user_id=${userId}&per_page=0&verifiable=true&captive=false&quality_grade=research&d2=2008-03-01`
          ).then((res) => res.json());

          // Fetch continent observations for World Traveler achievement
          const continentPlaceIds = {
            Europe: 67952,
            "South America": 97389,
            "North America": 9853,
            Asia: 97395,
            Oceania: 97393,
            Africa: 91708,
          };
          const continentPromises = Object.entries(continentPlaceIds).map(
            ([continent, placeId]) =>
              fetch(
                `https://api.inaturalist.org/v2/observations?user_id=${userId}&per_page=0&verifiable=true&captive=false&place_id=${placeId}`
              )
                .then((res) => res.json())
                .then((data) => ({
                  continent,
                  hasObservations: data.total_results > 0,
                }))
          );


          const [
            researchGradeData,
            histogramData,
            favoriteObservations,
            allSpeciesCounts,
            threatenedSpeciesCounts,
            introducedSpeciesCounts,
            endemicSpeciesCounts,
            soundObservationsData,
            soundPhotoObservationsData,
            projectsData,
            earlyBirdData,
            nightOwlData,
            fromArchivesData,
            oldTimerData,
            continentResults,
          ] = await Promise.all([
            researchGradePromise,
            histogramPromise,
            favoriteObservationsPromise,
            allSpeciesCountsPromise,
            threatenedSpeciesCountsPromise,
            introducedSpeciesCountsPromise,
            endemicSpeciesCountsPromise,
            soundObservationsPromise,
            soundPhotoObservationsPromise,
            projectsPromise,
            earlyBirdPromise,
            nightOwlPromise,
            fromArchivesPromise,
            oldTimerPromise,
            Promise.all(continentPromises),
          ]);

          // Calculate sound-related achievements
          const soundObservationsCount =
            soundObservationsData.total_results || 0;
          const soundPhotoObservationsCount =
            soundPhotoObservationsData.total_results || 0;

          // Get annotated observations count from user data
          const annotatedObservationsCount =
            userData.results[0].annotated_observations_count || 0;

          // Get projects count
          const projectsCount = projectsData.total_results || 0;

          // Get early bird and night owl counts
          const earlyBirdCount = earlyBirdData.total_results || 0;
          const nightOwlCount = nightOwlData.total_results || 0;

          // Get from archives and old timer counts
          const fromArchivesCount = fromArchivesData.total_results || 0;
          const oldTimerCount = oldTimerData.total_results || 0;

          // Calculate observed continents from continent API calls
          const observedContinents = new Set(
            continentResults
              .filter((r) => r.hasObservations)
              .map((r) => r.continent)
          );

          // Calculate observed world grid squares using UTF Grid API (single call)
          // Fetch grid at zoom level 0 (entire world in one tile)
          const worldGridData = await fetch(
            `https://api.inaturalist.org/v1/grid/0/0/0.grid.json?user_id=${userId}`
          ).then(res => res.json()).catch(() => null);

          // Parse UTF Grid to find cells with observations
          // Use the data object keys - each key represents an observed cell
          const displayGridSize = 32;
          const observedGridCells = new Map();

          if (worldGridData && worldGridData.grid && worldGridData.keys && worldGridData.data) {
            const utfGridSize = worldGridData.grid.length; // 64
            const groupSize = utfGridSize / displayGridSize; // 2

            // Get keys that have data (these are the observed cells)
            const dataKeys = Object.keys(worldGridData.data);

            // For each data key, find its position in the grid
            dataKeys.forEach(dataKey => {
              const keyIndex = worldGridData.keys.indexOf(dataKey);
              if (keyIndex <= 0) return; // Skip if not found or index 0 (no data)

              // Find where this key appears in the grid
              for (let row = 0; row < utfGridSize; row++) {
                const gridRow = worldGridData.grid[row];
                if (!gridRow) continue;

                for (let col = 0; col < gridRow.length; col++) {
                  let id = gridRow.charCodeAt(col);
                  if (id >= 93) id--;
                  if (id >= 35) id--;
                  id -= 32;

                  if (id === keyIndex) {
                    const displayRow = Math.floor(row / groupSize);
                    const displayCol = Math.floor(col / groupSize);
                    const cellKey = displayRow + "," + displayCol;
                    observedGridCells.set(cellKey, true);
                    return; // Found position for this key, move to next
                  }
                }
              }
            });
          }

          const observedGridSquares = observedGridCells.size;

          // Calculate iconic taxon species counts from allSpeciesCounts
          const iconicTaxonSpeciesCounts = {};
          Object.keys(ICONIC_TAXONS).forEach((taxonName) => {
            iconicTaxonSpeciesCounts[taxonName] = 0;
          });

          // Calculate all species-based counts from allSpeciesCounts
          let lepidopteraSpeciesCount = 0;
          let raptorSpeciesCount = 0;
          let beetleSpeciesCount = 0;
          let beeSpeciesCount = 0;
          let cetaceaSpeciesCount = 0;
          let anuraSpeciesCount = 0;
          let serpentesSpeciesCount = 0;
          let turtleSpeciesCount = 0;
          let rodentiaSpeciesCount = 0;
          let primatesSpeciesCount = 0;

          allSpeciesCounts.forEach((species) => {
            const iconicTaxonName = species.taxon?.iconic_taxon_name;
            if (
              iconicTaxonName &&
              iconicTaxonName in iconicTaxonSpeciesCounts
            ) {
              iconicTaxonSpeciesCounts[iconicTaxonName]++;
            }

            // Check ancestor_ids for specialty taxons
            const ancestorIds = species.taxon?.ancestor_ids || [];
            const taxonId = species.taxon?.id;

            if (
              ancestorIds.includes(SPECIALTY_TAXONS.lepidoptera) ||
              taxonId === SPECIALTY_TAXONS.lepidoptera
            ) {
              lepidopteraSpeciesCount++;
            }
            if (
              SPECIALTY_TAXONS.raptors.some(
                (id) => ancestorIds.includes(id) || taxonId === id
              )
            ) {
              raptorSpeciesCount++;
            }
            if (
              ancestorIds.includes(SPECIALTY_TAXONS.coleoptera) ||
              taxonId === SPECIALTY_TAXONS.coleoptera
            ) {
              beetleSpeciesCount++;
            }
            if (
              ancestorIds.includes(SPECIALTY_TAXONS.anthophila) ||
              taxonId === SPECIALTY_TAXONS.anthophila
            ) {
              beeSpeciesCount++;
            }
            if (
              ancestorIds.includes(SPECIALTY_TAXONS.cetacea) ||
              taxonId === SPECIALTY_TAXONS.cetacea
            ) {
              cetaceaSpeciesCount++;
            }
            if (
              ancestorIds.includes(SPECIALTY_TAXONS.anura) ||
              taxonId === SPECIALTY_TAXONS.anura
            ) {
              anuraSpeciesCount++;
            }
            if (
              ancestorIds.includes(SPECIALTY_TAXONS.serpentes) ||
              taxonId === SPECIALTY_TAXONS.serpentes
            ) {
              serpentesSpeciesCount++;
            }
            if (
              ancestorIds.includes(SPECIALTY_TAXONS.testudines) ||
              taxonId === SPECIALTY_TAXONS.testudines
            ) {
              turtleSpeciesCount++;
            }
            if (
              ancestorIds.includes(SPECIALTY_TAXONS.rodentia) ||
              taxonId === SPECIALTY_TAXONS.rodentia
            ) {
              rodentiaSpeciesCount++;
            }
            if (
              ancestorIds.includes(SPECIALTY_TAXONS.primates) ||
              taxonId === SPECIALTY_TAXONS.primates
            ) {
              primatesSpeciesCount++;
            }
          });

          // Add animal iconic taxon counts to Animalia
          const animalIconicTaxons = [
            "Mollusca",
            "Arachnida",
            "Insecta",
            "Actinopterygii",
            "Amphibia",
            "Reptilia",
            "Aves",
            "Mammalia",
          ];
          animalIconicTaxons.forEach((taxon) => {
            iconicTaxonSpeciesCounts["Animalia"] +=
              iconicTaxonSpeciesCounts[taxon] || 0;
          });

          // Threatened species count comes from the separate API call
          const threatenedSpeciesCount = threatenedSpeciesCounts.length;

          // Introduced species count comes from the separate API call
          const introducedSpeciesCount = introducedSpeciesCounts;

          // Endemic species count comes from the separate API call
          const endemicSpeciesCount = endemicSpeciesCounts;
          // Extract research grade count from quality_grades response
          const researchGradeResult = researchGradeData.results?.find(
            (r) => r.quality_grade === "research"
          );
          const researchGradeCount = researchGradeResult?.count || 0;

          // Get species count from allSpeciesCounts
          const speciesCount = allSpeciesCounts.length;

          // Get initial observation count from user data
          const observationsTotalResults = user.observations_count || 0;

          // Calculate histogram-based achievements
          const histogramAchievements = calculateHistogramAchievements(
            histogramData.results?.day || {}
          );

          // Calculate conservation status achievements from threatened species
          const conservationStatusAchievements = {
            nearThreatened10:
              calculateStatusSpeciesAchievementFromSpeciesCounts(
                threatenedSpeciesCounts,
                ["nt", "near_threatened", "near threatened"],
                10
              ),
            vulnerable10: calculateStatusSpeciesAchievementFromSpeciesCounts(
              threatenedSpeciesCounts,
              ["vu", "vulnerable"],
              10
            ),
            endangered5: calculateStatusSpeciesAchievementFromSpeciesCounts(
              threatenedSpeciesCounts,
              ["en", "endangered"],
              5
            ),
            criticallyEndangered1:
              calculateStatusSpeciesAchievementFromSpeciesCounts(
                threatenedSpeciesCounts,
                ["cr", "critically_endangered", "critically endangered"],
                1
              ),
            extinctInWild1: calculateStatusSpeciesAchievementFromSpeciesCounts(
              threatenedSpeciesCounts,
              ["ew", "extinct_in_the_wild", "extinct in the wild"],
              1
            ),
            extinct1: calculateStatusSpeciesAchievementFromSpeciesCounts(
              threatenedSpeciesCounts,
              ["ex", "extinct"],
              1
            ),
          };

          // Calculate favorite achievements from favorite observations
          const favoriteAchievements =
            calculateFavoriteAchievements(favoriteObservations);

          // Calculate rarity achievements from species counts
          const rarityAchievements = {
            onlyObserver:
              calculateOnlyObserverAchievementFromSpeciesCounts(
                allSpeciesCounts
              ),
            rareSpecies100: calculateRareSpeciesAchievementFromSpeciesCounts(
              allSpeciesCounts,
              100,
              10
            ),
            rareSpecies10: calculateRareSpeciesAchievementFromSpeciesCounts(
              allSpeciesCounts,
              10,
              10
            ),
            rareSpecies10_50: calculateRareSpeciesAchievementFromSpeciesCounts(
              allSpeciesCounts,
              10,
              50
            ),
            rareSpecies100_100: calculateRareSpeciesAchievementFromSpeciesCounts(
              allSpeciesCounts,
              100,
              100
            ),
          };

          // Display achievements immediately with available data (without observations)
          loading.style.display = "none";
          let result = renderAchievements(
            observationsTotalResults,
            speciesCount,
            identificationsCount,
            idCategories,
            maxSpeciesIdCount,
            maxSpeciesName,
            userCreatedAt,
            iconicTaxonSpeciesCounts,
            lepidopteraSpeciesCount,
            raptorSpeciesCount,
            beetleSpeciesCount,
            beeSpeciesCount,
            cetaceaSpeciesCount,
            anuraSpeciesCount,
            serpentesSpeciesCount,
            turtleSpeciesCount,
            rodentiaSpeciesCount,
            primatesSpeciesCount,
            threatenedSpeciesCount,
            introducedSpeciesCount,
            endemicSpeciesCount,
            researchGradeCount,
            histogramAchievements,
            conservationStatusAchievements,
            favoriteAchievements,
            rarityAchievements,
            soundObservationsCount,
            soundPhotoObservationsCount,
            annotatedObservationsCount,
            projectsCount,
            earlyBirdCount,
            nightOwlCount,
            observedContinents,
            fromArchivesCount,
            oldTimerCount,
            observedGridCells,
            observedGridSquares
          );
          achievementsContainer.innerHTML = result.html;

          // Update achievements progress
          let percentage = Math.round(
            (result.completedCount / result.totalAchievements) * 100
          );
          achievementsProgress.textContent = `${result.completedCount}/${result.totalAchievements} (${percentage}%)`;
          achievementsProgress.classList.add("show");
        } catch (error) {
          console.error("Error fetching user data:", error);
          loading.style.display = "none";
          showError("Error fetching data. Please try again.");
        }
      }

      async function loadAllSpeciesCounts(userId, onProgress) {
        const perPage = 500;
        let page = 1;
        let allSpecies = [];
        let hasMore = true;
        let totalResults = 0;

        while (hasMore) {
          const url = `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&per_page=${perPage}&page=${page}&captive=false&verifiable=true`;
          const response = await fetch(url);
          const data = await response.json();

          if (!data.results || data.results.length === 0) {
            hasMore = false;
          } else {
            allSpecies = allSpecies.concat(data.results);
            totalResults = data.total_results;

            // Update progress
            if (onProgress && totalResults > 0) {
              const percentage = Math.round(
                (allSpecies.length / totalResults) * 100
              );
              onProgress(percentage);
            }

            // Check if there are more pages
            if (allSpecies.length >= data.total_results) {
              hasMore = false;
            } else {
              page++;
            }
          }
        }

        return allSpecies;
      }

      async function loadThreatenedSpeciesCounts(userId) {
        const perPage = 500;
        let page = 1;
        let allSpecies = [];
        let hasMore = true;

        while (hasMore) {
          const url = `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&per_page=${perPage}&page=${page}&captive=false&verifiable=true&threatened=true`;
          const response = await fetch(url);
          const data = await response.json();

          if (!data.results || data.results.length === 0) {
            hasMore = false;
          } else {
            allSpecies = allSpecies.concat(data.results);

            if (allSpecies.length >= data.total_results) {
              hasMore = false;
            } else {
              page++;
            }
          }
        }

        return allSpecies;
      }

      async function loadIntroducedSpeciesCounts(userId) {
        const url = `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&per_page=0&captive=false&verifiable=true&introduced=true`;
        const response = await fetch(url);
        const data = await response.json();
        return data.total_results || 0;
      }

      async function loadEndemicSpeciesCounts(userId) {
        const url = `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&per_page=0&captive=false&verifiable=true&endemic=true`;
        const response = await fetch(url);
        const data = await response.json();
        return data.total_results || 0;
      }

      async function loadFavoriteObservations(userId) {
        // Fetch observations ordered by votes/faves - only first page needed
        const url = `https://api.inaturalist.org/v2/observations?per_page=200&order_by=votes&order=desc&user_id=${userId}&fields=id,faves_count`;
        const response = await fetch(url);
        const data = await response.json();
        return data.results || [];
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add("show");
      }

      function hideError() {
        errorMessage.classList.remove("show");
      }

      function calculateStatusSpeciesAchievementFromSpeciesCounts(
        threatenedSpecies,
        statusCodes,
        goal
      ) {
        const species = new Set();
        const taxonIds = [];

        threatenedSpecies.forEach((speciesData) => {
          if (
            speciesData.taxon &&
            speciesData.taxon.id &&
            speciesData.taxon.conservation_status &&
            speciesData.taxon.conservation_status.status
          ) {
            const status =
              speciesData.taxon.conservation_status.status.toLowerCase();
            if (statusCodes.includes(status)) {
              species.add(speciesData.taxon.id);
              taxonIds.push(speciesData.taxon.id);
            }
          }
        });

        return {
          current: species.size,
          total: goal,
          completed: species.size >= goal,
          taxonIds: taxonIds,
        };
      }

      function calculateFavoriteAchievements(favoriteObservations) {
        // Count observations with at least 1 favorite
        const obsWithFaves = favoriteObservations.filter(
          (obs) => obs.faves_count > 0
        );

        // Find max faves count and the observation IDs with 10+ faves
        let maxFaves = 0;
        const obsWithTenPlusFaves = [];

        favoriteObservations.forEach((obs) => {
          if (obs.faves_count > maxFaves) {
            maxFaves = obs.faves_count;
          }
          if (obs.faves_count >= 10) {
            obsWithTenPlusFaves.push(obs.id);
          }
        });

        return {
          favorited10: {
            current: obsWithFaves.length,
            total: 10,
            completed: obsWithFaves.length >= 10,
          },
          mostFavorited10: {
            current: obsWithTenPlusFaves.length,
            total: 1,
            completed: obsWithTenPlusFaves.length >= 1,
            obsIds: obsWithTenPlusFaves,
          },
        };
      }

      function calculateCountAchievement(current, goal) {
        return {
          current: current,
          total: goal,
          completed: current >= goal,
        };
      }

      const CONTINENTS = {
        "North America": "ü¶Ö",
        "South America": "ü¶ú",
        Europe: "ü¶å",
        Africa: "ü¶Å",
        Asia: "üêº",
        Oceania: "ü¶ò",
        // Antarctica: "üêß", // TODO: Add back when we have place_id
      };

      const SEASONS = {
        Spring: "üå∏",
        Summer: "‚òÄÔ∏è",
        Fall: "üçÇ",
        Winter: "‚ùÑÔ∏è",
      };

      const MONTHS = {
        Jan: "Jan",
        Feb: "Feb",
        Mar: "Mar",
        Apr: "Apr",
        May: "May",
        Jun: "Jun",
        Jul: "Jul",
        Aug: "Aug",
        Sep: "Sep",
        Oct: "Oct",
        Nov: "Nov",
        Dec: "Dec",
      };

      function calculateRareSpeciesAchievementFromSpeciesCounts(
        speciesCounts,
        maxObsCount,
        goal
      ) {
        const rareSpecies = [];

        speciesCounts.forEach((species) => {
          if (
            species.taxon &&
            species.taxon.id &&
            species.taxon.observations_count
          ) {
            if (species.taxon.observations_count < maxObsCount) {
              rareSpecies.push(species.taxon.id);
            }
          }
        });

        return {
          current: rareSpecies.length,
          total: goal,
          completed: rareSpecies.length >= goal,
          taxonIds: rareSpecies,
        };
      }

      function calculateOnlyObserverAchievementFromSpeciesCounts(
        speciesCounts
      ) {
        // Find species where user's count equals the global observation count
        // (meaning user is the only observer)
        const onlyObserverTaxonIds = [];

        speciesCounts.forEach((species) => {
          if (
            species.taxon &&
            species.taxon.id &&
            species.taxon.observations_count
          ) {
            // User's observation count for this species
            const userCount = species.count;
            // Global observation count for this species
            const globalCount = species.taxon.observations_count;

            if (userCount === globalCount && globalCount > 0) {
              onlyObserverTaxonIds.push(species.taxon.id);
            }
          }
        });

        return {
          current: onlyObserverTaxonIds.length,
          total: 1,
          taxonIds: onlyObserverTaxonIds,
          completed: onlyObserverTaxonIds.length >= 1,
        };
      }

      function calculateIconicTaxonAchievementFromCounts(
        iconicTaxonSpeciesCounts
      ) {
        const observedTaxons = new Set();
        const taxonKeys = Object.keys(ICONIC_TAXONS);

        // Check which iconic taxons have at least 1 species observed
        taxonKeys.forEach((taxon) => {
          const count = iconicTaxonSpeciesCounts[taxon] || 0;
          if (count > 0) {
            observedTaxons.add(taxon);
          }
        });

        return {
          current: observedTaxons.size,
          total: taxonKeys.length,
          completed: observedTaxons.size === taxonKeys.length,
          observedTaxons: observedTaxons,
        };
      }

      function calculateAccountAgeAchievement(createdAt, years) {
        if (!createdAt) {
          return { current: 0, total: 1, completed: false };
        }

        const now = new Date();
        const created = new Date(createdAt);
        const diffYears = (now - created) / (1000 * 60 * 60 * 24 * 365);

        return {
          current: diffYears >= years ? 1 : 0,
          total: 1,
          completed: diffYears >= years,
        };
      }

      function calculateHistogramAchievements(histogram) {
        // histogram is an object like: { "2020-01-01": 5, "2020-01-02": 3, ... }
        // Filter out dates with 0 observations
        const dates = Object.keys(histogram)
          .filter((date) => histogram[date] > 0)
          .sort();

        if (dates.length === 0) {
          return {
            veteran2: { current: 0, total: 1, completed: false },
            veteran5: { current: 0, total: 1, completed: false },
            veteran10: { current: 0, total: 1, completed: false },
            streak7: { current: 0, total: 7, completed: false },
            streak30: { current: 0, total: 30, completed: false },
            streak60: { current: 0, total: 60, completed: false },
            newYear: { current: 0, total: 10, completed: false },
            obsDay10: { current: 0, total: 10, completed: false },
            obsDay100: { current: 0, total: 100, completed: false },
            monthsAchievement: {
              current: 0,
              total: 12,
              completed: false,
              observedMonths: new Set(),
            },
            seasonsAchievement: {
              current: 0,
              total: 4,
              completed: false,
              observedSeasons: new Set(),
            },
            weekendWarrior: { current: 0, total: 25, completed: false },
            observationDays100: { current: 0, total: 100, completed: false },
            observationDays500: { current: 0, total: 500, completed: false },
          };
        }

        // Veteran achievements (observations from X years ago)
        const now = new Date();
        const cutoff2Years = new Date(
          now.getFullYear() - 2,
          now.getMonth(),
          now.getDate()
        );
        const cutoff5Years = new Date(
          now.getFullYear() - 5,
          now.getMonth(),
          now.getDate()
        );
        const cutoff10Years = new Date(
          now.getFullYear() - 10,
          now.getMonth(),
          now.getDate()
        );

        let veteran2Count = 0;
        let veteran5Count = 0;
        let veteran10Count = 0;

        dates.forEach((dateStr) => {
          const date = new Date(dateStr);
          const count = histogram[dateStr];
          if (date <= cutoff2Years) veteran2Count += count;
          if (date <= cutoff5Years) veteran5Count += count;
          if (date <= cutoff10Years) veteran10Count += count;
        });

        // Streak achievements
        let longestStreak = 1;
        let currentStreak = 1;

        for (let i = 1; i < dates.length; i++) {
          const prevDate = new Date(dates[i - 1]);
          const currDate = new Date(dates[i]);
          const diffDays = Math.round(
            (currDate - prevDate) / (1000 * 60 * 60 * 24)
          );

          if (diffDays === 1) {
            currentStreak++;
            longestStreak = Math.max(longestStreak, currentStreak);
          } else {
            currentStreak = 1;
          }
        }

        // New Year achievement (observations on January 1st)
        let newYearCount = 0;
        dates.forEach((dateStr) => {
          const date = new Date(dateStr);
          if (date.getMonth() === 0 && date.getDate() === 1) {
            newYearCount += histogram[dateStr];
          }
        });

        // Max observations in a single day (Photo Marathon)
        let maxObsInDay = 0;
        dates.forEach((dateStr) => {
          const count = histogram[dateStr];
          if (count > maxObsInDay) {
            maxObsInDay = count;
          }
        });

        // Months achievement
        const observedMonths = new Set();
        const monthNames = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];
        dates.forEach((dateStr) => {
          const date = new Date(dateStr);
          const monthIndex = date.getMonth();
          observedMonths.add(monthNames[monthIndex]);
        });

        // Seasons achievement
        const observedSeasons = new Set();
        dates.forEach((dateStr) => {
          const date = new Date(dateStr);
          const month = date.getMonth(); // 0-11
          let season;
          if (month >= 2 && month <= 4) season = "Spring";
          else if (month >= 5 && month <= 7) season = "Summer";
          else if (month >= 8 && month <= 10) season = "Fall";
          else season = "Winter";
          observedSeasons.add(season);
        });

        // Weekend warrior achievement (Saturday = 6, Sunday = 0)
        const weekendDays = new Set();
        dates.forEach((dateStr) => {
          const date = new Date(dateStr);
          const dayOfWeek = date.getDay();
          if (dayOfWeek === 0 || dayOfWeek === 6) {
            weekendDays.add(dateStr);
          }
        });

        // Total observation days
        const totalObservationDays = dates.length;

        return {
          veteran2: {
            current: veteran2Count,
            total: 1,
            completed: veteran2Count >= 1,
          },
          veteran5: {
            current: veteran5Count,
            total: 1,
            completed: veteran5Count >= 1,
          },
          veteran10: {
            current: veteran10Count,
            total: 1,
            completed: veteran10Count >= 1,
          },
          streak7: {
            current: longestStreak,
            total: 7,
            completed: longestStreak >= 7,
          },
          streak30: {
            current: longestStreak,
            total: 30,
            completed: longestStreak >= 30,
          },
          streak60: {
            current: longestStreak,
            total: 60,
            completed: longestStreak >= 60,
          },
          newYear: {
            current: newYearCount,
            total: 10,
            completed: newYearCount >= 10,
          },
          obsDay10: {
            current: maxObsInDay,
            total: 10,
            completed: maxObsInDay >= 10,
          },
          obsDay100: {
            current: maxObsInDay,
            total: 100,
            completed: maxObsInDay >= 100,
          },
          monthsAchievement: {
            current: observedMonths.size,
            total: 12,
            completed: observedMonths.size >= 12,
            observedMonths: observedMonths,
          },
          seasonsAchievement: {
            current: observedSeasons.size,
            total: 4,
            completed: observedSeasons.size >= 4,
            observedSeasons: observedSeasons,
          },
          weekendWarrior: {
            current: weekendDays.size,
            total: 25,
            completed: weekendDays.size >= 25,
          },
          observationDays100: {
            current: totalObservationDays,
            total: 100,
            completed: totalObservationDays >= 100,
          },
          observationDays500: {
            current: totalObservationDays,
            total: 500,
            completed: totalObservationDays >= 500,
          },
        };
      }

      function renderAchievements(
        observationsCount,
        speciesCount,
        identificationsCount,
        idCategories,
        maxSpeciesIdCount,
        maxSpeciesName,
        userCreatedAt,
        iconicTaxonSpeciesCounts,
        lepidopteraSpeciesCount,
        raptorSpeciesCount,
        beetleSpeciesCount,
        beeSpeciesCount,
        cetaceaSpeciesCount,
        anuraSpeciesCount,
        serpentesSpeciesCount,
        turtleSpeciesCount,
        rodentiaSpeciesCount,
        primatesSpeciesCount,
        threatenedSpeciesCount,
        introducedSpeciesCount,
        endemicSpeciesCount,
        researchGradeCount,
        histogramAchievements,
        conservationStatusAchievements,
        favoriteAchievements,
        rarityAchievements,
        soundObservationsCount,
        soundPhotoObservationsCount,
        annotatedObservationsCount,
        projectsCount,
        earlyBirdCount,
        nightOwlCount,
        observedContinents,
        fromArchivesCount,
        oldTimerCount,
        observedGridCells,
        observedGridSquares
      ) {
        // Calculate iconic taxon achievement from species counts (not observations)
        const iconicTaxonAchievement =
          calculateIconicTaxonAchievementFromCounts(iconicTaxonSpeciesCounts);
        const iconicPercentage =
          (iconicTaxonAchievement.current / iconicTaxonAchievement.total) * 100;

        const threatened10 = {
          current: threatenedSpeciesCount,
          total: 10,
          completed: threatenedSpeciesCount >= 10,
        };
        const threatened50 = {
          current: threatenedSpeciesCount,
          total: 50,
          completed: threatenedSpeciesCount >= 50,
        };
        const threatened100 = {
          current: threatenedSpeciesCount,
          total: 100,
          completed: threatenedSpeciesCount >= 100,
        };

        // Use conservation status achievements from API data
        const nearThreatened10 =
          conservationStatusAchievements.nearThreatened10;
        const vulnerable10 = conservationStatusAchievements.vulnerable10;
        const endangered5 = conservationStatusAchievements.endangered5;
        const criticallyEndangered1 =
          conservationStatusAchievements.criticallyEndangered1;
        const extinctInWild1 = conservationStatusAchievements.extinctInWild1;
        const extinct1 = conservationStatusAchievements.extinct1;

        // Introduced species achievements
        const introduced10 = {
          current: introducedSpeciesCount,
          total: 10,
          completed: introducedSpeciesCount >= 10,
        };
        const introduced50 = {
          current: introducedSpeciesCount,
          total: 50,
          completed: introducedSpeciesCount >= 50,
        };
        const introduced100 = {
          current: introducedSpeciesCount,
          total: 100,
          completed: introducedSpeciesCount >= 100,
        };

        // Endemic species achievements
        const endemic10 = {
          current: endemicSpeciesCount,
          total: 10,
          completed: endemicSpeciesCount >= 10,
        };
        const endemic50 = {
          current: endemicSpeciesCount,
          total: 50,
          completed: endemicSpeciesCount >= 50,
        };
        const endemic100 = {
          current: endemicSpeciesCount,
          total: 100,
          completed: endemicSpeciesCount >= 100,
        };

        // Observation achievements
        const obs100 = calculateCountAchievement(observationsCount, 100);
        const obs1000 = calculateCountAchievement(observationsCount, 1000);
        const obs10000 = calculateCountAchievement(observationsCount, 10000);

        // Research Grade observation achievements
        const researchGrade100 = {
          current: researchGradeCount,
          total: 100,
          completed: researchGradeCount >= 100,
        };
        const researchGrade1000 = {
          current: researchGradeCount,
          total: 1000,
          completed: researchGradeCount >= 1000,
        };
        const researchGrade10000 = {
          current: researchGradeCount,
          total: 10000,
          completed: researchGradeCount >= 10000,
        };

        // Sound observation achievements
        const soundObservation = {
          current: soundObservationsCount,
          total: 1,
          completed: soundObservationsCount >= 1,
        };
        const soundObservation100 = {
          current: soundObservationsCount,
          total: 100,
          completed: soundObservationsCount >= 100,
        };

        // Sound + photo observation achievements
        const soundPhotoObservation = {
          current: soundPhotoObservationsCount,
          total: 1,
          completed: soundPhotoObservationsCount >= 1,
        };

        // Annotated observations achievement
        const annotatedObservation50 = {
          current: annotatedObservationsCount,
          total: 50,
          completed: annotatedObservationsCount >= 50,
        };
        const annotatedObservation100 = {
          current: annotatedObservationsCount,
          total: 100,
          completed: annotatedObservationsCount >= 100,
        };

        // Project participation achievement
        const projectParticipant = {
          current: projectsCount,
          total: 1,
          completed: projectsCount >= 1,
        };

        // Early bird achievement (observations between 5-7 AM)
        const earlyBird = {
          current: earlyBirdCount,
          total: 1,
          completed: earlyBirdCount >= 1,
        };

        // Night owl achievement (observations between 9 PM - 4 AM)
        const nightOwl = {
          current: nightOwlCount,
          total: 1,
          completed: nightOwlCount >= 1,
        };

        // From the Archives achievement (RG observations from before user joined)
        const fromArchives = {
          current: fromArchivesCount,
          total: 1,
          completed: fromArchivesCount >= 1,
        };

        // Old Timer achievement (RG observations from before iNaturalist existed)
        const oldTimer = {
          current: oldTimerCount,
          total: 1,
          completed: oldTimerCount >= 1,
        };

        // Species achievements
        const species100 = calculateCountAchievement(speciesCount, 100);
        const species1000 = calculateCountAchievement(speciesCount, 1000);
        const species10000 = calculateCountAchievement(speciesCount, 10000);

        // Identification achievements
        const ids100 = calculateCountAchievement(identificationsCount, 100);
        const ids1000 = calculateCountAchievement(identificationsCount, 1000);
        const ids10000 = calculateCountAchievement(identificationsCount, 10000);

        // Identification category achievements (for others' observations)
        const idsSupporting100 = calculateCountAchievement(
          idCategories.supporting || 0,
          100
        );
        const idsSupporting1000 = calculateCountAchievement(
          idCategories.supporting || 0,
          1000
        );
        const idsImproving100 = calculateCountAchievement(
          idCategories.improving || 0,
          100
        );
        const idsImproving1000 = calculateCountAchievement(
          idCategories.improving || 0,
          1000
        );
        const idsLeading100 = calculateCountAchievement(
          idCategories.leading || 0,
          100
        );
        const idsLeading1000 = calculateCountAchievement(
          idCategories.leading || 0,
          1000
        );

        // Species identification expert achievements
        const idsSpecies100 = calculateCountAchievement(maxSpeciesIdCount, 100);
        const idsSpecies1000 = calculateCountAchievement(
          maxSpeciesIdCount,
          1000
        );

        // Only observer achievement - use pre-calculated from species counts
        const onlyObserver = rarityAchievements.onlyObserver;

        // Continents achievement - uses API calls for each continent
        const continentsAchievement = {
          current: observedContinents.size,
          total: Object.keys(CONTINENTS).length,
          completed: observedContinents.size >= Object.keys(CONTINENTS).length,
          observedContinents: observedContinents,
        };

        // Globe Trotter achievement (observe in 25+ grid squares around the world)
        const globeTrotterAchievement = {
          current: observedGridSquares,
          total: 25,
          completed: observedGridSquares >= 25,
          gridCells: observedGridCells,
        };

        // Use histogram-based achievements for seasons, months, and streaks
        const seasonsAchievement = histogramAchievements.seasonsAchievement;
        const monthsAchievement = histogramAchievements.monthsAchievement;
        const streak7 = histogramAchievements.streak7;
        const streak30 = histogramAchievements.streak30;
        const streak60 = histogramAchievements.streak60;

        // Use histogram-based achievements for New Year and Veteran
        const newYear = histogramAchievements.newYear;
        const veteran2 = histogramAchievements.veteran2;
        const veteran5 = histogramAchievements.veteran5;
        const veteran10 = histogramAchievements.veteran10;
        const weekendWarrior = histogramAchievements.weekendWarrior;
        const observationDays100 = histogramAchievements.observationDays100;
        const observationDays500 = histogramAchievements.observationDays500;

        // Account age achievements
        const account2 = calculateAccountAgeAchievement(userCreatedAt, 2);
        const account5 = calculateAccountAgeAchievement(userCreatedAt, 5);
        const account10 = calculateAccountAgeAchievement(userCreatedAt, 10);

        // Use favorite achievements from API data
        const favorited10 = favoriteAchievements.favorited10;
        const mostFavorited10 = favoriteAchievements.mostFavorited10;

        // Rare species achievements - use pre-calculated from species counts
        const rareSpecies100 = rarityAchievements.rareSpecies100;
        const rareSpecies10 = rarityAchievements.rareSpecies10;
        const rareSpecies10_50 = rarityAchievements.rareSpecies10_50;
        const rareSpecies100_100 = rarityAchievements.rareSpecies100_100;

        // Species in a day achievements - WIP: requires all observations
        const speciesDay10 = { current: 0, total: 10, completed: false };
        const speciesDay100 = { current: 0, total: 100, completed: false };

        // Observations in a day achievements - use histogram data
        const obsDay10 = histogramAchievements.obsDay10;
        const obsDay100 = histogramAchievements.obsDay100;

        // Species per iconic taxon achievements
        const taxonAchievements = {};
        const taxonGoals = {
          Animalia: 250,
          Insecta: 150,
          Mammalia: 50,
          Amphibia: 50,
          Chromista: 10,
          Protozoa: 10,
        };
        Object.keys(ICONIC_TAXONS).forEach((taxon) => {
          const count = iconicTaxonSpeciesCounts[taxon] || 0;
          const goal = taxonGoals[taxon] || 100;
          taxonAchievements[taxon] = {
            current: count,
            total: goal,
            completed: count >= goal,
          };
        });

        // New specialty achievements
        const lepidopterist = {
          current: lepidopteraSpeciesCount,
          total: 100,
          completed: lepidopteraSpeciesCount >= 100,
        };
        const raptorWatcher = {
          current: raptorSpeciesCount,
          total: 15,
          completed: raptorSpeciesCount >= 15,
        };
        const coleopterist = {
          current: beetleSpeciesCount,
          total: 50,
          completed: beetleSpeciesCount >= 50,
        };
        const pollinatorPal = {
          current: beeSpeciesCount,
          total: 50,
          completed: beeSpeciesCount >= 50,
        };
        const whaleWatcher = {
          current: cetaceaSpeciesCount,
          total: 5,
          completed: cetaceaSpeciesCount >= 5,
        };
        const frogFinder = {
          current: anuraSpeciesCount,
          total: 25,
          completed: anuraSpeciesCount >= 25,
        };
        const snakeSpotter = {
          current: serpentesSpeciesCount,
          total: 20,
          completed: serpentesSpeciesCount >= 20,
        };
        const shellSeeker = {
          current: turtleSpeciesCount,
          total: 15,
          completed: turtleSpeciesCount >= 15,
        };
        const rodentRider = {
          current: rodentiaSpeciesCount,
          total: 25,
          completed: rodentiaSpeciesCount >= 25,
        };
        const primatePatrol = {
          current: primatesSpeciesCount,
          total: 15,
          completed: primatesSpeciesCount >= 15,
        };

        const taxonIconsHtml = Object.entries(ICONIC_TAXONS)
          .map(([key, value]) => {
            const isObserved = iconicTaxonAchievement.observedTaxons.has(key);
            return `
              <div class="taxon-icon ${isObserved ? "observed" : ""}" title="${
              value.name
            }">
                ${value.emoji}
              </div>
            `;
          })
          .join("");

        const continentIconsHtml = Object.entries(CONTINENTS)
          .map(([name, emoji]) => {
            const isObserved =
              continentsAchievement.observedContinents.has(name);
            return `
              <div class="taxon-icon continent-icon ${
                isObserved ? "observed" : ""
              }" title="${name}">
                ${emoji}
              </div>
            `;
          })
          .join("");

        const seasonIconsHtml = Object.entries(SEASONS)
          .map(([name, emoji]) => {
            const isObserved = seasonsAchievement.observedSeasons.has(name);
            return `
              <div class="taxon-icon ${
                isObserved ? "observed" : ""
              }" title="${name}">
                ${emoji}
              </div>
            `;
          })
          .join("");

        const monthIconsHtml = Object.entries(MONTHS)
          .map(([name, label]) => {
            const isObserved = monthsAchievement.observedMonths.has(name);
            return `
              <div class="taxon-icon month-icon ${
                isObserved ? "observed" : ""
              }" title="${name}">
                ${label}
              </div>
            `;
          })
          .join("");

        // Count total achievements (excluding WIP: speciesDay10, speciesDay100)
        const allAchievements = [
          obs100,
          obs1000,
          obs10000,
          researchGrade100,
          researchGrade1000,
          researchGrade10000,
          soundObservation,
          soundObservation100,
          soundPhotoObservation,
          annotatedObservation50,
          annotatedObservation100,
          projectParticipant,
          earlyBird,
          nightOwl,
          fromArchives,
          oldTimer,
          species100,
          species1000,
          species10000,
          ids100,
          ids1000,
          ids10000,
          idsSupporting100,
          idsSupporting1000,
          idsImproving100,
          idsImproving1000,
          idsLeading100,
          idsLeading1000,
          idsSpecies100,
          idsSpecies1000,
          threatened10,
          threatened50,
          threatened100,
          nearThreatened10,
          vulnerable10,
          endangered5,
          criticallyEndangered1,
          extinctInWild1,
          extinct1,
          introduced10,
          introduced50,
          introduced100,
          endemic10,
          endemic50,
          endemic100,
          onlyObserver,
          iconicTaxonAchievement,
          continentsAchievement,
          globeTrotterAchievement,
          seasonsAchievement,
          monthsAchievement,
          streak7,
          streak30,
          streak60,
          newYear,
          obsDay10,
          obsDay100,
          weekendWarrior,
          observationDays100,
          observationDays500,
          veteran2,
          veteran5,
          veteran10,
          account2,
          account5,
          account10,
          favorited10,
          mostFavorited10,
          rareSpecies100,
          rareSpecies10,
          rareSpecies10_50,
          rareSpecies100_100,
          lepidopterist,
          raptorWatcher,
          coleopterist,
          pollinatorPal,
          whaleWatcher,
          frogFinder,
          snakeSpotter,
          shellSeeker,
          rodentRider,
          primatePatrol,
          ...Object.values(taxonAchievements),
        ];
        const completedCount = allAchievements.filter(
          (a) => a.completed
        ).length;
        const totalAchievements = allAchievements.length;

        function renderAchievementCard(
          achievement,
          icon,
          name,
          description,
          link = null,
          isLoading = false
        ) {
          const percentage = Math.min(
            (achievement.current / achievement.total) * 100,
            100
          );
          const linkStart = link
            ? `<a href="${link}" target="_blank" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 14px; flex: 1;">`
            : "";
          const linkEnd = link ? "</a>" : "";
          const loadingClass = isLoading ? "loading" : "";

          if (link) {
            return `
              <div class="achievement-card ${
                achievement.completed ? "completed" : ""
              } ${loadingClass}" style="cursor: pointer;">
                ${linkStart}
                <div class="achievement-icon">${icon}</div>
                <div class="achievement-content">
                  <div class="achievement-name">${name}</div>
                  <div class="achievement-description">${description}</div>
                  <div class="achievement-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${percentage}%"></div>
                    </div>
                    <div class="progress-text">${achievement.current.toLocaleString()}/${achievement.total.toLocaleString()}</div>
                  </div>
                </div>
                ${linkEnd}
              </div>
            `;
          }

          return `
            <div class="achievement-card ${
              achievement.completed ? "completed" : ""
            } ${loadingClass}">
              <div class="achievement-icon">${icon}</div>
              <div class="achievement-content">
                <div class="achievement-name">${name}</div>
                <div class="achievement-description">${description}</div>
                <div class="achievement-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${percentage}%"></div>
                  </div>
                  <div class="progress-text">${achievement.current.toLocaleString()}/${achievement.total.toLocaleString()}</div>
                </div>
              </div>
            </div>
          `;
        }

        function renderCategoryTitle(title, icon, achievements) {
          const completed = achievements.filter(a => a.completed).length;
          const total = achievements.length;
          const isPlatinum = completed === total && total > 0;
          const platinumClass = isPlatinum ? 'platinum' : '';
          const platinumBadge = isPlatinum ? '<span class="platinum-badge">‚úì</span>' : '';
          const countDisplay = isPlatinum
            ? `<span class="category-count">COMPLETE ${platinumBadge}</span>`
            : `<span class="category-count">${completed}/${total}</span>`;

          return `
            <h3 class="category-title ${platinumClass}">
              <span class="category-icon">${icon}</span>
              <span class="category-title-text">${title}</span>
              ${countDisplay}
            </h3>
          `;
        }

        // Define category achievements for tracking
        const milestonesAchievements = [
          obs100, obs1000, obs10000,
          researchGrade100, researchGrade1000, researchGrade10000,
          species100, species1000, species10000,
          veteran2, veteran5, veteran10,
          account2, account5, account10,
          soundObservation, soundObservation100, soundPhotoObservation
        ];

        const conservationAchievements = [
          threatened10, threatened50, threatened100,
          nearThreatened10, vulnerable10, endangered5, criticallyEndangered1, extinctInWild1, extinct1,
          introduced10, introduced50, introduced100,
          endemic10, endemic50, endemic100
        ];

        const rarityAchievementsArray = [
          onlyObserver, rareSpecies10, rareSpecies10_50, rareSpecies100, rareSpecies100_100
        ];

        const timeDedicationAchievements = [
          streak7, streak30, streak60, newYear, obsDay10, obsDay100,
          earlyBird, nightOwl, fromArchives, oldTimer,
          weekendWarrior, observationDays100, observationDays500
        ];

        const communityAchievements = [
          favorited10, mostFavorited10, annotatedObservation50, annotatedObservation100, projectParticipant
        ];

        const identificationsAchievements = [
          ids100, ids1000, ids10000,
          idsSupporting100, idsSupporting1000,
          idsImproving100, idsImproving1000,
          idsLeading100, idsLeading1000,
          idsSpecies100, idsSpecies1000
        ];

        const taxonomyAchievementsArray = [
          ...Object.values(taxonAchievements),
          lepidopterist, raptorWatcher, coleopterist, pollinatorPal,
          whaleWatcher, frogFinder, snakeSpotter, shellSeeker,
          rodentRider, primatePatrol, iconicTaxonAchievement
        ];

        const geographySeasonsAchievements = [
          seasonsAchievement, monthsAchievement, continentsAchievement, globeTrotterAchievement
        ];

        const html = `
          <div class="achievements-section">
            ${renderCategoryTitle('Milestones', 'üèÜ', milestonesAchievements)}
            <div class="achievements-grid">
              ${renderAchievementCard(
                obs100,
                "üì∑",
                "Observer",
                "Record 100 observations",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}`
              )}
              ${renderAchievementCard(
                obs1000,
                "üì∑",
                "Dedicated Observer",
                "Record 1,000 observations",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}`
              )}
              ${renderAchievementCard(
                obs10000,
                "üì∑",
                "Master Observer",
                "Record 10,000 observations",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}`
              )}
              ${renderAchievementCard(
                researchGrade100,
                "‚úÖ",
                "Quality Contributor",
                "Have 100 research grade observations",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&quality_grade=research`
              )}
              ${renderAchievementCard(
                researchGrade1000,
                "‚úÖ",
                "Quality Expert",
                "Have 1,000 research grade observations",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&quality_grade=research`
              )}
              ${renderAchievementCard(
                researchGrade10000,
                "‚úÖ",
                "Quality Master",
                "Have 10,000 research grade observations",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&quality_grade=research`
              )}
              ${renderAchievementCard(
                species100,
                "üî¨",
                "Species Spotter",
                "Observe 100 species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&view=species`
              )}
              ${renderAchievementCard(
                species1000,
                "üî¨",
                "Species Expert",
                "Observe 1,000 species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&view=species`
              )}
              ${renderAchievementCard(
                species10000,
                "üî¨",
                "Species Master",
                "Observe 10,000 species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&view=species`
              )}
              ${renderAchievementCard(
                veteran2,
                "üéñÔ∏è",
                "2-Year Veteran",
                "Have an observation from 2+ years ago",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&d2=${
                  new Date(
                    new Date().setFullYear(new Date().getFullYear() - 2) -
                      86400000
                  )
                    .toISOString()
                    .split("T")[0]
                }`,
                false
              )}
              ${renderAchievementCard(
                veteran5,
                "üéñÔ∏è",
                "5-Year Veteran",
                "Have an observation from 5+ years ago",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&d2=${
                  new Date(
                    new Date().setFullYear(new Date().getFullYear() - 5) -
                      86400000
                  )
                    .toISOString()
                    .split("T")[0]
                }`,
                false
              )}
              ${renderAchievementCard(
                veteran10,
                "üèÖ",
                "10-Year Veteran",
                "Have an observation from 10+ years ago",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&d2=${
                  new Date(
                    new Date().setFullYear(new Date().getFullYear() - 10) -
                      86400000
                  )
                    .toISOString()
                    .split("T")[0]
                }`,
                false
              )}
              ${renderAchievementCard(
                account2,
                "üìÖ",
                "2-Year Member",
                "Have an account for 2+ years"
              )}
              ${renderAchievementCard(
                account5,
                "üìÖ",
                "5-Year Member",
                "Have an account for 5+ years"
              )}
              ${renderAchievementCard(
                account10,
                "üìÖ",
                "10-Year Member",
                "Have an account for 10+ years"
              )}
              ${renderAchievementCard(
                soundObservation,
                "üîä",
                "Sound Recorder",
                "Record an observation with sound",
                soundObservation.current > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&sounds`
                  : null
              )}
              ${renderAchievementCard(
                soundObservation100,
                "üîä",
                "Sound Expert",
                "Record 100 observations with sound",
                soundObservation100.current > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&sounds`
                  : null
              )}
              ${renderAchievementCard(
                soundPhotoObservation,
                "üé¨",
                "Multimedia Master",
                "Record an observation with sound and image",
                soundPhotoObservation.current > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&sounds&photos`
                  : null
              )}
            </div>

            ${renderCategoryTitle('Conservation', 'üå±', conservationAchievements)}
            <div class="achievements-grid">
              ${renderAchievementCard(
                threatened10,
                "ü¶Å",
                "Conservation Ally",
                "Observe 10 species with conservation status",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&threatened=true&view=species`,
                false
              )}
              ${renderAchievementCard(
                threatened50,
                "ü¶Å",
                "Conservation Champion",
                "Observe 50 species with conservation status",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&threatened=true&view=species`,
                false
              )}
              ${renderAchievementCard(
                threatened100,
                "ü¶Å",
                "Conservation Hero",
                "Observe 100 species with conservation status",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&threatened=true&view=species`,
                false
              )}
              ${renderAchievementCard(
                nearThreatened10,
                "üëÅÔ∏è",
                "Near Threatened Spotter",
                "Observe 10 near threatened species",
                nearThreatened10.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${nearThreatened10.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
              ${renderAchievementCard(
                vulnerable10,
                "üõ°Ô∏è",
                "Vulnerable Spotter",
                "Observe 10 vulnerable species",
                vulnerable10.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${vulnerable10.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
              ${renderAchievementCard(
                endangered5,
                "üö®",
                "Endangered Spotter",
                "Observe 5 endangered species",
                endangered5.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${endangered5.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
              ${renderAchievementCard(
                criticallyEndangered1,
                "‚ö†Ô∏è",
                "Critically Endangered Spotter",
                "Observe 1 critically endangered species",
                criticallyEndangered1.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${criticallyEndangered1.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
              ${renderAchievementCard(
                extinctInWild1,
                "üíÄ",
                "Extinct in Wild Spotter",
                "Observe 1 species extinct in the wild",
                extinctInWild1.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${extinctInWild1.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
              ${renderAchievementCard(
                extinct1,
                "ü¶§",
                "Extinct Species Spotter",
                "Observe 1 extinct species",
                extinct1.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${extinct1.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
              ${renderAchievementCard(
                introduced10,
                "üåç",
                "Invasive Spotter",
                "Observe 10 introduced species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&introduced=true&view=species`,
                false
              )}
              ${renderAchievementCard(
                introduced50,
                "üåç",
                "Invasive Tracker",
                "Observe 50 introduced species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&introduced=true&view=species`,
                false
              )}
              ${renderAchievementCard(
                introduced100,
                "üåç",
                "Invasive Expert",
                "Observe 100 introduced species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&introduced=true&view=species`,
                false
              )}
              ${renderAchievementCard(
                endemic10,
                "üèùÔ∏è",
                "Endemic Explorer",
                "Observe 10 endemic species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&endemic=true&view=species`,
                false
              )}
              ${renderAchievementCard(
                endemic50,
                "üèùÔ∏è",
                "Endemic Tracker",
                "Observe 50 endemic species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&endemic=true&view=species`,
                false
              )}
              ${renderAchievementCard(
                endemic100,
                "üèùÔ∏è",
                "Endemic Expert",
                "Observe 100 endemic species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&endemic=true&view=species`,
                false
              )}
            </div>

            ${renderCategoryTitle('Rarity', 'üíé', rarityAchievementsArray)}
            <div class="achievements-grid">
              ${renderAchievementCard(
                onlyObserver,
                "‚≠ê",
                "Rare Find",
                "Be the only observer of a species",
                onlyObserver.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${onlyObserver.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
              ${renderAchievementCard(
                rareSpecies10,
                "ü¶Ñ",
                "Unicorn Spotter",
                "Observe 10 species with less than 10 total observations",
                rareSpecies10.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${rareSpecies10.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
              ${renderAchievementCard(
                rareSpecies10_50,
                "ü¶Ñ",
                "Unicorn Hunter",
                "Observe 50 species with less than 10 total observations",
                rareSpecies10_50.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${rareSpecies10_50.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
              ${renderAchievementCard(
                rareSpecies100,
                "üíé",
                "Diamond Hunter",
                "Observe 10 species with less than 100 total observations",
                rareSpecies100.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${rareSpecies100.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
              ${renderAchievementCard(
                rareSpecies100_100,
                "üíé",
                "Diamond Expert",
                "Observe 100 species with less than 100 total observations",
                rareSpecies100_100.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${rareSpecies100_100.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
            </div>

            ${renderCategoryTitle('Time & Dedication', '‚è∞', timeDedicationAchievements)}
            <div class="achievements-grid">
              ${renderAchievementCard(
                streak7,
                "üî•",
                "Week Warrior",
                "7-day observation streak",
                null,
                false
              )}
              ${renderAchievementCard(
                streak30,
                "üî•",
                "Monthly Dedication",
                "30-day observation streak",
                null,
                false
              )}
              ${renderAchievementCard(
                streak60,
                "üî•",
                "Streak Master",
                "60-day observation streak",
                null,
                false
              )}
              ${renderAchievementCard(
                weekendWarrior,
                "üéâ",
                "Weekend Warrior",
                "Observe on 25 different weekend days",
                null
              )}
              ${renderAchievementCard(
                observationDays100,
                "üìÜ",
                "Dedicated Days",
                "Observe on 100 different days",
                null
              )}
              ${renderAchievementCard(
                observationDays500,
                "üìÜ",
                "Year-Round Observer",
                "Observe on 500 different days",
                null
              )}
              ${renderAchievementCard(
                newYear,
                "üéÜ",
                "New Year, New Observations",
                "10 observations on January 1st",
                null,
                false
              )}
              ${renderAchievementCard(
                obsDay10,
                "üì∏",
                "Busy Day",
                "10 observations in a single day",
                null,
                false
              )}
              ${renderAchievementCard(
                obsDay100,
                "üì∏",
                "Photo Marathon",
                "100 observations in a single day",
                null,
                false
              )}
              ${renderAchievementCard(
                earlyBird,
                "üåÖ",
                "Early Bird",
                "Make an observation between 5-7 AM",
                earlyBird.current > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&hour=5,6,7`
                  : null
              )}
              ${renderAchievementCard(
                nightOwl,
                "ü¶â",
                "Night Owl",
                "Make an observation between 9 PM - 4 AM",
                nightOwl.current > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&hour=21,22,23,0,1,2,3,4`
                  : null
              )}
              ${renderAchievementCard(
                fromArchives,
                "üìú",
                "From the Archives",
                "Add a research grade observation from before you joined iNaturalist",
                fromArchives.current > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&quality_grade=research&d2=${userCreatedAt ? new Date(userCreatedAt).toISOString().split("T")[0] : ""}`
                  : null
              )}
              ${renderAchievementCard(
                oldTimer,
                "üèõÔ∏è",
                "Old Timer",
                "Add a research grade observation from before iNaturalist existed (March 2008)",
                oldTimer.current > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&quality_grade=research&d2=2008-03-01`
                  : null
              )}
              ${
                /* WIP - Diversity Day and Biodiversity Blitz
              ${renderAchievementCard(
                speciesDay10,
                "üåà",
                "Diversity Day (WIP)",
                "10 species in a single day",
                null,
                false
              )}
              ${renderAchievementCard(
                speciesDay100,
                "üåà",
                "Biodiversity Blitz (WIP)",
                "100 species in a single day",
                null,
                false
              )}
              */ ""
              }
            </div>

            ${renderCategoryTitle('Community', 'üë•', communityAchievements)}
            <div class="achievements-grid">
              ${renderAchievementCard(
                favorited10,
                "‚ù§Ô∏è",
                "Fan Favorite",
                "Have 10 observations that were favorited",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&popular=true`,
                false
              )}
              ${renderAchievementCard(
                mostFavorited10,
                "üåü",
                "Superstar",
                "Have an observation with 10+ favorites",
                mostFavorited10.obsIds && mostFavorited10.obsIds.length > 0
                  ? `https://www.inaturalist.org/observations?id=${mostFavorited10.obsIds.join(
                      ","
                    )}`
                  : null,
                false
              )}
              ${renderAchievementCard(
                annotatedObservation50,
                "üè∑Ô∏è",
                "Annotator",
                "Annotate 50 observations",
                annotatedObservation50.current > 0
                  ? `https://www.inaturalist.org/observations?annotation_user_id=${currentUsername}&verifiable=any`
                  : null
              )}
              ${renderAchievementCard(
                annotatedObservation100,
                "üè∑Ô∏è",
                "Super Annotator",
                "Annotate 100 observations",
                annotatedObservation100.current > 0
                  ? `https://www.inaturalist.org/observations?annotation_user_id=${currentUsername}&verifiable=any`
                  : null
              )}
              ${renderAchievementCard(
                projectParticipant,
                "üìã",
                "Project Participant",
                "Join a project",
                projectParticipant.current > 0
                  ? `https://www.inaturalist.org/projects/user/${currentUsername}`
                  : null
              )}
            </div>

            ${renderCategoryTitle('Identifications', 'üè∑Ô∏è', identificationsAchievements)}
            <div class="achievements-grid">
              ${renderAchievementCard(
                ids100,
                "üè∑Ô∏è",
                "Identifier",
                "Make 100 identifications"
              )}
              ${renderAchievementCard(
                ids1000,
                "üè∑Ô∏è",
                "Dedicated Identifier",
                "Make 1,000 identifications"
              )}
              ${renderAchievementCard(
                ids10000,
                "üè∑Ô∏è",
                "Master Identifier",
                "Make 10,000 identifications"
              )}
              ${renderAchievementCard(
                idsSupporting100,
                "üëç",
                "Supporter",
                "Make 100 supporting identifications"
              )}
              ${renderAchievementCard(
                idsSupporting1000,
                "üëç",
                "Super Supporter",
                "Make 1,000 supporting identifications"
              )}
              ${renderAchievementCard(
                idsImproving100,
                "üìà",
                "Improver",
                "Make 100 improving identifications"
              )}
              ${renderAchievementCard(
                idsImproving1000,
                "üìà",
                "Super Improver",
                "Make 1,000 improving identifications"
              )}
              ${renderAchievementCard(
                idsLeading100,
                "ü•á",
                "Leader",
                "Make 100 leading identifications"
              )}
              ${renderAchievementCard(
                idsLeading1000,
                "ü•á",
                "Super Leader",
                "Make 1,000 leading identifications"
              )}
              ${renderAchievementCard(
                idsSpecies100,
                "üîç",
                "Species Specialist",
                `Identify a species 100 times${
                  maxSpeciesName ? ` (${maxSpeciesName})` : ""
                }`
              )}
              ${renderAchievementCard(
                idsSpecies1000,
                "üîç",
                "Species Expert",
                `Identify a species 1,000 times${
                  maxSpeciesName ? ` (${maxSpeciesName})` : ""
                }`
              )}
            </div>

            ${renderCategoryTitle('Taxonomy', 'üî¨', taxonomyAchievementsArray)}
            <div class="achievements-grid">
              ${Object.entries(ICONIC_TAXONS)
                .map(([taxon, data]) =>
                  renderAchievementCard(
                    taxonAchievements[taxon],
                    data.emoji,
                    `${data.name} Expert`,
                    `Observe ${
                      taxonAchievements[taxon].total
                    } ${data.name.toLowerCase()} species`,
                    `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=${data.id}&view=species`
                  )
                )
                .join("")}
              ${renderAchievementCard(
                lepidopterist,
                "ü¶ã",
                "Lepidopterist",
                "Observe 100 butterfly & moth species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=47157&view=species`
              )}
              ${renderAchievementCard(
                raptorWatcher,
                "ü¶Ö",
                "Raptor Watcher",
                "Observe 15 birds of prey species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=71261,67570,19350,559244&view=species`
              )}
              ${renderAchievementCard(
                coleopterist,
                "ü™≤",
                "Coleopterist",
                "Observe 50 beetle species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=47208&view=species`
              )}
              ${renderAchievementCard(
                pollinatorPal,
                "üêù",
                "Pollinator Pal",
                "Observe 50 bee species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=630955&view=species`
              )}
              ${renderAchievementCard(
                whaleWatcher,
                "üêã",
                "Whale Watcher",
                "Observe 5 whale & dolphin species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=152871&view=species`
              )}
              ${renderAchievementCard(
                frogFinder,
                "üê∏",
                "Frog Finder",
                "Observe 25 frog & toad species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=20979&view=species`
              )}
              ${renderAchievementCard(
                snakeSpotter,
                "üêç",
                "Snake Spotter",
                "Observe 20 snake species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=85553&view=species`
              )}
              ${renderAchievementCard(
                shellSeeker,
                "üê¢",
                "Shell Seeker",
                "Observe 15 turtle & tortoise species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=39532&view=species`
              )}
              ${renderAchievementCard(
                rodentRider,
                "üêøÔ∏è",
                "Rodent Rider",
                "Observe 25 rodent species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=43698&view=species`
              )}
              ${renderAchievementCard(
                primatePatrol,
                "üêí",
                "Primate Patrol",
                "Observe 15 primate species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=43367&view=species`
              )}
              <div class="achievement-card ${
                iconicTaxonAchievement.completed ? "completed" : ""
              }">
                <div class="achievement-icon">üåç</div>
                <div class="achievement-content">
                  <div class="achievement-name">Biodiversity Explorer</div>
                  <div class="achievement-description">Observe all iconic taxons</div>
                  <div class="achievement-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${iconicPercentage}%"></div>
                    </div>
                    <div class="progress-text">${
                      iconicTaxonAchievement.current
                    }/${iconicTaxonAchievement.total}</div>
                  </div>
                  <div class="taxon-icons">${taxonIconsHtml}</div>
                </div>
              </div>
            </div>

            ${renderCategoryTitle('Geography & Seasons', 'üåç', geographySeasonsAchievements)}
            <div class="achievements-grid">
              <div class="achievement-card ${
                seasonsAchievement.completed ? "completed" : ""
              }">
                <div class="achievement-icon">üìÖ</div>
                <div class="achievement-content">
                  <div class="achievement-name">Year-Round Observer</div>
                  <div class="achievement-description">Observe in all 4 seasons</div>
                  <div class="achievement-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${
                        (seasonsAchievement.current /
                          seasonsAchievement.total) *
                        100
                      }%"></div>
                    </div>
                    <div class="progress-text">${seasonsAchievement.current}/${
          seasonsAchievement.total
        }</div>
                  </div>
                  <div class="taxon-icons">${seasonIconsHtml}</div>
                </div>
              </div>
              <div class="achievement-card ${
                monthsAchievement.completed ? "completed" : ""
              }">
                <div class="achievement-icon">üìÜ</div>
                <div class="achievement-content">
                  <div class="achievement-name">Monthly Observer</div>
                  <div class="achievement-description">Observe in all 12 months</div>
                  <div class="achievement-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${
                        (monthsAchievement.current / monthsAchievement.total) *
                        100
                      }%"></div>
                    </div>
                    <div class="progress-text">${monthsAchievement.current}/${
          monthsAchievement.total
        }</div>
                  </div>
                  <div class="taxon-icons">${monthIconsHtml}</div>
                </div>
              </div>
              <div class="achievement-card ${
                continentsAchievement.completed ? "completed" : ""
              }">
                <div class="achievement-icon">‚úàÔ∏è</div>
                <div class="achievement-content">
                  <div class="achievement-name">World Traveler</div>
                  <div class="achievement-description">Observe in all 6 continents</div>
                  <div class="achievement-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${
                        (continentsAchievement.current /
                          continentsAchievement.total) *
                        100
                      }%"></div>
                    </div>
                    <div class="progress-text">${
                      continentsAchievement.current
                    }/${continentsAchievement.total}</div>
                  </div>
                  <div class="taxon-icons">${continentIconsHtml}</div>
                </div>
              </div>
              <div class="achievement-card ${
                globeTrotterAchievement.completed ? "completed" : ""
              }">
                <div class="achievement-icon">üåé</div>
                <div class="achievement-content">
                  <div class="achievement-name">Globe Trotter</div>
                  <div class="achievement-description">Explore 25 of the world's 1024 map regions</div>
                  <div class="achievement-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${
                        Math.min((globeTrotterAchievement.current /
                          globeTrotterAchievement.total) *
                        100, 100)
                      }%"></div>
                    </div>
                    <div class="progress-text">${
                      globeTrotterAchievement.current
                    }/${globeTrotterAchievement.total}</div>
                  </div>
                  <div class="world-grid-map" style="display: grid; grid-template-columns: repeat(32, 1fr); gap: 0; border-radius: 6px; margin-top: 10px; background: #1a1a1a; position: relative; overflow: hidden;">
                    <img src="https://tile.openstreetmap.org/0/0/0.png" alt="" style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: fill;"/>
                    ${(() => {
                      const gridSize = 32;
                      let cells = '';
                      for (let row = 0; row < gridSize; row++) {
                        for (let col = 0; col < gridSize; col++) {
                          const cellKey = row + ',' + col;
                          const hasObservation = globeTrotterAchievement.gridCells.has(cellKey);
                          const bgColor = hasObservation ? 'rgba(116, 172, 0, 0.8)' : 'transparent';
                          cells += '<div style="aspect-ratio: 1; background: ' + bgColor + '; position: relative; z-index: 1;" title="' + (hasObservation ? 'Observed' : '') + '"></div>';
                        }
                      }
                      return cells;
                    })()}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        return { html, completedCount, totalAchievements };
      }
    </script>
    <script>
      // Dark mode functionality
      const darkModeToggle = document.getElementById("darkModeToggle");

      // Load dark mode preference from localStorage
      if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark-mode");
        darkModeToggle.textContent = "‚òÄÔ∏è";
      }

      // Toggle dark mode
      darkModeToggle.addEventListener("click", () => {
        document.body.classList.toggle("dark-mode");
        const isDarkMode = document.body.classList.contains("dark-mode");
        localStorage.setItem("darkMode", isDarkMode);
        darkModeToggle.textContent = isDarkMode ? "‚òÄÔ∏è" : "üåô";
      });
    </script>
    <script
      defer
      data-domain="glauberramos.github.io/inat"
      src="https://plausible.io/js/script.js"
    ></script>
    <!-- <script type="text/javascript">
      window.$pipeback = [];
      window.PIPEBACK_ID = "a069b910-4aef-4233-99cc-913e7fb30fb5";
      (function () {
        d = document;
        s = d.createElement("script");
        s.src = "https://widget.pipeback.com/l.js";
        s.async = 1;
        d.getElementsByTagName("head")[0].appendChild(s);
      })();
    </script> -->
  </body>
</html>
