<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Achievements - iNaturalist</title>
    <link rel="icon" href="favicon.ico" />
    <meta
      name="description"
      content="View iNaturalist user achievements and milestones"
    />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="achievements.css" />
  </head>
  <body>
    <button
      class="dark-mode-toggle"
      id="darkModeToggle"
      title="Toggle dark mode"
    >
      üåô
    </button>
    <a
      href="/inat"
      style="
        position: fixed;
        top: 20px;
        left: 20px;
        background: #74ac00;
        color: white;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 10px 16px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
      "
      onmouseover="this.style.background='#659900'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.2)'"
      onmouseout="this.style.background='#74ac00'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.15)'"
    >
      <span style="font-size: 1rem">‚Üê</span> More iNat tools
    </a>
    <div class="container">
      <header>
        <div class="header-content">
          <div class="title-container">
            <img src="logo.png" alt="iNaturalist Logo" class="logo" />
            <h1>Achievements</h1>
          </div>
          <p class="description">
            Track your iNaturalist milestones and achievements
          </p>
        </div>
        <div class="error-message" id="errorMessage"></div>
      </header>

      <main>
        <div class="summary-card" id="summaryCard">
          <div class="summary-search">
            <div class="username-search-container" style="width: 300px">
              <input
                type="text"
                id="usernameInput"
                placeholder="Enter iNaturalist username..."
                autocomplete="off"
                style="width: 100%"
              />
              <div
                id="usernameAutocomplete"
                class="username-autocomplete"
              ></div>
            </div>
            <button id="loadButton">Load</button>
            <span
              id="achievementsProgress"
              class="achievements-progress"
            ></span>
          </div>
        </div>

        <div class="loading" id="loading" style="display: none">
          Loading... <span id="loadingCount"></span>
        </div>
        <div id="achievementsContainer"></div>
      </main>
    </div>
    <script>
      const usernameInput = document.getElementById("usernameInput");
      const usernameAutocomplete = document.getElementById(
        "usernameAutocomplete"
      );
      const loadButton = document.getElementById("loadButton");
      const loading = document.getElementById("loading");
      const achievementsContainer = document.getElementById(
        "achievementsContainer"
      );
      const errorMessage = document.getElementById("errorMessage");
      const achievementsProgress = document.getElementById(
        "achievementsProgress"
      );

      let searchTimeout = null;
      let allObservations = [];
      let currentUsername = "";

      // All iconic taxons in iNaturalist with emojis
      const ICONIC_TAXONS = {
        Plantae: { emoji: "üåø", name: "Plants", id: 47126 },
        Fungi: { emoji: "üçÑ", name: "Fungi", id: 47170 },
        Mollusca: { emoji: "üêå", name: "Mollusks", id: 47115 },
        Arachnida: { emoji: "üï∑Ô∏è", name: "Arachnids", id: 47119 },
        Insecta: { emoji: "ü¶ã", name: "Insects", id: 47158 },
        Actinopterygii: { emoji: "üêü", name: "Fish", id: 47178 },
        Amphibia: { emoji: "üê∏", name: "Amphibians", id: 20978 },
        Reptilia: { emoji: "ü¶é", name: "Reptiles", id: 26036 },
        Aves: { emoji: "üê¶", name: "Birds", id: 3 },
        Mammalia: { emoji: "ü¶å", name: "Mammals", id: 40151 },
      };

      // Load saved username from localStorage (shared with other tools)
      const savedUsername = localStorage.getItem("inatUsername");
      if (savedUsername) {
        usernameInput.value = savedUsername;
        loadUserData();
      }

      // Username autocomplete
      usernameInput.addEventListener("input", (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();

        if (query.length < 2) {
          usernameAutocomplete.innerHTML = "";
          usernameAutocomplete.style.display = "none";
          return;
        }

        searchTimeout = setTimeout(async () => {
          try {
            const response = await fetch(
              `https://api.inaturalist.org/v1/users/autocomplete?q=${encodeURIComponent(
                query
              )}`
            );
            const data = await response.json();

            if (data.results && data.results.length > 0) {
              usernameAutocomplete.innerHTML = data.results
                .slice(0, 10)
                .map((user) => {
                  const obsCount = user.observations_count || 0;
                  return `
                    <div class="username-suggestion" data-login="${user.login}">
                      <div class="username-name">${user.login}</div>
                      <div class="username-info">${obsCount.toLocaleString()} observations</div>
                    </div>
                  `;
                })
                .join("");
              usernameAutocomplete.style.display = "block";

              document
                .querySelectorAll(".username-suggestion")
                .forEach((item) => {
                  item.addEventListener("click", () => {
                    usernameInput.value = item.dataset.login;
                    usernameAutocomplete.innerHTML = "";
                    usernameAutocomplete.style.display = "none";
                    loadUserData();
                  });
                });
            } else {
              usernameAutocomplete.innerHTML = "";
              usernameAutocomplete.style.display = "none";
            }
          } catch (error) {
            console.error("Error fetching users:", error);
            usernameAutocomplete.innerHTML = "";
            usernameAutocomplete.style.display = "none";
          }
        }, 300);
      });

      // Hide autocomplete when clicking outside
      document.addEventListener("click", (e) => {
        if (
          !usernameInput.contains(e.target) &&
          !usernameAutocomplete.contains(e.target)
        ) {
          usernameAutocomplete.style.display = "none";
        }
      });

      // Load button handler
      loadButton.addEventListener("click", () => {
        loadUserData();
      });

      // Enter key handler
      usernameInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          loadUserData();
        }
      });

      async function loadUserData() {
        const username = usernameInput.value.trim();

        if (!username) {
          showError("Please enter a username");
          return;
        }

        hideError();
        loading.style.display = "block";
        achievementsContainer.innerHTML = "";
        achievementsProgress.classList.remove("show");
        document.getElementById("loadingCount").textContent = "";

        try {
          // Get user info
          const userResponse = await fetch(
            `https://api.inaturalist.org/v1/users/autocomplete?q=${encodeURIComponent(
              username
            )}`
          );
          const userData = await userResponse.json();

          if (!userData.results || userData.results.length === 0) {
            loading.style.display = "none";
            showError("User not found");
            return;
          }

          const user = userData.results[0];
          const userId = user.id;

          // Save username to localStorage (shared with other tools)
          localStorage.setItem("inatUsername", username);
          currentUsername = username;

          // Fetch species count (with same filters as observations)
          const speciesResponse = await fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&per_page=1&captive=false&verifiable=true`
          );
          const speciesData = await speciesResponse.json();

          const speciesCount = speciesData.total_results || 0;
          const identificationsCount = user.identifications_count || 0;
          const userCreatedAt = user.created_at || null;

          // Fetch identification categories (for others' observations)
          const idCategoriesResponse = await fetch(
            `https://api.inaturalist.org/v1/identifications/categories?own_observation=false&user_id=${userId}`
          );
          const idCategoriesData = await idCategoriesResponse.json();
          const idCategories = {};
          if (idCategoriesData.results) {
            idCategoriesData.results.forEach((item) => {
              idCategories[item.category] = item.count;
            });
          }

          // Fetch identification species counts (for others' observations)
          const idSpeciesResponse = await fetch(
            `https://api.inaturalist.org/v1/identifications/species_counts?own_observation=false&user_id=${userId}&per_page=1`
          );
          const idSpeciesData = await idSpeciesResponse.json();
          // Find max count for any single species
          let maxSpeciesIdCount = 0;
          let maxSpeciesName = "";
          if (idSpeciesData.results && idSpeciesData.results.length > 0) {
            maxSpeciesIdCount = idSpeciesData.results[0].count;
            const taxon = idSpeciesData.results[0].taxon;
            maxSpeciesName = taxon.preferred_common_name || taxon.name || "";
          }

          // Fetch iconic taxon species counts using the v2 endpoint
          const iconicTaxaPromise = fetch(
            `https://api.inaturalist.org/v2/observations/iconic_taxa_species_counts?user_id=${userId}&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch Lepidoptera species count (butterflies & moths - taxon_id 47157)
          const lepidopteraPromise = fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&taxon_id=47157&per_page=1&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch Raptor species count (birds of prey - taxon_ids 71261, 67570, 19350, 559244)
          const raptorPromise = fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&taxon_id=71261,67570,19350,559244&per_page=1&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch Beetle species count (Coleoptera - taxon_id 47208)
          const beetlePromise = fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&taxon_id=47208&per_page=1&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch Bee species count (Anthophila - taxon_id 630955)
          const beePromise = fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&taxon_id=630955&per_page=1&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch Cetacea species count (Whales & Dolphins - taxon_id 152871)
          const cetaceaPromise = fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&taxon_id=152871&per_page=1&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch Anura species count (Frogs & Toads - taxon_id 20979)
          const anuraPromise = fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&taxon_id=20979&per_page=1&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch Serpentes species count (Snakes - taxon_id 85553)
          const serpentesPromise = fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&taxon_id=85553&per_page=1&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch Testudines species count (Turtles - taxon_id 39532)
          const turtlePromise = fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&taxon_id=39532&per_page=1&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch Threatened species count
          const threatenedPromise = fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&threatened=true&per_page=1&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch Introduced species count
          const introducedPromise = fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&introduced=true&per_page=1&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch Endemic species count
          const endemicPromise = fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&endemic=true&per_page=1&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch Research Grade observations count
          const researchGradePromise = fetch(
            `https://api.inaturalist.org/v1/observations?user_id=${userId}&quality_grade=research&per_page=1&captive=false`
          ).then((res) => res.json());

          // Fetch observation histogram for date-based achievements
          const histogramPromise = fetch(
            `https://api.inaturalist.org/v2/observations/histogram?interval=day&d1=1900-01-01&user_id=${userId}&captive=false&verifiable=true`
          ).then((res) => res.json());

          // Fetch threatened species with conservation status details
          const threatenedSpeciesPromise = loadThreatenedSpecies(userId);

          const [
            iconicTaxaData,
            lepidopteraData,
            raptorData,
            beetleData,
            beeData,
            cetaceaData,
            anuraData,
            serpentesData,
            turtleData,
            threatenedData,
            introducedData,
            endemicData,
            researchGradeData,
            histogramData,
            threatenedSpecies,
          ] = await Promise.all([
            iconicTaxaPromise,
            lepidopteraPromise,
            raptorPromise,
            beetlePromise,
            beePromise,
            cetaceaPromise,
            anuraPromise,
            serpentesPromise,
            turtlePromise,
            threatenedPromise,
            introducedPromise,
            endemicPromise,
            researchGradePromise,
            histogramPromise,
            threatenedSpeciesPromise,
          ]);

          // Process iconic taxa data - map taxon IDs to names
          const iconicTaxonSpeciesCounts = {};
          if (iconicTaxaData.results) {
            // Create a reverse mapping from taxon ID to name
            const idToName = {};
            Object.entries(ICONIC_TAXONS).forEach(([name, data]) => {
              idToName[data.id] = name;
            });

            iconicTaxaData.results.forEach((item) => {
              const taxonId = item.taxon?.id;
              if (taxonId && idToName[taxonId]) {
                iconicTaxonSpeciesCounts[idToName[taxonId]] = item.count || 0;
              }
            });
          }

          // Ensure all iconic taxons have a count (even if 0)
          Object.keys(ICONIC_TAXONS).forEach((taxonName) => {
            if (!(taxonName in iconicTaxonSpeciesCounts)) {
              iconicTaxonSpeciesCounts[taxonName] = 0;
            }
          });

          const lepidopteraSpeciesCount = lepidopteraData.total_results || 0;
          const raptorSpeciesCount = raptorData.total_results || 0;
          const beetleSpeciesCount = beetleData.total_results || 0;
          const beeSpeciesCount = beeData.total_results || 0;
          const cetaceaSpeciesCount = cetaceaData.total_results || 0;
          const anuraSpeciesCount = anuraData.total_results || 0;
          const serpentesSpeciesCount = serpentesData.total_results || 0;
          const turtleSpeciesCount = turtleData.total_results || 0;
          const threatenedSpeciesCount = threatenedData.total_results || 0;
          const introducedSpeciesCount = introducedData.total_results || 0;
          const endemicSpeciesCount = endemicData.total_results || 0;
          const researchGradeCount = researchGradeData.total_results || 0;

          // Get initial observation count from user data
          const observationsTotalResults = user.observations_count || 0;

          // Calculate histogram-based achievements
          const histogramAchievements = calculateHistogramAchievements(histogramData.results?.day || {});

          // Calculate conservation status achievements from threatened species
          const conservationStatusAchievements = {
            nearThreatened10: calculateStatusSpeciesAchievementFromSpeciesCounts(
              threatenedSpecies,
              ["nt", "near_threatened", "near threatened"],
              10
            ),
            vulnerable10: calculateStatusSpeciesAchievementFromSpeciesCounts(
              threatenedSpecies,
              ["vu", "vulnerable"],
              10
            ),
            endangered5: calculateStatusSpeciesAchievementFromSpeciesCounts(
              threatenedSpecies,
              ["en", "endangered"],
              5
            ),
            criticallyEndangered1: calculateStatusSpeciesAchievementFromSpeciesCounts(
              threatenedSpecies,
              ["cr", "critically_endangered", "critically endangered"],
              1
            ),
            extinctInWild1: calculateStatusSpeciesAchievementFromSpeciesCounts(
              threatenedSpecies,
              ["ew", "extinct_in_the_wild", "extinct in the wild"],
              1
            ),
          };

          // Display achievements immediately with available data (without observations)
          loading.style.display = "none";
          let result = renderAchievements(
            observationsTotalResults,
            speciesCount,
            identificationsCount,
            idCategories,
            maxSpeciesIdCount,
            maxSpeciesName,
            userCreatedAt,
            iconicTaxonSpeciesCounts,
            lepidopteraSpeciesCount,
            raptorSpeciesCount,
            beetleSpeciesCount,
            beeSpeciesCount,
            cetaceaSpeciesCount,
            anuraSpeciesCount,
            serpentesSpeciesCount,
            turtleSpeciesCount,
            threatenedSpeciesCount,
            introducedSpeciesCount,
            endemicSpeciesCount,
            researchGradeCount,
            histogramAchievements,
            conservationStatusAchievements,
            false // observationsLoaded = false
          );
          achievementsContainer.innerHTML = result.html;

          // Update achievements progress
          let percentage = Math.round(
            (result.completedCount / result.totalAchievements) * 100
          );
          achievementsProgress.textContent = `${result.completedCount}/${result.totalAchievements} (${percentage}%)`;
          achievementsProgress.classList.add("show");

          // Load all observations in the background for observation-dependent achievements
          loading.style.display = "block";
          const obsResult = await loadAllObservations(userId);
          allObservations = obsResult.observations;
          loading.style.display = "none";

          // Re-render achievements with observation data
          result = renderAchievements(
            observationsTotalResults,
            speciesCount,
            identificationsCount,
            idCategories,
            maxSpeciesIdCount,
            maxSpeciesName,
            userCreatedAt,
            iconicTaxonSpeciesCounts,
            lepidopteraSpeciesCount,
            raptorSpeciesCount,
            beetleSpeciesCount,
            beeSpeciesCount,
            cetaceaSpeciesCount,
            anuraSpeciesCount,
            serpentesSpeciesCount,
            turtleSpeciesCount,
            threatenedSpeciesCount,
            introducedSpeciesCount,
            endemicSpeciesCount,
            researchGradeCount,
            histogramAchievements,
            conservationStatusAchievements,
            true // observationsLoaded = true
          );
          achievementsContainer.innerHTML = result.html;

          // Update achievements progress again
          percentage = Math.round(
            (result.completedCount / result.totalAchievements) * 100
          );
          achievementsProgress.textContent = `${result.completedCount}/${result.totalAchievements} (${percentage}%)`;
          achievementsProgress.classList.add("show");
        } catch (error) {
          console.error("Error fetching user data:", error);
          loading.style.display = "none";
          showError("Error fetching data. Please try again.");
        }
      }

      async function loadThreatenedSpecies(userId) {
        const perPage = 500;
        let page = 1;
        let allSpecies = [];
        let hasMore = true;

        while (hasMore) {
          const url = `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&threatened=true&per_page=${perPage}&page=${page}&captive=false&verifiable=true`;
          const response = await fetch(url);
          const data = await response.json();

          if (!data.results || data.results.length === 0) {
            hasMore = false;
          } else {
            allSpecies = allSpecies.concat(data.results);

            // Check if there are more pages
            if (allSpecies.length >= data.total_results) {
              hasMore = false;
            } else {
              page++;
            }
          }
        }

        return allSpecies;
      }

      async function loadAllObservations(userId) {
        const perPage = 200;
        const today = new Date().toISOString().split("T")[0];
        const loadingCount = document.getElementById("loadingCount");
        const baseUrl = `https://api.inaturalist.org/v1/observations?user_id=${userId}&per_page=${perPage}&d2=${today}&order_by=id&order=asc&captive=false&verifiable=true`;

        // First, load initial batch to get total_results
        const firstResponse = await fetch(baseUrl);
        const firstData = await firstResponse.json();

        if (!firstData.results || firstData.results.length === 0) {
          return { observations: [], totalResults: 0 };
        }

        let allResults = firstData.results;
        const totalResults = firstData.total_results;
        let lastId = firstData.results[firstData.results.length - 1].id;

        loadingCount.textContent = `(${allResults.length.toLocaleString()} of ${totalResults.toLocaleString()} observations)`;

        // Use id_above to fetch beyond 10k limit
        while (allResults.length < totalResults) {
          const response = await fetch(`${baseUrl}&id_above=${lastId}`);
          const data = await response.json();

          if (!data.results || data.results.length === 0) {
            break;
          }

          allResults = allResults.concat(data.results);
          lastId = data.results[data.results.length - 1].id;

          loadingCount.textContent = `(${allResults.length.toLocaleString()} of ${totalResults.toLocaleString()} observations)`;
        }

        return { observations: allResults, totalResults };
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add("show");
      }

      function hideError() {
        errorMessage.classList.remove("show");
      }

      function calculateStatusSpeciesAchievement(
        observations,
        statusCodes,
        goal
      ) {
        const species = new Set();

        observations.forEach((obs) => {
          if (
            obs.taxon &&
            obs.taxon.id &&
            obs.taxon.conservation_status &&
            obs.taxon.conservation_status.status
          ) {
            const status = obs.taxon.conservation_status.status.toLowerCase();
            if (statusCodes.includes(status)) {
              species.add(obs.taxon.id);
            }
          }
        });

        return {
          current: species.size,
          total: goal,
          completed: species.size >= goal,
          taxonIds: Array.from(species),
        };
      }

      function calculateStatusSpeciesAchievementFromSpeciesCounts(
        threatenedSpecies,
        statusCodes,
        goal
      ) {
        const species = new Set();

        threatenedSpecies.forEach((speciesData) => {
          if (
            speciesData.taxon &&
            speciesData.taxon.id &&
            speciesData.taxon.conservation_status &&
            speciesData.taxon.conservation_status.status
          ) {
            const status = speciesData.taxon.conservation_status.status.toLowerCase();
            if (statusCodes.includes(status)) {
              species.add(speciesData.taxon.id);
            }
          }
        });

        return {
          current: species.size,
          total: goal,
          completed: species.size >= goal,
          taxonIds: Array.from(species),
        };
      }

      function calculateCountAchievement(current, goal) {
        return {
          current: current,
          total: goal,
          completed: current >= goal,
        };
      }

      const CONTINENTS = {
        "North America": "ü¶Ö",
        "South America": "ü¶ú",
        Europe: "ü¶å",
        Africa: "ü¶Å",
        Asia: "üêº",
        Oceania: "ü¶ò",
        Antarctica: "üêß",
      };

      function getContinent(lat, lng) {
        if (lat === null || lng === null) return null;

        // Antarctica
        if (lat < -60) return "Antarctica";

        // Oceania/Australia
        if (lat < 0 && lng > 100 && lng <= 180) return "Oceania";
        if (lat >= 0 && lat < 20 && lng > 95 && lng <= 180) return "Oceania";
        if (lat < 0 && lng >= -180 && lng < -100) return "Oceania"; // Pacific islands

        // South America
        if (lat < 15 && lat > -60 && lng > -85 && lng < -30)
          return "South America";

        // North America (including Central America and Caribbean)
        if (lat >= 7 && lat < 85 && lng >= -170 && lng < -30)
          return "North America";

        // Africa
        if (lat > -40 && lat < 38 && lng >= -20 && lng < 55) return "Africa";

        // Europe
        if (lat >= 35 && lat < 75 && lng >= -25 && lng < 65) return "Europe";

        // Asia (rest of Eastern hemisphere)
        if (lng >= 25 || lng < -150) return "Asia";

        return null;
      }

      function calculateContinentsAchievement(observations) {
        const observedContinents = new Set();

        observations.forEach((obs) => {
          const lat =
            obs.geojson?.coordinates?.[1] || obs.location?.split(",")[0];
          const lng =
            obs.geojson?.coordinates?.[0] || obs.location?.split(",")[1];

          if (lat && lng) {
            const continent = getContinent(parseFloat(lat), parseFloat(lng));
            if (continent) {
              observedContinents.add(continent);
            }
          }
        });

        const total = Object.keys(CONTINENTS).length;
        return {
          current: observedContinents.size,
          total: total,
          completed: observedContinents.size >= total,
          observedContinents: observedContinents,
        };
      }

      const SEASONS = {
        Spring: "üå∏",
        Summer: "‚òÄÔ∏è",
        Fall: "üçÇ",
        Winter: "‚ùÑÔ∏è",
      };

      function getSeason(dateStr) {
        if (!dateStr) return null;
        const date = new Date(dateStr);
        const month = date.getMonth(); // 0-11

        if (month >= 2 && month <= 4) return "Spring"; // Mar, Apr, May
        if (month >= 5 && month <= 7) return "Summer"; // Jun, Jul, Aug
        if (month >= 8 && month <= 10) return "Fall"; // Sep, Oct, Nov
        return "Winter"; // Dec, Jan, Feb
      }

      function calculateSeasonsAchievement(observations) {
        const observedSeasons = new Set();

        observations.forEach((obs) => {
          const season = getSeason(obs.observed_on);
          if (season) {
            observedSeasons.add(season);
          }
        });

        const total = Object.keys(SEASONS).length;
        return {
          current: observedSeasons.size,
          total: total,
          completed: observedSeasons.size >= total,
          observedSeasons: observedSeasons,
        };
      }

      const MONTHS = {
        Jan: "Jan",
        Feb: "Feb",
        Mar: "Mar",
        Apr: "Apr",
        May: "May",
        Jun: "Jun",
        Jul: "Jul",
        Aug: "Aug",
        Sep: "Sep",
        Oct: "Oct",
        Nov: "Nov",
        Dec: "Dec",
      };

      function calculateMonthsAchievement(observations) {
        const observedMonths = new Set();

        observations.forEach((obs) => {
          if (obs.observed_on) {
            const date = new Date(obs.observed_on);
            const monthIndex = date.getMonth();
            const monthNames = [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ];
            observedMonths.add(monthNames[monthIndex]);
          }
        });

        const total = Object.keys(MONTHS).length;
        return {
          current: observedMonths.size,
          total: total,
          completed: observedMonths.size >= total,
          observedMonths: observedMonths,
        };
      }

      function calculateSpeciesInDayAchievement(observations, goal) {
        // Group species by date
        const speciesByDate = {};

        observations.forEach((obs) => {
          if (obs.observed_on && obs.taxon && obs.taxon.id) {
            if (!speciesByDate[obs.observed_on]) {
              speciesByDate[obs.observed_on] = new Set();
            }
            speciesByDate[obs.observed_on].add(obs.taxon.id);
          }
        });

        // Find max species in a single day
        let maxSpecies = 0;
        Object.values(speciesByDate).forEach((species) => {
          maxSpecies = Math.max(maxSpecies, species.size);
        });

        return {
          current: maxSpecies,
          total: goal,
          completed: maxSpecies >= goal,
        };
      }

      function calculateVeteranAchievement(observations, years, goal) {
        const now = new Date();
        const cutoffDate = new Date(
          now.getFullYear() - years,
          now.getMonth(),
          now.getDate()
        );

        let count = 0;

        observations.forEach((obs) => {
          if (obs.observed_on) {
            const obsDate = new Date(obs.observed_on);
            if (obsDate <= cutoffDate) {
              count++;
            }
          }
        });

        return {
          current: count,
          total: goal,
          completed: count >= goal,
        };
      }

      function calculateFavoritedAchievement(observations, goal) {
        let count = 0;

        observations.forEach((obs) => {
          if (obs.faves_count && obs.faves_count > 0) {
            count++;
          }
        });

        return {
          current: count,
          total: goal,
          completed: count >= goal,
        };
      }

      function calculateMostFavoritedAchievement(observations, minFaves) {
        let count = 0;
        const obsIds = [];

        observations.forEach((obs) => {
          if (obs.faves_count && obs.faves_count >= minFaves) {
            count++;
            obsIds.push(obs.id);
          }
        });

        return {
          current: count,
          total: 1,
          completed: count >= 1,
          obsIds: obsIds,
        };
      }

      function calculateCommentedAchievement(observations, goal) {
        let count = 0;

        observations.forEach((obs) => {
          if (obs.comments_count && obs.comments_count > 0) {
            count++;
          }
        });

        return {
          current: count,
          total: goal,
          completed: count >= goal,
        };
      }

      function calculateObservationsInDayAchievement(observations, goal) {
        // Group observations by date
        const obsByDate = {};

        observations.forEach((obs) => {
          if (obs.observed_on) {
            if (!obsByDate[obs.observed_on]) {
              obsByDate[obs.observed_on] = 0;
            }
            obsByDate[obs.observed_on]++;
          }
        });

        // Find max observations in a single day
        let maxObs = 0;
        Object.values(obsByDate).forEach((count) => {
          maxObs = Math.max(maxObs, count);
        });

        return {
          current: maxObs,
          total: goal,
          completed: maxObs >= goal,
        };
      }

      function calculateRareSpeciesAchievement(
        observations,
        maxObsCount,
        goal
      ) {
        const rareSpecies = new Set();

        observations.forEach((obs) => {
          if (obs.taxon && obs.taxon.id && obs.taxon.observations_count) {
            if (obs.taxon.observations_count < maxObsCount) {
              rareSpecies.add(obs.taxon.id);
            }
          }
        });

        return {
          current: rareSpecies.size,
          total: goal,
          completed: rareSpecies.size >= goal,
          taxonIds: Array.from(rareSpecies),
        };
      }

      function calculateNewYearAchievement(observations, goal) {
        let count = 0;

        observations.forEach((obs) => {
          if (obs.observed_on) {
            const date = new Date(obs.observed_on);
            const month = date.getMonth(); // 0 = January
            const day = date.getDate();

            if (month === 0 && day === 1) {
              count++;
            }
          }
        });

        return {
          current: count,
          total: goal,
          completed: count >= goal,
        };
      }

      function calculateTimeOfDayAchievement(
        observations,
        startHour,
        endHour,
        goal
      ) {
        let count = 0;

        observations.forEach((obs) => {
          if (obs.time_observed_at) {
            let hour;

            // Use observation's timezone if available
            if (obs.observed_time_zone) {
              try {
                const date = new Date(obs.time_observed_at);
                const formatter = new Intl.DateTimeFormat("en-US", {
                  hour: "numeric",
                  hour12: false,
                  timeZone: obs.observed_time_zone,
                });
                hour = parseInt(formatter.format(date), 10);
              } catch (e) {
                // Fallback to UTC if timezone is invalid
                const date = new Date(obs.time_observed_at);
                hour = date.getUTCHours();
              }
            } else {
              // Fallback to UTC
              const date = new Date(obs.time_observed_at);
              hour = date.getUTCHours();
            }

            if (startHour < endHour) {
              // Normal range (e.g., 0-7 for early bird)
              if (hour >= startHour && hour < endHour) {
                count++;
              }
            } else {
              // Wrap around range (e.g., 20-24 for night owl)
              if (hour >= startHour || hour < endHour) {
                count++;
              }
            }
          }
        });

        return {
          current: count,
          total: goal,
          completed: count >= goal,
        };
      }

      function calculateStreakAchievement(observations, goalDays) {
        // Get all unique dates with observations
        const datesWithObs = new Set();

        observations.forEach((obs) => {
          if (obs.observed_on) {
            datesWithObs.add(obs.observed_on);
          }
        });

        // Convert to sorted array of dates
        const sortedDates = Array.from(datesWithObs).sort();

        if (sortedDates.length === 0) {
          return { current: 0, total: goalDays, completed: false };
        }

        // Calculate longest streak
        let longestStreak = 1;
        let currentStreak = 1;

        for (let i = 1; i < sortedDates.length; i++) {
          const prevDate = new Date(sortedDates[i - 1]);
          const currDate = new Date(sortedDates[i]);
          const diffDays = Math.round(
            (currDate - prevDate) / (1000 * 60 * 60 * 24)
          );

          if (diffDays === 1) {
            currentStreak++;
            longestStreak = Math.max(longestStreak, currentStreak);
          } else {
            currentStreak = 1;
          }
        }

        return {
          current: longestStreak,
          total: goalDays,
          completed: longestStreak >= goalDays,
        };
      }

      function calculateOnlyObserverAchievement(observations) {
        // Group observations by taxon and count user's observations per taxon
        const taxonCounts = {};
        const taxonGlobalCounts = {};

        observations.forEach((obs) => {
          if (obs.taxon && obs.taxon.id) {
            const taxonId = obs.taxon.id;
            taxonCounts[taxonId] = (taxonCounts[taxonId] || 0) + 1;
            taxonGlobalCounts[taxonId] = obs.taxon.observations_count || 0;
          }
        });

        // Count species where user is the only observer
        let onlyObserverCount = 0;
        const onlyObserverTaxonIds = [];
        Object.keys(taxonCounts).forEach((taxonId) => {
          const userCount = taxonCounts[taxonId];
          const globalCount = taxonGlobalCounts[taxonId];
          if (userCount === globalCount && globalCount > 0) {
            onlyObserverCount++;
            onlyObserverTaxonIds.push(taxonId);
          }
        });

        return {
          current: onlyObserverCount,
          total: 1,
          taxonIds: onlyObserverTaxonIds,
          completed: onlyObserverCount >= 1,
        };
      }

      function calculateIconicTaxonAchievement(observations) {
        const observedTaxons = new Set();

        observations.forEach((obs) => {
          if (obs.taxon && obs.taxon.iconic_taxon_name) {
            observedTaxons.add(obs.taxon.iconic_taxon_name);
          }
        });

        const taxonKeys = Object.keys(ICONIC_TAXONS);
        const count = taxonKeys.filter((taxon) =>
          observedTaxons.has(taxon)
        ).length;
        return {
          current: count,
          total: taxonKeys.length,
          completed: count === taxonKeys.length,
          observedTaxons: observedTaxons,
        };
      }

      function calculateIconicTaxonAchievementFromCounts(iconicTaxonSpeciesCounts) {
        const observedTaxons = new Set();
        const taxonKeys = Object.keys(ICONIC_TAXONS);

        // Check which iconic taxons have at least 1 species observed
        taxonKeys.forEach((taxon) => {
          const count = iconicTaxonSpeciesCounts[taxon] || 0;
          if (count > 0) {
            observedTaxons.add(taxon);
          }
        });

        return {
          current: observedTaxons.size,
          total: taxonKeys.length,
          completed: observedTaxons.size === taxonKeys.length,
          observedTaxons: observedTaxons,
        };
      }

      function calculateAccountAgeAchievement(createdAt, years) {
        if (!createdAt) {
          return { current: 0, total: 1, completed: false };
        }

        const now = new Date();
        const created = new Date(createdAt);
        const diffYears = (now - created) / (1000 * 60 * 60 * 24 * 365);

        return {
          current: diffYears >= years ? 1 : 0,
          total: 1,
          completed: diffYears >= years,
        };
      }

      function calculateHistogramAchievements(histogram) {
        // histogram is an object like: { "2020-01-01": 5, "2020-01-02": 3, ... }
        // Filter out dates with 0 observations
        const dates = Object.keys(histogram)
          .filter(date => histogram[date] > 0)
          .sort();

        if (dates.length === 0) {
          return {
            veteran2: { current: 0, total: 1, completed: false },
            veteran5: { current: 0, total: 1, completed: false },
            veteran10: { current: 0, total: 1, completed: false },
            streak7: { current: 0, total: 7, completed: false },
            streak30: { current: 0, total: 30, completed: false },
            newYear: { current: 0, total: 10, completed: false },
            monthsAchievement: { current: 0, total: 12, completed: false, observedMonths: new Set() },
            seasonsAchievement: { current: 0, total: 4, completed: false, observedSeasons: new Set() },
          };
        }

        // Veteran achievements (observations from X years ago)
        const now = new Date();
        const cutoff2Years = new Date(now.getFullYear() - 2, now.getMonth(), now.getDate());
        const cutoff5Years = new Date(now.getFullYear() - 5, now.getMonth(), now.getDate());
        const cutoff10Years = new Date(now.getFullYear() - 10, now.getMonth(), now.getDate());

        let veteran2Count = 0;
        let veteran5Count = 0;
        let veteran10Count = 0;

        dates.forEach(dateStr => {
          const date = new Date(dateStr);
          const count = histogram[dateStr];
          if (date <= cutoff2Years) veteran2Count += count;
          if (date <= cutoff5Years) veteran5Count += count;
          if (date <= cutoff10Years) veteran10Count += count;
        });

        // Streak achievements
        let longestStreak = 1;
        let currentStreak = 1;

        for (let i = 1; i < dates.length; i++) {
          const prevDate = new Date(dates[i - 1]);
          const currDate = new Date(dates[i]);
          const diffDays = Math.round((currDate - prevDate) / (1000 * 60 * 60 * 24));

          if (diffDays === 1) {
            currentStreak++;
            longestStreak = Math.max(longestStreak, currentStreak);
          } else {
            currentStreak = 1;
          }
        }

        // New Year achievement (observations on January 1st)
        let newYearCount = 0;
        dates.forEach(dateStr => {
          const date = new Date(dateStr);
          if (date.getMonth() === 0 && date.getDate() === 1) {
            newYearCount += histogram[dateStr];
          }
        });

        // Months achievement
        const observedMonths = new Set();
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        dates.forEach(dateStr => {
          const date = new Date(dateStr);
          const monthIndex = date.getMonth();
          observedMonths.add(monthNames[monthIndex]);
        });

        // Seasons achievement
        const observedSeasons = new Set();
        dates.forEach(dateStr => {
          const date = new Date(dateStr);
          const month = date.getMonth(); // 0-11
          let season;
          if (month >= 2 && month <= 4) season = "Spring";
          else if (month >= 5 && month <= 7) season = "Summer";
          else if (month >= 8 && month <= 10) season = "Fall";
          else season = "Winter";
          observedSeasons.add(season);
        });

        return {
          veteran2: { current: veteran2Count >= 1 ? 1 : 0, total: 1, completed: veteran2Count >= 1 },
          veteran5: { current: veteran5Count >= 1 ? 1 : 0, total: 1, completed: veteran5Count >= 1 },
          veteran10: { current: veteran10Count >= 1 ? 1 : 0, total: 1, completed: veteran10Count >= 1 },
          streak7: { current: longestStreak, total: 7, completed: longestStreak >= 7 },
          streak30: { current: longestStreak, total: 30, completed: longestStreak >= 30 },
          newYear: { current: newYearCount, total: 10, completed: newYearCount >= 10 },
          monthsAchievement: {
            current: observedMonths.size,
            total: 12,
            completed: observedMonths.size >= 12,
            observedMonths: observedMonths
          },
          seasonsAchievement: {
            current: observedSeasons.size,
            total: 4,
            completed: observedSeasons.size >= 4,
            observedSeasons: observedSeasons
          },
        };
      }

      function renderAchievements(
        observationsCount,
        speciesCount,
        identificationsCount,
        idCategories,
        maxSpeciesIdCount,
        maxSpeciesName,
        userCreatedAt,
        iconicTaxonSpeciesCounts,
        lepidopteraSpeciesCount,
        raptorSpeciesCount,
        beetleSpeciesCount,
        beeSpeciesCount,
        cetaceaSpeciesCount,
        anuraSpeciesCount,
        serpentesSpeciesCount,
        turtleSpeciesCount,
        threatenedSpeciesCount,
        introducedSpeciesCount,
        endemicSpeciesCount,
        researchGradeCount,
        histogramAchievements,
        conservationStatusAchievements,
        observationsLoaded = true
      ) {
        // Calculate iconic taxon achievement from species counts (not observations)
        const iconicTaxonAchievement = calculateIconicTaxonAchievementFromCounts(iconicTaxonSpeciesCounts);
        const iconicPercentage =
          (iconicTaxonAchievement.current / iconicTaxonAchievement.total) * 100;

        const threatened10 = {
          current: threatenedSpeciesCount,
          total: 10,
          completed: threatenedSpeciesCount >= 10,
        };
        const threatened50 = {
          current: threatenedSpeciesCount,
          total: 50,
          completed: threatenedSpeciesCount >= 50,
        };
        const threatened100 = {
          current: threatenedSpeciesCount,
          total: 100,
          completed: threatenedSpeciesCount >= 100,
        };

        // Use conservation status achievements from API data
        const nearThreatened10 = conservationStatusAchievements.nearThreatened10;
        const vulnerable10 = conservationStatusAchievements.vulnerable10;
        const endangered5 = conservationStatusAchievements.endangered5;
        const criticallyEndangered1 = conservationStatusAchievements.criticallyEndangered1;
        const extinctInWild1 = conservationStatusAchievements.extinctInWild1;

        // Introduced species achievements
        const introduced10 = {
          current: introducedSpeciesCount,
          total: 10,
          completed: introducedSpeciesCount >= 10,
        };
        const introduced50 = {
          current: introducedSpeciesCount,
          total: 50,
          completed: introducedSpeciesCount >= 50,
        };
        const introduced100 = {
          current: introducedSpeciesCount,
          total: 100,
          completed: introducedSpeciesCount >= 100,
        };

        // Endemic species achievement
        const endemic10 = {
          current: endemicSpeciesCount,
          total: 10,
          completed: endemicSpeciesCount >= 10,
        };

        // Observation achievements
        const obs100 = calculateCountAchievement(observationsCount, 100);
        const obs1000 = calculateCountAchievement(observationsCount, 1000);
        const obs10000 = calculateCountAchievement(observationsCount, 10000);

        // Research Grade observation achievements
        const researchGrade100 = {
          current: researchGradeCount,
          total: 100,
          completed: researchGradeCount >= 100,
        };
        const researchGrade1000 = {
          current: researchGradeCount,
          total: 1000,
          completed: researchGradeCount >= 1000,
        };
        const researchGrade10000 = {
          current: researchGradeCount,
          total: 10000,
          completed: researchGradeCount >= 10000,
        };

        // Species achievements
        const species100 = calculateCountAchievement(speciesCount, 100);
        const species1000 = calculateCountAchievement(speciesCount, 1000);
        const species10000 = calculateCountAchievement(speciesCount, 10000);

        // Identification achievements
        const ids100 = calculateCountAchievement(identificationsCount, 100);
        const ids1000 = calculateCountAchievement(identificationsCount, 1000);
        const ids10000 = calculateCountAchievement(identificationsCount, 10000);

        // Identification category achievements (for others' observations)
        const idsSupporting100 = calculateCountAchievement(
          idCategories.supporting || 0,
          100
        );
        const idsSupporting1000 = calculateCountAchievement(
          idCategories.supporting || 0,
          1000
        );
        const idsImproving100 = calculateCountAchievement(
          idCategories.improving || 0,
          100
        );
        const idsImproving1000 = calculateCountAchievement(
          idCategories.improving || 0,
          1000
        );
        const idsLeading100 = calculateCountAchievement(
          idCategories.leading || 0,
          100
        );
        const idsLeading1000 = calculateCountAchievement(
          idCategories.leading || 0,
          1000
        );

        // Species identification expert achievements
        const idsSpecies100 = calculateCountAchievement(maxSpeciesIdCount, 100);
        const idsSpecies1000 = calculateCountAchievement(
          maxSpeciesIdCount,
          1000
        );

        // Only observer achievement
        const onlyObserver = calculateOnlyObserverAchievement(allObservations);

        // Continents achievement
        const continentsAchievement =
          calculateContinentsAchievement(allObservations);

        // Use histogram-based achievements for seasons, months, and streaks
        const seasonsAchievement = histogramAchievements.seasonsAchievement;
        const monthsAchievement = histogramAchievements.monthsAchievement;
        const streak7 = histogramAchievements.streak7;
        const streak30 = histogramAchievements.streak30;

        // Time of day achievements
        const earlyBird = calculateTimeOfDayAchievement(
          allObservations,
          0,
          7,
          50
        );
        const nightOwl = calculateTimeOfDayAchievement(
          allObservations,
          20,
          24,
          50
        );

        // Use histogram-based achievements for New Year and Veteran
        const newYear = histogramAchievements.newYear;
        const veteran2 = histogramAchievements.veteran2;
        const veteran5 = histogramAchievements.veteran5;
        const veteran10 = histogramAchievements.veteran10;

        // Account age achievements
        const account2 = calculateAccountAgeAchievement(userCreatedAt, 2);
        const account5 = calculateAccountAgeAchievement(userCreatedAt, 5);
        const account10 = calculateAccountAgeAchievement(userCreatedAt, 10);

        // Favorited and commented achievements
        const favorited10 = calculateFavoritedAchievement(allObservations, 10);
        const mostFavorited10 = calculateMostFavoritedAchievement(
          allObservations,
          10
        );
        const commented10 = calculateCommentedAchievement(allObservations, 10);

        // Rare species achievements
        const rareSpecies100 = calculateRareSpeciesAchievement(
          allObservations,
          100,
          10
        );
        const rareSpecies10 = calculateRareSpeciesAchievement(
          allObservations,
          10,
          10
        );

        // Species in a day achievements
        const speciesDay10 = calculateSpeciesInDayAchievement(
          allObservations,
          10
        );
        const speciesDay100 = calculateSpeciesInDayAchievement(
          allObservations,
          100
        );

        // Observations in a day achievement
        const obsDay100 = calculateObservationsInDayAchievement(
          allObservations,
          100
        );

        // Species per iconic taxon achievements (100 each)
        const taxonAchievements = {};
        Object.keys(ICONIC_TAXONS).forEach((taxon) => {
          const count = iconicTaxonSpeciesCounts[taxon] || 0;
          taxonAchievements[taxon] = {
            current: count,
            total: 100,
            completed: count >= 100,
          };
        });

        // New specialty achievements
        const lepidopterist = {
          current: lepidopteraSpeciesCount,
          total: 100,
          completed: lepidopteraSpeciesCount >= 100,
        };
        const raptorWatcher = {
          current: raptorSpeciesCount,
          total: 25,
          completed: raptorSpeciesCount >= 25,
        };
        const coleopterist = {
          current: beetleSpeciesCount,
          total: 50,
          completed: beetleSpeciesCount >= 50,
        };
        const pollinatorPal = {
          current: beeSpeciesCount,
          total: 50,
          completed: beeSpeciesCount >= 50,
        };
        const whaleWatcher = {
          current: cetaceaSpeciesCount,
          total: 10,
          completed: cetaceaSpeciesCount >= 10,
        };
        const frogFinder = {
          current: anuraSpeciesCount,
          total: 25,
          completed: anuraSpeciesCount >= 25,
        };
        const snakeSpotter = {
          current: serpentesSpeciesCount,
          total: 25,
          completed: serpentesSpeciesCount >= 25,
        };
        const shellSeeker = {
          current: turtleSpeciesCount,
          total: 15,
          completed: turtleSpeciesCount >= 15,
        };

        const taxonIconsHtml = Object.entries(ICONIC_TAXONS)
          .map(([key, value]) => {
            const isObserved = iconicTaxonAchievement.observedTaxons.has(key);
            return `
              <div class="taxon-icon ${isObserved ? "observed" : ""}" title="${
              value.name
            }">
                ${value.emoji}
              </div>
            `;
          })
          .join("");

        const continentIconsHtml = Object.entries(CONTINENTS)
          .map(([name, emoji]) => {
            const isObserved =
              continentsAchievement.observedContinents.has(name);
            return `
              <div class="taxon-icon continent-icon ${
                isObserved ? "observed" : ""
              }" title="${name}">
                ${emoji}
              </div>
            `;
          })
          .join("");

        const seasonIconsHtml = Object.entries(SEASONS)
          .map(([name, emoji]) => {
            const isObserved = seasonsAchievement.observedSeasons.has(name);
            return `
              <div class="taxon-icon ${
                isObserved ? "observed" : ""
              }" title="${name}">
                ${emoji}
              </div>
            `;
          })
          .join("");

        const monthIconsHtml = Object.entries(MONTHS)
          .map(([name, label]) => {
            const isObserved = monthsAchievement.observedMonths.has(name);
            return `
              <div class="taxon-icon month-icon ${
                isObserved ? "observed" : ""
              }" title="${name}">
                ${label}
              </div>
            `;
          })
          .join("");

        // Count total achievements
        const allAchievements = [
          obs100,
          obs1000,
          obs10000,
          researchGrade100,
          researchGrade1000,
          researchGrade10000,
          species100,
          species1000,
          species10000,
          ids100,
          ids1000,
          ids10000,
          idsSupporting100,
          idsSupporting1000,
          idsImproving100,
          idsImproving1000,
          idsLeading100,
          idsLeading1000,
          idsSpecies100,
          idsSpecies1000,
          threatened10,
          threatened50,
          threatened100,
          nearThreatened10,
          vulnerable10,
          endangered5,
          criticallyEndangered1,
          extinctInWild1,
          introduced10,
          introduced50,
          introduced100,
          endemic10,
          onlyObserver,
          iconicTaxonAchievement,
          continentsAchievement,
          seasonsAchievement,
          monthsAchievement,
          streak7,
          streak30,
          earlyBird,
          nightOwl,
          newYear,
          speciesDay10,
          speciesDay100,
          obsDay100,
          veteran2,
          veteran5,
          veteran10,
          account2,
          account5,
          account10,
          favorited10,
          mostFavorited10,
          commented10,
          rareSpecies100,
          rareSpecies10,
          lepidopterist,
          raptorWatcher,
          coleopterist,
          pollinatorPal,
          whaleWatcher,
          frogFinder,
          snakeSpotter,
          shellSeeker,
          ...Object.values(taxonAchievements),
        ];
        const completedCount = allAchievements.filter(
          (a) => a.completed
        ).length;
        const totalAchievements = allAchievements.length;

        function renderAchievementCard(
          achievement,
          icon,
          name,
          description,
          link = null,
          isLoading = false
        ) {
          const percentage = Math.min(
            (achievement.current / achievement.total) * 100,
            100
          );
          const linkStart = link
            ? `<a href="${link}" target="_blank" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 14px; flex: 1;">`
            : "";
          const linkEnd = link ? "</a>" : "";
          const loadingClass = isLoading ? "loading" : "";

          if (link) {
            return `
              <div class="achievement-card ${
                achievement.completed ? "completed" : ""
              } ${loadingClass}" style="cursor: pointer;">
                ${linkStart}
                <div class="achievement-icon">${icon}</div>
                <div class="achievement-content">
                  <div class="achievement-name">${name}</div>
                  <div class="achievement-description">${description}</div>
                  <div class="achievement-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${percentage}%"></div>
                    </div>
                    <div class="progress-text">${achievement.current.toLocaleString()}/${achievement.total.toLocaleString()}</div>
                  </div>
                </div>
                ${linkEnd}
              </div>
            `;
          }

          return `
            <div class="achievement-card ${
              achievement.completed ? "completed" : ""
            } ${loadingClass}">
              <div class="achievement-icon">${icon}</div>
              <div class="achievement-content">
                <div class="achievement-name">${name}</div>
                <div class="achievement-description">${description}</div>
                <div class="achievement-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${percentage}%"></div>
                  </div>
                  <div class="progress-text">${achievement.current.toLocaleString()}/${achievement.total.toLocaleString()}</div>
                </div>
              </div>
            </div>
          `;
        }

        const html = `
          <div class="achievements-section">
            <h3 class="category-title">Milestones</h3>
            <div class="achievements-grid">
              ${renderAchievementCard(
                obs100,
                "üì∑",
                "Observer",
                "Record 100 observations",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}`
              )}
              ${renderAchievementCard(
                obs1000,
                "üì∑",
                "Dedicated Observer",
                "Record 1,000 observations",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}`
              )}
              ${renderAchievementCard(
                obs10000,
                "üì∑",
                "Master Observer",
                "Record 10,000 observations",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}`
              )}
              ${renderAchievementCard(
                researchGrade100,
                "‚úÖ",
                "Quality Contributor",
                "Have 100 research grade observations",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&quality_grade=research`
              )}
              ${renderAchievementCard(
                researchGrade1000,
                "‚úÖ",
                "Quality Expert",
                "Have 1,000 research grade observations",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&quality_grade=research`
              )}
              ${renderAchievementCard(
                researchGrade10000,
                "‚úÖ",
                "Quality Master",
                "Have 10,000 research grade observations",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&quality_grade=research`
              )}
              ${renderAchievementCard(
                species100,
                "üî¨",
                "Species Spotter",
                "Observe 100 species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&view=species`
              )}
              ${renderAchievementCard(
                species1000,
                "üî¨",
                "Species Expert",
                "Observe 1,000 species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&view=species`
              )}
              ${renderAchievementCard(
                species10000,
                "üî¨",
                "Species Master",
                "Observe 10,000 species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&view=species`
              )}
              ${renderAchievementCard(
                veteran2,
                "üéñÔ∏è",
                "2-Year Veteran",
                "Have an observation from 2+ years ago",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&d2=${
                  new Date(
                    new Date().setFullYear(new Date().getFullYear() - 2) -
                      86400000
                  )
                    .toISOString()
                    .split("T")[0]
                }`,
                false
              )}
              ${renderAchievementCard(
                veteran5,
                "üéñÔ∏è",
                "5-Year Veteran",
                "Have an observation from 5+ years ago",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&d2=${
                  new Date(
                    new Date().setFullYear(new Date().getFullYear() - 5) -
                      86400000
                  )
                    .toISOString()
                    .split("T")[0]
                }`,
                false
              )}
              ${renderAchievementCard(
                veteran10,
                "üèÖ",
                "10-Year Veteran",
                "Have an observation from 10+ years ago",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&d2=${
                  new Date(
                    new Date().setFullYear(new Date().getFullYear() - 10) -
                      86400000
                  )
                    .toISOString()
                    .split("T")[0]
                }`,
                false
              )}
              ${renderAchievementCard(
                account2,
                "üìÖ",
                "2-Year Member",
                "Have an account for 2+ years"
              )}
              ${renderAchievementCard(
                account5,
                "üìÖ",
                "5-Year Member",
                "Have an account for 5+ years"
              )}
              ${renderAchievementCard(
                account10,
                "üìÖ",
                "10-Year Member",
                "Have an account for 10+ years"
              )}
            </div>

            <h3 class="category-title">Conservation</h3>
            <div class="achievements-grid">
              ${renderAchievementCard(
                threatened10,
                "ü¶Å",
                "Conservation Ally",
                "Observe 10 threatened species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&threatened=true&view=species`,
                false
              )}
              ${renderAchievementCard(
                threatened50,
                "ü¶Å",
                "Conservation Champion",
                "Observe 50 threatened species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&threatened=true&view=species`,
                false
              )}
              ${renderAchievementCard(
                threatened100,
                "ü¶Å",
                "Conservation Hero",
                "Observe 100 threatened species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&threatened=true&view=species`,
                false
              )}
              ${renderAchievementCard(
                nearThreatened10,
                "üëÅÔ∏è",
                "Near Threatened Spotter",
                "Observe 10 near threatened species",
                nearThreatened10.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${nearThreatened10.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
              ${renderAchievementCard(
                vulnerable10,
                "üõ°Ô∏è",
                "Vulnerable Spotter",
                "Observe 10 vulnerable species",
                vulnerable10.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${vulnerable10.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
              ${renderAchievementCard(
                endangered5,
                "üö®",
                "Endangered Spotter",
                "Observe 5 endangered species",
                endangered5.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${endangered5.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
              ${renderAchievementCard(
                criticallyEndangered1,
                "‚ö†Ô∏è",
                "Critically Endangered Spotter",
                "Observe 1 critically endangered species",
                criticallyEndangered1.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${criticallyEndangered1.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
              ${renderAchievementCard(
                extinctInWild1,
                "üíÄ",
                "Extinct in Wild Spotter",
                "Observe 1 species extinct in the wild",
                extinctInWild1.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${extinctInWild1.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                false
              )}
              ${renderAchievementCard(
                introduced10,
                "üåç",
                "Invasive Spotter",
                "Observe 10 introduced species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&introduced=true&view=species`,
                false
              )}
              ${renderAchievementCard(
                introduced50,
                "üåç",
                "Invasive Tracker",
                "Observe 50 introduced species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&introduced=true&view=species`,
                false
              )}
              ${renderAchievementCard(
                introduced100,
                "üåç",
                "Invasive Expert",
                "Observe 100 introduced species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&introduced=true&view=species`,
                false
              )}
              ${renderAchievementCard(
                endemic10,
                "üèùÔ∏è",
                "Endemic Explorer",
                "Observe 10 endemic species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&endemic=true&view=species`,
                false
              )}
            </div>

            <h3 class="category-title">Rarity</h3>
            <div class="achievements-grid">
              ${renderAchievementCard(
                onlyObserver,
                "‚≠ê",
                "Rare Find",
                "Be the only observer of a species",
                onlyObserver.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${onlyObserver.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                !observationsLoaded
              )}
              ${renderAchievementCard(
                rareSpecies100,
                "üíé",
                "Diamond Hunter",
                "Observe 10 species with less than 100 total observations",
                rareSpecies100.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${rareSpecies100.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                !observationsLoaded
              )}
              ${renderAchievementCard(
                rareSpecies10,
                "ü¶Ñ",
                "Unicorn Spotter",
                "Observe 10 species with less than 10 total observations",
                rareSpecies10.taxonIds.length > 0
                  ? `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=${rareSpecies10.taxonIds.join(
                      ","
                    )}&view=species`
                  : null,
                !observationsLoaded
              )}
            </div>

            <h3 class="category-title">Time & Dedication</h3>
            <div class="achievements-grid">
              ${renderAchievementCard(
                streak7,
                "üî•",
                "Week Warrior",
                "7-day observation streak",
                null,
                false
              )}
              ${renderAchievementCard(
                streak30,
                "üî•",
                "Monthly Dedication",
                "30-day observation streak",
                null,
                false
              )}
              ${renderAchievementCard(
                earlyBird,
                "üåÖ",
                "Early Bird",
                "50 observations before 7am",
                null,
                !observationsLoaded
              )}
              ${renderAchievementCard(
                nightOwl,
                "ü¶â",
                "Night Owl",
                "50 observations after 8pm",
                null,
                !observationsLoaded
              )}
              ${renderAchievementCard(
                newYear,
                "üéÜ",
                "New Year, New Observations",
                "10 observations on January 1st",
                null,
                false
              )}
              ${renderAchievementCard(
                speciesDay10,
                "üåà",
                "Diversity Day",
                "10 species in a single day",
                null,
                !observationsLoaded
              )}
              ${renderAchievementCard(
                speciesDay100,
                "üåà",
                "Biodiversity Blitz",
                "100 species in a single day",
                null,
                !observationsLoaded
              )}
              ${renderAchievementCard(
                obsDay100,
                "üì∏",
                "Photo Marathon",
                "100 observations in a single day",
                null,
                !observationsLoaded
              )}
            </div>

            <h3 class="category-title">Community</h3>
            <div class="achievements-grid">
              ${renderAchievementCard(
                favorited10,
                "‚ù§Ô∏è",
                "Fan Favorite",
                "Have 10 observations that were favorited",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&popular=true`,
                !observationsLoaded
              )}
              ${renderAchievementCard(
                mostFavorited10,
                "üåü",
                "Superstar",
                "Have an observation with 10+ favorites",
                mostFavorited10.obsIds && mostFavorited10.obsIds.length > 0
                  ? `https://www.inaturalist.org/observations?id=${mostFavorited10.obsIds.join(",")}`
                  : null,
                !observationsLoaded
              )}
              ${renderAchievementCard(
                commented10,
                "üí¨",
                "Conversation Starter",
                "Have 10 observations that received comments",
                null,
                !observationsLoaded
              )}
            </div>

            <h3 class="category-title">Identifications</h3>
            <div class="achievements-grid">
              ${renderAchievementCard(
                ids100,
                "üè∑Ô∏è",
                "Identifier",
                "Make 100 identifications"
              )}
              ${renderAchievementCard(
                ids1000,
                "üè∑Ô∏è",
                "Dedicated Identifier",
                "Make 1,000 identifications"
              )}
              ${renderAchievementCard(
                ids10000,
                "üè∑Ô∏è",
                "Master Identifier",
                "Make 10,000 identifications"
              )}
              ${renderAchievementCard(
                idsSupporting100,
                "üëç",
                "Supporter",
                "Make 100 supporting identifications"
              )}
              ${renderAchievementCard(
                idsSupporting1000,
                "üëç",
                "Super Supporter",
                "Make 1,000 supporting identifications"
              )}
              ${renderAchievementCard(
                idsImproving100,
                "üìà",
                "Improver",
                "Make 100 improving identifications"
              )}
              ${renderAchievementCard(
                idsImproving1000,
                "üìà",
                "Super Improver",
                "Make 1,000 improving identifications"
              )}
              ${renderAchievementCard(
                idsLeading100,
                "ü•á",
                "Leader",
                "Make 100 leading identifications"
              )}
              ${renderAchievementCard(
                idsLeading1000,
                "ü•á",
                "Super Leader",
                "Make 1,000 leading identifications"
              )}
              ${renderAchievementCard(
                idsSpecies100,
                "üîç",
                "Species Specialist",
                `Identify a species 100 times${
                  maxSpeciesName ? ` (${maxSpeciesName})` : ""
                }`
              )}
              ${renderAchievementCard(
                idsSpecies1000,
                "üîç",
                "Species Expert",
                `Identify a species 1,000 times${
                  maxSpeciesName ? ` (${maxSpeciesName})` : ""
                }`
              )}
            </div>

            <h3 class="category-title">Taxonomy</h3>
            <div class="achievements-grid">
              ${Object.entries(ICONIC_TAXONS)
                .map(([taxon, data]) =>
                  renderAchievementCard(
                    taxonAchievements[taxon],
                    data.emoji,
                    `${data.name} Expert`,
                    `Observe 100 ${data.name.toLowerCase()} species`,
                    `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=${data.id}&view=species`
                  )
                )
                .join("")}
              <div class="achievement-card ${
                iconicTaxonAchievement.completed ? "completed" : ""
              }">
                <div class="achievement-icon">üåç</div>
                <div class="achievement-content">
                  <div class="achievement-name">Biodiversity Explorer</div>
                  <div class="achievement-description">Observe all iconic taxons</div>
                  <div class="achievement-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${iconicPercentage}%"></div>
                    </div>
                    <div class="progress-text">${
                      iconicTaxonAchievement.current
                    }/${iconicTaxonAchievement.total}</div>
                  </div>
                  <div class="taxon-icons">${taxonIconsHtml}</div>
                </div>
              </div>
              ${renderAchievementCard(
                lepidopterist,
                "ü¶ã",
                "Lepidopterist",
                "Observe 100 butterfly & moth species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=47157&view=species`
              )}
              ${renderAchievementCard(
                raptorWatcher,
                "ü¶Ö",
                "Raptor Watcher",
                "Observe 25 birds of prey species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_ids=71261,67570,19350,559244&view=species`
              )}
              ${renderAchievementCard(
                coleopterist,
                "ü™≤",
                "Coleopterist",
                "Observe 50 beetle species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=47208&view=species`
              )}
              ${renderAchievementCard(
                pollinatorPal,
                "üêù",
                "Pollinator Pal",
                "Observe 50 bee species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=630955&view=species`
              )}
              ${renderAchievementCard(
                whaleWatcher,
                "üêã",
                "Whale Watcher",
                "Observe 10 whale & dolphin species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=152871&view=species`
              )}
              ${renderAchievementCard(
                frogFinder,
                "üê∏",
                "Frog Finder",
                "Observe 25 frog & toad species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=20979&view=species`
              )}
              ${renderAchievementCard(
                snakeSpotter,
                "üêç",
                "Snake Spotter",
                "Observe 25 snake species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=85553&view=species`
              )}
              ${renderAchievementCard(
                shellSeeker,
                "üê¢",
                "Shell Seeker",
                "Observe 15 turtle & tortoise species",
                `https://www.inaturalist.org/observations?user_id=${currentUsername}&taxon_id=39532&view=species`
              )}
            </div>

            <h3 class="category-title">Geography & Seasons</h3>
            <div class="achievements-grid">
              <div class="achievement-card ${
                continentsAchievement.completed ? "completed" : ""
              } ${!observationsLoaded ? "loading" : ""}">
                <div class="achievement-icon">‚úàÔ∏è</div>
                <div class="achievement-content">
                  <div class="achievement-name">World Traveler</div>
                  <div class="achievement-description">Observe in all 7 continents</div>
                  <div class="achievement-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${
                        (continentsAchievement.current /
                          continentsAchievement.total) *
                        100
                      }%"></div>
                    </div>
                    <div class="progress-text">${
                      continentsAchievement.current
                    }/${continentsAchievement.total}</div>
                  </div>
                  <div class="taxon-icons">${continentIconsHtml}</div>
                </div>
              </div>
              <div class="achievement-card ${
                seasonsAchievement.completed ? "completed" : ""
              }">
                <div class="achievement-icon">üìÖ</div>
                <div class="achievement-content">
                  <div class="achievement-name">Year-Round Observer</div>
                  <div class="achievement-description">Observe in all 4 seasons</div>
                  <div class="achievement-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${
                        (seasonsAchievement.current /
                          seasonsAchievement.total) *
                        100
                      }%"></div>
                    </div>
                    <div class="progress-text">${seasonsAchievement.current}/${
          seasonsAchievement.total
        }</div>
                  </div>
                  <div class="taxon-icons">${seasonIconsHtml}</div>
                </div>
              </div>
              <div class="achievement-card ${
                monthsAchievement.completed ? "completed" : ""
              }">
                <div class="achievement-icon">üìÜ</div>
                <div class="achievement-content">
                  <div class="achievement-name">Monthly Observer</div>
                  <div class="achievement-description">Observe in all 12 months</div>
                  <div class="achievement-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${
                        (monthsAchievement.current / monthsAchievement.total) *
                        100
                      }%"></div>
                    </div>
                    <div class="progress-text">${monthsAchievement.current}/${
          monthsAchievement.total
        }</div>
                  </div>
                  <div class="taxon-icons">${monthIconsHtml}</div>
                </div>
              </div>
            </div>
          </div>
        `;

        return { html, completedCount, totalAchievements };
      }
    </script>
    <script>
      // Dark mode functionality
      const darkModeToggle = document.getElementById("darkModeToggle");

      // Load dark mode preference from localStorage
      if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark-mode");
        darkModeToggle.textContent = "‚òÄÔ∏è";
      }

      // Toggle dark mode
      darkModeToggle.addEventListener("click", () => {
        document.body.classList.toggle("dark-mode");
        const isDarkMode = document.body.classList.contains("dark-mode");
        localStorage.setItem("darkMode", isDarkMode);
        darkModeToggle.textContent = isDarkMode ? "‚òÄÔ∏è" : "üåô";
      });
    </script>
    <script
      defer
      data-domain="glauberramos.github.io/inat"
      src="https://plausible.io/js/script.js"
    ></script>
    <script type="text/javascript">
      window.$pipeback = [];
      window.PIPEBACK_ID = "a069b910-4aef-4233-99cc-913e7fb30fb5";
      (function () {
        d = document;
        s = d.createElement("script");
        s.src = "https://widget.pipeback.com/l.js";
        s.async = 1;
        d.getElementsByTagName("head")[0].appendChild(s);
      })();
    </script>
  </body>
</html>
