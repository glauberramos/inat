<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Achievements - iNaturalist</title>
    <link rel="icon" href="favicon.ico" />
    <meta
      name="description"
      content="View iNaturalist user achievements and milestones"
    />
    <link rel="stylesheet" href="styles.css" />
    <style>
      .summary-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #ddd;
        padding: 15px 20px;
        display: flex;
        gap: 20px;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
      }

      .summary-search {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .summary-stats {
        display: none;
        gap: 20px;
        align-items: center;
      }

      .summary-stats.show {
        display: flex;
      }

      .summary-stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .summary-stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #74ac00;
      }

      .summary-stat-label {
        font-size: 0.9rem;
        color: #666;
      }

      .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 12px;
        border-radius: 4px;
        margin: 16px 0;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      #achievementsContainer {
        margin-top: 30px;
      }

      .stats-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #ddd;
        padding: 30px;
        display: flex;
        gap: 40px;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
      }

      .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }

      .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #74ac00;
      }

      .stat-label {
        font-size: 1rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .achievements-section {
        margin-top: 30px;
      }

      .achievements-title {
        font-size: 1.5rem;
        color: #2c3e50;
        margin-bottom: 20px;
        text-align: center;
      }

      .achievements-count {
        font-size: 1rem;
        color: #74ac00;
        font-weight: 600;
        background: #e8f5e9;
        padding: 4px 10px;
        border-radius: 12px;
        margin-left: 8px;
      }

      .achievements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 15px;
      }

      .achievement-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #ddd;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .achievement-card.completed {
        border: 3px solid #74ac00;
        background: linear-gradient(to right, rgba(116, 172, 0, 0.1), white);
        box-shadow: 0 2px 8px rgba(116, 172, 0, 0.25);
      }

      .achievement-icon {
        font-size: 2rem;
      }

      .achievement-content {
        flex: 1;
        min-width: 0;
      }

      .achievement-name {
        font-size: 1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 3px;
      }

      .achievement-description {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 8px;
      }

      .achievement-progress {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .progress-bar {
        flex: 1;
        height: 8px;
        background: #eee;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: #74ac00;
        border-radius: 4px;
        transition: width 0.3s;
      }

      .progress-text {
        font-size: 0.9rem;
        font-weight: 600;
        color: #74ac00;
        min-width: 50px;
      }

      .taxon-icons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
      }

      .taxon-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        background: #f5f5f5;
        opacity: 0.3;
        filter: grayscale(100%);
        transition: all 0.3s;
      }

      .taxon-icon.observed {
        opacity: 1;
        filter: grayscale(0%);
        background: #e8f5e9;
      }

      .taxon-icon.observed::after {
        display: none;
      }

      .taxon-icon:hover {
        transform: scale(1.1);
      }

      .taxon-icon.month-icon {
        font-size: 0.75rem;
        font-weight: 600;
        color: #999;
      }

      .taxon-icon.month-icon.observed {
        color: #74ac00;
      }

    </style>
  </head>
  <body>
    <a
      href="/inat"
      style="
        position: fixed;
        top: 20px;
        left: 20px;
        background: #74ac00;
        color: white;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 10px 16px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
      "
      onmouseover="this.style.background='#659900'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.2)'"
      onmouseout="this.style.background='#74ac00'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.15)'"
    >
      <span style="font-size: 1rem">‚Üê</span> More iNat tools
    </a>
    <div
      style="
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: white;
        text-align: center;
        padding: 12px 20px;
        font-size: 0.9rem;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      "
    >
      <span style="margin-right: 8px">üöß</span> This feature is still in beta -
      some achievements may not work as expected
    </div>
    <div class="container">
      <header>
        <div class="header-content">
          <div class="title-container">
            <img src="logo.png" alt="iNaturalist Logo" class="logo" />
            <h1>Achievements</h1>
          </div>
          <p class="description">
            Track your iNaturalist milestones and achievements
          </p>
        </div>
        <div class="error-message" id="errorMessage"></div>
      </header>

      <main>
        <div class="summary-card" id="summaryCard">
          <div class="summary-search">
            <div class="username-search-container" style="width: 300px">
              <input
                type="text"
                id="usernameInput"
                placeholder="Enter iNaturalist username..."
                autocomplete="off"
                style="width: 100%"
              />
              <div
                id="usernameAutocomplete"
                class="username-autocomplete"
              ></div>
            </div>
            <button id="loadButton">Load</button>
          </div>
          <div class="summary-stats" id="summaryStats">
            <div class="summary-stat-item">
              <div class="summary-stat-value" id="totalObservations">0</div>
              <div class="summary-stat-label">Observations</div>
            </div>
            <div class="summary-stat-item">
              <div class="summary-stat-value" id="totalSpecies">0</div>
              <div class="summary-stat-label">Species</div>
            </div>
          </div>
        </div>

        <div class="loading" id="loading" style="display: none">
          Loading... <span id="loadingCount"></span>
        </div>
        <div id="achievementsContainer"></div>
      </main>
    </div>
    <footer
      style="text-align: center; padding: 40px 20px 20px; margin-top: 40px"
    >
      <img
        src="powered_by.png"
        alt="Powered By"
        style="max-width: 180px; height: auto; opacity: 0.8"
      />
    </footer>
    <script>
      const usernameInput = document.getElementById("usernameInput");
      const usernameAutocomplete = document.getElementById(
        "usernameAutocomplete"
      );
      const loadButton = document.getElementById("loadButton");
      const loading = document.getElementById("loading");
      const achievementsContainer = document.getElementById(
        "achievementsContainer"
      );
      const errorMessage = document.getElementById("errorMessage");
      const summaryStats = document.getElementById("summaryStats");
      const totalObservationsEl = document.getElementById("totalObservations");
      const totalSpeciesEl = document.getElementById("totalSpecies");

      let searchTimeout = null;
      let allObservations = [];

      // All iconic taxons in iNaturalist with emojis
      const ICONIC_TAXONS = {
        Plantae: { emoji: "üåø", name: "Plants" },
        Fungi: { emoji: "üçÑ", name: "Fungi" },
        Animalia: { emoji: "üêæ", name: "Other Animals" },
        Mollusca: { emoji: "üêå", name: "Mollusks" },
        Arachnida: { emoji: "üï∑Ô∏è", name: "Arachnids" },
        Insecta: { emoji: "ü¶ã", name: "Insects" },
        Actinopterygii: { emoji: "üêü", name: "Fish" },
        Amphibia: { emoji: "üê∏", name: "Amphibians" },
        Reptilia: { emoji: "ü¶é", name: "Reptiles" },
        Aves: { emoji: "üê¶", name: "Birds" },
        Mammalia: { emoji: "ü¶å", name: "Mammals" },
      };

      // Load saved username from localStorage (shared with other tools)
      const savedUsername = localStorage.getItem("inatUsername");
      if (savedUsername) {
        usernameInput.value = savedUsername;
        loadUserData();
      }

      // Username autocomplete
      usernameInput.addEventListener("input", (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();

        if (query.length < 2) {
          usernameAutocomplete.innerHTML = "";
          usernameAutocomplete.style.display = "none";
          return;
        }

        searchTimeout = setTimeout(async () => {
          try {
            const response = await fetch(
              `https://api.inaturalist.org/v1/users/autocomplete?q=${encodeURIComponent(
                query
              )}`
            );
            const data = await response.json();

            if (data.results && data.results.length > 0) {
              usernameAutocomplete.innerHTML = data.results
                .slice(0, 10)
                .map((user) => {
                  const obsCount = user.observations_count || 0;
                  return `
                    <div class="username-suggestion" data-login="${user.login}">
                      <div class="username-name">${user.login}</div>
                      <div class="username-info">${obsCount.toLocaleString()} observations</div>
                    </div>
                  `;
                })
                .join("");
              usernameAutocomplete.style.display = "block";

              document
                .querySelectorAll(".username-suggestion")
                .forEach((item) => {
                  item.addEventListener("click", () => {
                    usernameInput.value = item.dataset.login;
                    usernameAutocomplete.innerHTML = "";
                    usernameAutocomplete.style.display = "none";
                    loadUserData();
                  });
                });
            } else {
              usernameAutocomplete.innerHTML = "";
              usernameAutocomplete.style.display = "none";
            }
          } catch (error) {
            console.error("Error fetching users:", error);
            usernameAutocomplete.innerHTML = "";
            usernameAutocomplete.style.display = "none";
          }
        }, 300);
      });

      // Hide autocomplete when clicking outside
      document.addEventListener("click", (e) => {
        if (
          !usernameInput.contains(e.target) &&
          !usernameAutocomplete.contains(e.target)
        ) {
          usernameAutocomplete.style.display = "none";
        }
      });

      // Load button handler
      loadButton.addEventListener("click", () => {
        loadUserData();
      });

      // Enter key handler
      usernameInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          loadUserData();
        }
      });

      async function loadUserData() {
        const username = usernameInput.value.trim();

        if (!username) {
          showError("Please enter a username");
          return;
        }

        hideError();
        loading.style.display = "block";
        achievementsContainer.innerHTML = "";
        summaryStats.classList.remove("show");

        try {
          // Get user info
          const userResponse = await fetch(
            `https://api.inaturalist.org/v1/users/autocomplete?q=${encodeURIComponent(
              username
            )}`
          );
          const userData = await userResponse.json();

          if (!userData.results || userData.results.length === 0) {
            loading.style.display = "none";
            showError("User not found");
            return;
          }

          const user = userData.results[0];
          const userId = user.id;

          // Save username to localStorage (shared with other tools)
          localStorage.setItem("inatUsername", username);

          // Fetch species count
          const speciesResponse = await fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&per_page=1`
          );
          const speciesData = await speciesResponse.json();

          const observationsCount = user.observations_count || 0;
          const speciesCount = speciesData.total_results || 0;

          // Load all observations
          allObservations = await loadAllObservations(userId);

          loading.style.display = "none";

          // Update and show summary stats
          totalObservationsEl.textContent = observationsCount.toLocaleString();
          totalSpeciesEl.textContent = speciesCount.toLocaleString();
          summaryStats.classList.add("show");

          // Display achievements
          achievementsContainer.innerHTML = renderAchievements(
            observationsCount,
            speciesCount
          );
        } catch (error) {
          console.error("Error fetching user data:", error);
          loading.style.display = "none";
          showError("Error fetching data. Please try again.");
        }
      }

      async function loadAllObservations(userId) {
        const perPage = 200;
        const today = new Date().toISOString().split("T")[0];
        const loadingCount = document.getElementById("loadingCount");
        let allResults = [];
        let page = 1;
        let hasMore = true;

        while (hasMore) {
          const response = await fetch(
            `https://api.inaturalist.org/v1/observations?user_id=${userId}&per_page=${perPage}&page=${page}&d2=${today}&order_by=observed_on&captive=false&verifiable=true`
          );
          const data = await response.json();

          if (data.results && data.results.length > 0) {
            allResults = allResults.concat(data.results);
            loadingCount.textContent = `(${allResults.length.toLocaleString()} observations)`;
            page++;
            hasMore = data.results.length === perPage;
          } else {
            hasMore = false;
          }
        }

        return allResults;
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add("show");
      }

      function hideError() {
        errorMessage.classList.remove("show");
      }

      const THREATENED_STATUSES = [
        "cr",
        "critically_endangered",
        "en",
        "endangered",
        "vu",
        "vulnerable",
        "nt",
        "near_threatened",
      ];

      function calculateThreatenedSpeciesAchievement(observations) {
        const threatenedSpecies = new Set();

        observations.forEach((obs) => {
          if (
            obs.taxon &&
            obs.taxon.conservation_status &&
            obs.taxon.conservation_status.status
          ) {
            const status = obs.taxon.conservation_status.status.toLowerCase();
            if (THREATENED_STATUSES.includes(status)) {
              threatenedSpecies.add(obs.taxon.id);
            }
          }
        });

        return threatenedSpecies.size;
      }

      function calculateThreatenedAchievement(observations, goal) {
        const count = calculateThreatenedSpeciesAchievement(observations);
        return {
          current: count,
          total: goal,
          completed: count >= goal,
        };
      }

      function calculateCountAchievement(current, goal) {
        return {
          current: current,
          total: goal,
          completed: current >= goal,
        };
      }

      const CONTINENTS = {
        "North America": "ü¶Ö",
        "South America": "ü¶ú",
        Europe: "ü¶å",
        Africa: "ü¶Å",
        Asia: "üêº",
        Oceania: "ü¶ò",
        Antarctica: "üêß",
      };

      function getContinent(lat, lng) {
        if (lat === null || lng === null) return null;

        // Antarctica
        if (lat < -60) return "Antarctica";

        // Oceania/Australia
        if (lat < 0 && lng > 100 && lng <= 180) return "Oceania";
        if (lat >= 0 && lat < 20 && lng > 95 && lng <= 180) return "Oceania";
        if (lat < 0 && lng >= -180 && lng < -100) return "Oceania"; // Pacific islands

        // South America
        if (lat < 15 && lat > -60 && lng > -85 && lng < -30)
          return "South America";

        // North America (including Central America and Caribbean)
        if (lat >= 7 && lat < 85 && lng >= -170 && lng < -30)
          return "North America";

        // Africa
        if (lat > -40 && lat < 38 && lng >= -20 && lng < 55) return "Africa";

        // Europe
        if (lat >= 35 && lat < 75 && lng >= -25 && lng < 65) return "Europe";

        // Asia (rest of Eastern hemisphere)
        if (lng >= 25 || lng < -150) return "Asia";

        return null;
      }

      function calculateContinentsAchievement(observations) {
        const observedContinents = new Set();

        observations.forEach((obs) => {
          const lat =
            obs.geojson?.coordinates?.[1] || obs.location?.split(",")[0];
          const lng =
            obs.geojson?.coordinates?.[0] || obs.location?.split(",")[1];

          if (lat && lng) {
            const continent = getContinent(parseFloat(lat), parseFloat(lng));
            if (continent) {
              observedContinents.add(continent);
            }
          }
        });

        const total = Object.keys(CONTINENTS).length;
        return {
          current: observedContinents.size,
          total: total,
          completed: observedContinents.size >= total,
          observedContinents: observedContinents,
        };
      }

      const SEASONS = {
        Spring: "üå∏",
        Summer: "‚òÄÔ∏è",
        Fall: "üçÇ",
        Winter: "‚ùÑÔ∏è",
      };

      function getSeason(dateStr) {
        if (!dateStr) return null;
        const date = new Date(dateStr);
        const month = date.getMonth(); // 0-11

        if (month >= 2 && month <= 4) return "Spring"; // Mar, Apr, May
        if (month >= 5 && month <= 7) return "Summer"; // Jun, Jul, Aug
        if (month >= 8 && month <= 10) return "Fall"; // Sep, Oct, Nov
        return "Winter"; // Dec, Jan, Feb
      }

      function calculateSeasonsAchievement(observations) {
        const observedSeasons = new Set();

        observations.forEach((obs) => {
          const season = getSeason(obs.observed_on);
          if (season) {
            observedSeasons.add(season);
          }
        });

        const total = Object.keys(SEASONS).length;
        return {
          current: observedSeasons.size,
          total: total,
          completed: observedSeasons.size >= total,
          observedSeasons: observedSeasons,
        };
      }

      const MONTHS = {
        Jan: "Jan",
        Feb: "Feb",
        Mar: "Mar",
        Apr: "Apr",
        May: "May",
        Jun: "Jun",
        Jul: "Jul",
        Aug: "Aug",
        Sep: "Sep",
        Oct: "Oct",
        Nov: "Nov",
        Dec: "Dec",
      };

      function calculateMonthsAchievement(observations) {
        const observedMonths = new Set();

        observations.forEach((obs) => {
          if (obs.observed_on) {
            const date = new Date(obs.observed_on);
            const monthIndex = date.getMonth();
            const monthNames = [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ];
            observedMonths.add(monthNames[monthIndex]);
          }
        });

        const total = Object.keys(MONTHS).length;
        return {
          current: observedMonths.size,
          total: total,
          completed: observedMonths.size >= total,
          observedMonths: observedMonths,
        };
      }

      function calculateSpeciesInDayAchievement(observations, goal) {
        // Group species by date
        const speciesByDate = {};

        observations.forEach((obs) => {
          if (obs.observed_on && obs.taxon && obs.taxon.id) {
            if (!speciesByDate[obs.observed_on]) {
              speciesByDate[obs.observed_on] = new Set();
            }
            speciesByDate[obs.observed_on].add(obs.taxon.id);
          }
        });

        // Find max species in a single day
        let maxSpecies = 0;
        Object.values(speciesByDate).forEach((species) => {
          maxSpecies = Math.max(maxSpecies, species.size);
        });

        return {
          current: maxSpecies,
          total: goal,
          completed: maxSpecies >= goal,
        };
      }

      function calculateVeteranAchievement(observations, years, goal) {
        const now = new Date();
        const cutoffDate = new Date(
          now.getFullYear() - years,
          now.getMonth(),
          now.getDate()
        );

        let count = 0;

        observations.forEach((obs) => {
          if (obs.observed_on) {
            const obsDate = new Date(obs.observed_on);
            if (obsDate <= cutoffDate) {
              count++;
            }
          }
        });

        return {
          current: count,
          total: goal,
          completed: count >= goal,
        };
      }

      function calculateFavoritedAchievement(observations, goal) {
        let count = 0;

        observations.forEach((obs) => {
          if (obs.faves_count && obs.faves_count > 0) {
            count++;
          }
        });

        return {
          current: count,
          total: goal,
          completed: count >= goal,
        };
      }

      function calculateCommentedAchievement(observations, goal) {
        let count = 0;

        observations.forEach((obs) => {
          if (obs.comments_count && obs.comments_count > 0) {
            count++;
          }
        });

        return {
          current: count,
          total: goal,
          completed: count >= goal,
        };
      }

      function calculateNewYearAchievement(observations, goal) {
        let count = 0;

        observations.forEach((obs) => {
          if (obs.observed_on) {
            const date = new Date(obs.observed_on);
            const month = date.getMonth(); // 0 = January
            const day = date.getDate();

            if (month === 0 && day === 1) {
              count++;
            }
          }
        });

        return {
          current: count,
          total: goal,
          completed: count >= goal,
        };
      }

      function calculateTimeOfDayAchievement(
        observations,
        startHour,
        endHour,
        goal
      ) {
        let count = 0;

        observations.forEach((obs) => {
          if (obs.time_observed_at) {
            let hour;

            // Use observation's timezone if available
            if (obs.observed_time_zone) {
              try {
                const date = new Date(obs.time_observed_at);
                const formatter = new Intl.DateTimeFormat("en-US", {
                  hour: "numeric",
                  hour12: false,
                  timeZone: obs.observed_time_zone,
                });
                hour = parseInt(formatter.format(date), 10);
              } catch (e) {
                // Fallback to UTC if timezone is invalid
                const date = new Date(obs.time_observed_at);
                hour = date.getUTCHours();
              }
            } else {
              // Fallback to UTC
              const date = new Date(obs.time_observed_at);
              hour = date.getUTCHours();
            }

            if (startHour < endHour) {
              // Normal range (e.g., 0-7 for early bird)
              if (hour >= startHour && hour < endHour) {
                count++;
              }
            } else {
              // Wrap around range (e.g., 20-24 for night owl)
              if (hour >= startHour || hour < endHour) {
                count++;
              }
            }
          }
        });

        return {
          current: count,
          total: goal,
          completed: count >= goal,
        };
      }

      function calculateStreakAchievement(observations, goalDays) {
        // Get all unique dates with observations
        const datesWithObs = new Set();

        observations.forEach((obs) => {
          if (obs.observed_on) {
            datesWithObs.add(obs.observed_on);
          }
        });

        // Convert to sorted array of dates
        const sortedDates = Array.from(datesWithObs).sort();

        if (sortedDates.length === 0) {
          return { current: 0, total: goalDays, completed: false };
        }

        // Calculate longest streak
        let longestStreak = 1;
        let currentStreak = 1;

        for (let i = 1; i < sortedDates.length; i++) {
          const prevDate = new Date(sortedDates[i - 1]);
          const currDate = new Date(sortedDates[i]);
          const diffDays = Math.round(
            (currDate - prevDate) / (1000 * 60 * 60 * 24)
          );

          if (diffDays === 1) {
            currentStreak++;
            longestStreak = Math.max(longestStreak, currentStreak);
          } else {
            currentStreak = 1;
          }
        }

        return {
          current: longestStreak,
          total: goalDays,
          completed: longestStreak >= goalDays,
        };
      }

      function calculateSpeciesPerTaxonAchievement(
        observations,
        iconicTaxon,
        goal
      ) {
        const speciesInTaxon = new Set();

        observations.forEach((obs) => {
          if (
            obs.taxon &&
            obs.taxon.iconic_taxon_name === iconicTaxon &&
            obs.taxon.id
          ) {
            speciesInTaxon.add(obs.taxon.id);
          }
        });

        return {
          current: speciesInTaxon.size,
          total: goal,
          completed: speciesInTaxon.size >= goal,
        };
      }

      function calculateOnlyObserverAchievement(observations) {
        // Group observations by taxon and count user's observations per taxon
        const taxonCounts = {};
        const taxonGlobalCounts = {};

        observations.forEach((obs) => {
          if (obs.taxon && obs.taxon.id) {
            const taxonId = obs.taxon.id;
            taxonCounts[taxonId] = (taxonCounts[taxonId] || 0) + 1;
            taxonGlobalCounts[taxonId] = obs.taxon.observations_count || 0;
          }
        });

        // Count species where user is the only observer
        let onlyObserverCount = 0;
        Object.keys(taxonCounts).forEach((taxonId) => {
          const userCount = taxonCounts[taxonId];
          const globalCount = taxonGlobalCounts[taxonId];
          if (userCount === globalCount && globalCount > 0) {
            onlyObserverCount++;
          }
        });

        return {
          current: onlyObserverCount,
          total: 1,
          completed: onlyObserverCount >= 1,
        };
      }

      function calculateIconicTaxonAchievement(observations) {
        const observedTaxons = new Set();

        observations.forEach((obs) => {
          if (obs.taxon && obs.taxon.iconic_taxon_name) {
            observedTaxons.add(obs.taxon.iconic_taxon_name);
          }
        });

        const taxonKeys = Object.keys(ICONIC_TAXONS);
        const count = taxonKeys.filter((taxon) =>
          observedTaxons.has(taxon)
        ).length;
        return {
          current: count,
          total: taxonKeys.length,
          completed: count === taxonKeys.length,
          observedTaxons: observedTaxons,
        };
      }

      function renderAchievements(observationsCount, speciesCount) {
        const iconicTaxonAchievement =
          calculateIconicTaxonAchievement(allObservations);
        const iconicPercentage =
          (iconicTaxonAchievement.current / iconicTaxonAchievement.total) * 100;

        const threatened10 = calculateThreatenedAchievement(
          allObservations,
          10
        );
        const threatened50 = calculateThreatenedAchievement(
          allObservations,
          50
        );
        const threatened100 = calculateThreatenedAchievement(
          allObservations,
          100
        );

        // Observation achievements
        const obs100 = calculateCountAchievement(observationsCount, 100);
        const obs1000 = calculateCountAchievement(observationsCount, 1000);
        const obs10000 = calculateCountAchievement(observationsCount, 10000);

        // Species achievements
        const species100 = calculateCountAchievement(speciesCount, 100);
        const species1000 = calculateCountAchievement(speciesCount, 1000);
        const species10000 = calculateCountAchievement(speciesCount, 10000);

        // Only observer achievement
        const onlyObserver = calculateOnlyObserverAchievement(allObservations);

        // Continents achievement
        const continentsAchievement =
          calculateContinentsAchievement(allObservations);

        // Seasons achievement
        const seasonsAchievement = calculateSeasonsAchievement(allObservations);

        // Months achievement
        const monthsAchievement = calculateMonthsAchievement(allObservations);

        // Streak achievements
        const streak7 = calculateStreakAchievement(allObservations, 7);
        const streak30 = calculateStreakAchievement(allObservations, 30);

        // Time of day achievements
        const earlyBird = calculateTimeOfDayAchievement(
          allObservations,
          0,
          7,
          50
        );
        const nightOwl = calculateTimeOfDayAchievement(
          allObservations,
          20,
          24,
          50
        );

        // New Year achievement
        const newYear = calculateNewYearAchievement(allObservations, 10);

        // Veteran achievements
        const veteran5 = calculateVeteranAchievement(allObservations, 5, 10);
        const veteran10 = calculateVeteranAchievement(allObservations, 10, 10);

        // Favorited and commented achievements
        const favorited10 = calculateFavoritedAchievement(allObservations, 10);
        const commented10 = calculateCommentedAchievement(allObservations, 10);

        // Species in a day achievements
        const speciesDay10 = calculateSpeciesInDayAchievement(
          allObservations,
          10
        );
        const speciesDay100 = calculateSpeciesInDayAchievement(
          allObservations,
          100
        );

        // Species per iconic taxon achievements (100 each)
        const taxonAchievements = {};
        Object.keys(ICONIC_TAXONS).forEach((taxon) => {
          taxonAchievements[taxon] = calculateSpeciesPerTaxonAchievement(
            allObservations,
            taxon,
            100
          );
        });

        const taxonIconsHtml = Object.entries(ICONIC_TAXONS)
          .map(([key, value]) => {
            const isObserved = iconicTaxonAchievement.observedTaxons.has(key);
            return `
              <div class="taxon-icon ${isObserved ? "observed" : ""}" title="${
              value.name
            }">
                ${value.emoji}
              </div>
            `;
          })
          .join("");

        const continentIconsHtml = Object.entries(CONTINENTS)
          .map(([name, emoji]) => {
            const isObserved =
              continentsAchievement.observedContinents.has(name);
            return `
              <div class="taxon-icon continent-icon ${
                isObserved ? "observed" : ""
              }" title="${name}">
                ${emoji}
              </div>
            `;
          })
          .join("");

        const seasonIconsHtml = Object.entries(SEASONS)
          .map(([name, emoji]) => {
            const isObserved = seasonsAchievement.observedSeasons.has(name);
            return `
              <div class="taxon-icon ${
                isObserved ? "observed" : ""
              }" title="${name}">
                ${emoji}
              </div>
            `;
          })
          .join("");

        const monthIconsHtml = Object.entries(MONTHS)
          .map(([name, label]) => {
            const isObserved = monthsAchievement.observedMonths.has(name);
            return `
              <div class="taxon-icon month-icon ${
                isObserved ? "observed" : ""
              }" title="${name}">
                ${label}
              </div>
            `;
          })
          .join("");

        // Count total achievements
        const allAchievements = [
          obs100,
          obs1000,
          obs10000,
          species100,
          species1000,
          species10000,
          threatened10,
          threatened50,
          threatened100,
          onlyObserver,
          iconicTaxonAchievement,
          continentsAchievement,
          seasonsAchievement,
          monthsAchievement,
          streak7,
          streak30,
          earlyBird,
          nightOwl,
          newYear,
          speciesDay10,
          speciesDay100,
          veteran5,
          veteran10,
          favorited10,
          commented10,
          ...Object.values(taxonAchievements),
        ];
        const completedCount = allAchievements.filter(
          (a) => a.completed
        ).length;
        const totalAchievements = allAchievements.length;

        function renderAchievementCard(achievement, icon, name, description) {
          const percentage = Math.min(
            (achievement.current / achievement.total) * 100,
            100
          );
          return `
            <div class="achievement-card ${
              achievement.completed ? "completed" : ""
            }">
              <div class="achievement-icon">${
                achievement.completed ? "üèÜ" : icon
              }</div>
              <div class="achievement-content">
                <div class="achievement-name">${name}</div>
                <div class="achievement-description">${description}</div>
                <div class="achievement-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${percentage}%"></div>
                  </div>
                  <div class="progress-text">${achievement.current.toLocaleString()}/${achievement.total.toLocaleString()}</div>
                </div>
              </div>
            </div>
          `;
        }

        return `
          <div class="achievements-section">
            <h2 class="achievements-title">Achievements <span class="achievements-count">${completedCount}/${totalAchievements}</span></h2>
            <div class="achievements-grid">
              ${renderAchievementCard(
                obs100,
                "üì∑",
                "Observer",
                "Record 100 observations"
              )}
              ${renderAchievementCard(
                obs1000,
                "üì∑",
                "Dedicated Observer",
                "Record 1,000 observations"
              )}
              ${renderAchievementCard(
                obs10000,
                "üì∑",
                "Master Observer",
                "Record 10,000 observations"
              )}
              ${renderAchievementCard(
                species100,
                "üî¨",
                "Species Spotter",
                "Observe 100 species"
              )}
              ${renderAchievementCard(
                species1000,
                "üî¨",
                "Species Expert",
                "Observe 1,000 species"
              )}
              ${renderAchievementCard(
                species10000,
                "üî¨",
                "Species Master",
                "Observe 10,000 species"
              )}
              ${renderAchievementCard(
                threatened10,
                "ü¶Å",
                "Conservation Ally",
                "Observe 10 threatened species"
              )}
              ${renderAchievementCard(
                threatened50,
                "ü¶Å",
                "Conservation Champion",
                "Observe 50 threatened species"
              )}
              ${renderAchievementCard(
                threatened100,
                "ü¶Å",
                "Conservation Hero",
                "Observe 100 threatened species"
              )}
              ${renderAchievementCard(
                onlyObserver,
                "‚≠ê",
                "Rare Find",
                "Be the only observer of a species"
              )}
              ${renderAchievementCard(
                streak7,
                "üî•",
                "Week Warrior",
                "7-day observation streak"
              )}
              ${renderAchievementCard(
                streak30,
                "üî•",
                "Monthly Dedication",
                "30-day observation streak"
              )}
              ${renderAchievementCard(
                earlyBird,
                "üåÖ",
                "Early Bird",
                "50 observations before 7am"
              )}
              ${renderAchievementCard(
                nightOwl,
                "ü¶â",
                "Night Owl",
                "50 observations after 8pm"
              )}
              ${renderAchievementCard(
                newYear,
                "üéÜ",
                "New Year, New Observations",
                "10 observations on January 1st"
              )}
              ${renderAchievementCard(
                speciesDay10,
                "üåà",
                "Diversity Day",
                "10 species in a single day"
              )}
              ${renderAchievementCard(
                speciesDay100,
                "üåà",
                "Biodiversity Blitz",
                "100 species in a single day"
              )}
              ${renderAchievementCard(
                veteran5,
                "üéñÔ∏è",
                "5-Year Veteran",
                "Have 10 observations from 5+ years ago"
              )}
              ${renderAchievementCard(
                veteran10,
                "üèÖ",
                "10-Year Veteran",
                "Have 10 observations from 10+ years ago"
              )}
              ${renderAchievementCard(
                favorited10,
                "‚ù§Ô∏è",
                "Fan Favorite",
                "Have 10 observations that were favorited"
              )}
              ${renderAchievementCard(
                commented10,
                "üí¨",
                "Conversation Starter",
                "Have 10 observations that received comments"
              )}
              ${Object.entries(ICONIC_TAXONS)
                .map(([taxon, data]) =>
                  renderAchievementCard(
                    taxonAchievements[taxon],
                    data.emoji,
                    `${data.name} Expert`,
                    `Observe 100 ${data.name.toLowerCase()} species`
                  )
                )
                .join("")}
              <div class="achievement-card ${
                iconicTaxonAchievement.completed ? "completed" : ""
              }">
                <div class="achievement-icon">${
                  iconicTaxonAchievement.completed ? "üèÜ" : "üåç"
                }</div>
                <div class="achievement-content">
                  <div class="achievement-name">Biodiversity Explorer</div>
                  <div class="achievement-description">Observe all iconic taxons</div>
                  <div class="achievement-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${iconicPercentage}%"></div>
                    </div>
                    <div class="progress-text">${
                      iconicTaxonAchievement.current
                    }/${iconicTaxonAchievement.total}</div>
                  </div>
                  <div class="taxon-icons">
                    ${taxonIconsHtml}
                  </div>
                </div>
              </div>
              <div class="achievement-card ${
                continentsAchievement.completed ? "completed" : ""
              }">
                <div class="achievement-icon">${
                  continentsAchievement.completed ? "üèÜ" : "‚úàÔ∏è"
                }</div>
                <div class="achievement-content">
                  <div class="achievement-name">World Traveler</div>
                  <div class="achievement-description">Observe in all 7 continents</div>
                  <div class="achievement-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${
                        (continentsAchievement.current /
                          continentsAchievement.total) *
                        100
                      }%"></div>
                    </div>
                    <div class="progress-text">${
                      continentsAchievement.current
                    }/${continentsAchievement.total}</div>
                  </div>
                  <div class="taxon-icons">
                    ${continentIconsHtml}
                  </div>
                </div>
              </div>
              <div class="achievement-card ${
                seasonsAchievement.completed ? "completed" : ""
              }">
                <div class="achievement-icon">${
                  seasonsAchievement.completed ? "üèÜ" : "üìÖ"
                }</div>
                <div class="achievement-content">
                  <div class="achievement-name">Year-Round Observer</div>
                  <div class="achievement-description">Observe in all 4 seasons</div>
                  <div class="achievement-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${
                        (seasonsAchievement.current /
                          seasonsAchievement.total) *
                        100
                      }%"></div>
                    </div>
                    <div class="progress-text">${seasonsAchievement.current}/${
          seasonsAchievement.total
        }</div>
                  </div>
                  <div class="taxon-icons">
                    ${seasonIconsHtml}
                  </div>
                </div>
              </div>
              <div class="achievement-card ${
                monthsAchievement.completed ? "completed" : ""
              }">
                <div class="achievement-icon">${
                  monthsAchievement.completed ? "üèÜ" : "üìÜ"
                }</div>
                <div class="achievement-content">
                  <div class="achievement-name">Monthly Observer</div>
                  <div class="achievement-description">Observe in all 12 months</div>
                  <div class="achievement-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${
                        (monthsAchievement.current / monthsAchievement.total) *
                        100
                      }%"></div>
                    </div>
                    <div class="progress-text">${monthsAchievement.current}/${
          monthsAchievement.total
        }</div>
                  </div>
                  <div class="taxon-icons">
                    ${monthIconsHtml}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
    </script>
    <script
      defer
      data-domain="glauberramos.github.io/inat"
      src="https://plausible.io/js/script.js"
    ></script>
  </body>
</html>
