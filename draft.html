<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Draft Observations - iNaturalist</title>
    <link rel="icon" href="favicon.ico" />
    <meta
      name="description"
      content="Create and submit draft observations to iNaturalist"
    />
    <link rel="stylesheet" href="styles.css" />
    <style>
      .auth-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        text-align: center;
      }

      .auth-status {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 15px;
        border-radius: 6px;
        background: #f5f5f5;
        margin-bottom: 10px;
      }

      .auth-status.authenticated {
        background: #d4edda;
        color: #155724;
      }

      .drafts-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .draft-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 2px solid #ddd;
      }

      .draft-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 48px;
      }

      .draft-content {
        padding: 15px;
      }

      .draft-field {
        margin-bottom: 10px;
      }

      .draft-field label {
        display: block;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
        font-size: 14px;
      }

      .draft-field input,
      .draft-field textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
      }

      .draft-field textarea {
        resize: vertical;
        min-height: 60px;
      }

      .draft-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .draft-actions button {
        flex: 1;
        padding: 8px;
        font-size: 14px;
      }

      .btn-submit {
        background: #74ac00;
      }

      .btn-submit:hover {
        background: #659900;
      }

      .btn-delete {
        background: #dc3545;
      }

      .btn-delete:hover {
        background: #c82333;
      }

      .btn-submit:disabled {
        background: #95a5a6;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .btn-submit:disabled:hover {
        background: #95a5a6;
      }

      .add-draft-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 2px dashed #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .add-draft-card:hover {
        border-color: #74ac00;
        background: #f9f9f9;
      }

      .add-draft-content {
        text-align: center;
        color: #666;
      }

      .add-draft-content .icon {
        font-size: 64px;
        margin-bottom: 10px;
      }

      #photoInput {
        display: none;
      }

      .taxon-autocomplete-draft {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #ddd;
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }

      .taxon-suggestion-draft {
        padding: 8px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid #eee;
      }

      .taxon-suggestion-draft:hover {
        background: #f5f5f5;
      }

      .taxon-suggestion-draft .taxon-name {
        font-weight: 500;
        color: #2c3e50;
      }

      .taxon-suggestion-draft .taxon-sci-name {
        font-style: italic;
        color: #666;
        font-size: 12px;
      }

      .location-autocomplete-draft {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #ddd;
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }

      .location-suggestion-draft {
        padding: 8px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid #eee;
      }

      .location-suggestion-draft:hover {
        background: #f5f5f5;
      }

      .field-wrapper {
        position: relative;
      }

      .submission-status {
        padding: 8px;
        border-radius: 4px;
        font-size: 12px;
        margin-top: 10px;
        display: none;
      }

      .submission-status.success {
        display: block;
        background: #d4edda;
        color: #155724;
      }

      .submission-status.error {
        display: block;
        background: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <a
      href="/inat"
      style="
        position: fixed;
        top: 20px;
        left: 20px;
        background: #74ac00;
        color: white;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 10px 16px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
      "
      onmouseover="this.style.background='#659900'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.2)'"
      onmouseout="this.style.background='#74ac00'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.15)'"
    >
      <span style="font-size: 1rem">‚Üê</span> More iNat tools
    </a>
    <div class="container">
      <header>
        <div class="header-content">
          <div class="title-container">
            <img src="logo.png" alt="iNaturalist Logo" class="logo" />
            <h1>Draft Observations</h1>
          </div>
          <p class="description">
            Create and submit observations to iNaturalist
          </p>
        </div>

        <div class="auth-section">
          <div class="auth-status" id="authStatus">
            <span>üîí Not authenticated</span>
          </div>
          <button id="authButton">Sign in with iNaturalist</button>
          <p style="font-size: 12px; color: #666; margin-top: 10px">
            Note: Authentication is required to submit observations
          </p>
        </div>
      </header>

      <main>
        <div class="drafts-container" id="draftsContainer">
          <div class="add-draft-card" id="addDraftCard">
            <div class="add-draft-content">
              <div class="icon">üì∏</div>
              <div>Click to add a new draft observation</div>
            </div>
          </div>
        </div>
        <input type="file" id="photoInput" accept="image/*" multiple />
      </main>
    </div>
    <footer
      style="text-align: center; padding: 40px 20px 20px; margin-top: 40px"
    >
      <img
        src="powered_by.png"
        alt="Powered By"
        style="max-width: 180px; height: auto; opacity: 0.8"
      />
    </footer>
    <script>
      let drafts = [];
      let isAuthenticated = false;
      let accessToken = null;
      let currentUser = null;

      // Load drafts from localStorage
      function loadDrafts() {
        const saved = localStorage.getItem("inatDrafts");
        if (saved) {
          drafts = JSON.parse(saved);
          renderDrafts();
        }
      }

      // Save drafts to localStorage
      function saveDrafts() {
        localStorage.setItem("inatDrafts", JSON.stringify(drafts));
      }

      // Check authentication status
      function checkAuth() {
        accessToken = localStorage.getItem("inatAccessToken");
        currentUser = localStorage.getItem("inatCurrentUser");

        if (accessToken && currentUser) {
          isAuthenticated = true;
          updateAuthStatus();
        }
      }

      // Update authentication status UI
      function updateAuthStatus() {
        const authStatus = document.getElementById("authStatus");
        const authButton = document.getElementById("authButton");

        if (isAuthenticated && currentUser) {
          authStatus.classList.add("authenticated");
          authStatus.innerHTML = `<span>‚úÖ Signed in as ${currentUser}</span>`;
          authButton.textContent = "Sign out";
        } else {
          authStatus.classList.remove("authenticated");
          authStatus.innerHTML = `<span>üîí Not authenticated</span>`;
          authButton.textContent = "Sign in with iNaturalist";
        }
      }

      // Authentication handler
      document.getElementById("authButton").addEventListener("click", () => {
        if (isAuthenticated) {
          // Sign out
          localStorage.removeItem("inatAccessToken");
          localStorage.removeItem("inatCurrentUser");
          isAuthenticated = false;
          accessToken = null;
          currentUser = null;
          updateAuthStatus();
        } else {
          // Sign in - Note: This requires OAuth setup with iNaturalist
          alert(
            "OAuth authentication with iNaturalist requires setting up an application at https://www.inaturalist.org/oauth/applications/new\n\n" +
            "For development purposes, you can manually enter an API token."
          );

          const token = prompt("Enter your iNaturalist API token (for testing):");
          if (token) {
            const username = prompt("Enter your iNaturalist username:");
            if (username) {
              localStorage.setItem("inatAccessToken", token);
              localStorage.setItem("inatCurrentUser", username);
              accessToken = token;
              currentUser = username;
              isAuthenticated = true;
              updateAuthStatus();
            }
          }
        }
      });

      // Add draft card click
      document.getElementById("addDraftCard").addEventListener("click", () => {
        document.getElementById("photoInput").click();
      });

      // Photo input change
      document.getElementById("photoInput").addEventListener("change", (e) => {
        const files = Array.from(e.target.files);
        files.forEach((file) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            const draft = {
              id: Date.now() + Math.random(),
              photo: event.target.result,
              notes: "",
              taxon: "",
              taxonId: null,
              location: "",
              latitude: null,
              longitude: null,
              date: new Date().toISOString().split("T")[0],
              submissionStatus: null,
            };
            drafts.push(draft);
            saveDrafts();
            renderDrafts();
          };
          reader.readAsDataURL(file);
        });
        e.target.value = "";
      });

      // Render drafts
      function renderDrafts() {
        const container = document.getElementById("draftsContainer");
        const addCard = document.getElementById("addDraftCard");

        // Clear existing draft cards
        Array.from(container.children).forEach((child) => {
          if (child !== addCard) {
            child.remove();
          }
        });

        // Render each draft
        drafts.forEach((draft) => {
          const card = createDraftCard(draft);
          container.insertBefore(card, addCard);
        });
      }

      // Create draft card
      function createDraftCard(draft) {
        const card = document.createElement("div");
        card.className = "draft-card";
        card.innerHTML = `
          <img src="${draft.photo}" class="draft-image" alt="Draft observation" />
          <div class="draft-content">
            <div class="draft-field">
              <label>Notes</label>
              <textarea class="notes-input" data-id="${draft.id}">${
          draft.notes
        }</textarea>
            </div>
            <div class="draft-field">
              <label>Taxon (Species)</label>
              <div class="field-wrapper">
                <input
                  type="text"
                  class="taxon-input"
                  data-id="${draft.id}"
                  value="${draft.taxon}"
                  placeholder="Search for species..."
                  autocomplete="off"
                />
                <div class="taxon-autocomplete-draft" data-id="${draft.id}"></div>
              </div>
            </div>
            <div class="draft-field">
              <label>Location</label>
              <div class="field-wrapper">
                <input
                  type="text"
                  class="location-input"
                  data-id="${draft.id}"
                  value="${draft.location}"
                  placeholder="Search for location..."
                  autocomplete="off"
                />
                <div class="location-autocomplete-draft" data-id="${
                  draft.id
                }"></div>
              </div>
            </div>
            <div class="draft-field">
              <label>Date</label>
              <input
                type="date"
                class="date-input"
                data-id="${draft.id}"
                value="${draft.date}"
              />
            </div>
            <div class="submission-status ${
              draft.submissionStatus === "success"
                ? "success"
                : draft.submissionStatus === "error"
                ? "error"
                : ""
            }" data-id="${draft.id}">
              ${
                draft.submissionStatus === "success" && draft.observationUrl
                  ? `‚úÖ Observation submitted! <a href="${draft.observationUrl}" target="_blank" style="color: #155724; text-decoration: underline;">View on iNaturalist</a>`
                  : draft.submissionStatus === "success"
                  ? "‚úÖ Observation submitted successfully!"
                  : draft.submissionStatus === "error"
                  ? "‚ùå Failed to submit observation"
                  : ""
              }
            </div>
            <div class="draft-actions">
              <button class="btn-submit" data-id="${draft.id}" ${
          draft.submissionStatus === "success" ? 'disabled' : ''
        }>${
          draft.submissionStatus === "success" ? "‚úì Submitted" : "Submit"
        }</button>
              <button class="btn-delete" data-id="${draft.id}">Delete</button>
            </div>
          </div>
        `;

        // Add event listeners
        attachDraftEventListeners(card, draft);

        return card;
      }

      // Attach event listeners to draft card
      function attachDraftEventListeners(card, draft) {
        // Notes input
        const notesInput = card.querySelector(".notes-input");
        notesInput.addEventListener("input", (e) => {
          updateDraft(draft.id, { notes: e.target.value });
        });

        // Taxon input with autocomplete
        const taxonInput = card.querySelector(".taxon-input");
        const taxonAutocomplete = card.querySelector(".taxon-autocomplete-draft");
        let taxonTimeout = null;

        taxonInput.addEventListener("input", (e) => {
          const query = e.target.value.trim();
          clearTimeout(taxonTimeout);

          if (query.length < 2) {
            taxonAutocomplete.style.display = "none";
            return;
          }

          taxonTimeout = setTimeout(async () => {
            try {
              const response = await fetch(
                `https://api.inaturalist.org/v1/taxa/autocomplete?q=${encodeURIComponent(
                  query
                )}`
              );
              const data = await response.json();

              if (data.results && data.results.length > 0) {
                taxonAutocomplete.innerHTML = data.results
                  .slice(0, 10)
                  .map(
                    (taxon) => `
                    <div class="taxon-suggestion-draft" data-id="${taxon.id}" data-name="${taxon.name}">
                      <div class="taxon-name">${
                        taxon.preferred_common_name || taxon.name
                      }</div>
                      <div class="taxon-sci-name">${taxon.name}</div>
                    </div>
                  `
                  )
                  .join("");
                taxonAutocomplete.style.display = "block";

                // Add click handlers
                taxonAutocomplete
                  .querySelectorAll(".taxon-suggestion-draft")
                  .forEach((item) => {
                    item.addEventListener("click", () => {
                      const taxonId = item.dataset.id;
                      const taxonName = item.textContent.trim();
                      taxonInput.value = taxonName;
                      updateDraft(draft.id, {
                        taxon: taxonName,
                        taxonId: taxonId,
                      });
                      taxonAutocomplete.style.display = "none";
                    });
                  });
              } else {
                taxonAutocomplete.style.display = "none";
              }
            } catch (error) {
              console.error("Error fetching taxa:", error);
              taxonAutocomplete.style.display = "none";
            }
          }, 300);
        });

        // Location input with autocomplete
        const locationInput = card.querySelector(".location-input");
        const locationAutocomplete = card.querySelector(
          ".location-autocomplete-draft"
        );
        let locationTimeout = null;

        locationInput.addEventListener("input", (e) => {
          const query = e.target.value.trim();
          clearTimeout(locationTimeout);

          if (query.length < 2) {
            locationAutocomplete.style.display = "none";
            return;
          }

          locationTimeout = setTimeout(async () => {
            try {
              const response = await fetch(
                `https://api.inaturalist.org/v1/places/autocomplete?q=${encodeURIComponent(
                  query
                )}`
              );
              const data = await response.json();

              if (data.results && data.results.length > 0) {
                locationAutocomplete.innerHTML = data.results
                  .slice(0, 10)
                  .map(
                    (place) => `
                    <div class="location-suggestion-draft" data-lat="${
                      place.location ? place.location.split(",")[0] : ""
                    }" data-lng="${
                      place.location ? place.location.split(",")[1] : ""
                    }" data-name="${place.display_name}">
                      ${place.display_name}
                    </div>
                  `
                  )
                  .join("");
                locationAutocomplete.style.display = "block";

                // Add click handlers
                locationAutocomplete
                  .querySelectorAll(".location-suggestion-draft")
                  .forEach((item) => {
                    item.addEventListener("click", () => {
                      const lat = item.dataset.lat;
                      const lng = item.dataset.lng;
                      const name = item.dataset.name;
                      locationInput.value = name;
                      updateDraft(draft.id, {
                        location: name,
                        latitude: lat,
                        longitude: lng,
                      });
                      locationAutocomplete.style.display = "none";
                    });
                  });
              } else {
                locationAutocomplete.style.display = "none";
              }
            } catch (error) {
              console.error("Error fetching locations:", error);
              locationAutocomplete.style.display = "none";
            }
          }, 300);
        });

        // Hide autocompletes when clicking outside
        document.addEventListener("click", (e) => {
          if (!card.contains(e.target)) {
            taxonAutocomplete.style.display = "none";
            locationAutocomplete.style.display = "none";
          }
        });

        // Date input
        const dateInput = card.querySelector(".date-input");
        dateInput.addEventListener("change", (e) => {
          updateDraft(draft.id, { date: e.target.value });
        });

        // Submit button
        const submitBtn = card.querySelector(".btn-submit");
        submitBtn.addEventListener("click", () => {
          submitDraft(draft.id);
        });

        // Delete button
        const deleteBtn = card.querySelector(".btn-delete");
        deleteBtn.addEventListener("click", () => {
          if (confirm("Are you sure you want to delete this draft?")) {
            deleteDraft(draft.id);
          }
        });
      }

      // Update draft
      function updateDraft(id, updates) {
        const draft = drafts.find((d) => d.id === id);
        if (draft) {
          Object.assign(draft, updates);
          saveDrafts();
        }
      }

      // Delete draft
      function deleteDraft(id) {
        drafts = drafts.filter((d) => d.id !== id);
        saveDrafts();
        renderDrafts();
      }

      // Helper function to convert base64 to Blob
      function base64ToBlob(base64Data) {
        const parts = base64Data.split(";base64,");
        const contentType = parts[0].split(":")[1];
        const raw = window.atob(parts[1]);
        const rawLength = raw.length;
        const uint8Array = new Uint8Array(rawLength);

        for (let i = 0; i < rawLength; i++) {
          uint8Array[i] = raw.charCodeAt(i);
        }

        return new Blob([uint8Array], { type: contentType });
      }

      // Submit draft to iNaturalist
      async function submitDraft(id) {
        const draft = drafts.find((d) => d.id === id);
        if (!draft) return;

        if (!isAuthenticated || !accessToken) {
          alert("Please sign in with iNaturalist first");
          return;
        }

        // Validation
        if (!draft.photo) {
          alert("Photo is required");
          return;
        }

        if (!draft.date) {
          alert("Date is required");
          return;
        }

        const statusEl = document.querySelector(
          `.submission-status[data-id="${id}"]`
        );
        const submitBtn = document.querySelector(
          `.btn-submit[data-id="${id}"]`
        );

        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";

        statusEl.className = "submission-status";
        statusEl.textContent = "‚è≥ Uploading observation...";
        statusEl.style.display = "block";

        try {
          // Convert base64 image to Blob
          const photoBlob = base64ToBlob(draft.photo);

          // Create FormData
          const formData = new FormData();

          // Add observation fields (matching the API example structure)
          formData.append("observation[observed_on_string]", draft.date);

          if (draft.notes) {
            formData.append("observation[description]", draft.notes);
          }

          if (draft.taxonId) {
            formData.append("observation[taxon_id]", draft.taxonId);
          } else if (draft.taxon) {
            formData.append("observation[species_guess]", draft.taxon);
          }

          if (draft.latitude && draft.longitude) {
            formData.append("observation[latitude]", draft.latitude);
            formData.append("observation[longitude]", draft.longitude);

            // Add place_guess (location name)
            if (draft.location) {
              formData.append("observation[place_guess]", draft.location);
            }
          }

          // Add photo
          formData.append(
            "observation[photos][]",
            photoBlob,
            `observation_${Date.now()}.jpg`
          );

          // Submit to iNaturalist API
          const response = await fetch(
            "https://api.inaturalist.org/v1/observations",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
              body: formData,
            }
          );

          const data = await response.json();

          console.log("API Response:", data);
          console.log("Response status:", response.status);

          if (response.ok && data && data.length > 0) {
            // Success
            const observation = data[0];
            const observationUrl = `https://www.inaturalist.org/observations/${observation.id}`;

            statusEl.className = "submission-status success";
            statusEl.innerHTML = `‚úÖ Observation submitted! <a href="${observationUrl}" target="_blank" style="color: #155724; text-decoration: underline;">View on iNaturalist</a>`;

            updateDraft(id, {
              submissionStatus: "success",
              observationId: observation.id,
              observationUrl: observationUrl,
            });

            submitBtn.textContent = "‚úì Submitted";
          } else {
            // API returned error - show detailed error info
            let errorMessage = "Failed to create observation";

            if (data.errors) {
              if (Array.isArray(data.errors)) {
                errorMessage = data.errors.join(", ");
              } else if (typeof data.errors === "object") {
                errorMessage = Object.entries(data.errors)
                  .map(([key, value]) => `${key}: ${Array.isArray(value) ? value.join(", ") : value}`)
                  .join("; ");
              }
            } else if (data.error) {
              errorMessage = data.error;
            }

            console.error("API Error:", errorMessage, data);
            throw new Error(errorMessage);
          }
        } catch (error) {
          console.error("Error submitting observation:", error);

          let errorMessage = "‚ùå Failed to submit observation";

          if (error.message.includes("401") || error.message.includes("Unauthorized")) {
            errorMessage += " - Invalid or expired token. Please sign in again.";
          } else if (error.message.includes("429")) {
            errorMessage += " - Rate limit exceeded. Please try again later.";
          } else if (error.message) {
            errorMessage += ` - ${error.message}`;
          }

          statusEl.className = "submission-status error";
          statusEl.textContent = errorMessage;

          updateDraft(id, { submissionStatus: "error" });

          submitBtn.disabled = false;
          submitBtn.textContent = "Retry Submit";
        }
      }

      // Initialize
      checkAuth();
      loadDrafts();
    </script>
    <script
      defer
      data-domain="glauberramos.github.io/inat"
      src="https://plausible.io/js/script.js"
    ></script>
  </body>
</html>
