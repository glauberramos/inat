<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile - iNaturalist Stats & Analytics</title>
    <link rel="icon" href="favicon.ico" />
    <link rel="canonical" href="https://glauberramos.github.io/inat/profile.html" />
    <meta
      name="description"
      content="View detailed iNaturalist user profile statistics including species counts, observation quality breakdown, endemic and introduced species, and biodiversity metrics."
    />
    <meta
      name="keywords"
      content="iNaturalist profile, user statistics, species count, research grade, endemic species, introduced species, biodiversity metrics"
    />
    <meta property="og:title" content="User Profile - iNaturalist Stats & Analytics" />
    <meta property="og:description" content="View detailed iNaturalist user profile statistics and biodiversity metrics." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://glauberramos.github.io/inat/profile.html" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="User Profile - iNaturalist" />
    <meta name="twitter:description" content="View detailed iNaturalist user profile statistics and biodiversity metrics." />
    <meta name="robots" content="index, follow" />
    <meta name="author" content="Glauber Ramos" />
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "User Profile",
      "description": "View detailed iNaturalist user profile statistics including species counts, observation quality breakdown, and biodiversity metrics.",
      "url": "https://glauberramos.github.io/inat/profile.html",
      "applicationCategory": "UtilitiesApplication",
      "operatingSystem": "Web",
      "author": {
        "@type": "Person",
        "name": "Glauber Ramos"
      }
    }
    </script>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="dark-mode.css" />
    <style>
      .profile-header {
        background: linear-gradient(135deg, #74ac00 0%, #5d8a00 100%);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 25px;
        color: white;
        display: flex;
        align-items: center;
        gap: 25px;
        box-shadow: 0 4px 15px rgba(116, 172, 0, 0.3);
      }

      .profile-left {
        display: flex;
        align-items: center;
        gap: 25px;
        flex: 1;
      }

      .recent-photos-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 0;
        width: 400px;
        height: 100%;
        flex-shrink: 0;
        overflow: hidden;
        border-radius: 12px;
        margin: -30px;
        margin-left: 20px;
      }

      .recent-photo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.2s, opacity 0.2s;
      }

      .recent-photo:hover {
        transform: scale(1.15);
        z-index: 1;
        opacity: 0.9;
      }

      .recent-photo-link {
        display: block;
        line-height: 0;
        overflow: hidden;
      }

      .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      .profile-avatar-placeholder {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        border: 4px solid rgba(255, 255, 255, 0.3);
      }

      .profile-info {
        flex: 1;
      }

      .profile-name {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .profile-login {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 10px;
      }

      .profile-meta {
        display: flex;
        gap: 20px;
        font-size: 0.9rem;
        opacity: 0.85;
      }

      .profile-meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
      }

      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e0e0e0;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      }

      a.stat-card {
        text-decoration: none;
        color: inherit;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .stat-value.green { color: #74ac00; }
      .stat-value.blue { color: #3498db; }
      .stat-value.orange { color: #e67e22; }
      .stat-value.red { color: #e74c3c; }
      .stat-value.purple { color: #9b59b6; }
      .stat-value.teal { color: #1abc9c; }

      .stat-label {
        font-size: 0.85rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .charts-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
      }

      .chart-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e0e0e0;
      }

      .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 15px;
        text-align: center;
      }

      .pie-chart-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 30px;
      }

      .pie-chart {
        width: 180px;
        height: 180px;
        border-radius: 50%;
        position: relative;
      }

      .pie-legend {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
      }

      .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
      }

      .legend-label {
        color: #666;
      }

      .legend-value {
        font-weight: 600;
        color: #333;
        margin-left: auto;
      }

      .taxon-chart-container {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        justify-content: center;
        height: 150px;
        padding: 10px 0;
      }

      .taxon-bar-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .taxon-bar-col:hover {
        opacity: 0.8;
      }

      .taxon-bar-wrapper {
        width: 36px;
        background: #f0f0f0;
        border-radius: 4px 4px 0 0;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        overflow: hidden;
      }

      .taxon-bar {
        width: 100%;
        border-radius: 4px 4px 0 0;
        transition: height 0.5s ease-out;
        min-height: 4px;
      }

      .taxon-bar-value {
        font-size: 11px;
        font-weight: 600;
        color: #666;
        text-align: center;
      }

      .taxon-bar-emoji {
        font-size: 18px;
      }

      .taxon-bar-name {
        font-size: 9px;
        color: #888;
        text-align: center;
        max-width: 40px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .search-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e0e0e0;
        margin-bottom: 25px;
      }

      .search-row {
        display: flex;
        gap: 6px;
        align-items: center;
        justify-content: center;
        max-width: 500px;
        margin: 0 auto;
      }

      .search-row .input-wrapper {
        position: relative;
        width: 300px;
      }

      .search-row .input-wrapper input {
        width: 100%;
      }

      .profile-links {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .profile-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        color: white;
        text-decoration: none;
        font-size: 0.85rem;
        transition: background 0.2s;
      }

      .profile-link:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
      }

      .map-card {
        max-width: 50%;
      }

      .world-grid-map {
        display: grid;
        grid-template-columns: repeat(32, 1fr);
        gap: 0;
        border-radius: 6px;
        background: #1a1a1a;
        position: relative;
        overflow: hidden;
      }

      .world-grid-map img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: fill;
      }

      .grid-cell {
        aspect-ratio: 1;
        position: relative;
        z-index: 1;
        background: transparent;
      }

      .grid-cell.observed {
        background: rgba(116, 172, 0, 0.8);
      }

      .map-subtitle {
        text-align: center;
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 15px;
      }

      @media (max-width: 768px) {
        .map-card {
          max-width: 100%;
        }
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 15px;
      }

      .empty-state-text {
        font-size: 1.1rem;
      }

      @media (max-width: 768px) {
        .profile-header {
          flex-direction: column;
          text-align: center;
          padding: 25px 20px;
        }

        .profile-left {
          flex-direction: column;
        }

        .profile-meta {
          justify-content: center;
          flex-wrap: wrap;
        }

        .profile-links {
          justify-content: center;
          flex-wrap: wrap;
        }

        .recent-photos-grid {
          width: calc(100% + 40px);
          max-width: none;
          height: 80px;
          margin: 15px -20px -25px -20px;
          border-radius: 0 0 16px 16px;
          grid-template-columns: repeat(10, 1fr);
          grid-template-rows: 1fr;
        }

        .charts-row {
          grid-template-columns: 1fr;
        }

        .pie-chart-container {
          flex-direction: column;
          gap: 20px;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .search-row .input-wrapper {
          width: 100%;
        }

        .search-row {
          flex-direction: column;
          gap: 10px;
        }

        .search-row button {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        body {
          padding-top: 60px;
        }

        .back-button {
          font-size: 0.8rem !important;
          padding: 8px 12px !important;
          top: 10px !important;
          left: 10px !important;
        }

        .profile-header {
          padding: 20px 15px;
        }

        .profile-avatar,
        .profile-avatar-placeholder {
          width: 70px;
          height: 70px;
          font-size: 36px;
        }

        .profile-name {
          font-size: 1.3rem;
        }

        .profile-login {
          font-size: 0.95rem;
        }

        .profile-meta {
          font-size: 0.8rem;
          gap: 12px;
        }

        .profile-links {
          gap: 8px;
        }

        .profile-link {
          font-size: 0.75rem;
          padding: 6px 12px;
        }

        .recent-photos-grid {
          height: 60px;
          margin: 15px -15px -20px -15px;
          width: calc(100% + 30px);
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
        }

        .stat-card {
          padding: 15px 10px;
        }

        .stat-value {
          font-size: 1.4rem;
        }

        .stat-label {
          font-size: 0.7rem;
        }

        .chart-card {
          padding: 15px;
        }

        .chart-title {
          font-size: 1rem;
        }

        .taxon-chart-container {
          height: 120px;
          gap: 4px;
          flex-wrap: wrap;
        }

        .taxon-bar-wrapper {
          width: 24px;
        }

        .taxon-bar-emoji {
          font-size: 12px;
        }

        .taxon-bar-value {
          font-size: 8px;
        }

        .taxon-bar-name {
          display: none;
        }

        .pie-chart {
          width: 150px;
          height: 150px;
        }

        .legend-item {
          font-size: 0.8rem;
        }

        .map-card {
          max-width: 100%;
        }

        .world-grid-map {
          grid-template-columns: repeat(16, 1fr);
        }

        .search-card {
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <a
      href="/inat"
      class="back-button"
      style="
        position: fixed;
        top: 20px;
        left: 20px;
        background: #74ac00;
        color: white;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 10px 16px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
      "
      onmouseover="this.style.background='#659900'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.2)'"
      onmouseout="this.style.background='#74ac00'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.15)'"
    >
      <span style="font-size: 1rem">&larr;</span> More iNat tools
    </a>

    <div class="container">
      <header>
        <div class="header-content">
          <div class="title-container">
            <img src="logo.png" alt="iNaturalist Logo" class="logo" />
            <h1>User Profile</h1>
          </div>
          <p class="description">View detailed statistics and biodiversity metrics</p>
        </div>
      </header>

      <main>
        <div class="search-card">
          <div class="search-row">
            <div class="input-wrapper">
              <input
                type="text"
                id="usernameInput"
                placeholder="Enter iNaturalist username..."
                autocomplete="off"
              />
              <div id="usernameAutocomplete" class="username-autocomplete"></div>
            </div>
            <button id="searchButton">View Profile</button>
          </div>
        </div>

        <div id="profileContent" style="display: none;">
          <div class="profile-header" id="profileHeader">
            <div class="profile-left">
              <div id="avatarContainer"></div>
              <div class="profile-info">
                <div class="profile-name" id="profileName"></div>
                <div class="profile-login" id="profileLogin"></div>
                <div class="profile-meta">
                  <div class="profile-meta-item">
                    <span>üìÖ</span>
                    <span id="joinDate"></span>
                  </div>
                  <div class="profile-meta-item">
                    <span>üè∑Ô∏è</span>
                    <span><span id="annotationsCount">0</span> annotations</span>
                  </div>
                  <div class="profile-meta-item">
                    <span>‚úÖ</span>
                    <span><span id="identificationsCount">0</span> identifications</span>
                  </div>
                </div>
                <div class="profile-links">
                  <a href="#" id="inatProfileLink" class="profile-link" target="_blank">
                    <span>üîó</span> iNaturalist Profile
                  </a>
                  <a href="#" id="speciesLink" class="profile-link">
                    <span>üìä</span> View Species
                  </a>
                </div>
              </div>
            </div>
            <div class="recent-photos-grid" id="recentPhotosGrid"></div>
          </div>

          <div class="stats-grid">
            <a href="#" id="observationsLink" class="stat-card" target="_blank">
              <div class="stat-value green" id="totalObservations">0</div>
              <div class="stat-label">Observations</div>
            </a>
            <a href="#" id="speciesLink2" class="stat-card" target="_blank">
              <div class="stat-value blue" id="totalSpecies">0</div>
              <div class="stat-label">Species</div>
            </a>
            <a href="#" id="threatenedLink" class="stat-card" target="_blank">
              <div class="stat-value red" id="threatenedCount">0</div>
              <div class="stat-label">Threatened</div>
            </a>
            <a href="#" id="endemicLink" class="stat-card" target="_blank">
              <div class="stat-value purple" id="endemicCount">0</div>
              <div class="stat-label">Endemic</div>
            </a>
            <a href="#" id="introducedLink" class="stat-card" target="_blank">
              <div class="stat-value orange" id="introducedCount">0</div>
              <div class="stat-label">Introduced</div>
            </a>
            <a href="#" id="nativeLink" class="stat-card" target="_blank">
              <div class="stat-value teal" id="nativeCount">0</div>
              <div class="stat-label">Native</div>
            </a>
          </div>

          <div class="chart-card" style="margin-bottom: 20px;">
            <div class="chart-title">Species by Category</div>
            <div class="taxon-chart-container" id="taxonChart"></div>
          </div>

          <div class="charts-row">
            <div class="chart-card">
              <div class="chart-title">Observation Quality</div>
              <div class="pie-chart-container">
                <canvas id="pieChart" width="180" height="180"></canvas>
                <div class="pie-legend" id="pieLegend"></div>
              </div>
            </div>
            <div class="chart-card">
              <div class="chart-title">Identification Categories</div>
              <div class="pie-chart-container">
                <canvas id="idPieChart" width="180" height="180"></canvas>
                <div class="pie-legend" id="idPieLegend"></div>
              </div>
            </div>
          </div>

          <div class="chart-card map-card">
            <div class="chart-title">World Observation Map</div>
            <div class="map-subtitle" id="mapSubtitle"></div>
            <div class="world-grid-map" id="worldGridMap"></div>
          </div>
        </div>

        <div id="emptyState" class="empty-state"></div>

        <div id="loading" class="loading" style="display: none;">Loading profile data...</div>
        <div id="errorMessage" class="error-message"></div>
      </main>
    </div>

    <script>
      const usernameInput = document.getElementById('usernameInput');
      const usernameAutocomplete = document.getElementById('usernameAutocomplete');
      const searchButton = document.getElementById('searchButton');
      const profileContent = document.getElementById('profileContent');
      const emptyState = document.getElementById('emptyState');
      const loading = document.getElementById('loading');
      const errorMessage = document.getElementById('errorMessage');

      let searchTimeout = null;

      // Load saved username
      const savedUsername = localStorage.getItem('inatUsername');
      if (savedUsername) {
        usernameInput.value = savedUsername;
      }

      // Username autocomplete
      usernameInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();

        if (query.length < 2) {
          usernameAutocomplete.innerHTML = '';
          usernameAutocomplete.style.display = 'none';
          return;
        }

        searchTimeout = setTimeout(async () => {
          try {
            const response = await fetch(
              `https://api.inaturalist.org/v1/users/autocomplete?q=${encodeURIComponent(query)}`
            );
            const data = await response.json();

            if (data.results && data.results.length > 0) {
              usernameAutocomplete.innerHTML = data.results
                .slice(0, 10)
                .map((user) => `
                  <div class="username-suggestion" data-login="${user.login}">
                    <div class="username-name">${user.login}</div>
                    <div class="username-info">${(user.observations_count || 0).toLocaleString()} observations</div>
                  </div>
                `)
                .join('');
              usernameAutocomplete.style.display = 'block';

              document.querySelectorAll('.username-suggestion').forEach((item) => {
                item.addEventListener('click', () => {
                  usernameInput.value = item.dataset.login;
                  usernameAutocomplete.style.display = 'none';
                  loadProfile();
                });
              });
            } else {
              usernameAutocomplete.style.display = 'none';
            }
          } catch (error) {
            console.error('Error fetching users:', error);
          }
        }, 300);
      });

      // Hide autocomplete when clicking outside
      document.addEventListener('click', (e) => {
        if (!usernameInput.contains(e.target) && !usernameAutocomplete.contains(e.target)) {
          usernameAutocomplete.style.display = 'none';
        }
      });

      // Search button and enter key
      searchButton.addEventListener('click', loadProfile);
      usernameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadProfile();
      });

      async function loadProfile() {
        const username = usernameInput.value.trim();
        if (!username) {
          showError('Please enter a username');
          return;
        }

        hideError();
        emptyState.style.display = 'none';
        profileContent.style.display = 'none';
        loading.style.display = 'block';

        try {
          // Fetch user data
          const userResponse = await fetch(
            `https://api.inaturalist.org/v1/users/autocomplete?q=${encodeURIComponent(username)}`
          );
          const userData = await userResponse.json();

          if (!userData.results || userData.results.length === 0) {
            throw new Error('User not found');
          }

          const user = userData.results.find(u => u.login.toLowerCase() === username.toLowerCase()) || userData.results[0];
          localStorage.setItem('inatUsername', user.login);

          // Update profile header
          const avatarContainer = document.getElementById('avatarContainer');
          if (user.icon) {
            const highResIcon = user.icon.replace(/medium|square|small|thumb/g, 'original');
            avatarContainer.innerHTML = `<img src="${highResIcon}" alt="${user.login}" class="profile-avatar">`;
          } else {
            avatarContainer.innerHTML = `<div class="profile-avatar-placeholder">üë§</div>`;
          }

          document.getElementById('profileName').textContent = user.name || user.login;
          document.getElementById('profileLogin').textContent = `@${user.login}`;

          if (user.created_at) {
            const joinDate = new Date(user.created_at);
            document.getElementById('joinDate').textContent = `Joined ${joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}`;
          }

          document.getElementById('annotationsCount').textContent = (user.annotated_observations_count || 0).toLocaleString();
          document.getElementById('identificationsCount').textContent = (user.identifications_count || 0).toLocaleString();
          document.getElementById('inatProfileLink').href = `https://www.inaturalist.org/people/${user.login}`;
          document.getElementById('speciesLink').href = `/inat/species-observed?user=${user.login}`;

          // Set stat card links
          document.getElementById('observationsLink').href = `https://www.inaturalist.org/observations?user_id=${user.login}`;
          document.getElementById('speciesLink2').href = `https://www.inaturalist.org/observations?user_id=${user.login}&view=species`;
          document.getElementById('threatenedLink').href = `https://www.inaturalist.org/observations?user_id=${user.login}&threatened=true&view=species`;
          document.getElementById('endemicLink').href = `https://www.inaturalist.org/observations?user_id=${user.login}&endemic=true&view=species`;
          document.getElementById('introducedLink').href = `https://www.inaturalist.org/observations?user_id=${user.login}&introduced=true&view=species`;
          document.getElementById('nativeLink').href = `https://www.inaturalist.org/observations?user_id=${user.login}&native=true&view=species`;

          // Basic stats
          document.getElementById('totalObservations').textContent = (user.observations_count || 0).toLocaleString();

          // Fetch species count
          const speciesResponse = await fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${user.id}&per_page=0`
          );
          const speciesData = await speciesResponse.json();
          document.getElementById('totalSpecies').textContent = (speciesData.total_results || 0).toLocaleString();

          // Fetch observation quality grades
          const [researchResponse, needsIdResponse, casualResponse] = await Promise.all([
            fetch(`https://api.inaturalist.org/v1/observations?user_id=${user.id}&quality_grade=research&per_page=0`),
            fetch(`https://api.inaturalist.org/v1/observations?user_id=${user.id}&quality_grade=needs_id&per_page=0`),
            fetch(`https://api.inaturalist.org/v1/observations?user_id=${user.id}&quality_grade=casual&per_page=0`)
          ]);

          const [researchData, needsIdData, casualData] = await Promise.all([
            researchResponse.json(),
            needsIdResponse.json(),
            casualResponse.json()
          ]);

          const qualityData = {
            research: researchData.total_results || 0,
            needsId: needsIdData.total_results || 0,
            casual: casualData.total_results || 0
          };

          lastQualityData = qualityData;
          drawPieChart(qualityData);

          // Fetch identification categories (only for others' observations)
          const [improvingResponse, supportingResponse, leadingResponse, maverickResponse] = await Promise.all([
            fetch(`https://api.inaturalist.org/v1/identifications?user_id=${user.id}&category=improving&own_observation=false&per_page=0`),
            fetch(`https://api.inaturalist.org/v1/identifications?user_id=${user.id}&category=supporting&own_observation=false&per_page=0`),
            fetch(`https://api.inaturalist.org/v1/identifications?user_id=${user.id}&category=leading&own_observation=false&per_page=0`),
            fetch(`https://api.inaturalist.org/v1/identifications?user_id=${user.id}&category=maverick&own_observation=false&per_page=0`)
          ]);

          const [improvingData, supportingData, leadingData, maverickData] = await Promise.all([
            improvingResponse.json(),
            supportingResponse.json(),
            leadingResponse.json(),
            maverickResponse.json()
          ]);

          const idData = {
            improving: improvingData.total_results || 0,
            supporting: supportingData.total_results || 0,
            leading: leadingData.total_results || 0,
            maverick: maverickData.total_results || 0
          };

          lastIdData = idData;
          drawIdPieChart(idData);

          // Fetch threatened, endemic, introduced, native counts
          const [threatenedResponse, endemicResponse, introducedResponse, nativeResponse] = await Promise.all([
            fetch(`https://api.inaturalist.org/v1/observations/species_counts?user_id=${user.id}&threatened=true&per_page=0`),
            fetch(`https://api.inaturalist.org/v1/observations/species_counts?user_id=${user.id}&endemic=true&per_page=0`),
            fetch(`https://api.inaturalist.org/v1/observations/species_counts?user_id=${user.id}&introduced=true&per_page=0`),
            fetch(`https://api.inaturalist.org/v1/observations/species_counts?user_id=${user.id}&native=true&per_page=0`)
          ]);

          const [threatenedData, endemicData, introducedData, nativeData] = await Promise.all([
            threatenedResponse.json(),
            endemicResponse.json(),
            introducedResponse.json(),
            nativeResponse.json()
          ]);

          document.getElementById('threatenedCount').textContent = (threatenedData.total_results || 0).toLocaleString();
          document.getElementById('endemicCount').textContent = (endemicData.total_results || 0).toLocaleString();
          document.getElementById('introducedCount').textContent = (introducedData.total_results || 0).toLocaleString();
          document.getElementById('nativeCount').textContent = (nativeData.total_results || 0).toLocaleString();

          // Fetch species by iconic taxon for bar chart
          await renderTaxonChart(user.id);

          // Fetch recent observations with photos
          await loadRecentPhotos(user.login);

          // Load world grid map
          await loadWorldGridMap(user.id);

          loading.style.display = 'none';
          profileContent.style.display = 'block';

        } catch (error) {
          console.error('Error loading profile:', error);
          loading.style.display = 'none';
          showError(error.message || 'Error loading profile. Please try again.');
          emptyState.style.display = 'block';
        }
      }

      function drawPieChart(data) {
        const canvas = document.getElementById('pieChart');
        const ctx = canvas.getContext('2d');
        const total = data.research + data.needsId + data.casual;

        if (total === 0) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = '#ccc';
          ctx.font = '14px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('No data', canvas.width / 2, canvas.height / 2);
          return;
        }

        const colors = {
          research: '#27ae60',
          needsId: '#f39c12',
          casual: '#95a5a6'
        };

        const labels = {
          research: 'Research Grade',
          needsId: 'Needs ID',
          casual: 'Casual'
        };

        // Draw pie chart
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 80;

        let startAngle = -Math.PI / 2;

        Object.entries(data).forEach(([key, value]) => {
          if (value > 0) {
            const sliceAngle = (value / total) * 2 * Math.PI;

            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
            ctx.closePath();
            ctx.fillStyle = colors[key];
            ctx.fill();

            startAngle += sliceAngle;
          }
        });

        // Draw center circle for donut effect
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius * 0.65, 0, 2 * Math.PI);
        ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#2d2d2d' : 'white';
        ctx.fill();

        // Draw total in center
        ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#e0e0e0' : '#333';
        ctx.font = 'bold 18px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(total.toLocaleString(), centerX, centerY - 8);
        ctx.font = '11px sans-serif';
        ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#aaa' : '#666';
        ctx.fillText('total', centerX, centerY + 12);

        // Update legend
        const legend = document.getElementById('pieLegend');
        legend.innerHTML = Object.entries(data).map(([key, value]) => {
          const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
          return `
            <div class="legend-item">
              <div class="legend-color" style="background: ${colors[key]};"></div>
              <span class="legend-label">${labels[key]}</span>
              <span class="legend-value">${value.toLocaleString()} (${percentage}%)</span>
            </div>
          `;
        }).join('');
      }

      function drawIdPieChart(data) {
        const canvas = document.getElementById('idPieChart');
        const ctx = canvas.getContext('2d');
        const total = data.improving + data.supporting + data.leading + data.maverick;

        if (total === 0) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#888' : '#ccc';
          ctx.font = '14px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('No data', canvas.width / 2, canvas.height / 2);
          return;
        }

        const colors = {
          improving: '#27ae60',
          supporting: '#3498db',
          leading: '#9b59b6',
          maverick: '#e74c3c'
        };

        const labels = {
          improving: 'Improving',
          supporting: 'Supporting',
          leading: 'Leading',
          maverick: 'Maverick'
        };

        // Draw pie chart
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 80;

        let startAngle = -Math.PI / 2;

        Object.entries(data).forEach(([key, value]) => {
          if (value > 0) {
            const sliceAngle = (value / total) * 2 * Math.PI;

            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
            ctx.closePath();
            ctx.fillStyle = colors[key];
            ctx.fill();

            startAngle += sliceAngle;
          }
        });

        // Draw center circle for donut effect
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius * 0.65, 0, 2 * Math.PI);
        ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#2d2d2d' : 'white';
        ctx.fill();

        // Draw total in center
        ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#e0e0e0' : '#333';
        ctx.font = 'bold 18px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(total.toLocaleString(), centerX, centerY - 8);
        ctx.font = '11px sans-serif';
        ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#aaa' : '#666';
        ctx.fillText('total', centerX, centerY + 12);

        // Update legend
        const legend = document.getElementById('idPieLegend');
        legend.innerHTML = Object.entries(data).map(([key, value]) => {
          const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
          return `
            <div class="legend-item">
              <div class="legend-color" style="background: ${colors[key]};"></div>
              <span class="legend-label">${labels[key]}</span>
              <span class="legend-value">${value.toLocaleString()} (${percentage}%)</span>
            </div>
          `;
        }).join('');
      }

      async function renderTaxonChart(userId) {
        const taxonChart = document.getElementById('taxonChart');

        const iconicTaxonData = {
          Plantae: { emoji: 'üåø', name: 'Plants', color: '#74ac00', count: 0 },
          Insecta: { emoji: 'ü¶ã', name: 'Insects', color: '#e67e22', count: 0 },
          Aves: { emoji: 'ü¶Ö', name: 'Birds', color: '#3498db', count: 0 },
          Fungi: { emoji: 'üçÑ', name: 'Fungi', color: '#9b59b6', count: 0 },
          Mammalia: { emoji: 'ü¶å', name: 'Mammals', color: '#8b4513', count: 0 },
          Reptilia: { emoji: 'ü¶é', name: 'Reptiles', color: '#27ae60', count: 0 },
          Amphibia: { emoji: 'üê∏', name: 'Amphibians', color: '#16a085', count: 0 },
          Actinopterygii: { emoji: 'üêü', name: 'Fish', color: '#2980b9', count: 0 },
          Mollusca: { emoji: 'üêå', name: 'Mollusks', color: '#7f8c8d', count: 0 },
          Arachnida: { emoji: 'üï∑Ô∏è', name: 'Arachnids', color: '#2c3e50', count: 0 },
          Animalia: { emoji: 'üêæ', name: 'Other Animals', color: '#95a5a6', count: 0 },
          Protozoa: { emoji: 'ü¶†', name: 'Protozoa', color: '#1abc9c', count: 0 },
          Chromista: { emoji: 'üü§', name: 'Chromista', color: '#d35400', count: 0 }
        };

        // Fetch species counts per iconic taxon
        const promises = Object.keys(iconicTaxonData).map(async (taxon) => {
          try {
            const response = await fetch(
              `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&iconic_taxa=${taxon}&per_page=0`
            );
            const data = await response.json();
            iconicTaxonData[taxon].count = data.total_results || 0;
          } catch (error) {
            console.error(`Error fetching ${taxon}:`, error);
          }
        });

        await Promise.all(promises);

        // Sort by count and filter zeros
        const sortedTaxons = Object.entries(iconicTaxonData)
          .filter(([_, data]) => data.count > 0)
          .sort((a, b) => b[1].count - a[1].count);

        if (sortedTaxons.length === 0) {
          taxonChart.innerHTML = '<div style="text-align: center; color: #666;">No species data</div>';
          return;
        }

        const maxCount = sortedTaxons[0][1].count;
        const maxHeight = 100;

        taxonChart.innerHTML = sortedTaxons.map(([key, data]) => {
          const barHeight = Math.max(6, (data.count / maxCount) * maxHeight);
          return `
            <div class="taxon-bar-col" title="${data.name}: ${data.count.toLocaleString()} species">
              <span class="taxon-bar-value">${data.count}</span>
              <div class="taxon-bar-wrapper" style="height: ${maxHeight}px;">
                <div class="taxon-bar" style="height: ${barHeight}px; background: ${data.color};"></div>
              </div>
              <span class="taxon-bar-emoji">${data.emoji}</span>
            </div>
          `;
        }).join('');
      }

      async function loadWorldGridMap(userId) {
        const mapContainer = document.getElementById('worldGridMap');
        const mapSubtitle = document.getElementById('mapSubtitle');

        try {
          const response = await fetch(
            `https://api.inaturalist.org/v1/grid/0/0/0.grid.json?user_id=${userId}`
          );
          const worldGridData = await response.json();

          // Parse UTF Grid to find cells with observations (same logic as achievements)
          const displayGridSize = 32;
          const observedGridCells = new Map();

          if (worldGridData && worldGridData.grid && worldGridData.keys && worldGridData.data) {
            const utfGridSize = worldGridData.grid.length;
            const groupSize = utfGridSize / displayGridSize;
            const dataKeys = Object.keys(worldGridData.data);

            dataKeys.forEach(dataKey => {
              const keyIndex = worldGridData.keys.indexOf(dataKey);
              if (keyIndex <= 0) return;

              for (let row = 0; row < utfGridSize; row++) {
                const gridRow = worldGridData.grid[row];
                if (!gridRow) continue;

                for (let col = 0; col < gridRow.length; col++) {
                  let id = gridRow.charCodeAt(col);
                  if (id >= 93) id--;
                  if (id >= 35) id--;
                  id -= 32;

                  if (id === keyIndex) {
                    const displayRow = Math.floor(row / groupSize);
                    const displayCol = Math.floor(col / groupSize);
                    const cellKey = displayRow + "," + displayCol;
                    observedGridCells.set(cellKey, true);
                    return;
                  }
                }
              }
            });
          }

          const observedGridSquares = observedGridCells.size;

          // Update subtitle
          mapSubtitle.textContent = `${observedGridSquares} grid squares explored`;

          // Render map (same as achievements)
          let html = '<img src="https://tile.openstreetmap.org/0/0/0.png" alt="">';

          for (let row = 0; row < displayGridSize; row++) {
            for (let col = 0; col < displayGridSize; col++) {
              const cellKey = row + ',' + col;
              const hasObservation = observedGridCells.has(cellKey);
              const bgColor = hasObservation ? 'rgba(116, 172, 0, 0.8)' : 'transparent';
              html += '<div style="aspect-ratio: 1; background: ' + bgColor + '; position: relative; z-index: 1;"></div>';
            }
          }

          mapContainer.innerHTML = html;

        } catch (error) {
          console.error('Error loading world grid map:', error);
          mapContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Unable to load map</div>';
        }
      }

      async function loadRecentPhotos(username) {
        const grid = document.getElementById('recentPhotosGrid');

        try {
          const response = await fetch(
            `https://api.inaturalist.org/v1/observations?user_id=${username}&photos=true&per_page=10&order_by=created_at&order=desc`
          );
          const data = await response.json();

          if (data.results && data.results.length > 0) {
            grid.innerHTML = data.results.map(obs => {
              const photo = obs.photos && obs.photos[0];
              if (!photo) return '';
              const photoUrl = photo.url.replace('square', 'small');
              return `
                <a href="https://www.inaturalist.org/observations/${obs.id}" target="_blank" class="recent-photo-link" title="${obs.species_guess || 'Observation'}">
                  <img src="${photoUrl}" alt="${obs.species_guess || 'Observation'}" class="recent-photo">
                </a>
              `;
            }).join('');
          } else {
            grid.innerHTML = '';
          }
        } catch (error) {
          console.error('Error loading recent photos:', error);
          grid.innerHTML = '';
        }
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add('show');
      }

      function hideError() {
        errorMessage.classList.remove('show');
      }

      // Redraw pie charts when dark mode changes
      let lastQualityData = null;
      let lastIdData = null;

      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.attributeName === 'class') {
            if (profileContent.style.display !== 'none') {
              // Re-draw charts with cached data
              if (lastQualityData) {
                drawPieChart(lastQualityData);
              }
              if (lastIdData) {
                drawIdPieChart(lastIdData);
              }
            }
          }
        });
      });

      observer.observe(document.body, { attributes: true });
    </script>
    <script defer data-domain="glauberramos.github.io/inat" src="https://plausible.io/js/script.js"></script>
    <script src="dark-mode.js"></script>
  </body>
</html>
