<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile - iNaturalist Stats & Analytics</title>
    <link rel="icon" href="favicon.ico" />
    <link rel="canonical" href="https://glauberramos.github.io/inat/profile.html" />
    <meta
      name="description"
      content="View detailed iNaturalist user profile statistics including species counts, observation quality breakdown, endemic and introduced species, and biodiversity metrics."
    />
    <meta
      name="keywords"
      content="iNaturalist profile, user statistics, species count, research grade, endemic species, introduced species, biodiversity metrics"
    />
    <meta property="og:title" content="User Profile - iNaturalist Stats & Analytics" />
    <meta property="og:description" content="View detailed iNaturalist user profile statistics and biodiversity metrics." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://glauberramos.github.io/inat/profile.html" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="User Profile - iNaturalist" />
    <meta name="twitter:description" content="View detailed iNaturalist user profile statistics and biodiversity metrics." />
    <meta name="robots" content="index, follow" />
    <meta name="author" content="Glauber Ramos" />
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "User Profile",
      "description": "View detailed iNaturalist user profile statistics including species counts, observation quality breakdown, and biodiversity metrics.",
      "url": "https://glauberramos.github.io/inat/profile.html",
      "applicationCategory": "UtilitiesApplication",
      "operatingSystem": "Web",
      "author": {
        "@type": "Person",
        "name": "Glauber Ramos"
      }
    }
    </script>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="dark-mode.css" />
    <style>
      .profile-header {
        background: linear-gradient(135deg, #74ac00 0%, #5d8a00 100%);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 25px;
        color: white;
        display: flex;
        align-items: center;
        gap: 25px;
        box-shadow: 0 4px 15px rgba(116, 172, 0, 0.3);
      }

      .profile-left {
        display: flex;
        align-items: center;
        gap: 25px;
        flex: 1;
      }

      .recent-photos-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 0;
        width: 400px;
        height: 100%;
        flex-shrink: 0;
        overflow: hidden;
        border-radius: 12px;
        margin: -30px;
        margin-left: 20px;
      }

      .recent-photo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.2s, opacity 0.2s;
      }

      .recent-photo:hover {
        transform: scale(1.15);
        z-index: 1;
        opacity: 0.9;
      }

      .recent-photo-link {
        display: block;
        line-height: 0;
        overflow: hidden;
      }

      .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      .profile-avatar-placeholder {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        border: 4px solid rgba(255, 255, 255, 0.3);
      }

      .profile-info {
        flex: 1;
      }

      .profile-name {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .profile-login {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 10px;
      }

      .profile-meta {
        display: flex;
        gap: 20px;
        font-size: 0.9rem;
        opacity: 0.85;
      }

      .profile-meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
      }

      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e0e0e0;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      }

      a.stat-card {
        text-decoration: none;
        color: inherit;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .stat-value.green { color: #74ac00; }
      .stat-value.blue { color: #74ac00; }
      .stat-value.orange { color: #74ac00; }
      .stat-value.red { color: #e74c3c; }
      .stat-value.purple { color: #74ac00; }
      .stat-value.teal { color: #74ac00; }

      .stat-label {
        font-size: 0.85rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .charts-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
      }

      .chart-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e0e0e0;
      }

      .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 15px;
        text-align: center;
      }

      .pie-chart-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 30px;
      }

      .pie-chart {
        width: 180px;
        height: 180px;
        border-radius: 50%;
        position: relative;
      }

      .pie-legend {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
      }

      .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
      }

      .legend-label {
        color: #666;
      }

      .legend-value {
        font-weight: 600;
        color: #333;
        margin-left: auto;
      }

      .taxon-chart-container {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        justify-content: center;
        height: 150px;
        padding: 10px 0;
      }

      .taxon-bar-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: opacity 0.2s;
        text-decoration: none;
        color: inherit;
      }

      .taxon-bar-col:hover {
        opacity: 0.8;
      }

      a.taxon-bar-col:hover {
        color: inherit;
      }

      .taxon-bar-wrapper {
        width: 36px;
        background: #f0f0f0;
        border-radius: 4px 4px 0 0;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        overflow: hidden;
      }

      .taxon-bar {
        width: 100%;
        border-radius: 4px 4px 0 0;
        transition: height 0.5s ease-out;
        min-height: 4px;
      }

      .taxon-bar-value {
        font-size: 11px;
        font-weight: 600;
        color: #666;
        text-align: center;
      }

      .taxon-bar-emoji {
        font-size: 18px;
      }

      .taxon-bar-name {
        font-size: 9px;
        color: #888;
        text-align: center;
        max-width: 40px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .search-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e0e0e0;
        margin-bottom: 25px;
      }

      .search-row {
        display: flex;
        gap: 6px;
        align-items: center;
        justify-content: center;
        max-width: 500px;
        margin: 0 auto;
      }

      .search-row .input-wrapper {
        position: relative;
        width: 300px;
      }

      .search-row .input-wrapper input {
        width: 100%;
      }

      .profile-links {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .profile-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        color: white;
        text-decoration: none;
        font-size: 0.85rem;
        transition: background 0.2s;
      }

      .profile-link:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
      }

      .map-card {
        flex: 1;
        min-width: 0;
      }

      .world-grid-map {
        display: grid;
        grid-template-columns: repeat(32, 1fr);
        gap: 0;
        border-radius: 6px;
        background: #1a1a1a;
        position: relative;
        overflow: hidden;
      }

      .world-grid-map img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: fill;
      }

      .grid-cell {
        aspect-ratio: 1;
        position: relative;
        z-index: 1;
        background: transparent;
      }

      .grid-cell.observed {
        background: rgba(116, 172, 0, 0.8);
      }

      .map-subtitle {
        text-align: center;
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 15px;
      }

      .countries-card {
        flex: 1;
        min-width: 0;
      }

      .countries-subtitle {
        text-align: center;
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 15px;
      }

      .countries-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        max-height: 250px;
        overflow-y: auto;
      }

      .country-item {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: #f5f5f5;
        border-radius: 20px;
        font-size: 0.85rem;
        text-decoration: none;
        color: inherit;
        transition: background 0.2s, transform 0.2s;
      }

      .country-item:hover {
        background: #e8e8e8;
        transform: translateY(-1px);
      }

      .country-flag {
        font-size: 1.2rem;
      }

      .country-name {
        font-weight: 500;
        color: #333;
      }

      .country-count {
        color: #666;
        font-size: 0.8rem;
      }

      .countries-loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .countries-progress {
        font-size: 0.85rem;
        color: #888;
        margin-top: 10px;
      }

      /* Calendar styles */
      .calendar-card {
        margin-bottom: 20px;
      }

      .calendar-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .calendar-header .chart-title {
        margin-bottom: 0;
      }

      .calendar-year-select {
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9rem;
        background: white;
        cursor: pointer;
      }

      .calendar-streak-info {
        display: flex;
        gap: 20px;
        font-size: 0.9rem;
        color: #666;
      }

      .calendar-streak-info strong {
        color: #74ac00;
      }

      .calendar-container {
        display: flex;
        gap: 8px;
        justify-content: center;
      }

      .calendar-weekdays {
        display: flex;
        flex-direction: column;
        gap: 2px;
        font-size: 10px;
        color: #888;
        padding-top: 20px;
      }

      .calendar-weekday {
        height: 12px;
        display: flex;
        align-items: center;
      }

      .calendar-wrapper {
        overflow-x: auto;
      }

      .calendar-months {
        display: flex;
        font-size: 10px;
        color: #888;
        margin-bottom: 4px;
        height: 16px;
      }

      .calendar-month {
        text-align: left;
      }

      .calendar-grid {
        display: grid;
        grid-template-rows: repeat(7, 12px);
        grid-auto-flow: column;
        grid-auto-columns: 12px;
        gap: 2px;
      }

      .calendar-day {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        background: #ebedf0;
      }

      .calendar-day[data-level="1"] { background: #c6e48b; }
      .calendar-day[data-level="2"] { background: #7bc96f; }
      .calendar-day[data-level="3"] { background: #40c463; }
      .calendar-day[data-level="4"] { background: #30d158; }

      .calendar-day:hover {
        outline: 1px solid #666;
      }

      .calendar-day.today {
        outline: 2px solid #74ac00;
        outline-offset: -1px;
      }

      @media (max-width: 768px) {
        .map-card {
          max-width: 100%;
        }

        .countries-card {
          max-width: 100%;
        }

        .calendar-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .calendar-year-select {
          margin-left: 0;
        }

        .calendar-streak-info {
          flex-direction: column;
          gap: 5px;
        }

        .calendar-grid {
          grid-template-rows: repeat(7, 10px);
          grid-auto-columns: 10px;
        }

        .calendar-day {
          width: 10px;
          height: 10px;
        }

        .calendar-weekday {
          height: 10px;
        }
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 15px;
      }

      .empty-state-text {
        font-size: 1.1rem;
      }

      @media (max-width: 768px) {
        .profile-header {
          flex-direction: column;
          text-align: center;
          padding: 25px 20px;
        }

        .profile-left {
          flex-direction: column;
        }

        .profile-meta {
          justify-content: center;
          flex-wrap: wrap;
        }

        .profile-links {
          justify-content: center;
          flex-wrap: wrap;
        }

        .recent-photos-grid {
          width: calc(100% + 40px);
          max-width: none;
          height: 80px;
          margin: 15px -20px -25px -20px;
          border-radius: 0 0 16px 16px;
          grid-template-columns: repeat(10, 1fr);
          grid-template-rows: 1fr;
        }

        .charts-row {
          grid-template-columns: 1fr;
        }

        .pie-chart-container {
          flex-direction: column;
          gap: 20px;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .search-row .input-wrapper {
          width: 100%;
        }

        .search-row {
          flex-direction: column;
          gap: 10px;
        }

        .search-row button {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        body {
          padding-top: 60px;
        }

        .back-button {
          font-size: 0.8rem !important;
          padding: 8px 12px !important;
          top: 10px !important;
          left: 10px !important;
        }

        .profile-header {
          padding: 20px 15px;
        }

        .profile-avatar,
        .profile-avatar-placeholder {
          width: 70px;
          height: 70px;
          font-size: 36px;
        }

        .profile-name {
          font-size: 1.3rem;
        }

        .profile-login {
          font-size: 0.95rem;
        }

        .profile-meta {
          font-size: 0.8rem;
          gap: 12px;
        }

        .profile-links {
          gap: 8px;
        }

        .profile-link {
          font-size: 0.75rem;
          padding: 6px 12px;
        }

        .recent-photos-grid {
          height: 60px;
          margin: 15px -15px -20px -15px;
          width: calc(100% + 30px);
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
        }

        .stat-card {
          padding: 15px 10px;
        }

        .stat-value {
          font-size: 1.4rem;
        }

        .stat-label {
          font-size: 0.7rem;
        }

        .chart-card {
          padding: 15px;
        }

        .chart-title {
          font-size: 1rem;
        }

        .taxon-chart-container {
          height: 120px;
          gap: 4px;
          flex-wrap: wrap;
        }

        .taxon-bar-wrapper {
          width: 24px;
        }

        .taxon-bar-emoji {
          font-size: 12px;
        }

        .taxon-bar-value {
          font-size: 8px;
        }

        .taxon-bar-name {
          display: none;
        }

        .pie-chart {
          width: 150px;
          height: 150px;
        }

        .legend-item {
          font-size: 0.8rem;
        }

        .map-card {
          max-width: 100%;
        }

        .world-grid-map {
          grid-template-columns: repeat(16, 1fr);
        }

        .search-card {
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <a
      href="/inat"
      class="back-button"
      style="
        position: fixed;
        top: 20px;
        left: 20px;
        background: #74ac00;
        color: white;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 10px 16px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
      "
      onmouseover="this.style.background='#659900'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.2)'"
      onmouseout="this.style.background='#74ac00'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.15)'"
    >
      <span style="font-size: 1rem">&larr;</span> More iNat tools
    </a>

    <div class="container">
      <header>
        <div class="header-content">
          <div class="title-container">
            <img src="logo.png" alt="iNaturalist Logo" class="logo" />
            <h1>User Profile</h1>
          </div>
          <p class="description">View detailed statistics and biodiversity metrics</p>
        </div>
      </header>

      <main>
        <div class="search-card">
          <div class="search-row">
            <div class="input-wrapper">
              <input
                type="text"
                id="usernameInput"
                placeholder="Enter iNaturalist username..."
                autocomplete="off"
              />
              <div id="usernameAutocomplete" class="username-autocomplete"></div>
            </div>
            <button id="searchButton">View Profile</button>
          </div>
        </div>

        <div id="profileContent" style="display: none;">
          <div class="profile-header" id="profileHeader">
            <div class="profile-left">
              <div id="avatarContainer"></div>
              <div class="profile-info">
                <div class="profile-name" id="profileName"></div>
                <div class="profile-login" id="profileLogin"></div>
                <div class="profile-meta">
                  <div class="profile-meta-item">
                    <span>üìÖ</span>
                    <span id="joinDate"></span>
                  </div>
                  <div class="profile-meta-item">
                    <span>üì∑</span>
                    <span>Last obs: <span id="lastObsDate">-</span></span>
                  </div>
                  <div class="profile-meta-item">
                    <span>üè∑Ô∏è</span>
                    <span><span id="annotationsCount">0</span> annotations</span>
                  </div>
                  <div class="profile-meta-item">
                    <span>‚úÖ</span>
                    <span><span id="identificationsCount">0</span> identifications</span>
                  </div>
                </div>
                <div class="profile-links">
                  <a href="#" id="inatProfileLink" class="profile-link" target="_blank">
                    <span>üîó</span> iNaturalist Profile
                  </a>
                  <a href="#" id="speciesLink" class="profile-link">
                    <span>üìä</span> View Species
                  </a>
                  <a href="#" id="lifelistLink" class="profile-link">
                    <span>üìÖ</span> Lifelist
                  </a>
                  <a href="#" id="achievementsLink" class="profile-link">
                    <span>üèÜ</span> Achievements
                  </a>
                </div>
              </div>
            </div>
            <div class="recent-photos-grid" id="recentPhotosGrid"></div>
          </div>

          <div class="stats-grid">
            <a href="#" id="observationsLink" class="stat-card" target="_blank">
              <div class="stat-value green" id="totalObservations">0</div>
              <div class="stat-label">Observations</div>
            </a>
            <a href="#" id="speciesLink2" class="stat-card" target="_blank">
              <div class="stat-value blue" id="totalSpecies">0</div>
              <div class="stat-label">Species</div>
            </a>
            <div class="stat-card">
              <div class="stat-value green" id="speciesRatio">0%</div>
              <div class="stat-label">Species/Obs Ratio</div>
            </div>
            <a href="#" id="threatenedLink" class="stat-card" target="_blank">
              <div class="stat-value red" id="threatenedCount">0</div>
              <div class="stat-label">Threatened</div>
            </a>
            <a href="#" id="endemicLink" class="stat-card" target="_blank">
              <div class="stat-value purple" id="endemicCount">0</div>
              <div class="stat-label">Endemic</div>
            </a>
            <a href="#" id="introducedLink" class="stat-card" target="_blank">
              <div class="stat-value orange" id="introducedCount">0</div>
              <div class="stat-label">Introduced</div>
            </a>
            <a href="#" id="nativeLink" class="stat-card" target="_blank">
              <div class="stat-value teal" id="nativeCount">0</div>
              <div class="stat-label">Native</div>
            </a>
            <a href="#" id="journalLink" class="stat-card" target="_blank">
              <div class="stat-value green" id="journalCount">0</div>
              <div class="stat-label">Journal Posts</div>
            </a>
          </div>

          <div class="chart-card" style="margin-bottom: 20px;">
            <div class="chart-title">Species by Category</div>
            <div class="taxon-chart-container" id="taxonChart"></div>
          </div>

          <div class="charts-row">
            <div class="chart-card">
              <div class="chart-title">Observation Categories</div>
              <div class="pie-chart-container">
                <canvas id="pieChart" width="180" height="180"></canvas>
                <div class="pie-legend" id="pieLegend"></div>
              </div>
            </div>
            <div class="chart-card">
              <div class="chart-title">Identification Categories</div>
              <div class="pie-chart-container">
                <canvas id="idPieChart" width="180" height="180"></canvas>
                <div class="pie-legend" id="idPieLegend"></div>
              </div>
            </div>
          </div>

          <div class="chart-card calendar-card">
            <div class="calendar-header">
              <div class="chart-title">Activity Calendar</div>
              <div class="calendar-streak-info">
                <span>Current streak: <strong id="currentStreak">0</strong> days</span>
                <span>Longest streak: <strong id="longestStreak">0</strong> days</span>
              </div>
              <select id="calendarYearSelect" class="calendar-year-select"></select>
            </div>
            <div class="calendar-container">
              <div class="calendar-weekdays">
                <div class="calendar-weekday">Sun</div>
                <div class="calendar-weekday">Mon</div>
                <div class="calendar-weekday">Tue</div>
                <div class="calendar-weekday">Wed</div>
                <div class="calendar-weekday">Thu</div>
                <div class="calendar-weekday">Fri</div>
                <div class="calendar-weekday">Sat</div>
              </div>
              <div class="calendar-wrapper">
                <div class="calendar-months" id="calendarMonths"></div>
                <div class="calendar-grid" id="calendarGrid"></div>
              </div>
            </div>
          </div>

          <div class="charts-row">
            <div class="chart-card map-card">
              <div class="chart-title">World Observation Map</div>
              <div class="map-subtitle" id="mapSubtitle"></div>
              <div class="world-grid-map" id="worldGridMap"></div>
            </div>
            <div class="chart-card countries-card">
              <div class="chart-title">Countries & Regions Observed</div>
              <div class="countries-subtitle" id="countriesSubtitle">Loading...</div>
              <div class="countries-grid" id="countriesGrid"></div>
            </div>
          </div>
        </div>

        <div id="emptyState" class="empty-state"></div>

        <div id="loading" class="loading" style="display: none;">Loading profile data...</div>
        <div id="errorMessage" class="error-message"></div>
      </main>
    </div>

    <script>
      const usernameInput = document.getElementById('usernameInput');
      const usernameAutocomplete = document.getElementById('usernameAutocomplete');
      const searchButton = document.getElementById('searchButton');
      const profileContent = document.getElementById('profileContent');
      const emptyState = document.getElementById('emptyState');
      const loading = document.getElementById('loading');
      const errorMessage = document.getElementById('errorMessage');

      let searchTimeout = null;

      // Load saved username
      const savedUsername = localStorage.getItem('inatUsername');
      if (savedUsername) {
        usernameInput.value = savedUsername;
      }

      // Username autocomplete
      usernameInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();

        if (query.length < 2) {
          usernameAutocomplete.innerHTML = '';
          usernameAutocomplete.style.display = 'none';
          return;
        }

        searchTimeout = setTimeout(async () => {
          try {
            const response = await fetch(
              `https://api.inaturalist.org/v1/users/autocomplete?q=${encodeURIComponent(query)}`
            );
            const data = await response.json();

            if (data.results && data.results.length > 0) {
              usernameAutocomplete.innerHTML = data.results
                .slice(0, 10)
                .map((user) => `
                  <div class="username-suggestion" data-login="${user.login}">
                    <div class="username-name">${user.login}</div>
                    <div class="username-info">${(user.observations_count || 0).toLocaleString()} observations</div>
                  </div>
                `)
                .join('');
              usernameAutocomplete.style.display = 'block';

              document.querySelectorAll('.username-suggestion').forEach((item) => {
                item.addEventListener('click', () => {
                  usernameInput.value = item.dataset.login;
                  usernameAutocomplete.style.display = 'none';
                  loadProfile();
                });
              });
            } else {
              usernameAutocomplete.style.display = 'none';
            }
          } catch (error) {
            console.error('Error fetching users:', error);
          }
        }, 300);
      });

      // Hide autocomplete when clicking outside
      document.addEventListener('click', (e) => {
        if (!usernameInput.contains(e.target) && !usernameAutocomplete.contains(e.target)) {
          usernameAutocomplete.style.display = 'none';
        }
      });

      // Search button and enter key
      searchButton.addEventListener('click', loadProfile);
      usernameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadProfile();
      });

      // Helper for delay between API calls
      const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

      let loadingStep = 0;
      const totalLoadingSteps = 28;

      function updateLoadingProgress(step) {
        loadingStep = step;
        const percent = Math.round((loadingStep / totalLoadingSteps) * 100);
        loading.textContent = `Loading profile data... ${percent}%`;
      }

      async function loadProfile() {
        const username = usernameInput.value.trim();
        if (!username) {
          showError('Please enter a username');
          return;
        }

        hideError();
        emptyState.style.display = 'none';
        profileContent.style.display = 'none';
        loadingStep = 0;
        loading.textContent = 'Loading profile data... 0%';
        loading.style.display = 'block';

        try {
          // Fetch user data
          const userResponse = await fetch(
            `https://api.inaturalist.org/v1/users/autocomplete?q=${encodeURIComponent(username)}`
          );
          const userData = await userResponse.json();
          updateLoadingProgress(1);
          await delay(250);

          if (!userData.results || userData.results.length === 0) {
            throw new Error('User not found');
          }

          const user = userData.results.find(u => u.login.toLowerCase() === username.toLowerCase()) || userData.results[0];
          localStorage.setItem('inatUsername', user.login);

          // Update profile header
          const avatarContainer = document.getElementById('avatarContainer');
          if (user.icon) {
            const highResIcon = user.icon.replace(/medium|square|small|thumb/g, 'original');
            avatarContainer.innerHTML = `<img src="${highResIcon}" alt="${user.login}" class="profile-avatar">`;
          } else {
            avatarContainer.innerHTML = `<div class="profile-avatar-placeholder">üë§</div>`;
          }

          document.getElementById('profileName').textContent = user.name || user.login;
          document.getElementById('profileLogin').textContent = `@${user.login}`;

          if (user.created_at) {
            const joinDate = new Date(user.created_at);
            document.getElementById('joinDate').textContent = `Joined ${joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}`;
          }

          document.getElementById('annotationsCount').textContent = (user.annotated_observations_count || 0).toLocaleString();
          document.getElementById('identificationsCount').textContent = (user.identifications_count || 0).toLocaleString();
          document.getElementById('inatProfileLink').href = `https://www.inaturalist.org/people/${user.login}`;
          document.getElementById('speciesLink').href = `/inat/species-observed?user=${user.login}`;
          document.getElementById('lifelistLink').href = `/inat/lifelist.html?user=${user.login}`;
          document.getElementById('achievementsLink').href = `/inat/achievements.html?user=${user.login}`;

          // Set stat card links
          document.getElementById('observationsLink').href = `https://www.inaturalist.org/observations?user_id=${user.login}`;
          document.getElementById('speciesLink2').href = `https://www.inaturalist.org/observations?user_id=${user.login}&view=species`;
          document.getElementById('threatenedLink').href = `https://www.inaturalist.org/observations?user_id=${user.login}&threatened=true&view=species`;
          document.getElementById('endemicLink').href = `https://www.inaturalist.org/observations?user_id=${user.login}&endemic=true&view=species`;
          document.getElementById('introducedLink').href = `https://www.inaturalist.org/observations?user_id=${user.login}&introduced=true&view=species`;
          document.getElementById('nativeLink').href = `https://www.inaturalist.org/observations?user_id=${user.login}&native=true&view=species`;
          document.getElementById('journalCount').textContent = (user.journal_posts_count || 0).toLocaleString();
          document.getElementById('journalLink').href = `https://www.inaturalist.org/journal/${user.login}`;

          // Basic stats
          document.getElementById('totalObservations').textContent = (user.observations_count || 0).toLocaleString();

          // Fetch species count
          const speciesResponse = await fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${user.id}&per_page=0`
          );
          const speciesData = await speciesResponse.json();
          updateLoadingProgress(2);
          await delay(250);
          const speciesCount = speciesData.total_results || 0;
          const observationsCount = user.observations_count || 0;
          document.getElementById('totalSpecies').textContent = speciesCount.toLocaleString();

          // Calculate species to observation ratio
          const ratio = observationsCount > 0 ? (speciesCount / observationsCount) * 100 : 0;
          document.getElementById('speciesRatio').textContent = ratio.toFixed(1) + '%';

          // Fetch observation quality grades (sequential)
          const researchResponse = await fetch(`https://api.inaturalist.org/v1/observations?user_id=${user.id}&quality_grade=research&per_page=0`);
          const researchData = await researchResponse.json();
          updateLoadingProgress(3);
          await delay(250);

          const needsIdResponse = await fetch(`https://api.inaturalist.org/v1/observations?user_id=${user.id}&quality_grade=needs_id&per_page=0`);
          const needsIdData = await needsIdResponse.json();
          updateLoadingProgress(4);
          await delay(250);

          const casualResponse = await fetch(`https://api.inaturalist.org/v1/observations?user_id=${user.id}&quality_grade=casual&per_page=0`);
          const casualData = await casualResponse.json();
          updateLoadingProgress(5);
          await delay(250);

          const qualityData = {
            research: researchData.total_results || 0,
            needsId: needsIdData.total_results || 0,
            casual: casualData.total_results || 0
          };

          lastQualityData = qualityData;
          drawPieChart(qualityData);

          // Fetch identification categories (sequential, only for others' observations)
          const improvingResponse = await fetch(`https://api.inaturalist.org/v1/identifications?user_id=${user.id}&category=improving&own_observation=false&per_page=0`);
          const improvingData = await improvingResponse.json();
          updateLoadingProgress(6);
          await delay(250);

          const supportingResponse = await fetch(`https://api.inaturalist.org/v1/identifications?user_id=${user.id}&category=supporting&own_observation=false&per_page=0`);
          const supportingData = await supportingResponse.json();
          updateLoadingProgress(7);
          await delay(250);

          const leadingResponse = await fetch(`https://api.inaturalist.org/v1/identifications?user_id=${user.id}&category=leading&own_observation=false&per_page=0`);
          const leadingData = await leadingResponse.json();
          updateLoadingProgress(8);
          await delay(250);

          const maverickResponse = await fetch(`https://api.inaturalist.org/v1/identifications?user_id=${user.id}&category=maverick&own_observation=false&per_page=0`);
          const maverickData = await maverickResponse.json();
          updateLoadingProgress(9);
          await delay(250);

          const idData = {
            improving: improvingData.total_results || 0,
            supporting: supportingData.total_results || 0,
            leading: leadingData.total_results || 0,
            maverick: maverickData.total_results || 0
          };

          // Update identifications count to match pie chart total (only others' observations)
          const totalIdentifications = idData.improving + idData.supporting + idData.leading + idData.maverick;
          document.getElementById('identificationsCount').textContent = totalIdentifications.toLocaleString();

          lastIdData = idData;
          drawIdPieChart(idData);

          // Fetch threatened, endemic, introduced, native counts (sequential to avoid rate limiting)
          const threatenedResponse = await fetch(`https://api.inaturalist.org/v1/observations/species_counts?user_id=${user.id}&threatened=true&per_page=0`);
          const threatenedData = await threatenedResponse.json();
          document.getElementById('threatenedCount').textContent = (threatenedData.total_results || 0).toLocaleString();
          updateLoadingProgress(10);
          await delay(250);

          const endemicResponse = await fetch(`https://api.inaturalist.org/v1/observations/species_counts?user_id=${user.id}&endemic=true&per_page=0`);
          const endemicData = await endemicResponse.json();
          document.getElementById('endemicCount').textContent = (endemicData.total_results || 0).toLocaleString();
          updateLoadingProgress(11);
          await delay(250);

          const introducedResponse = await fetch(`https://api.inaturalist.org/v1/observations/species_counts?user_id=${user.id}&introduced=true&per_page=0`);
          const introducedData = await introducedResponse.json();
          document.getElementById('introducedCount').textContent = (introducedData.total_results || 0).toLocaleString();
          updateLoadingProgress(12);
          await delay(250);

          const nativeResponse = await fetch(`https://api.inaturalist.org/v1/observations/species_counts?user_id=${user.id}&native=true&per_page=0`);
          const nativeData = await nativeResponse.json();
          document.getElementById('nativeCount').textContent = (nativeData.total_results || 0).toLocaleString();
          updateLoadingProgress(13);
          await delay(250);

          // Fetch species by iconic taxon for bar chart
          await renderTaxonChart(user.id, user.login);
          await delay(250);

          // Fetch recent observations with photos
          await loadRecentPhotos(user.login);
          updateLoadingProgress(27);
          await delay(250);

          // Load world grid map
          await loadWorldGridMap(user.id);
          updateLoadingProgress(28);
          await delay(250);

          loading.style.display = 'none';
          profileContent.style.display = 'block';

          // Load calendar (independent, has its own loading state)
          const joinYear = user.created_at ? new Date(user.created_at).getFullYear() : new Date().getFullYear();
          await loadCalendar(user.id, user.login, joinYear);
          await delay(250);

          // Load countries (independent, has its own loading state)
          await loadCountriesObserved(user.id, user.login);

        } catch (error) {
          console.error('Error loading profile:', error);
          loading.style.display = 'none';
          showError(error.message || 'Error loading profile. Please try again.');
          emptyState.style.display = 'block';
        }
      }

      function drawPieChart(data) {
        const canvas = document.getElementById('pieChart');
        const ctx = canvas.getContext('2d');
        const total = data.research + data.needsId + data.casual;

        if (total === 0) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = '#ccc';
          ctx.font = '14px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('No data', canvas.width / 2, canvas.height / 2);
          return;
        }

        const colors = {
          research: '#27ae60',
          needsId: '#f39c12',
          casual: '#95a5a6'
        };

        const labels = {
          research: 'Research Grade',
          needsId: 'Needs ID',
          casual: 'Casual'
        };

        // Draw pie chart
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 80;

        let startAngle = -Math.PI / 2;

        Object.entries(data).forEach(([key, value]) => {
          if (value > 0) {
            const sliceAngle = (value / total) * 2 * Math.PI;

            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
            ctx.closePath();
            ctx.fillStyle = colors[key];
            ctx.fill();

            startAngle += sliceAngle;
          }
        });

        // Draw center circle for donut effect
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius * 0.65, 0, 2 * Math.PI);
        ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#2d2d2d' : 'white';
        ctx.fill();

        // Draw total in center
        ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#e0e0e0' : '#333';
        ctx.font = 'bold 18px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(total.toLocaleString(), centerX, centerY - 8);
        ctx.font = '11px sans-serif';
        ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#aaa' : '#666';
        ctx.fillText('total', centerX, centerY + 12);

        // Update legend
        const legend = document.getElementById('pieLegend');
        legend.innerHTML = Object.entries(data).map(([key, value]) => {
          const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
          return `
            <div class="legend-item">
              <div class="legend-color" style="background: ${colors[key]};"></div>
              <span class="legend-label">${labels[key]}</span>
              <span class="legend-value">${value.toLocaleString()} (${percentage}%)</span>
            </div>
          `;
        }).join('');
      }

      function drawIdPieChart(data) {
        const canvas = document.getElementById('idPieChart');
        const ctx = canvas.getContext('2d');
        const total = data.improving + data.supporting + data.leading + data.maverick;

        if (total === 0) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#888' : '#ccc';
          ctx.font = '14px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('No data', canvas.width / 2, canvas.height / 2);
          return;
        }

        const colors = {
          improving: '#27ae60',
          supporting: '#3498db',
          leading: '#9b59b6',
          maverick: '#e74c3c'
        };

        const labels = {
          improving: 'Improving',
          supporting: 'Supporting',
          leading: 'Leading',
          maverick: 'Maverick'
        };

        // Draw pie chart
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 80;

        let startAngle = -Math.PI / 2;

        Object.entries(data).forEach(([key, value]) => {
          if (value > 0) {
            const sliceAngle = (value / total) * 2 * Math.PI;

            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
            ctx.closePath();
            ctx.fillStyle = colors[key];
            ctx.fill();

            startAngle += sliceAngle;
          }
        });

        // Draw center circle for donut effect
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius * 0.65, 0, 2 * Math.PI);
        ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#2d2d2d' : 'white';
        ctx.fill();

        // Draw total in center
        ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#e0e0e0' : '#333';
        ctx.font = 'bold 18px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(total.toLocaleString(), centerX, centerY - 8);
        ctx.font = '11px sans-serif';
        ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#aaa' : '#666';
        ctx.fillText('total', centerX, centerY + 12);

        // Update legend
        const legend = document.getElementById('idPieLegend');
        legend.innerHTML = Object.entries(data).map(([key, value]) => {
          const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
          return `
            <div class="legend-item">
              <div class="legend-color" style="background: ${colors[key]};"></div>
              <span class="legend-label">${labels[key]}</span>
              <span class="legend-value">${value.toLocaleString()} (${percentage}%)</span>
            </div>
          `;
        }).join('');
      }

      async function renderTaxonChart(userId, username) {
        const taxonChart = document.getElementById('taxonChart');

        const iconicTaxonData = {
          Plantae: { emoji: 'üåø', name: 'Plants', color: '#74ac00', count: 0 },
          Insecta: { emoji: 'ü¶ã', name: 'Insects', color: '#e67e22', count: 0 },
          Aves: { emoji: 'ü¶Ö', name: 'Birds', color: '#3498db', count: 0 },
          Fungi: { emoji: 'üçÑ', name: 'Fungi', color: '#9b59b6', count: 0 },
          Mammalia: { emoji: 'ü¶å', name: 'Mammals', color: '#8b4513', count: 0 },
          Reptilia: { emoji: 'ü¶é', name: 'Reptiles', color: '#27ae60', count: 0 },
          Amphibia: { emoji: 'üê∏', name: 'Amphibians', color: '#16a085', count: 0 },
          Actinopterygii: { emoji: 'üêü', name: 'Fish', color: '#2980b9', count: 0 },
          Mollusca: { emoji: 'üêå', name: 'Mollusks', color: '#7f8c8d', count: 0 },
          Arachnida: { emoji: 'üï∑Ô∏è', name: 'Arachnids', color: '#2c3e50', count: 0 },
          Animalia: { emoji: 'üêæ', name: 'Other Animals', color: '#95a5a6', count: 0 },
          Protozoa: { emoji: 'ü¶†', name: 'Protozoa', color: '#1abc9c', count: 0 },
          Chromista: { emoji: 'üü§', name: 'Chromista', color: '#d35400', count: 0 }
        };

        // Fetch species counts per iconic taxon (sequential)
        let taxonIndex = 0;
        for (const taxon of Object.keys(iconicTaxonData)) {
          try {
            const response = await fetch(
              `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&iconic_taxa=${taxon}&verifiable=true&per_page=0`
            );
            const data = await response.json();
            iconicTaxonData[taxon].count = data.total_results || 0;
            updateLoadingProgress(14 + taxonIndex);
            taxonIndex++;
            await delay(250);
          } catch (error) {
            console.error(`Error fetching ${taxon}:`, error);
            taxonIndex++;
          }
        }

        // Sort by count and filter zeros
        const sortedTaxons = Object.entries(iconicTaxonData)
          .filter(([_, data]) => data.count > 0)
          .sort((a, b) => b[1].count - a[1].count);

        if (sortedTaxons.length === 0) {
          taxonChart.innerHTML = '<div style="text-align: center; color: #666;">No species data</div>';
          return;
        }

        const maxCount = sortedTaxons[0][1].count;
        const maxHeight = 100;

        taxonChart.innerHTML = sortedTaxons.map(([key, data]) => {
          const barHeight = Math.max(6, (data.count / maxCount) * maxHeight);
          const inatUrl = `https://www.inaturalist.org/observations?user_id=${username}&iconic_taxa=${key}&verifiable=true&view=species`;
          return `
            <a href="${inatUrl}" target="_blank" class="taxon-bar-col" title="${data.name}: ${data.count.toLocaleString()} species">
              <span class="taxon-bar-value">${data.count}</span>
              <div class="taxon-bar-wrapper" style="height: ${maxHeight}px;">
                <div class="taxon-bar" style="height: ${barHeight}px; background: ${data.color};"></div>
              </div>
              <span class="taxon-bar-emoji">${data.emoji}</span>
            </a>
          `;
        }).join('');
      }

      async function loadWorldGridMap(userId) {
        const mapContainer = document.getElementById('worldGridMap');
        const mapSubtitle = document.getElementById('mapSubtitle');

        try {
          const response = await fetch(
            `https://api.inaturalist.org/v1/grid/0/0/0.grid.json?user_id=${userId}`
          );
          const worldGridData = await response.json();

          // Parse UTF Grid to find cells with observations (same logic as achievements)
          const displayGridSize = 32;
          const observedGridCells = new Map();

          if (worldGridData && worldGridData.grid && worldGridData.keys && worldGridData.data) {
            const utfGridSize = worldGridData.grid.length;
            const groupSize = utfGridSize / displayGridSize;
            const dataKeys = Object.keys(worldGridData.data);

            dataKeys.forEach(dataKey => {
              const keyIndex = worldGridData.keys.indexOf(dataKey);
              if (keyIndex <= 0) return;

              for (let row = 0; row < utfGridSize; row++) {
                const gridRow = worldGridData.grid[row];
                if (!gridRow) continue;

                for (let col = 0; col < gridRow.length; col++) {
                  let id = gridRow.charCodeAt(col);
                  if (id >= 93) id--;
                  if (id >= 35) id--;
                  id -= 32;

                  if (id === keyIndex) {
                    const displayRow = Math.floor(row / groupSize);
                    const displayCol = Math.floor(col / groupSize);
                    const cellKey = displayRow + "," + displayCol;
                    observedGridCells.set(cellKey, true);
                    return;
                  }
                }
              }
            });
          }

          const observedGridSquares = observedGridCells.size;

          // Update subtitle
          mapSubtitle.textContent = `${observedGridSquares} grid squares explored`;

          // Render map (same as achievements)
          let html = '<img src="https://tile.openstreetmap.org/0/0/0.png" alt="">';

          for (let row = 0; row < displayGridSize; row++) {
            for (let col = 0; col < displayGridSize; col++) {
              const cellKey = row + ',' + col;
              const hasObservation = observedGridCells.has(cellKey);
              const bgColor = hasObservation ? 'rgba(116, 172, 0, 0.8)' : 'transparent';
              html += '<div style="aspect-ratio: 1; background: ' + bgColor + '; position: relative; z-index: 1;"></div>';
            }
          }

          mapContainer.innerHTML = html;

        } catch (error) {
          console.error('Error loading world grid map:', error);
          mapContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Unable to load map</div>';
        }
      }

      async function loadRecentPhotos(username) {
        const grid = document.getElementById('recentPhotosGrid');
        const lastObsDateEl = document.getElementById('lastObsDate');

        try {
          const response = await fetch(
            `https://api.inaturalist.org/v1/observations?user_id=${username}&photos=true&per_page=10&order_by=observed_on&order=desc`
          );
          const data = await response.json();

          if (data.results && data.results.length > 0) {
            // Update last observation date
            const lastObs = data.results[0];
            if (lastObs.observed_on && lastObsDateEl) {
              const obsDate = new Date(lastObs.observed_on);
              lastObsDateEl.textContent = obsDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
              });
            }

            grid.innerHTML = data.results.map(obs => {
              const photo = obs.photos && obs.photos[0];
              if (!photo) return '';
              const photoUrl = photo.url.replace('square', 'small');
              return `
                <a href="https://www.inaturalist.org/observations/${obs.id}" target="_blank" class="recent-photo-link" title="${obs.species_guess || 'Observation'}">
                  <img src="${photoUrl}" alt="${obs.species_guess || 'Observation'}" class="recent-photo">
                </a>
              `;
            }).join('');
          } else {
            grid.innerHTML = '';
            if (lastObsDateEl) lastObsDateEl.textContent = '-';
          }
        } catch (error) {
          console.error('Error loading recent photos:', error);
          grid.innerHTML = '';
          if (lastObsDateEl) lastObsDateEl.textContent = '-';
        }
      }

      // Country place IDs with flags
      const COUNTRY_FLAGS = {
        1: "üá∫üá∏", 1303: "üáªüá™", 6681: "üáÆüá≥", 6712: "üá®üá¶", 6718: "üáÆüá™", 6734: "üá∏üá¨",
        6737: "üáØüáµ", 6744: "üá¶üá∫", 6748: "üáµüá´", 6774: "üá™üá∏", 6783: "üáßüá¥", 6793: "üá≤üáΩ",
        6815: "üáÆüá±", 6818: "üáÆüá∑", 6845: "üá∏üá≥", 6847: "üáªüá≥", 6857: "üá¨üáß", 6873: "üáµüá≠",
        6878: "üáßüá∑", 6903: "üá®üá≥", 6924: "üá®üá∑", 6925: "üá≥üáÆ", 6929: "üá≠üá≥", 6931: "üá©üá¥",
        6940: "üá¨üáπ", 6944: "üá®üá∫", 6949: "üá¨üá´", 6953: "üáßüáø", 6966: "üáÆüá©", 6967: "üáπüá≠",
        6968: "üá∫üá¨", 6986: "üáøüá¶", 6992: "üá≤üá≤", 7001: "üá±üá¶", 7002: "üá∞üá≠", 7003: "üáµüá¶",
        7008: "üáßüá™", 7013: "üáµüá¨", 7016: "üá≥üá¥", 7020: "üá´üáÆ", 7042: "üá∞üá™", 7046: "üá®üá¨",
        7054: "üá®üá©", 7055: "üá™üá¨", 7063: "üá¨üá≤", 7064: "üá∏üá©", 7074: "üáπüá©", 7076: "üáµüá∞",
        7077: "üá±üá∞", 7082: "üáªüá∫", 7083: "üá≥üá®", 7100: "üá¶üá¥", 7112: "üá¨üá¶", 7113: "üá≤üáº",
        7122: "üáµüáπ", 7133: "üá≤üá∑", 7134: "üá≤üáø", 7141: "üá≥üá¨", 7142: "üá∑üáº", 7143: "üá∏üáø",
        7144: "üáπüáø", 7145: "üáøüá≤", 7147: "üá∑üá∏", 7154: "üáßüá©", 7155: "üá≤üáæ", 7161: "üá∑üá∫",
        7182: "üá®üá±", 7183: "üáπüá∑", 7190: "üá¶üá∑", 7196: "üá®üá¥", 7207: "üá©üá™", 7228: "üá¨üá≠",
        7236: "üá®üá≠", 7254: "üáµüáæ", 7259: "üá∫üáæ", 7278: "üáÆüá∏", 7300: "üá©üáø", 7305: "üá±üáæ",
        7306: "üá≤üá¶", 7312: "üáπüá≥", 7313: "üáßüá∏", 7332: "üá´üáØ", 7333: "üá≥üá´", 7334: "üáºüá´",
        7335: "üá≥üáµ", 7341: "üá¶üá´", 7342: "üá∞üáø", 7346: "üá∞üá¨", 7347: "üá≤üá≥", 7353: "üá∏üáØ",
        7355: "üá∞üáº", 7356: "üá¥üá≤", 7358: "üá∏üá¶", 7375: "üáπüáπ", 7399: "üá≠üá∫", 7487: "üá∏üá±",
        7488: "üá∞üáæ", 7506: "üá≥üá±", 7512: "üá™üá®", 7513: "üáµüá™", 7526: "üá≠üáπ", 7563: "üá∏üáª",
        7578: "üáßüáæ", 7599: "üá∏üá™", 7613: "üá≠üá∞", 7616: "üá®üáΩ", 7690: "üá´üá∞", 7704: "üá¨üá±",
        7707: "üáßüáπ", 7783: "üá≤üá¨", 7800: "üáµüá±", 7827: "üá∏üá∑", 7833: "üáØüá¥", 7837: "üáæüá™",
        7838: "üáßüá≥", 7841: "üáπüá¥", 7846: "üá≤üá±", 7887: "üáπüáº", 7985: "üá¨üá∏", 8004: "üá®üáÆ",
        8050: "üá±üáª", 8142: "üá¨üáæ", 8147: "üá±üá∫", 8177: "üá¨üáµ", 8196: "üá≠üá∑", 8206: "üáÆüá∂",
        8226: "üá¶üá©", 8227: "üá≤üá®", 8228: "üá∏üáÆ", 8240: "üá≤üáπ", 8241: "üáßüá¨", 8263: "üá±üáÆ",
        8266: "üá±üáπ", 8267: "üá∏üá∞", 8357: "üá≤üá∫", 8358: "üá∏üá®", 8360: "üáßüá∂", 8421: "üá∞üá≤",
        8425: "üá≤üáª", 8433: "üá¶üá≤", 8434: "üá¶üáø", 8504: "üáºüá∏", 8511: "üá©üáØ", 8512: "üá¨üá≥",
        8513: "üá¨üáº", 8514: "üá±üá∑", 8515: "üá≥üá™", 8516: "üáπüá¨", 8638: "üáßüá≤", 8748: "üáØüá≤",
        8834: "üá∑üá™", 8857: "üá¨üá™", 8858: "üá∑üá¥", 8859: "üá≤üá™", 8860: "üá∫üá¶", 9173: "üá∏üáπ",
        9184: "üá©üá≤", 9213: "üáªüá¶", 9240: "üá¨üá∂", 9445: "üá®üáª", 9992: "üá¨üá©", 10281: "üá¶üáÆ",
        10282: "üá¶üáΩ", 10283: "üá¶üá¨", 10284: "üáßüá≠", 10285: "üáßüáß", 10286: "üáßüáª", 10287: "üá®üá®",
        10288: "üá®üá∞", 10289: "üá®üáæ", 10290: "üá´üá¥", 10291: "üá¨üá¨", 10292: "üá¨üáÆ", 10293: "üá≠üá≤",
        10294: "üáÆüá≤", 10295: "üáÆüá¥", 10296: "üáØüá™", 10297: "üá∞üá≥", 10298: "üáΩüá∞", 10299: "üá±üáß",
        10300: "üá±üá®", 10301: "üá≤üá¥", 10302: "üá≤üá©", 10303: "üá≤üá∞", 10304: "üá≤üá∏", 10305: "üá≤üá∂",
        10306: "üáæüáπ", 10307: "üá≥üá∫", 10308: "üá≥üá∑", 10309: "üáµüá≥", 10310: "üá∏üá≤", 10311: "üáµüá≤",
        10313: "üáπüá∞", 10314: "üáπüá±", 10315: "üáπüáª", 10316: "üá∫üá≤", 10317: "üáªüá®", 10318: "üáªüá¨",
        10320: "üá®üáµ", 10322: "üá´üá≤", 10323: "üá∞üáÆ", 10324: "üá≤üá≠", 10408: "üá®üáº", 10411: "üá∏üáΩ",
        51356: "üáßüá±", 51360: "üá≤üá´", 51754: "üá∏üá∏", 54505: "üá¶üá∂", 96773: "üá®üáæ", 96774: "üá¨üáß"
      };

      // Country place IDs to names mapping
      const COUNTRY_PLACES = {
        1: "United States", 1303: "Venezuela", 6681: "India", 6712: "Canada",
        6718: "Ireland", 6734: "Singapore", 6737: "Japan", 6744: "Australia",
        6748: "French Polynesia", 6774: "Spain", 6783: "Bolivia", 6793: "Mexico",
        6815: "Israel", 6818: "Iran", 6845: "Senegal", 6847: "Vietnam",
        6857: "United Kingdom", 6873: "Philippines", 6878: "Brazil", 6903: "China",
        6924: "Costa Rica", 6925: "Nicaragua", 6929: "Honduras", 6931: "Dominican Republic",
        6940: "Guatemala", 6944: "Cuba", 6949: "French Guiana", 6953: "Belize",
        6966: "Indonesia", 6967: "Thailand", 6968: "Uganda", 6986: "South Africa",
        6992: "Myanmar", 7001: "Laos", 7002: "Cambodia", 7003: "Panama", 7008: "Belgium",
        7013: "Papua New Guinea", 7016: "Norway", 7020: "Finland", 7042: "Kenya",
        7046: "Republic of Congo", 7054: "DR Congo", 7055: "Egypt", 7063: "Gambia",
        7064: "Sudan", 7074: "Chad", 7076: "Pakistan", 7077: "Sri Lanka", 7082: "Vanuatu",
        7083: "New Caledonia", 7100: "Angola", 7112: "Gabon", 7113: "Malawi",
        7122: "Portugal", 7133: "Mauritania", 7134: "Mozambique", 7141: "Nigeria",
        7142: "Rwanda", 7143: "Eswatini", 7144: "Tanzania", 7145: "Zambia",
        7147: "Serbia", 7154: "Bangladesh", 7155: "Malaysia", 7161: "Russia",
        7182: "Chile", 7183: "T√ºrkiye", 7190: "Argentina", 7196: "Colombia",
        7207: "Germany", 7228: "Ghana", 7236: "Switzerland", 7254: "Paraguay",
        7259: "Uruguay", 7278: "Iceland", 7300: "Algeria", 7305: "Libya",
        7306: "Morocco", 7312: "Tunisia", 7313: "Bahamas", 7332: "Fiji",
        7333: "Norfolk Island", 7334: "Wallis and Futuna", 7335: "Nepal",
        7341: "Afghanistan", 7342: "Kazakhstan", 7346: "Kyrgyzstan", 7347: "Mongolia",
        7353: "Svalbard", 7355: "Kuwait", 7356: "Oman", 7358: "Saudi Arabia",
        7375: "Trinidad and Tobago", 7399: "Hungary", 7487: "Sierra Leone",
        7488: "Cayman Islands", 7506: "Netherlands", 7512: "Ecuador", 7513: "Peru",
        7526: "Haiti", 7563: "El Salvador", 7578: "Belarus", 7599: "Sweden",
        7613: "Hong Kong", 7616: "Christmas Island", 7690: "Falkland Islands",
        7704: "Greenland", 7707: "Bhutan", 7783: "Madagascar", 7800: "Poland",
        7827: "Suriname", 7833: "Jordan", 7837: "Yemen", 7838: "Brunei",
        7841: "Tonga", 7846: "Mali", 7887: "Taiwan", 7985: "South Georgia",
        8004: "C√¥te d'Ivoire", 8050: "Latvia", 8142: "Guyana", 8147: "Luxembourg",
        8177: "Guadeloupe", 8196: "Croatia", 8206: "Iraq", 8226: "Andorra",
        8227: "Monaco", 8228: "Slovenia", 8240: "Malta", 8241: "Bulgaria",
        8263: "Liechtenstein", 8266: "Lithuania", 8267: "Slovakia", 8357: "Mauritius",
        8358: "Seychelles", 8360: "Caribbean Netherlands", 8421: "Comoros",
        8425: "Maldives", 8433: "Armenia", 8434: "Azerbaijan", 8504: "Samoa",
        8511: "Djibouti", 8512: "Guinea", 8513: "Guinea-Bissau", 8514: "Liberia",
        8515: "Niger", 8516: "Togo", 8638: "Bermuda", 8748: "Jamaica",
        8834: "R√©union", 8857: "Georgia", 8858: "Romania", 8859: "Montenegro",
        8860: "Ukraine", 9173: "S√£o Tom√© and Pr√≠ncipe", 9184: "Dominica",
        9213: "Vatican City", 9240: "Equatorial Guinea", 9445: "Cape Verde",
        9992: "Grenada", 10281: "Anguilla", 10282: "√Öland", 10283: "Antigua and Barbuda",
        10284: "Bahrain", 10285: "Barbados", 10286: "Bouvet Island", 10287: "Cocos Islands",
        10288: "Cook Islands", 10289: "Cyprus", 10290: "Faroe Islands", 10291: "Guernsey",
        10292: "Gibraltar", 10293: "Heard Island", 10294: "Isle of Man", 10295: "British Indian Ocean",
        10296: "Jersey", 10297: "Saint Kitts and Nevis", 10298: "Kosovo", 10299: "Lebanon",
        10300: "Saint Lucia", 10301: "Macao", 10302: "Moldova", 10303: "North Macedonia",
        10304: "Montserrat", 10305: "Martinique", 10306: "Mayotte", 10307: "Niue",
        10308: "Nauru", 10309: "Pitcairn Islands", 10310: "San Marino",
        10311: "Saint Pierre and Miquelon", 10313: "Tokelau", 10314: "East Timor",
        10315: "Tuvalu", 10316: "US Minor Outlying Islands", 10317: "Saint Vincent",
        10318: "British Virgin Islands", 10320: "Clipperton Island", 10322: "Micronesia",
        10323: "Kiribati", 10324: "Marshall Islands", 10408: "Cura√ßao", 10411: "Sint Maarten",
        51356: "Saint-Barth√©lemy", 51360: "Saint-Martin", 51754: "South Sudan",
        54505: "Antarctica", 96773: "Northern Cyprus", 96774: "Akrotiri and Dhekelia"
      };

      // Iconic places data
      const ICONIC_PLACES = [
        { id: 12990, name: "Gal√°pagos", flag: "üê¢" },
        { id: 11, name: "Hawaii", flag: "üå∫" },
        { id: 130979, name: "Canary Islands", flag: "üèùÔ∏è" },
        { id: 13197, name: "Azores", flag: "üåã" },
        { id: 7291, name: "Madeira", flag: "üèùÔ∏è" },
        { id: 6, name: "Alaska", flag: "üêª" },
        { id: 10782, name: "Bali", flag: "üèùÔ∏è" },
      ];

      // Build PLACES_DATA from countries and iconic places
      const PLACES_DATA = [
        ...Object.entries(COUNTRY_PLACES).map(([id, name]) => ({
          id: parseInt(id),
          name,
          flag: COUNTRY_FLAGS[id] || "üè≥Ô∏è",
          type: "country"
        })),
        ...ICONIC_PLACES.map(place => ({ ...place, type: "iconic" }))
      ];

      async function loadCountriesObserved(userId, username) {
        const countriesGrid = document.getElementById('countriesGrid');
        const countriesSubtitle = document.getElementById('countriesSubtitle');

        // Show loading state
        countriesGrid.innerHTML = '<div class="countries-loading">üåç Checking countries...<div class="countries-progress" id="countriesProgress">Initializing...</div></div>';
        countriesSubtitle.textContent = 'Loading...';

        const observedPlaces = [];
        const progressEl = document.getElementById('countriesProgress');
        let apiCalls = 0;

        // Check if a batch of place IDs has any observations
        async function checkBatch(placeIds) {
          apiCalls++;
          if (progressEl) {
            progressEl.textContent = `${apiCalls} API calls, ${observedPlaces.length} places found`;
          }
          try {
            const response = await fetch(
              `https://api.inaturalist.org/v1/observations?user_id=${userId}&place_id=${placeIds.join(',')}&verifiable=true&per_page=0`
            );
            const data = await response.json();
            await new Promise(resolve => setTimeout(resolve, 1000));
            return data.total_results > 0;
          } catch (error) {
            console.error('Error checking batch:', error);
            return false;
          }
        }

        // Get count for a single place
        async function getPlaceCount(placeId) {
          apiCalls++;
          if (progressEl) {
            progressEl.textContent = `${apiCalls} API calls, ${observedPlaces.length} places found`;
          }
          try {
            const response = await fetch(
              `https://api.inaturalist.org/v1/observations?user_id=${userId}&place_id=${placeId}&verifiable=true&per_page=0`
            );
            const data = await response.json();
            await new Promise(resolve => setTimeout(resolve, 1000));
            return data.total_results || 0;
          } catch (error) {
            console.error('Error getting count:', error);
            return 0;
          }
        }

        // Binary search to find places with observations
        async function findObservedPlaces(places) {
          if (places.length === 0) return;

          // Single place - get its count directly
          if (places.length === 1) {
            const count = await getPlaceCount(places[0].id);
            if (count > 0) {
              observedPlaces.push({ ...places[0], count });
            }
            return;
          }

          // Check if this batch has any observations
          const placeIds = places.map(p => p.id);
          const hasObservations = await checkBatch(placeIds);

          if (!hasObservations) {
            return; // No observations in this entire batch
          }

          // If batch is small enough, check each individually
          if (places.length <= 4) {
            for (const place of places) {
              const count = await getPlaceCount(place.id);
              if (count > 0) {
                observedPlaces.push({ ...place, count });
              }
            }
            return;
          }

          // Split batch in half and recurse
          const mid = Math.floor(places.length / 2);
          await findObservedPlaces(places.slice(0, mid));
          await findObservedPlaces(places.slice(mid));
        }

        // Start the binary search
        await findObservedPlaces(PLACES_DATA);

        // Sort by observation count (highest first)
        observedPlaces.sort((a, b) => b.count - a.count);

        // Separate countries and iconic places
        const countries = observedPlaces.filter(p => p.type === 'country');
        const iconicPlaces = observedPlaces.filter(p => p.type === 'iconic');

        // Update subtitle
        const countryCount = countries.length;
        const iconicCount = iconicPlaces.length;
        let subtitleText = `${countryCount} ${countryCount === 1 ? 'country' : 'countries'}`;
        if (iconicCount > 0) {
          subtitleText += ` + ${iconicCount} iconic ${iconicCount === 1 ? 'region' : 'regions'}`;
        }
        countriesSubtitle.textContent = subtitleText;

        // Render the grid
        if (observedPlaces.length === 0) {
          countriesGrid.innerHTML = '<div class="countries-loading">No countries found</div>';
          return;
        }

        // Combine: iconic places first, then countries
        const allPlaces = [...iconicPlaces, ...countries];

        countriesGrid.innerHTML = allPlaces.map(place => {
          const inatUrl = `https://www.inaturalist.org/observations?user_id=${username}&place_id=${place.id}`;
          return `
            <a href="${inatUrl}" target="_blank" class="country-item" title="${place.name}: ${place.count.toLocaleString()} observations">
              <span class="country-flag">${place.flag}</span>
              <span class="country-name">${place.name}</span>
              <span class="country-count">(${place.count.toLocaleString()})</span>
            </a>
          `;
        }).join('');
      }

      // Calendar functions
      let currentUserId = null;
      let currentUsername = null;
      let currentUserJoinYear = null;

      // Helper function to format date as YYYY-MM-DD in local time
      function formatDateLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      async function loadCalendar(userId, username, joinYear) {
        currentUserId = userId;
        currentUsername = username;
        currentUserJoinYear = joinYear;

        const yearSelect = document.getElementById('calendarYearSelect');
        const currentYear = new Date().getFullYear();

        // Find earliest year with data (might be before join year due to backdated observations)
        let earliestYear = joinYear;
        try {
          const response = await fetch(
            `https://api.inaturalist.org/v1/observations?user_id=${userId}&order=asc&order_by=observed_on&per_page=1`
          );
          const data = await response.json();
          await delay(250);
          if (data.results && data.results.length > 0 && data.results[0].observed_on) {
            const firstObsYear = new Date(data.results[0].observed_on).getFullYear();
            earliestYear = Math.min(joinYear, firstObsYear);
          }
        } catch (error) {
          console.error('Error fetching earliest observation:', error);
        }

        // Populate year selector
        yearSelect.innerHTML = '';
        for (let year = currentYear; year >= earliestYear; year--) {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        }

        yearSelect.addEventListener('change', async () => {
          await renderCalendarForYear(parseInt(yearSelect.value));
        });

        // Load current year
        await renderCalendarForYear(currentYear);
        await delay(250);

        // Calculate streaks across all years
        await calculateAllStreaks(userId, earliestYear, currentYear);
      }

      async function renderCalendarForYear(year) {
        const calendarGrid = document.getElementById('calendarGrid');
        const calendarMonths = document.getElementById('calendarMonths');

        calendarGrid.innerHTML = '<div style="padding: 20px; color: #666;">Loading...</div>';

        try {
          const response = await fetch(
            `https://api.inaturalist.org/v1/observations/histogram?user_id=${currentUserId}&d1=${year}-01-01&d2=${year}-12-31&date_field=observed&interval=day`
          );
          const data = await response.json();
          await delay(250);
          const dayData = data.results?.day || {};

          renderCalendar(dayData, year);
        } catch (error) {
          console.error('Error loading calendar:', error);
          calendarGrid.innerHTML = '<div style="padding: 20px; color: #666;">Error loading calendar</div>';
        }
      }

      function renderCalendar(dayData, year) {
        const calendarGrid = document.getElementById('calendarGrid');
        const calendarMonths = document.getElementById('calendarMonths');

        // Get first day of the year
        const startDate = new Date(year, 0, 1);
        const endDate = new Date(year, 11, 31);
        const today = new Date();
        today.setHours(23, 59, 59, 999);

        // Start from the Sunday of the week containing Jan 1
        const firstDayOfWeek = startDate.getDay();
        const gridStartDate = new Date(year, 0, 1 - firstDayOfWeek);

        // Calculate total weeks needed (always complete the year)
        const lastDayOfWeek = endDate.getDay();
        const gridEndDate = new Date(year, 11, 31 + (6 - lastDayOfWeek));
        const totalDays = Math.round((gridEndDate - gridStartDate) / (1000 * 60 * 60 * 24)) + 1;
        const totalWeeks = Math.ceil(totalDays / 7);

        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        // Build weeks array (each week is an array of 7 days)
        const weeks = [];
        const monthPositions = [];
        let lastMonth = -1;

        for (let week = 0; week < totalWeeks; week++) {
          const weekDays = [];
          for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
            const dayOffset = week * 7 + dayOfWeek;
            const currentDate = new Date(gridStartDate);
            currentDate.setDate(gridStartDate.getDate() + dayOffset);

            const dateStr = formatDateLocal(currentDate);
            const count = dayData[dateStr] || 0;
            const level = getLevel(count);
            const isInYear = currentDate.getFullYear() === year;
            const isFuture = currentDate > today;

            // Track month positions for labels
            if (dayOfWeek === 0 && isInYear && currentDate.getMonth() !== lastMonth) {
              monthPositions.push({ month: currentDate.getMonth(), week: week });
              lastMonth = currentDate.getMonth();
            }

            const displayDate = `${dayNames[dayOfWeek]}, ${monthNames[currentDate.getMonth()]} ${currentDate.getDate()}, ${currentDate.getFullYear()}`;
            const title = !isFuture ? `${displayDate}: ${count} observation${count !== 1 ? 's' : ''}` : displayDate;

            const isToday = dateStr === formatDateLocal(today);

            weekDays.push({
              dateStr,
              level: !isFuture ? level : 0,
              opacity: isFuture ? 'opacity: 0.3;' : '',
              title,
              isInYear,
              isToday
            });
          }
          weeks.push(weekDays);
        }

        // Render grid (column by column = week by week)
        let html = '';
        for (let week = 0; week < weeks.length; week++) {
          for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
            const day = weeks[week][dayOfWeek];
            const todayClass = day.isToday ? ' today' : '';
            html += `<div class="calendar-day${todayClass}" data-level="${day.level}" style="${day.opacity}" title="${day.title}"></div>`;
          }
        }
        calendarGrid.innerHTML = html;

        // Render month labels
        const weekWidth = 14; // 12px + 2px gap

        calendarMonths.innerHTML = monthPositions.map((pos, i) => {
          const nextPos = monthPositions[i + 1];
          const width = nextPos ? (nextPos.week - pos.week) * weekWidth : (totalWeeks - pos.week) * weekWidth;
          return `<span class="calendar-month" style="width: ${width}px;">${monthNames[pos.month]}</span>`;
        }).join('');
      }

      function getLevel(count) {
        if (count === 0) return 0;
        if (count === 1) return 1;
        if (count <= 4) return 2;
        if (count <= 9) return 3;
        return 4;
      }

      async function calculateAllStreaks(userId, joinYear, currentYear) {
        const currentStreakEl = document.getElementById('currentStreak');
        const longestStreakEl = document.getElementById('longestStreak');

        // Fetch all histogram data in a single call
        let allDays = {};

        try {
          const response = await fetch(
            `https://api.inaturalist.org/v1/observations/histogram?user_id=${userId}&d1=${joinYear}-01-01&d2=${currentYear}-12-31&date_field=observed&interval=day`
          );
          const data = await response.json();
          await delay(250);
          allDays = data.results?.day || {};
        } catch (error) {
          console.error('Error fetching histogram:', error);
        }

        // Calculate streaks
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStr = formatDateLocal(today);

        let currentStreak = 0;
        let longestStreak = 0;
        let tempStreak = 0;
        let longestStreakStart = null;
        let longestStreakEnd = null;
        let tempStreakStart = null;

        // Get all dates sorted
        const dates = Object.keys(allDays).filter(d => allDays[d] > 0).sort();

        if (dates.length === 0) {
          currentStreakEl.textContent = '0';
          longestStreakEl.textContent = '0';
          return;
        }

        // Helper to parse date string as local date
        function parseLocalDate(dateStr) {
          const [year, month, day] = dateStr.split('-').map(Number);
          return new Date(year, month - 1, day);
        }

        // Helper to get next day string
        function getNextDayStr(dateStr) {
          const date = parseLocalDate(dateStr);
          date.setDate(date.getDate() + 1);
          return formatDateLocal(date);
        }

        // Calculate longest streak
        let streakStart = dates[0];
        let streakEnd = dates[0];

        for (let i = 1; i < dates.length; i++) {
          const expectedNext = getNextDayStr(dates[i - 1]);

          if (dates[i] === expectedNext) {
            // Consecutive day, extend current streak
            streakEnd = dates[i];
          } else {
            // Gap found, check if current streak is longest
            const currentStreakLength = Math.round((parseLocalDate(streakEnd) - parseLocalDate(streakStart)) / (1000 * 60 * 60 * 24)) + 1;
            if (currentStreakLength > longestStreak) {
              longestStreak = currentStreakLength;
              longestStreakStart = parseLocalDate(streakStart);
              longestStreakEnd = parseLocalDate(streakEnd);
            }
            // Start new streak
            streakStart = dates[i];
            streakEnd = dates[i];
          }
        }

        // Check final streak
        const finalStreakLength = Math.round((parseLocalDate(streakEnd) - parseLocalDate(streakStart)) / (1000 * 60 * 60 * 24)) + 1;
        if (finalStreakLength > longestStreak) {
          longestStreak = finalStreakLength;
          longestStreakStart = parseLocalDate(streakStart);
          longestStreakEnd = parseLocalDate(streakEnd);
        }

        // Calculate current streak (going backwards from today)
        let checkDate = new Date(today);

        // First check if today has observations
        let hasToday = allDays[todayStr] > 0;
        if (!hasToday) {
          // Check yesterday
          checkDate.setDate(checkDate.getDate() - 1);
        }

        while (true) {
          const dateStr = formatDateLocal(checkDate);
          if (allDays[dateStr] > 0) {
            currentStreak++;
            checkDate.setDate(checkDate.getDate() - 1);
          } else {
            break;
          }
        }

        currentStreakEl.textContent = currentStreak.toString();

        // Format longest streak with date range
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        if (longestStreakStart && longestStreakEnd && longestStreak > 0) {
          const startStr = `${monthNames[longestStreakStart.getMonth()]} ${longestStreakStart.getDate()}, ${longestStreakStart.getFullYear()}`;
          const endStr = `${monthNames[longestStreakEnd.getMonth()]} ${longestStreakEnd.getDate()}, ${longestStreakEnd.getFullYear()}`;
          longestStreakEl.innerHTML = `${longestStreak} <span style="font-weight: normal; color: #aaa;">(${startStr} - ${endStr})</span>`;
        } else {
          longestStreakEl.textContent = longestStreak.toString();
        }
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add('show');
      }

      function hideError() {
        errorMessage.classList.remove('show');
      }

      // Redraw pie charts when dark mode changes
      let lastQualityData = null;
      let lastIdData = null;

      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.attributeName === 'class') {
            if (profileContent.style.display !== 'none') {
              // Re-draw charts with cached data
              if (lastQualityData) {
                drawPieChart(lastQualityData);
              }
              if (lastIdData) {
                drawIdPieChart(lastIdData);
              }
            }
          }
        });
      });

      observer.observe(document.body, { attributes: true });
    </script>
    <script defer data-domain="glauberramos.github.io/inat" src="https://plausible.io/js/script.js"></script>
    <script src="dark-mode.js"></script>
  </body>
</html>
