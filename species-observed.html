<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Species Observed - View Your iNaturalist Species List & Statistics
    </title>
    <link rel="icon" href="favicon.ico" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#74ac00" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <link rel="apple-touch-icon" href="logo.png" />
    <link
      rel="canonical"
      href="https://glauberramos.github.io/inat/species-observed.html"
    />
    <meta
      name="description"
      content="View all species you've observed on iNaturalist with detailed statistics, filter by location, iconic taxon, and conservation status. Track your observation counts and discover threatened species."
    />
    <meta
      name="keywords"
      content="iNaturalist species list, observation statistics, species tracker, biodiversity, nature observations, threatened species, conservation status"
    />
    <meta
      property="og:title"
      content="Species Observed - iNaturalist Species List Viewer"
    />
    <meta
      property="og:description"
      content="View all species you've observed on iNaturalist with statistics and filters."
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://glauberramos.github.io/inat/species-observed.html"
    />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Species Observed - iNaturalist Species List" />
    <meta name="twitter:description" content="View all species you've observed on iNaturalist with statistics and filters." />
    <meta name="robots" content="index, follow" />
    <meta name="author" content="Glauber Ramos" />
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Species Observed",
      "description": "View all species you've observed on iNaturalist with detailed statistics, filter by location, iconic taxon, and conservation status.",
      "url": "https://glauberramos.github.io/inat/species-observed.html",
      "applicationCategory": "UtilitiesApplication",
      "operatingSystem": "Web",
      "author": {
        "@type": "Person",
        "name": "Glauber Ramos"
      }
    }
    </script>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="dark-mode.css" />
    <style>
      .summary-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #ddd;
        padding: 15px 20px;
        display: flex;
        gap: 20px;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
      }

      .summary-search {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        align-items: center;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .controls label {
        font-weight: 500;
        color: #2c3e50;
      }

      .controls select {
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        background: white;
        cursor: pointer;
      }

      #speciesContainer {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 16px;
        margin-top: 16px;
      }

      .species-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #ddd;
        overflow: hidden;
        transition: transform 0.3s;
        position: relative;
      }

      .species-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .threatened-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
        text-transform: uppercase;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .only-observer-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: linear-gradient(135deg, #ffd700, #ffed4e);
        color: #2c3e50;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .species-card.only-observer {
        border: 3px solid #ffd700;
        box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
      }

      .species-card.only-observer:hover {
        box-shadow: 0 4px 12px rgba(255, 215, 0, 0.6);
      }

      .conservation-status {
        font-size: 10px;
        color: #666;
        margin-top: 4px;
        padding: 3px 6px;
        border-radius: 3px;
        font-weight: 500;
        display: inline-block;
      }

      .status-cr {
        background: #8b0000;
        color: white;
      }
      .status-en {
        background: #d12f19;
        color: white;
      }
      .status-vu {
        background: #f39c12;
        color: white;
      }
      .status-nt {
        background: #f1c40f;
        color: #333;
      }
      .status-lc {
        background: #27ae60;
        color: white;
      }

      .species-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        background: #f5f5f5;
      }

      .species-image-placeholder {
        width: 100%;
        height: 200px;
        background: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        color: #bbb;
      }

      .species-content {
        padding: 8px;
        padding-top: 4px;
      }

      .species-common-name {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 2px;
      }

      .species-sci-name {
        font-style: italic;
        color: #666;
        font-size: 13px;
        margin-bottom: 4px;
      }

      .species-stats {
        display: flex;
        flex-direction: row;
        gap: 8px;
        font-size: 13px;
        color: #666;
      }

      .user-count {
        color: #74ac00;
        font-weight: 600;
        font-size: 15px;
      }

      .global-count {
        color: #3498db;
        font-weight: 600;
        font-size: 15px;
      }

      .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 12px;
        border-radius: 4px;
        margin: 16px 0;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      @media (max-width: 1400px) {
        #speciesContainer {
          grid-template-columns: repeat(4, 1fr);
        }
      }

      @media (max-width: 1200px) {
        #speciesContainer {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      @media (max-width: 900px) {
        #speciesContainer {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 600px) {
        #speciesContainer {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
        }

        .species-image {
          height: 100px;
        }

        .species-content {
          padding: 6px;
        }
      }

      @media (max-width: 400px) {
        #speciesContainer {
          grid-template-columns: 1fr;
        }
      }

      .view-controls {
        display: flex;
        gap: 15px;
        align-items: center;
        margin: 20px 0;
      }

      .view-buttons {
        display: flex;
        gap: 0;
        border-radius: 6px;
        overflow: hidden;
        border: 2px solid #ddd;
      }

      .view-btn {
        padding: 10px 20px;
        border: none;
        background: white;
        color: #2c3e50;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
        border-right: 1px solid #ddd;
      }

      .view-btn:last-child {
        border-right: none;
      }

      .view-btn:hover:not(.active) {
        background: #f5f5f5;
      }

      .view-btn.active {
        background: #3498db;
        color: white;
      }

      .species-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        margin-top: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
      }

      .species-table thead {
        background: #f5f5f5;
        border-bottom: 2px solid #ddd;
      }

      .species-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #2c3e50;
        font-size: 15px;
      }

      .species-table td {
        padding: 6px;
        border-bottom: 1px solid #eee;
        font-size: 15px;
      }

      .species-table tbody tr {
        transition: background 0.2s;
      }

      .species-table tbody tr:hover {
        background: #f9f9f9;
      }

      .species-table .table-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
      }

      .table-image-placeholder {
        width: 60px;
        height: 60px;
        background: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        color: #bbb;
        border-radius: 4px;
      }

      .species-table .table-common-name {
        font-weight: 600;
        color: #2c3e50;
        font-size: 15px;
      }

      .species-table .table-sci-name {
        font-style: italic;
        color: #666;
        font-size: 13px;
      }

      .species-table .user-count {
        color: #74ac00;
        font-weight: 600;
        font-size: 15px;
      }

      .species-table .global-count {
        color: #3498db;
        font-weight: 600;
        font-size: 15px;
      }

      #speciesContainer.table-view {
        display: block;
      }

      @media (max-width: 768px) {
        .summary-card {
          padding: 15px;
        }

        .summary-search {
          flex-direction: column;
          width: 100%;
          gap: 10px;
        }

        .summary-search .username-search-container {
          width: 100% !important;
        }

        .summary-search button {
          width: 100%;
        }

        .controls {
          flex-direction: column;
          align-items: stretch;
          gap: 10px;
        }

        .controls label {
          margin-left: 0 !important;
        }

        .controls select,
        .controls input[type="text"] {
          width: 100%;
        }

        .view-controls {
          flex-direction: column;
          align-items: stretch;
          gap: 10px;
        }

        .view-buttons {
          width: 100%;
        }

        .view-btn {
          flex: 1;
        }

        #resultsCount {
          text-align: center;
        }

        .species-table {
          display: block;
          overflow-x: auto;
          white-space: nowrap;
        }
      }

      @media (max-width: 480px) {
        body {
          padding-top: 60px;
        }

        .back-button {
          font-size: 0.8rem !important;
          padding: 8px 12px !important;
          top: 10px !important;
          left: 10px !important;
        }

        .container {
          padding: 10px;
        }

        .header-content {
          flex-direction: column;
          gap: 10px;
        }

        .title-container {
          flex-direction: column;
          gap: 10px;
        }

        .logo {
          width: 50px;
          height: 50px;
        }

        h1 {
          font-size: 1.3rem;
          text-align: center;
        }

        .description {
          font-size: 0.9rem;
          text-align: center;
        }

        .species-card {
          margin: 0;
        }

        .species-common-name {
          font-size: 14px;
        }

        .species-sci-name {
          font-size: 12px;
        }

        .species-stats {
          font-size: 12px;
        }

        .only-observer-badge,
        .threatened-badge {
          font-size: 9px;
          padding: 3px 6px;
        }
      }

      /* Hide default pipeback widget */
      #pipeback-widget-container,
      .pipeback-launcher-frame {
        display: none !important;
      }

      /* Custom feedback button */
      .feedback-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #74ac00;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 999;
        transition: all 0.3s;
      }

      .feedback-button:hover {
        background: #5d8a00;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      }
    </style>
  </head>
  <body>
    <a
      href="/inat"
      class="back-button"
      style="
        position: fixed;
        top: 20px;
        left: 20px;
        background: #74ac00;
        color: white;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 10px 16px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
      "
      onmouseover="this.style.background='#659900'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.2)'"
      onmouseout="this.style.background='#74ac00'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.15)'"
    >
      <span style="font-size: 1rem">‚Üê</span> More iNat tools
    </a>
    <div class="container">
      <header>
        <div class="header-content">
          <div class="title-container">
            <img src="logo.png" alt="iNaturalist Logo" class="logo" />
            <h1>Species Observed on iNaturalist</h1>
          </div>
          <p class="description">View user statistics and species</p>
        </div>
        <div class="error-message" id="errorMessage"></div>
      </header>

      <main>
        <div class="summary-card" id="summaryCard">
          <div class="summary-search">
            <div class="username-search-container" style="width: 300px">
              <input
                type="text"
                id="usernameInput"
                placeholder="Enter iNaturalist username..."
                autocomplete="off"
                style="width: 100%"
              />
              <div
                id="usernameAutocomplete"
                class="username-autocomplete"
              ></div>
            </div>
            <div class="username-search-container" style="width: 250px">
              <input
                type="text"
                id="locationInput"
                placeholder="Filter by location (optional)"
                autocomplete="off"
                style="width: 100%"
              />
              <div
                id="locationAutocomplete"
                class="username-autocomplete"
              ></div>
              <input type="hidden" id="placeId" value="" />
            </div>
            <div class="username-search-container" style="width: 250px">
              <input
                type="text"
                id="taxonInput"
                placeholder="Filter by taxon (optional)"
                autocomplete="off"
                style="width: 100%"
              />
              <div id="taxonAutocomplete" class="username-autocomplete"></div>
              <input type="hidden" id="taxonId" value="" />
            </div>
            <button id="searchButton">Search</button>
          </div>
        </div>


        <div class="controls" id="controls" style="display: none">
          <label for="iconicTaxonSelect">Iconic Taxon:</label>
          <select
            id="iconicTaxonSelect"
            style="
              padding: 8px 12px;
              border: 2px solid #ddd;
              border-radius: 5px;
              font-size: 14px;
              background: white;
              cursor: pointer;
            "
          >
            <option value="">All</option>
            <option value="Mammalia">Mammalia</option>
            <option value="Aves">Aves</option>
            <option value="Animalia">Animalia</option>
            <option value="Mollusca">Mollusca</option>
            <option value="Plantae">Plantae</option>
            <option value="Arachnida">Arachnida</option>
            <option value="Insecta">Insecta</option>
            <option value="Amphibia">Amphibia</option>
            <option value="Protozoa">Protozoa</option>
            <option value="Fungi">Fungi</option>
            <option value="Chromista">Chromista</option>
            <option value="Actinopterygii">Actinopterygii</option>
            <option value="Reptilia">Reptilia</option>
          </select>
          <label
            style="
              margin-left: 20px;
              display: inline-flex;
              align-items: center;
              gap: 6px;
              cursor: pointer;
            "
          >
            <input
              type="checkbox"
              id="conservationStatusFilter"
              style="width: 16px; height: 16px; cursor: pointer"
            />
            <span>Threatened</span>
          </label>
          <label for="sortSelect" style="margin-left: 20px">Sort by:</label>
          <select id="sortSelect">
            <option value="user">User Observations (High to Low)</option>
            <option value="user-asc">User Observations (Low to High)</option>
            <option value="global">Global Observations (High to Low)</option>
            <option value="global-asc">
              Global Observations (Low to High)
            </option>
          </select>
          <label for="filterInput" style="margin-left: 20px">Filter:</label>
          <input
            type="text"
            id="filterInput"
            placeholder="Search by name..."
            style="
              padding: 8px 12px;
              border: 2px solid #ddd;
              border-radius: 5px;
              font-size: 14px;
              width: 200px;
            "
          />
        </div>

        <div class="view-controls" id="viewControls" style="display: none">
          <div class="view-buttons">
            <button id="gridViewBtn" class="view-btn active">Grid View</button>
            <button id="tableViewBtn" class="view-btn">Table View</button>
          </div>
          <div id="resultsCount" style="color: #666; font-size: 14px"></div>
        </div>

        <div class="loading" id="loading" style="display: none">Loading...</div>
        <div id="speciesContainer"></div>
      </main>
    </div>
    <script>
      const usernameInput = document.getElementById("usernameInput");
      const usernameAutocomplete = document.getElementById(
        "usernameAutocomplete"
      );
      const locationInput = document.getElementById("locationInput");
      const locationAutocomplete = document.getElementById(
        "locationAutocomplete"
      );
      const placeIdInput = document.getElementById("placeId");
      const taxonInput = document.getElementById("taxonInput");
      const taxonAutocomplete = document.getElementById("taxonAutocomplete");
      const taxonIdInput = document.getElementById("taxonId");
      const searchButton = document.getElementById("searchButton");
      const loading = document.getElementById("loading");
      const resultsCount = document.getElementById("resultsCount");
      const speciesContainer = document.getElementById("speciesContainer");
      const errorMessage = document.getElementById("errorMessage");
      const summaryCard = document.getElementById("summaryCard");
      const controls = document.getElementById("controls");
      const iconicTaxonSelect = document.getElementById("iconicTaxonSelect");
      const conservationStatusFilter = document.getElementById(
        "conservationStatusFilter"
      );
      const sortSelect = document.getElementById("sortSelect");
      const filterInput = document.getElementById("filterInput");
      const viewControls = document.getElementById("viewControls");
      const gridViewBtn = document.getElementById("gridViewBtn");
      const tableViewBtn = document.getElementById("tableViewBtn");

      let speciesData = [];
      let threatenedTaxonIds = new Set();
      let currentUserId = null;
      let searchTimeout = null;
      let locationSearchTimeout = null;
      let currentView = "grid"; // 'grid' or 'table'

      // URL parameter and localStorage handling
      const urlParams = new URLSearchParams(window.location.search);
      const urlUsername = urlParams.get("user");
      const urlPlaceId = urlParams.get("place_id");
      const urlPlaceName = urlParams.get("place");
      const savedUsername = localStorage.getItem("inatUsername");

      function updateUrlWithUsername(username) {
        const url = new URL(window.location);
        url.searchParams.set("user", username);
        window.history.replaceState({}, "", url);
      }

      function updateUrlWithPlace(placeId, placeName) {
        const url = new URL(window.location);
        if (placeId && placeName) {
          url.searchParams.set("place_id", placeId);
          url.searchParams.set("place", placeName);
        } else {
          url.searchParams.delete("place_id");
          url.searchParams.delete("place");
        }
        window.history.replaceState({}, "", url);
      }

      if (urlUsername) {
        usernameInput.value = urlUsername;
        localStorage.setItem("inatUsername", urlUsername);
      } else if (savedUsername) {
        usernameInput.value = savedUsername;
      }

      // Load place from URL parameter or localStorage
      const savedPlaceId = localStorage.getItem("inatPlaceId");
      const savedPlaceName = localStorage.getItem("inatPlaceName");
      if (urlPlaceId && urlPlaceName) {
        placeIdInput.value = urlPlaceId;
        locationInput.value = urlPlaceName;
        localStorage.setItem("inatPlaceId", urlPlaceId);
        localStorage.setItem("inatPlaceName", urlPlaceName);
      } else if (savedPlaceId && savedPlaceName) {
        placeIdInput.value = savedPlaceId;
        locationInput.value = savedPlaceName;
      }

      // Username autocomplete
      usernameInput.addEventListener("input", (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();

        if (query.length < 2) {
          usernameAutocomplete.innerHTML = "";
          usernameAutocomplete.style.display = "none";
          return;
        }

        searchTimeout = setTimeout(async () => {
          try {
            const response = await fetch(
              `https://api.inaturalist.org/v1/users/autocomplete?q=${encodeURIComponent(
                query
              )}`
            );
            const data = await response.json();

            if (data.results && data.results.length > 0) {
              usernameAutocomplete.innerHTML = data.results
                .slice(0, 10)
                .map((user) => {
                  const obsCount = user.observations_count || 0;
                  return `
                    <div class="username-suggestion" data-login="${user.login}">
                      <div class="username-name">${user.login}</div>
                      <div class="username-info">${obsCount.toLocaleString()} observations</div>
                    </div>
                  `;
                })
                .join("");
              usernameAutocomplete.style.display = "block";

              document
                .querySelectorAll(".username-suggestion")
                .forEach((item) => {
                  item.addEventListener("click", () => {
                    usernameInput.value = item.dataset.login;
                    usernameAutocomplete.innerHTML = "";
                    usernameAutocomplete.style.display = "none";
                    fetchUserData();
                  });
                });
            } else {
              usernameAutocomplete.innerHTML = "";
              usernameAutocomplete.style.display = "none";
            }
          } catch (error) {
            console.error("Error fetching users:", error);
            usernameAutocomplete.innerHTML = "";
            usernameAutocomplete.style.display = "none";
          }
        }, 300);
      });

      // Hide autocomplete when clicking outside
      document.addEventListener("click", (e) => {
        if (
          !usernameInput.contains(e.target) &&
          !usernameAutocomplete.contains(e.target)
        ) {
          usernameAutocomplete.style.display = "none";
        }
        if (
          !locationInput.contains(e.target) &&
          !locationAutocomplete.contains(e.target)
        ) {
          locationAutocomplete.style.display = "none";
        }
        if (
          !taxonInput.contains(e.target) &&
          !taxonAutocomplete.contains(e.target)
        ) {
          taxonAutocomplete.style.display = "none";
        }
      });

      // Location autocomplete
      locationInput.addEventListener("input", (e) => {
        clearTimeout(locationSearchTimeout);
        const query = e.target.value.trim();

        // Clear place ID when user types
        placeIdInput.value = "";

        if (query.length < 2) {
          locationAutocomplete.innerHTML = "";
          locationAutocomplete.style.display = "none";
          // Clear from localStorage and URL if input is empty
          if (query.length === 0) {
            localStorage.removeItem("inatPlaceId");
            localStorage.removeItem("inatPlaceName");
            updateUrlWithPlace(null, null);
          }
          return;
        }

        locationSearchTimeout = setTimeout(async () => {
          try {
            const response = await fetch(
              `https://api.inaturalist.org/v1/places/autocomplete?q=${encodeURIComponent(
                query
              )}&per_page=10`
            );
            const data = await response.json();

            if (data.results && data.results.length > 0) {
              locationAutocomplete.innerHTML = data.results
                .map(
                  (place) => `
                  <div class="username-suggestion" data-place-id="${
                    place.id
                  }" data-place-name="${place.display_name || place.name}">
                    <div class="username-name">${
                      place.display_name || place.name
                    }</div>
                    <div class="username-info">${
                      place.place_type_name || ""
                    }</div>
                  </div>
                `
                )
                .join("");
              locationAutocomplete.style.display = "block";

              document
                .querySelectorAll("#locationAutocomplete .username-suggestion")
                .forEach((item) => {
                  item.addEventListener("click", () => {
                    locationInput.value = item.dataset.placeName;
                    placeIdInput.value = item.dataset.placeId;
                    // Save to localStorage and update URL
                    localStorage.setItem("inatPlaceId", item.dataset.placeId);
                    localStorage.setItem("inatPlaceName", item.dataset.placeName);
                    updateUrlWithPlace(item.dataset.placeId, item.dataset.placeName);
                    locationAutocomplete.innerHTML = "";
                    locationAutocomplete.style.display = "none";
                  });
                });
            } else {
              locationAutocomplete.innerHTML = "";
              locationAutocomplete.style.display = "none";
            }
          } catch (error) {
            console.error("Error fetching places:", error);
            locationAutocomplete.innerHTML = "";
            locationAutocomplete.style.display = "none";
          }
        }, 300);
      });

      // Taxon autocomplete
      let taxonSearchTimeout = null;

      taxonInput.addEventListener("input", (e) => {
        clearTimeout(taxonSearchTimeout);
        const query = e.target.value.trim();

        // Clear taxon ID when user types
        taxonIdInput.value = "";

        if (query.length < 2) {
          taxonAutocomplete.innerHTML = "";
          taxonAutocomplete.style.display = "none";
          return;
        }

        taxonSearchTimeout = setTimeout(async () => {
          try {
            const response = await fetch(
              `https://api.inaturalist.org/v1/taxa/autocomplete?q=${encodeURIComponent(
                query
              )}&per_page=10&rank=kingdom,phylum,subphylum,class,subclass,order,suborder,family,subfamily,tribe,subtribe,genus,subgenus`
            );
            const data = await response.json();

            if (data.results && data.results.length > 0) {
              taxonAutocomplete.innerHTML = data.results
                .map(
                  (taxon) => `
                  <div class="username-suggestion" data-taxon-id="${
                    taxon.id
                  }" data-taxon-name="${taxon.name}">
                    <div class="username-name">${
                      taxon.preferred_common_name || taxon.name
                    }</div>
                    <div class="username-info">${taxon.rank}${
                    taxon.preferred_common_name ? ` - ${taxon.name}` : ""
                  }</div>
                  </div>
                `
                )
                .join("");
              taxonAutocomplete.style.display = "block";

              document
                .querySelectorAll("#taxonAutocomplete .username-suggestion")
                .forEach((item) => {
                  item.addEventListener("click", () => {
                    taxonInput.value = item.dataset.taxonName;
                    taxonIdInput.value = item.dataset.taxonId;
                    taxonAutocomplete.innerHTML = "";
                    taxonAutocomplete.style.display = "none";
                  });
                });
            } else {
              taxonAutocomplete.innerHTML = "";
              taxonAutocomplete.style.display = "none";
            }
          } catch (error) {
            console.error("Error fetching taxa:", error);
            taxonAutocomplete.innerHTML = "";
            taxonAutocomplete.style.display = "none";
          }
        }, 300);
      });

      // Search button handler
      searchButton.addEventListener("click", () => {
        fetchUserData();
      });

      // Enter key handler
      usernameInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          fetchUserData();
        }
      });

      // Iconic taxon filter handler
      iconicTaxonSelect.addEventListener("change", () => {
        displaySpecies();
      });

      // Conservation status filter handler
      conservationStatusFilter.addEventListener("change", () => {
        displaySpecies();
      });

      // Sort handler
      sortSelect.addEventListener("change", () => {
        displaySpecies();
      });

      // Filter handler
      filterInput.addEventListener("input", () => {
        displaySpecies();
      });

      // View toggle handlers
      gridViewBtn.addEventListener("click", () => {
        currentView = "grid";
        gridViewBtn.classList.add("active");
        tableViewBtn.classList.remove("active");
        displaySpecies();
      });

      tableViewBtn.addEventListener("click", () => {
        currentView = "table";
        tableViewBtn.classList.add("active");
        gridViewBtn.classList.remove("active");
        displaySpecies();
      });

      async function fetchUserData() {
        const username = usernameInput.value.trim();

        if (!username) {
          showError("Please enter a username");
          return;
        }

        // Get place ID if location filter is set
        const placeId = placeIdInput.value || null;
        const locationName = locationInput.value.trim();
        const placeParam = placeId ? `&place_id=${placeId}` : "";

        // Get taxon ID if taxon filter is set
        const taxonId = taxonIdInput.value || null;
        const taxonParam = taxonId ? `&taxon_id=${taxonId}` : "";

        hideError();
        loading.style.display = "block";
        speciesContainer.innerHTML = "";
        controls.style.display = "none";

        try {
          // First, get user info to get user_id
          const userResponse = await fetch(
            `https://api.inaturalist.org/v1/users/autocomplete?q=${encodeURIComponent(
              username
            )}`
          );
          const userData = await userResponse.json();

          if (!userData.results || userData.results.length === 0) {
            loading.style.display = "none";
            showError("User not found");
            return;
          }

          const user = userData.results[0];
          const userId = user.id;
          currentUserId = userId;

          // Save username to localStorage and update URL
          localStorage.setItem("inatUsername", username);
          updateUrlWithUsername(username);

          // Fetch species count data - first page to get total_results
          const perPage = 500;
          const firstResponse = await fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&per_page=${perPage}&page=1${placeParam}${taxonParam}`
          );
          const firstData = await firstResponse.json();

          if (!firstData.results || firstData.results.length === 0) {
            loading.style.display = "none";
            const locationMsg = locationName ? ` in ${locationName}` : "";
            showError(`No species found for this user${locationMsg}`);
            return;
          }

          // Start with first page results
          let allResults = [...firstData.results];
          const totalResults = firstData.total_results;
          const totalPages = Math.ceil(totalResults / perPage);

          // If there are more pages, fetch them all
          if (totalPages > 1) {
            const additionalPromises = [];
            for (let page = 2; page <= totalPages; page++) {
              additionalPromises.push(
                fetch(
                  `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&per_page=${perPage}&page=${page}${placeParam}${taxonParam}`
                )
                  .then((response) => response.json())
                  .then((data) => data.results)
              );
            }

            // Fetch all remaining pages in parallel
            const additionalResults = await Promise.all(additionalPromises);
            additionalResults.forEach((results) => {
              allResults.push(...results);
            });
          }

          loading.style.display = "none";

          speciesData = allResults;

          // Fetch all threatened species using separate API call with pagination
          threatenedTaxonIds = new Set();
          const threatenedPerPage = 500;
          const firstThreatenedResponse = await fetch(
            `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&per_page=${threatenedPerPage}&page=1&threatened=true${placeParam}${taxonParam}`
          );
          const firstThreatenedData = await firstThreatenedResponse.json();
          const threatenedTotalResults = firstThreatenedData.total_results || 0;

          // Add first page results to set
          if (firstThreatenedData.results) {
            firstThreatenedData.results.forEach((item) => {
              if (item.taxon && item.taxon.id) {
                threatenedTaxonIds.add(item.taxon.id);
              }
            });
          }

          // Fetch remaining pages if needed
          const threatenedTotalPages = Math.ceil(
            threatenedTotalResults / threatenedPerPage
          );
          if (threatenedTotalPages > 1) {
            const threatenedPromises = [];
            for (let page = 2; page <= threatenedTotalPages; page++) {
              threatenedPromises.push(
                fetch(
                  `https://api.inaturalist.org/v1/observations/species_counts?user_id=${userId}&per_page=${threatenedPerPage}&page=${page}&threatened=true${placeParam}${taxonParam}`
                )
                  .then((response) => response.json())
                  .then((data) => data.results || [])
              );
            }
            const additionalThreatenedResults = await Promise.all(
              threatenedPromises
            );
            additionalThreatenedResults.forEach((results) => {
              results.forEach((item) => {
                if (item.taxon && item.taxon.id) {
                  threatenedTaxonIds.add(item.taxon.id);
                }
              });
            });
          }

          controls.style.display = "flex";
          viewControls.style.display = "flex";

          displaySpecies();
        } catch (error) {
          console.error("Error fetching user data:", error);
          loading.style.display = "none";
          showError("Error fetching data. Please try again.");
        }
      }

      function displaySpecies() {
        // Filter data based on text input and iconic taxon
        const filterText = filterInput.value.trim().toLowerCase();
        const iconicTaxon = iconicTaxonSelect.value;
        const onlyWithConservationStatus = conservationStatusFilter.checked;
        let filteredData = speciesData;

        // Filter by iconic taxon
        if (iconicTaxon) {
          filteredData = filteredData.filter((item) => {
            return item.taxon.iconic_taxon_name === iconicTaxon;
          });
        }

        // Filter by threatened species (using API-fetched threatened taxon IDs)
        if (onlyWithConservationStatus) {
          filteredData = filteredData.filter((item) => {
            return item.taxon && threatenedTaxonIds.has(item.taxon.id);
          });
        }

        // Filter by text
        if (filterText) {
          filteredData = filteredData.filter((item) => {
            const commonName = (
              item.taxon.preferred_common_name || ""
            ).toLowerCase();
            const sciName = (item.taxon.name || "").toLowerCase();
            return (
              commonName.includes(filterText) || sciName.includes(filterText)
            );
          });
        }

        // Sort data based on selection
        const sortBy = sortSelect.value;
        let sortedData = [...filteredData];

        if (sortBy === "user") {
          sortedData.sort((a, b) => b.count - a.count);
        } else if (sortBy === "user-asc") {
          sortedData.sort((a, b) => a.count - b.count);
        } else if (sortBy === "global") {
          sortedData.sort(
            (a, b) =>
              (b.taxon.observations_count || 0) -
              (a.taxon.observations_count || 0)
          );
        } else if (sortBy === "global-asc") {
          sortedData.sort(
            (a, b) =>
              (a.taxon.observations_count || 0) -
              (b.taxon.observations_count || 0)
          );
        }

        // Display results count
        const resultCount = sortedData.length;
        resultsCount.textContent = `${resultCount.toLocaleString()} result${
          resultCount !== 1 ? "s" : ""
        }`;

        // Escape HTML helper function
        const escapeHtml = (text) => {
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        };

        // Render based on current view
        if (currentView === "table") {
          speciesContainer.classList.add("table-view");
          speciesContainer.innerHTML = `
            <table class="species-table">
              <thead>
                <tr>
                  <th>Taxon ID</th>
                  <th>Iconic Taxon</th>
                  <th>Image</th>
                  <th>Common Name</th>
                  <th>Scientific Name</th>
                  <th>Your Observations</th>
                  <th>Global Observations</th>
                  <th>Conservation Status</th>
                </tr>
              </thead>
              <tbody>
                ${sortedData
                  .map((item) => {
                    const taxon = item.taxon;
                    const userCount = item.count;
                    const globalCount = taxon.observations_count || 0;

                    // Check if user is the only observer
                    const isOnlyObserver =
                      userCount === globalCount && globalCount > 0;

                    // Get image
                    let imageUrl = null;
                    let hasPhoto = false;
                    if (taxon.default_photo && taxon.default_photo.medium_url) {
                      imageUrl = taxon.default_photo.medium_url;
                      hasPhoto = true;
                    }

                    // Get iconic taxon icon
                    const iconicTaxonIcons = {
                      Mammalia: "ü¶å",
                      Aves: "ü¶Ö",
                      Reptilia: "ü¶é",
                      Amphibia: "üê∏",
                      Actinopterygii: "üêü",
                      Insecta: "ü¶ã",
                      Arachnida: "üï∑Ô∏è",
                      Mollusca: "üêå",
                      Plantae: "üåø",
                      Fungi: "üçÑ",
                      Animalia: "üêæ",
                      Protozoa: "ü¶†",
                      Chromista: "ü¶†",
                    };
                    const iconicTaxonIcon =
                      iconicTaxonIcons[taxon.iconic_taxon_name] || "üîç";

                    // Get names
                    const commonName =
                      taxon.preferred_common_name || taxon.name;
                    const sciName = taxon.name;

                    // Get iconic taxon
                    const iconicTaxon = taxon.iconic_taxon_name || "-";

                    // Get conservation status
                    let conservationStatusHtml = "-";
                    if (
                      taxon.conservation_status &&
                      taxon.conservation_status.status
                    ) {
                      const status =
                        taxon.conservation_status.status.toLowerCase();
                      const statusName =
                        taxon.conservation_status.status_name ||
                        status.toUpperCase();

                      const statusConfig = {
                        cr: { class: "status-cr" },
                        critically_endangered: { class: "status-cr" },
                        en: { class: "status-en" },
                        endangered: { class: "status-en" },
                        vu: { class: "status-vu" },
                        vulnerable: { class: "status-vu" },
                        nt: { class: "status-nt" },
                        near_threatened: { class: "status-nt" },
                        lc: { class: "status-lc" },
                        least_concern: { class: "status-lc" },
                      };

                      const config = statusConfig[status];
                      if (config) {
                        conservationStatusHtml = `<span class="conservation-status ${config.class}">${statusName}</span>`;
                      }
                    }

                    return `
                      <tr${
                        isOnlyObserver
                          ? ' style="background: linear-gradient(to right, rgba(255, 215, 0, 0.1), transparent);"'
                          : ""
                      }>
                        <td><a href="https://www.inaturalist.org/taxa/${
                          taxon.id
                        }" target="_blank" style="color: #3498db; text-decoration: underline;">${
                      taxon.id
                    }</a></td>
                        <td>${iconicTaxon}</td>
                        <td>${
                          hasPhoto
                            ? `<img class="table-image" src="${imageUrl}" alt="${escapeHtml(
                                commonName
                              )}" onerror="this.src='https://www.inaturalist.org/assets/logo-small.png'">`
                            : `<div class="table-image-placeholder">${iconicTaxonIcon}</div>`
                        }</td>
                        <td><div class="table-common-name">${
                          isOnlyObserver ? "‚≠ê " : ""
                        }${escapeHtml(commonName)}</div></td>
                        <td><div class="table-sci-name">${escapeHtml(
                          sciName
                        )}</div></td>
                        <td><a href="https://www.inaturalist.org/observations?user_id=${currentUserId}&taxon_id=${
                      taxon.id
                    }" target="_blank" style="color: #74ac00; text-decoration: underline; font-weight: 600;">${userCount.toLocaleString()}</a></td>
                        <td><a href="https://www.inaturalist.org/observations?taxon_id=${
                          taxon.id
                        }" target="_blank" style="color: #3498db; text-decoration: underline; font-weight: 600;">${globalCount.toLocaleString()}</a></td>
                        <td>${conservationStatusHtml}</td>
                      </tr>
                    `;
                  })
                  .join("")}
              </tbody>
            </table>
          `;
        } else {
          // Grid view
          speciesContainer.classList.remove("table-view");
          speciesContainer.innerHTML = sortedData
            .map((item) => {
              const taxon = item.taxon;
              const userCount = item.count;
              const globalCount = taxon.observations_count || 0;

              // Get image
              let imageUrl = null;
              let hasPhoto = false;
              if (taxon.default_photo && taxon.default_photo.medium_url) {
                imageUrl = taxon.default_photo.medium_url;
                hasPhoto = true;
              }

              // Get iconic taxon icon
              const iconicTaxonIcons = {
                Mammalia: "ü¶å",
                Aves: "ü¶Ö",
                Reptilia: "ü¶é",
                Amphibia: "üê∏",
                Actinopterygii: "üêü",
                Insecta: "ü¶ã",
                Arachnida: "üï∑Ô∏è",
                Mollusca: "üêå",
                Plantae: "üåø",
                Fungi: "üçÑ",
                Animalia: "üêæ",
                Protozoa: "ü¶†",
                Chromista: "ü¶†",
              };
              const iconicTaxonIcon =
                iconicTaxonIcons[taxon.iconic_taxon_name] || "üîç";

              // Get names
              const commonName = taxon.preferred_common_name || taxon.name;
              const sciName = taxon.name;

              // Check if user is the only observer
              const isOnlyObserver =
                userCount === globalCount && globalCount > 0;
              const onlyObserverClass = isOnlyObserver ? " only-observer" : "";
              const onlyObserverBadge = isOnlyObserver
                ? `<div class="only-observer-badge">‚≠ê Only Observer</div>`
                : "";

              // Get conservation status
              let conservationBadge = "";
              let conservationStatusHtml = "";
              if (
                taxon.conservation_status &&
                taxon.conservation_status.status
              ) {
                const status = taxon.conservation_status.status.toLowerCase();
                const statusName =
                  taxon.conservation_status.status_name || status.toUpperCase();

                // Map status codes to colors and badge text
                const statusConfig = {
                  cr: { color: "#8b0000", badge: "CR", class: "status-cr" },
                  critically_endangered: {
                    color: "#8b0000",
                    badge: "CR",
                    class: "status-cr",
                  },
                  en: { color: "#d12f19", badge: "EN", class: "status-en" },
                  endangered: {
                    color: "#d12f19",
                    badge: "EN",
                    class: "status-en",
                  },
                  vu: { color: "#f39c12", badge: "VU", class: "status-vu" },
                  vulnerable: {
                    color: "#f39c12",
                    badge: "VU",
                    class: "status-vu",
                  },
                  nt: { color: "#f1c40f", badge: "NT", class: "status-nt" },
                  near_threatened: {
                    color: "#f1c40f",
                    badge: "NT",
                    class: "status-nt",
                  },
                  lc: { color: "#27ae60", badge: "LC", class: "status-lc" },
                  least_concern: {
                    color: "#27ae60",
                    badge: "LC",
                    class: "status-lc",
                  },
                };

                const config = statusConfig[status];
                if (config) {
                  conservationBadge = `<div class="threatened-badge" style="background: ${config.color};">${config.badge}</div>`;
                  conservationStatusHtml = `<div class="conservation-status ${config.class}">${statusName}</div>`;
                }
              }

              return `
                <div class="species-card${onlyObserverClass}">
                  ${onlyObserverBadge}
                  ${conservationBadge}
                  <a href="https://www.inaturalist.org/observations?user_id=${currentUserId}&taxon_id=${
                taxon.id
              }" target="_blank" style="text-decoration: none; color: inherit;">
                    ${
                      hasPhoto
                        ? `<img class="species-image" src="${imageUrl}" alt="${escapeHtml(
                            commonName
                          )}" onerror="this.src='https://www.inaturalist.org/assets/logo-small.png'">`
                        : `<div class="species-image-placeholder">${iconicTaxonIcon}</div>`
                    }
                    <div class="species-content">
                      <div class="species-common-name">${escapeHtml(
                        commonName
                      )}</div>
                      ${
                        commonName !== sciName
                          ? `<div class="species-sci-name">${escapeHtml(
                              sciName
                            )}</div>`
                          : ""
                      }
                      <div class="species-stats">
                        <div>Your obs: <span class="user-count">${userCount.toLocaleString()}</span></div>
                        <div>Global: <span class="global-count">${globalCount.toLocaleString()}</span></div>
                      </div>
                      ${conservationStatusHtml}
                    </div>
                  </a>
                </div>
              `;
            })
            .join("");
        }
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add("show");
      }

      function hideError() {
        errorMessage.classList.remove("show");
      }
    </script>
    <button class="feedback-button" id="feedbackBtn">Send feedback</button>
    <script
      defer
      data-domain="glauberramos.github.io/inat"
      src="https://plausible.io/js/script.js"
    ></script>
    <script type="text/javascript">
      window.$pipeback = [];
      window.PIPEBACK_ID = "a069b910-4aef-4233-99cc-913e7fb30fb5";
      (function () {
        d = document;
        s = d.createElement("script");
        s.src = "https://widget.pipeback.com/l.js";
        s.async = 1;
        d.getElementsByTagName("head")[0].appendChild(s);
      })();

      // Feedback button toggle
      let feedbackOpen = false;
      document.getElementById("feedbackBtn").addEventListener("click", () => {
        if (feedbackOpen) {
          $pipeback.close();
          feedbackOpen = false;
        } else {
          $pipeback.open();
          feedbackOpen = true;
        }
      });
    </script>
    <script src="dark-mode.js"></script>
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
      }
    </script>
  </body>
</html>
